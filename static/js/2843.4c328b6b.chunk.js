"use strict";(self.webpackChunkmmsp_land_hl=self.webpackChunkmmsp_land_hl||[]).push([[2843],{12843:(e,t,i)=>{i.d(t,{FeatureSnappingEngine:()=>O});var n=i(6326),r=i(91967),l=i(18690),a=i(54901),o=i(81806),s=i(43927),u=i(50346),d=i(68134),c=i(31633),p=i(46053),v=i(76460),h=i(87990),g=i(19555),y=i(20664),f=i(9392),m=i(53494),S=i(19451),w=i(12482),_=i(75543),b=i(23862),C=i(89379),M=i(34154),F=(i(47249),i(8203)),R=i(46530),x=i(31933),A=i(70330),I=i(90992);let L=class extends r.A{set attributeRulesEnabled(e){this._set("attributeRulesEnabled",e),e&&this.loadRules()}get layerView(){var e;return null===(e=this.view)||void 0===e||null===(e=e.allLayerViews)||void 0===e?void 0:e.find(e=>e.layer===this.layer)}get valid(){const{_valid:e,snappingSource:t,layer:i}=this;return!(!t||!i)&&e}get subtypeFilter(){var e,t,i;const{layer:n,snappingSource:r}=this;if(!(0,x.F2)(n)||null===(e=n.subtypes)||void 0===e||!e.length||!r)return{mode:"not-in-use",filter:null};const l=r.layerSource.sublayerSources.filter(e=>{var t;return e.enabled&&e.layer.visible&&(0,I.JU)(null===(t=this.view)||void 0===t?void 0:t.scale,e.layer.effectiveScaleRange.minScale,e.layer.effectiveScaleRange.maxScale)}).map(e=>e.layer.subtypeCode);if(!l.length)return{mode:"none-visible",filter:null};if(l.length===n.subtypes.length)return{mode:"all-visible",filter:null};const a=null!==(t=null===(i=n.fieldsIndex.get(n.subtypeField))||void 0===i?void 0:i.name)&&void 0!==t?t:n.subtypeField;return 1===l.length?{mode:"in-use",filter:"".concat(a," = ").concat(l.getItemAt(0))}:{mode:"in-use",filter:"".concat(a," IN (").concat(l.join(", "),")")}}get floorFilter(){const{view:e,layer:t}=this;return e&&t?(0,R.E)({view:e,layer:t}):null}constructor(e){super(e),this.layer=null,this.snappingSource=null,this.rulesTable=null,this._valid=null}initialize(){if(!this.snappingSource||!this.layer)return void(this._valid=!1);const{layer:e,snappingSource:t}=this;if("refresh"in e){const i=e;this.addHandles(i.on("refresh",()=>t.refresh()))}this.loadRules(),this.addHandles([(0,d.wB)(()=>t.updating,e=>t.layerSource.updating=e,d.pc),(0,d.wB)(()=>t.availability,e=>t.layerSource.availability=e,d.pc)])}getFetchCandidatesParameters(e,t,i){var n,r,l,a,s;if(!this.valid)return[];const{layer:u,layerView:d,floorFilter:c,rulesTable:p,subtypeFilter:v}=this,h=(0,C.A)((0,C.A)({distance:i,mode:null!==(n=null===(r=this.view)||void 0===r?void 0:r.type)&&void 0!==n?n:"2d",point:e,coordinateHelper:t.coordinateHelper},{returnEdge:!0,vertexMode:"all"}),{},{filter:d&&"filter"in d?d.filter:null});if(c&&(h.filter=T(h.filter,c)),"not-in-use"!==v.mode&&"all-visible"!==v.mode){if("none-visible"===v.mode)return[];h.filter?h.filter.where=(0,M.mA)(h.filter.where,v.mode):h.filter=new F.A({where:v.filter})}if(!this.attributeRulesEnabled)return[h];const g=t.feature,y="subtype-sublayer"===(null===g||void 0===g||null===(l=g.sourceLayer)||void 0===l?void 0:l.type)?g.sourceLayer.parent:null===g||void 0===g?void 0:g.sourceLayer;if(p&&g&&(0,A.Tu)(null===(a=this.view)||void 0===a?void 0:a.map)&&((0,x.yZ)(u)||(0,x.F2)(u))&&((0,x.yZ)(y)||(0,x.F2)(y))&&null!==(s=this.view.map.utilityNetworks)&&void 0!==s&&s.find(e=>e.isUtilityLayer(y))){var f,m;if("loaded"!==p.loadStatus)return[];const e=[],t=u.layerId,i=null===(f=p.getFeatureSQL(y,g))||void 0===f?void 0:f[t];if(!i)return[];const n=i.anyVertex;let r=i.endVertex;return r&&n&&r===n&&(r=""),r&&e.push((0,C.A)((0,C.A)({},h),{},{returnEdge:!1,vertexMode:"ends",filter:T(h.filter,r)})),n&&e.push((0,C.A)((0,C.A)({},h),{},{returnEdge:null!==(m=(0,o.A)("snapping-include-edges-when-applying-any-vertex-rule"))&&void 0!==m&&m,vertexMode:"all",filter:T(h.filter,n)})),e}return[h]}async loadRules(){this._valid=null;const{layer:e,view:t,attributeRulesEnabled:i}=this;if(i&&e&&t&&(0,A.Tu)(null===t||void 0===t?void 0:t.map)&&((0,x.yZ)(e)||(0,x.F2)(e)))try{var n,r,l,a;await Promise.allSettled(null!==(n=null===(r=t.map.utilityNetworks)||void 0===r?void 0:r.map(e=>e.load()))&&void 0!==n?n:[]);const i=null===(l=t.map.utilityNetworks)||void 0===l?void 0:l.find(t=>t.isUtilityLayer(e));i&&(this.rulesTable=await i.getRulesTable(),await(null===(a=this.rulesTable)||void 0===a?void 0:a.load()))}catch(o){return this._valid=!1,void v.A.getLogger("esri.views.interactive.snapping.FeatureSnappingSourceInfo").error("Failed to load rules table for snapping source",e.title)}this._valid=!0}remove(){this.destroy()}destroy(){var e;null===(e=this.snappingSource)||void 0===e||e.destroy()}};function T(e,t){return null==e?new F.A({where:t}):e.where?new F.A({where:(0,M.mA)(e.where,t)}):new F.A({where:t})}(0,n.Cg)([(0,p.MZ)({constructOnly:!0})],L.prototype,"layer",void 0),(0,n.Cg)([(0,p.MZ)({constructOnly:!0})],L.prototype,"snappingSource",void 0),(0,n.Cg)([(0,p.MZ)({constructOnly:!0})],L.prototype,"view",void 0),(0,n.Cg)([(0,p.MZ)({value:!1})],L.prototype,"attributeRulesEnabled",null),(0,n.Cg)([(0,p.MZ)()],L.prototype,"layerView",null),(0,n.Cg)([(0,p.MZ)()],L.prototype,"rulesTable",void 0),(0,n.Cg)([(0,p.MZ)()],L.prototype,"valid",null),(0,n.Cg)([(0,p.MZ)()],L.prototype,"subtypeFilter",null),(0,n.Cg)([(0,p.MZ)()],L.prototype,"floorFilter",null),(0,n.Cg)([(0,p.MZ)()],L.prototype,"_valid",void 0),L=(0,n.Cg)([(0,h.$)("esri.views.interactive.snapping.FeatureSnappingSourceInfo")],L);var E=i(80794),Z=i(9876),G=i(61751),H=i(78228),z=i(17072);let O=class extends r.A{get updating(){return this._snappingSources.some(e=>{var t;return null==(null===e||void 0===e?void 0:e.valid)||!0===e.valid&&!0===(null===(t=e.snappingSource)||void 0===t?void 0:t.updating)})||this._updatingHandles.updating}constructor(e){super(e),this.options=null,this._domain=1,this._updatingHandles=new S.U,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){const e=(0,s.l)(()=>{var e;return null===(e=this.options)||void 0===e?void 0:e._effectiveFeatureSources},(e,t)=>this._createSourceInfo(e,t));this._snappingSources=e,this.addHandles([(0,a.DQ)(e),(0,d.wB)(()=>{var e;return{rulesEnabled:!(null===(e=this.options)||void 0===e||!e.attributeRulesEnabled),sources:this._snappingSources.filter(l.Ru)}},e=>{let{rulesEnabled:t,sources:i}=e;for(const n of i)n.attributeRulesEnabled=t},d.OH)])}destroy(){this._set("options",null),this._updatingHandles.destroy()}async fetchCandidates(e,t,i,n){if(!(t&this._domain&&null!=this.options&&this.options.effectiveFeatureEnabled))return[];const r=[],l=this._computeScreenSizeDistanceParameters(e,i);for(const u of this._snappingSources){var a,o;if(null===u||void 0===u||!u.valid||null===(a=u.snappingSource)||void 0===a||null===(a=a.layerSource)||void 0===a||!a.enabled||null!==(o=u.layerView)&&void 0!==o&&o.suspended)continue;const t=u.getFetchCandidatesParameters(e,i,l);for(const e of t)r.push(u.snappingSource.fetchCandidates(e,n).then(e=>e.filter(e=>!this._candidateIsExcluded(u.snappingSource,e,i.excludeFeature))))}const s=(await(0,u.nA)(r)).flat();return this._addRightAngleCandidates(s,e,l,i),(0,u.Te)(n),(0,A.xX)(e,s),s}_addRightAngleCandidates(e,t,i,n){var r,l,a,o;const s=null!=n.vertexHandle?null===(r=n.vertexHandle.rightSegment)||void 0===r||null===(r=r.rightVertex)||void 0===r?void 0:r.pos:null!=n.editGeometryOperations&&"polygon"===n.editGeometryOperations.data.type?null===(l=n.editGeometryOperations.data.parts[0])||void 0===l||null===(l=l.getFirstVertex())||void 0===l?void 0:l.pos:null,u=null!=n.vertexHandle?null===(a=n.vertexHandle.leftSegment)||void 0===a||null===(a=a.leftVertex)||void 0===a?void 0:a.pos:null!=n.editGeometryOperations?null===(o=n.editGeometryOperations.data.parts[0])||void 0===o||null===(o=o.getLastVertex())||void 0===o?void 0:o.pos:null,{view:d}=this,c=(0,b.Lp)(s,d,n),p=(0,b.Lp)(u,d,n),v=e.length;for(let h=0;h<v;h++)this._addRightAngleCandidate(e[h],p,t,i,e),this._addRightAngleCandidate(e[h],c,t,i,e)}_addRightAngleCandidate(e,t,i,n,r){if(null==t||!function(e){return(e instanceof Z.z||e instanceof E.X)&&!function(e){let{constraint:{start:t,end:i}}=e;const n=(0,y.s)(t,i),r=(0,g.hG)((0,b.Xz)(t),(0,b.Xz)(i));return n<(0,m.FD)()||r/n<D}(e)}(e))return;const l=e.constraint.closestTo(t),a=(l[0]-i[0])/n.x,o=(l[1]-i[1])/n.y,{start:s,end:u}=e.constraint;if(a*a+o*o<=1){const i=(0,g.hG)((0,b.Xz)(l),(0,b.Xz)(s))>(0,g.hG)((0,b.Xz)(l),(0,b.Xz)(u))?s:u,n=new H.H({targetPoint:(0,b.de)(l),otherVertex:t,otherVertexType:0,previousVertex:i,constraint:new _.FX(t,l),objectId:e.objectId,isDraped:e.isDraped,domain:1});r.push(n)}}_computeScreenSizeDistanceParameters(e,t){let i=null!=this.options?this.options.distance*("touch"===t.pointer?this.options.touchSensitivityMultiplier:1):0;return null==this.view?{x:i,y:i,z:i,distance:i}:"2d"===this.view.type?(i*=this.view.resolution,{x:i,y:i,z:i,distance:i}):this._computeScreenSizeDistanceParameters3D(e,i,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,i,n){const{spatialReference:r}=n;i.renderCoordsHelper.toRenderCoords(e,r,V);const l=i.state.camera.computeScreenPixelSizeAt(V),a=l*i.renderCoordsHelper.unitInMeters,o=a/(0,c.GA)(r),s=a/(0,c.G9)(r),u=t*o,d=t*s,p=(0,z.j)(e,r,w.qt,i),v=p?P(p,e,o,0,0,i,n):0,h=p?P(p,e,0,o,0,i,n):0,g=p?P(p,e,0,0,s,i,n):0;return{x:0===v?0:u/v,y:0===h?0:u/h,z:0===g?0:d/g,distance:l*t}}_candidateIsExcluded(e,t,i){if(null==i)return!1;const n=this._getCandidateObjectId(t);if(null==n)return!1;const r=e.layerSource.layer;return"graphics"===r.type?i.uid===n:i.sourceLayer===r&&!(!i.attributes||!("objectIdField"in r))&&i.attributes[r.objectIdField]===n}_getCandidateObjectId(e){return e instanceof G.w?e.objectId:null}async _createSourceInfo(e,t){const i=e.layer;i.loaded||(await i.load(),(0,u.Te)(t));const{view:n}=this,r=await this._createFeatureSnappingSourceType(e);return(0,u.Te)(t),new L(null==r?{}:{snappingSource:r,view:n,layer:i})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){const{view:t}=this;return null==t||"3d"!==t.type?null:new((await this._getSourceModule("scene")).SceneLayerSnappingSource)({layerSource:e,view:t})}async _createFeatureSnappingSourceFeatureLayer(e){var t;switch(null===(t=e.layer.source)||void 0===t?void 0:t.type){case"feature-layer":case"oriented-imagery":return new((await this._getSourceModule("featureService")).FeatureServiceSnappingSource)({spatialReference:this.spatialReference,view:this.view,layerSource:e});case"memory":case"csv":case"geojson":case"wfs":return"mesh"===e.layer.geometryType?null:new((await this._getSourceModule("featureCollection")).FeatureCollectionSnappingSource)({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new((await this._getSourceModule("graphics")).GraphicsSnappingSource)({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new((await this._getSourceModule("notes")).GraphicsSnappingSource)({getGraphicsLayers:()=>{var t,i;return null!==(t=null===(i=e.layer.sublayers)||void 0===i?void 0:i.toArray())&&void 0!==t?t:[]},spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){const t=this._sourceModules[e];if(null==t.loader){const t=this._loadSourceModule(e),i={module:null,loader:t};this._sourceModules[e]=i;const n=await t,r={module:n,loader:t};return this._sourceModules[e]=r,n}return null==t.module?t.loader:t.module}_loadSourceModule(e){const t=this._updatingHandles;switch(e){case"featureService":return t.addPromise(i.e(1927).then(i.bind(i,51927)));case"featureCollection":return t.addPromise(i.e(7567).then(i.bind(i,77567)));case"graphics":case"notes":return t.addPromise(Promise.all([i.e(8618),i.e(7075),i.e(8683),i.e(2003),i.e(2034),i.e(3778),i.e(9546)]).then(i.bind(i,99546)));case"scene":return t.addPromise(Promise.all([i.e(8105),i.e(2259),i.e(1929)]).then(i.bind(i,91929)))}}get test(){}};function P(e,t,i,n,r,l,a){let{spatialReference:o}=a;const s=(0,y.d)(j,t);s[0]+=i,s[1]+=n,s[2]+=r;const u=(0,z.j)(s,o,w.qt,l);return u?(0,A.Mo)(u,e):1/0}(0,n.Cg)([(0,p.MZ)({constructOnly:!0})],O.prototype,"spatialReference",void 0),(0,n.Cg)([(0,p.MZ)({constructOnly:!0})],O.prototype,"view",void 0),(0,n.Cg)([(0,p.MZ)()],O.prototype,"options",void 0),(0,n.Cg)([(0,p.MZ)({readOnly:!0})],O.prototype,"updating",null),(0,n.Cg)([(0,p.MZ)()],O.prototype,"_snappingSources",void 0),O=(0,n.Cg)([(0,h.$)("esri.views.interactive.snapping.FeatureSnappingEngine")],O);const V=(0,f.vt)(),j=(0,f.vt)(),D=1e-4},43927:(e,t,i)=>{i.d(t,{L:()=>s,l:()=>p});var n=i(98773),r=i(19276),l=i(54901),a=i(50346),o=i(68134);function s(e,t,i){var n,l;const a=null!==(n=null===i||void 0===i||null===(l=i.createCollection)||void 0===l?void 0:l.call(i))&&void 0!==n?n:new r.A,s=null!==i&&void 0!==i&&i.recycleItems?new u:null,d=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(null===e||void 0===e||!e.length)return;const i=a.splice(t,e.length);s?s.processRemoved(e):i.forEach(c)},p=function(e){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(null===e||void 0===e||!e.length)return;const n=[];for(const r of e){const e=null===s||void 0===s?void 0:s.use(r);if(e)n.push(e);else{const e=t(r);null!==s&&void 0!==s&&s.register(r,e),n.push(e)}}a.addMany(n,i)},v=(0,o.on)(e,"after-splice",e=>{let{added:t,start:i,removed:n}=e;d(n,i),p(t,i)},{sync:!0,onListenerRemove:e=>d(e.items),onListenerAdd:e=>p(e.items)});return a.addHandles(v),a}class u{constructor(){this._originalToMapped=new Map,this._removedItemCandidates=new Set,this._garbageCollectionQueued=!1}processRemoved(e){if(null===e||void 0===e||!e.length)return;const{_removedItemCandidates:t}=this;for(const n of e){var i;(null===(i=this._getItem(n))||void 0===i?void 0:i.markRemoved())&&(t.add(n),this._queueGarbageCollection())}}use(e){const t=this._getItem(e);return t&&(t.removed=!1),null===t||void 0===t?void 0:t.item}register(e,t){this._originalToMapped.set(e,new d(t))}_getItem(e){return this._originalToMapped.get(e)}_queueGarbageCollection(){this._garbageCollectionQueued||(this._garbageCollectionQueued=!0,queueMicrotask(()=>this._garbageCollectCandidates()))}_garbageCollectCandidates(){this._garbageCollectionQueued=!1;const{_removedItemCandidates:e}=this,t=Array.from(e);e.clear(),t.forEach(e=>this._garbageCollectIfRemoved(e))}_garbageCollectIfRemoved(e){const{_originalToMapped:t}=this,i=this._getItem(e);(null===i||void 0===i?void 0:i.removed)&&(c(i.item),t.delete(e))}}class d{constructor(e){this.item=e,this.removed=!1}markRemoved(){return this.removed=!0,!0}}function c(e){"object"==typeof e&&e&&("destroy"in e&&"function"==typeof e.destroy?e.destroy():(0,l.wt)(e))}function p(e,t,i){const o=new r.A,u=s(e,e=>(0,n.UT)(async i=>{const n=await t(e,i);if((0,a.G4)(i))throw c(n),(0,a.NK)();return n}),i),d=()=>null,p=async e=>{const t=await e.promise,i=u.indexOf(e);i<0||o.splice(i,1,t)};o.addMany(u.items.map(d));for(const n of u)(0,a.QZ)(p(n));const v=u.on("after-splice",e=>{let{added:t,start:i,deleteCount:n}=e;const r=o.splice(i,n);for(const l of r)c(l);if(null!==t&&void 0!==t&&t.length){o.addMany(t.map(d),i);for(const e of t)(0,a.QZ)(p(e))}});return o.addHandles([(0,l.DQ)(u),v]),o}}}]);
//# sourceMappingURL=2843.4c328b6b.chunk.js.map