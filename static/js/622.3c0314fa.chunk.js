"use strict";(self.webpackChunkmmsp_land_hl=self.webpackChunkmmsp_land_hl||[]).push([[622],{2260:(e,t,i)=>{i.d(t,{n:()=>c});var r,n,s,a,o=i(57528),l=i(86955);function c(e,t){t.spherical?e.vertex.code.add((0,l.H)(r||(r=(0,o.A)(["vec3 getLocalUp(in vec3 pos, in vec3 origin) {\nreturn normalize(pos + origin);\n}"])))):e.vertex.code.add((0,l.H)(n||(n=(0,o.A)(["vec3 getLocalUp(in vec3 pos, in vec3 origin) {\nreturn vec3(0.0, 0.0, 1.0);\n}"])))),t.spherical?e.vertex.code.add((0,l.H)(s||(s=(0,o.A)(["mat3 getTBNMatrix(in vec3 n) {\nvec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));\nvec3 b = normalize(cross(n, t));\nreturn mat3(t, b, n);\n}"])))):e.vertex.code.add((0,l.H)(a||(a=(0,o.A)(["mat3 getTBNMatrix(in vec3 n) {\nvec3 t = vec3(1.0, 0.0, 0.0);\nvec3 b = normalize(cross(n, t));\nreturn mat3(t, b, n);\n}"]))))}},15263:(e,t,i)=>{i.d(t,{W:()=>L,b:()=>I});var r,n,s,a,o,l,c,h,d,u,p,v=i(57528),f=i(34981),m=i(26917),g=i(59395),_=i(90080),y=i(87236),x=i(50819),b=i(43557),w=i(2260),S=i(51740),C=i(94192),P=i(23445),A=i(82884),R=i(80883),T=i(3799),M=i(58350),D=i(21390),z=i(86955),O=i(91911),V=i(2687),E=i(75569);function I(e){const t=new V.N5,{vertex:i,fragment:I,varyings:L}=t,{output:U,draped:F,receiveShadows:k}=e;(0,T.NB)(i,e),t.include(g.d),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2");const G=new M.E("waterColor",e=>e.color);if(L.add("vpos","vec3",{invariant:!0}),i.uniforms.add(G),(0,f.RN)(U)){if(F)return i.main.add((0,z.H)(r||(r=(0,v.A)(["\n      if (waterColor.a < ",") {\n        // Discard this vertex\n        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n        return;\n      }\n\n      vpos = position;\n      gl_Position = transformPosition(proj, view, vpos);"])),z.H.float(E.Q))),I.uniforms.add(G),I.main.add((0,z.H)(n||(n=(0,v.A)(["fragColor = waterColor;"])))),t;t.include(w.n,e),L.add("vuv","vec2"),L.add("vnormal","vec3"),L.add("vtbnMatrix","mat3"),i.main.add((0,z.H)(s||(s=(0,v.A)(["\n      if (waterColor.a < ",") {\n        // Discard this vertex\n        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n        return;\n      }\n\n      vuv = uv0;\n      vpos = position;\n\n      vnormal = getLocalUp(vpos, localOrigin);\n      vtbnMatrix = getTBNMatrix(vnormal);\n      forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);\n\n      gl_Position = transformPosition(proj, view, vpos);\n      forwardLinearDepthToReadShadowMap();"])),z.H.float(E.Q)))}switch(t.include(S.Bz,e),t.include(C.Z,e),U){case 0:case 1:t.include(x.W,{pbrMode:0,lightingSphericalHarmonicsOrder:2}),t.include(A.V),t.include(P.E,e),I.include(m.HQ,e),t.include(O.z,e),I.include(R.a),(0,T.yu)(I,e),(0,b.Gc)(I),(0,b.O4)(I),I.uniforms.add(G,new D.m("timeElapsed",e=>{let{timeElapsed:t}=e;return t}),i.uniforms.get("view"),i.uniforms.get("localOrigin")).main.add((0,z.H)(a||(a=(0,v.A)(["\n        discardBySlice(vpos);\n        discardByTerrainDepth();\n        vec3 localUp = vnormal;\n        // the created normal is in tangent space\n        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\n\n        // we rotate the normal according to the tangent-bitangent-normal-Matrix\n        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);\n        vec3 v = -normalize(vpos - cameraPosition);\n        float shadow = ",";\n        vec4 vPosView = view * vec4(vpos, 1.0);\n        vec4 final = vec4(getSeaColor(n, v, mainLightDirection, waterColor.rgb, mainLightIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);\n\n        fragColor = delinearizeGamma(final);\n        outputColorHighlightOID(fragColor, vpos, final.rgb);"])),k?(0,z.H)(o||(o=(0,v.A)(["1.0 - readShadowMap(vpos, linearDepth)"]))):"1.0"));break;case 3:t.include(w.n,e),t.include(A.V,e),I.include(m.HQ,e),L.add("vuv","vec2"),i.main.add((0,z.H)(l||(l=(0,v.A)(["\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vuv = uv0;\n        vpos = position;\n\n        gl_Position = transformPosition(proj, view, vpos);"])),z.H.float(E.Q))),I.uniforms.add(new D.m("timeElapsed",e=>{let{timeElapsed:t}=e;return t})).main.add((0,z.H)(c||(c=(0,v.A)(["discardBySlice(vpos);\nvec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\ntangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);\nfragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);"]))));break;case 9:t.include(y.Q,e),i.main.add((0,z.H)(h||(h=(0,v.A)(["\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vpos = position;\n        gl_Position = transformPosition(proj, view, vpos);"])),z.H.float(E.Q))),I.include(m.HQ,e),I.main.add((0,z.H)(d||(d=(0,v.A)(["discardBySlice(vpos);\ncalculateOcclusionAndOutputHighlight();"]))));break;case 10:t.include(_.g,e),i.main.add((0,z.H)(u||(u=(0,v.A)(["\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vpos = position;\n        gl_Position = transformPosition(proj, view, vpos);\n        forwardObjectAndLayerIdColor();"])),z.H.float(E.Q))),I.include(m.HQ,e),I.main.add((0,z.H)(p||(p=(0,v.A)(["discardBySlice(vpos);\noutputObjectAndLayerIdColor();"]))))}return t}const L=Object.freeze(Object.defineProperty({__proto__:null,build:I},Symbol.toStringTag,{value:"Module"}))},22956:(e,t,i)=>{i.d(t,{projectMeshVertexPositions:()=>o});var r=i(45308),n=i(14894),s=i(80963),a=i(53848);function o(e,t){const i=(0,a.UR)(e,n.A.absolute);if(!i)return null;let o=i.position;return(0,s.aI)(e.spatialReference,t)||(o=new Float64Array(i.position.length),(0,r.projectBuffer)(i.position,e.spatialReference,0,o,t,0))?o:null}},23445:(e,t,i)=>{i.d(t,{E:()=>j});var r,n=i(57528),s=i(32925),a=i(94759),o=i(42953),l=i(48353),c=i(65058),h=i(28450),d=i(23148),u=i(86955),p=i(23687),v=i(4653);function f(e,t){if(!t.screenSpaceReflections)return;const i=e.fragment;i.include(c.E),i.uniforms.add(new h.E("nearFar",e=>e.camera.nearFar),new v.x("depthMap",e=>{var t;return null===(t=e.depth)||void 0===t?void 0:t.attachment}),new p.F("proj",e=>e.camera.projectionMatrix),new d.U("invResolutionHeight",e=>1/e.camera.height),new p.F("reprojectionMatrix",e=>e.ssr.reprojectionMatrix)).code.add((0,u.H)(r||(r=(0,n.A)(["\n  vec2 reprojectionCoordinate(vec3 projectionCoordinate)\n  {\n    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);\n    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);\n    reprojectedCoord.xy /= reprojectedCoord.w;\n    return reprojectedCoord.xy * 0.5 + 0.5;\n  }\n\n  const int maxSteps = ",";\n\n  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)\n  {\n    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);\n    projectedCoord.xy /= projectedCoord.w;\n    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;\n    return projectedCoord;\n  }\n\n  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)\n  {\n    vec3 viewPos = startPosition;\n    vec3 viewPosEnd = startPosition;\n\n    // Project the start position to the screen\n    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);\n    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space\n    float k0 = 1.0/ projectedCoordStart.w;\n\n    // advance the position in the direction of the reflection\n    viewPos += dir;\n\n    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);\n\n    // Project the advanced position to the screen\n    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);\n    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space\n    float k1 = 1.0/ projectedCoordEnd.w;\n\n    // calculate the reflection direction in the screen space\n    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);\n    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);\n\n    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);\n\n    float projectedCoordDirLength = length(projectedCoordDir);\n    float maxSt = float(maxSteps);\n\n    // normalize the projection direction depending on maximum steps\n    // this determines how blocky the reflection looks\n    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);\n\n    // Normalize the homogeneous camera space coordinates\n    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);\n    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);\n\n    // initialize the variables for ray marching\n    vec2 P = projectedCoordStart.xy;\n    vec3 Q = Q0;\n    float k = k0;\n    float rayStartZ = -startPosition.z; // estimated ray start depth value\n    float rayEndZ = -startPosition.z;   // estimated ray end depth value\n    float prevEstimateZ = -startPosition.z;\n    float rayDiffZ = 0.0;\n    float dDepth;\n    float depth;\n    float rayDiffZOld = 0.0;\n\n    // early outs\n    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)\n      return vec3(P, 0.0);\n    float dDepthBefore = 0.0;\n\n    for(int i = 0; i < maxSteps-1; i++)\n    {\n      depth = -linearDepthFromTexture(depthMap, P); // get linear depth from the depth buffer\n\n      // estimate depth of the marching ray\n      rayStartZ = prevEstimateZ;\n      dDepth = -rayStartZ - depth;\n      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));\n      rayDiffZ = rayEndZ- rayStartZ;\n      prevEstimateZ = rayEndZ;\n\n      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )\n      {\n        return vec3(P, 0.);\n      }\n\n      // If we detect a hit - return the intersection point, two conditions:\n      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth\n      //  - if difference between dDepth and rayDiffZOld is not too large\n      //  - if difference between dDepth and 0.025/abs(k) is not too large\n      //  - if the sampled depth is not behind far plane or in front of near plane\n\n      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)\n      {\n        float weight = dDepth / (dDepth - dDepthBefore);\n        vec2 Pf = mix(P - dP, P, 1.0 - weight);\n        if (abs(Pf.y - projectedCoordStart.y) > invResolutionHeight) {\n          return vec3(Pf, depth);\n        }\n        else {\n          return vec3(P, depth);\n        }\n      }\n\n      // continue with ray marching\n      P = clamp(P + dP, vec2(0.0), vec2(0.999));\n      Q.z += dQ.z;\n      k += dk;\n      rayDiffZOld = rayDiffZ;\n      dDepthBefore = dDepth;\n    }\n    return vec3(P, 0.0);\n  }\n  "])),t.highStepCount?"150":"75"))}var m,g=i(9392),_=i(14556),y=i(317),x=i(43557);function b(e){e.fragment.uniforms.add(new d.U("cloudAbsorption",e=>e.clouds.absorption),new d.U("cloudCoverage",e=>e.clouds.coverage)).code.add((0,u.H)(m||(m=(0,n.A)(["vec4 lookupCloudsFromTextureArray(sampler2DArray cubeMap, vec3 rayDir) {\nint faceIndex;\nvec2 uv;\nif(rayDir.z <= 0.0) {\nfloat hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudCoverage), abs(dot(rayDir, vec3(0, 0, 1))));\nfloat shading = clamp(1.0 - cloudAbsorption, 0.6, 1.0) * (1.0 - hazeFactor);\nfloat totalTransmittance = hazeFactor;\nreturn vec4(shading, totalTransmittance, shading, totalTransmittance);\n}\nif (abs(rayDir.x) >= abs(rayDir.y) && abs(rayDir.x) >= abs(rayDir.z)) {\nif(rayDir.x > 0.0) {\nfaceIndex = 0;\nuv = rayDir.yz / rayDir.x;\nuv = vec2(-uv.x, uv.y);\n} else {\nfaceIndex = 1;\nuv = rayDir.yz / rayDir.x;\nuv = vec2(-uv.x, -uv.y);\n}\n} else if (abs(rayDir.y) >= abs(rayDir.x) && abs(rayDir.y) >= abs(rayDir.z)) {\nif(rayDir.y > 0.0) {\nfaceIndex = 2;\nuv = rayDir.xz / rayDir.y;\n} else {\nfaceIndex = 3;\nuv = rayDir.xz / rayDir.y;\nuv = vec2(uv.x, -uv.y);\n}\n} else {\nif(rayDir.y < 0.0) {\nfaceIndex = 4;\nuv = rayDir.xy / rayDir.z;\nuv = vec2(uv.x, -uv.y);\n} else {\nfaceIndex = 5;\nuv = rayDir.xy / rayDir.z;\nuv = vec2(uv.x, -uv.y);\n}\n}\nuv = 0.5 * (uv + 1.0);\nif(faceIndex != 5) {\nuv.y = uv.y - 0.5;\n}\nuv.y = uv.y * 2.0;\nvec4 s = texture(cubeMap, vec3(uv, float(faceIndex)));\nreturn s;\n}"]))))}var w,S,C,P,A,R,T=i(67582),M=i(84115),D=i(87003);class z extends D.n{constructor(e,t){super(e,"sampler2DArray",0,(i,r)=>i.bindTexture(e,t(r)))}}function O(e){const t=e.fragment;t.constants.add("radiusCloudsSquared","float",V).code.add((0,u.H)(w||(w=(0,n.A)(["vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos) {\nfloat B = 2.0 * dot(cameraPosition, dir);\nfloat C = dot(cameraPosition, cameraPosition) - radiusCloudsSquared;\nfloat det = B * B - 4.0 * C;\nfloat pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));\nreturn (cameraPosition + dir * pointIntDist) - spherePos;\n}"])))),t.uniforms.add(new d.U("radiusCurvatureCorrection",e=>{let{clouds:t}=e;return t.parallax.radiusCurvatureCorrection})).code.add((0,u.H)(S||(S=(0,n.A)(["vec3 correctForPlanetCurvature(vec3 dir) {\ndir.z = dir.z * (1.0 - radiusCurvatureCorrection) + radiusCurvatureCorrection;\nreturn dir;\n}"])))),t.code.add((0,u.H)(C||(C=(0,n.A)(["vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec) {\nreturn (rotMat * vec4(inVec, 0.0)).xyz;\n}"])))),(0,x.Gc)(t),(0,x.O4)(t);const i=(0,g.fA)(.28,.175,.035);t.constants.add("RIM_COLOR","vec3",i);t.code.add((0,u.H)(P||(P=(0,n.A)(["\n    vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds) {\n      float upDotLight = dot(cameraPosition, mainLightDirection);\n      float dirDotLight = max(dot(worldSpaceRay, mainLightDirection), 0.0);\n      float sunsetTransition = clamp(pow(max(upDotLight, 0.0), ","), 0.0, 1.0);\n\n      // Base color of the clouds that depends on lighting of the sun and sky\n      vec3 ambientLight = calculateAmbientIrradiance(cameraPosition,  0.0);\n      vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));\n      vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));\n\n      // Rim light around the edge of the clouds simulating scattering of the direct lun light\n      float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);\n      float rimLightIntensity = 0.5 + 0.5 * pow(max(upDotLight, 0.0), 0.35);\n      vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, ",")) * scatteringMod;\n\n      // Brighten the clouds around the sun at the sunsets\n      float additionalLight = "," * pow(dirDotLight, ",") * (1. - pow(sunsetTransition, ",")) ;\n\n      return vec3(baseCloudColor * (1.0 + additionalLight) + directSunScattering);\n    }\n  "])),u.H.float(.3),u.H.float(140),u.H.float(.2),u.H.float(10),u.H.float(.3))),e.include(b),t.uniforms.add(new T.o("readChannelsRG",e=>0===e.clouds.readChannels),new z("cubeMap",e=>{var t;return null===(t=e.clouds.data)||void 0===t||null===(t=t.cubeMap)||void 0===t?void 0:t.colorTexture})).code.add((0,u.H)(A||(A=(0,n.A)(["vec4 sampleCloud(vec3 rayDir, bool readOtherChannel) {\nvec4 s = lookupCloudsFromTextureArray(cubeMap, rayDir);\nbool readRG = readChannelsRG ^^ readOtherChannel;\ns = readRG ? vec4(vec3(s.r), s.g) : vec4(vec3(s.b), s.a);\nreturn length(s) == 0.0 ? vec4(s.rgb, 1.0) : s;\n}"])))),t.uniforms.add(new M.d("anchorPoint",e=>e.clouds.parallax.anchorPoint),new M.d("anchorPointNew",e=>e.clouds.parallaxNew.anchorPoint),new p.F("rotationClouds",e=>e.clouds.parallax.transform),new p.F("rotationCloudsNew",e=>e.clouds.parallaxNew.transform),new d.U("cloudsOpacity",e=>e.clouds.opacity),new d.U("fadeFactor",e=>e.clouds.fadeFactor),new T.o("crossFade",e=>3===e.clouds.fadeState)).code.add((0,u.H)(R||(R=(0,n.A)(["vec4 renderClouds(vec3 worldRay, vec3 cameraPosition) {\nvec3 intersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPoint);\nvec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationClouds, normalize(intersectionPoint));\nvec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);\nvec4 cloudData = sampleCloud(worldRayRotatedCorrected, crossFade);\nvec3 cameraPositionN = normalize(cameraPosition);\nvec4 cloudColor = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);\nif(crossFade) {\nintersectionPoint = intersectWithCloudLayer(worldRay, cameraPosition, anchorPointNew);\nworldRayRotated = rotateDirectionToAnchorPoint(rotationCloudsNew, normalize(intersectionPoint));\nworldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);\ncloudData = sampleCloud(worldRayRotatedCorrected, false);\nvec4 cloudColorNew = vec4(calculateCloudColor(cameraPositionN, worldRay, cloudData), cloudData.a);\ncloudColor = mix(cloudColor, cloudColorNew, fadeFactor);\n}\nfloat totalTransmittance = length(cloudColor.rgb) == 0.0 ?\n1.0 :\nclamp(cloudColor.a * cloudsOpacity + (1.0 - cloudsOpacity), 0.0 , 1.0);\nreturn vec4(cloudColor.rgb, totalTransmittance);\n}"]))))}const V=(_.$O.radius+y.k9)**2;var E,I,L,U,F,k,G,B,H=i(61337);function j(e,t){const i=e.fragment;i.include(o.f,t),i.include(a.C),i.include(s.v),t.cloudReflections&&e.include(O),e.include(f,t),i.include(H.b,t),i.constants.add("fresnelSky","vec3",[.02,1,15]),i.constants.add("fresnelMaterial","vec2",[.02,.1]),i.constants.add("roughness","float",.015),i.constants.add("foamIntensityExternal","float",1.7),i.constants.add("ssrIntensity","float",.65),i.constants.add("ssrHeightFadeStart","float",l.O),i.constants.add("ssrHeightFadeEnd","float",l.b),i.constants.add("waterDiffusion","float",.92),i.constants.add("waterSeaColorMod","float",.8),i.constants.add("correctionViewingPowerFactor","float",.4),i.constants.add("skyZenitColor","vec3",[.52,.68,.9]),i.constants.add("skyColor","vec3",[.67,.79,.9]),i.constants.add("cloudFresnelModifier","vec2",[1.2,.01]),i.code.add((0,u.H)(E||(E=(0,n.A)(["PBRShadingWater shadingInfo;\nvec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {\nfloat exponent = pow((1.0 - cosTheta), fresnelSky[2]);\nreturn mix(zenit, horizon, exponent);\n}"])))),i.uniforms.add(new d.U("lightingSpecularStrength",e=>e.lighting.mainLight.specularStrength),new d.U("lightingEnvironmentStrength",e=>e.lighting.mainLight.environmentStrength)),i.code.add((0,u.H)(I||(I=(0,n.A)(["vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {\nfloat reflectionHit = 0.0;\nfloat reflectionHitDiffused = 0.0;\nvec3 seaWaterColor = linearizeGamma(color);\nvec3 h = normalize(l + v);\nshadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);\nshadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);\nshadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);\nshadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);\nshadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);\nfloat upDotV = max(dot(localUp,v), 0.0);\nvec3 skyHorizon = linearizeGamma(skyColor);\nvec3 skyZenit = linearizeGamma(skyZenitColor);\nvec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );\nfloat upDotL = max(dot(localUp,l),0.0);\nfloat daytimeMod = 0.1 + upDotL * 0.9;\nskyColor *= daytimeMod;\nfloat shadowModifier = clamp(shadow, 0.8, 1.0);\nvec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);\nvec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;\nvec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;\nvec3 specular = vec3(0.0);\nif(upDotV > 0.0 && upDotL > 0.0) {\nvec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);\nvec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;\nfloat NdotL = clamp(dot(n, l), 0.0, 1.0);\nspecular = lightingSpecularStrength * NdotL * incidentLight * specularSun;\n}\nvec3 foam = vec3(0.0);\nif(upDotV > 0.0) {\nfoam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);\n}\nfloat correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);\nvec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);\nvec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));"])))),t.cloudReflections&&i.uniforms.add(new d.U("cloudsOpacity",e=>e.clouds.opacity)).code.add((0,u.H)(L||(L=(0,n.A)(["vec4 cloudsColor = renderClouds(reflectedWorld, position);\ncloudsColor.a = 1.0 - cloudsColor.a;\ncloudsColor = pow(cloudsColor, vec4(GAMMA));\ncloudsColor *= clamp(fresnelModifier.y * cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * cloudsOpacity;"])))),t.screenSpaceReflections?i.uniforms.add(new p.F("view",e=>e.camera.viewMatrix),new v.x("lastFrameColorTexture",e=>{var t;return null===(t=e.ssr.lastFrameColor)||void 0===t?void 0:t.getTexture()}),new d.U("fadeFactorSSR",e=>e.ssr.fadeFactor)).code.add((0,u.H)(U||(U=(0,n.A)(["vec3 viewDir = normalize(viewPosition);\nvec4 viewNormalVectorCoordinate = view * vec4(n, 0.0);\nvec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);\nvec4 viewUp = view * vec4(localUp, 0.0);\nvec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);\nvec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));\nvec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);\nvec3 reflectedColor = vec3(0.0);\nif (hitCoordinate.z > 0.0)\n{\nvec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);\nvec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));\nfloat heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);\nreflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactorSSR;\nreflectionHitDiffused = waterDiffusion * reflectionHit;\nreflectedColor = linearizeGamma(texture(lastFrameColorTexture, reprojectedCoordinate).xyz) *\nreflectionHitDiffused * fresnelModifier.y * ssrIntensity;\n}\nfloat seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);\nvec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +\nreflSea * seaColorMod + specular + foam);"])))):i.code.add((0,u.H)(F||(F=(0,n.A)(["vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);"])))),t.cloudReflections?t.screenSpaceReflections?i.code.add((0,u.H)(k||(k=(0,n.A)(["return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;\n}"])))):i.code.add((0,u.H)(G||(G=(0,n.A)(["return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;\n}"])))):i.code.add((0,u.H)(B||(B=(0,n.A)(["return waterRenderedColor;\n}"]))))}},25672:(e,t,i)=>{i.d(t,{Tz:()=>l,aT:()=>a,fA:()=>o});var r=i(15941),n=i(20664),s=(i(9392),i(75002),i(39246));function a(e,t,i,r,n){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:2;const a=1/(Math.abs(i)+Math.abs(r)+Math.abs(n)),o=i*a,l=r*a,h=n<=0?(o>=0?1:-1)*(1-Math.abs(l)):o,d=n<=0?(l>=0?1:-1)*(1-Math.abs(o)):l,u=t*s;e[u]=c(h),e[u+1]=c(d)}function o(e){const t=e.length/3,i=(0,s.O)(2*t);let r=0;for(let n=0;n<t;++n)a(i,n,e[r++],e[r++],e[r++]);return i}function l(e,t,i){const r=i*(arguments.length>3&&void 0!==arguments[3]?arguments[3]:2),s=h(t[r]),a=h(t[r+1]),o=1-Math.abs(s)-Math.abs(a);return e[2]=o,o<0?(e[0]=(s>=0?1:-1)*(1-Math.abs(a)),e[1]=(a>=0?1:-1)*(1-Math.abs(s))):(e[0]=s,e[1]=a),(0,n.n)(e,e)}function c(e){return(0,r.qE)(Math.round(32767*e),-32767,32767)}function h(e){return(0,r.qE)(e/32767,-1,1)}},32925:(e,t,i)=>{i.d(t,{v:()=>l,z:()=>o});var r,n,s=i(57528),a=i(86955);function o(e){e.code.add((0,a.H)(r||(r=(0,s.A)(["float normals2FoamIntensity(vec3 n, float waveStrength){\nfloat normalizationFactor =  max(0.015, waveStrength);\nreturn max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);\n}"]))))}function l(e){e.code.add((0,a.H)(n||(n=(0,s.A)(["vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){\nreturn foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;\n}"]))))}},34026:(e,t,i)=>{i.d(t,{N:()=>f,b:()=>v});var r,n,s=i(57528),a=i(26917),o=i(59395),l=i(54478),c=i(3799),h=i(58350),d=i(86955),u=i(91911),p=i(2687);function v(e){const t=new p.N5,{vertex:i,fragment:v,varyings:f}=t;return t.fragment.include(a.HQ,e),t.include(o.d),t.include(l.c,e),t.include(u.z,e),(0,c.NB)(i,e),t.attributes.add("position","vec3"),f.add("vpos","vec3",{invariant:!0}),i.main.add((0,d.H)(r||(r=(0,s.A)(["vpos = position;\nforwardNormalizedVertexColor();\ngl_Position = transformPosition(proj, view, vpos);"])))),e.hasVertexColors||v.uniforms.add(new h.E("constantColor",e=>e.color)),v.main.add((0,d.H)(n||(n=(0,s.A)(["\n    discardBySlice(vpos);\n    vec4 color = ",";\n    outputColorHighlightOID(color, vpos, color.rgb);\n  "])),e.hasVertexColors?"vColor":"constantColor")),t}const f=Object.freeze(Object.defineProperty({__proto__:null,build:v},Symbol.toStringTag,{value:"Module"}))},39246:(e,t,i)=>{i.d(t,{O:()=>n});var r=i(78393);function n(e){return e<=r.y9?new Array(e):new Int16Array(e)}},39345:(e,t,i)=>{function r(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}i.d(t,{y:()=>r})},41921:(e,t,i)=>{i.d(t,{make:()=>nl});var r=i(76460),n=i(89379),s=i(81806),a=i(53084),o=i(31633),l=i(38983),c=i(86300),h=i(44680),d=i(34761),u=i(13191),p=i(20664),v=i(9392),f=i(5809),m=i(42294),g=i(44815),_=i(38496),y=i(45136),x=i(59883),b=i(86486),w=i(67425),S=i(99057),C=i(24947),P=i(36423),A=i(76797),R=i(65215),T=i(10294),M=i(50468),D=i(17345);function z(e,t,i){const r=(t.length>0?t[0]:e.length/3)-1,n=(0,T.S)(e,r,i);if(2!==n){e=e.slice();for(let t=0;t<e.length;t+=3)e[t+n]=e[t+2]}return(0,l.e)(e,t,3)}function O(e){const t=[["position",new M.n(e.attributeData.position,e.indices,3,!0)]],i=(0,_.EH)(e.indices.length);return null!=e.attributeData.colorFeature?t.push(["colorFeatureAttribute",new M.n([e.attributeData.colorFeature],i,1,!0)]):e.attributeData.color&&t.push(["color",new M.n(e.attributeData.color,i,4,!0)]),e.attributeData.uvMapSpace&&t.push(["uvMapSpace",new M.n(e.attributeData.uvMapSpace,e.indices,4,!0)]),e.attributeData.boundingRect&&t.push(["boundingRect",new M.n(e.attributeData.boundingRect,e.indices,9,!0)]),new D.V(e.material,t,e.mapPositions,0,e.attributeData.olidColor)}function V(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const i=[["position",new M.n(e.attributeData.position,e.indices,3,!0)],["uv0",new M.n(e.attributeData.uv0,e.indices,2,!0)]];return new D.V(e.material,i,e.mapPositions,0,t)}function E(e){switch(e.type){case"extent":if(e instanceof A.A)return R.A.fromExtent(e);break;case"polygon":return e}return null}class I{constructor(e,t,i){this.renderData=e,this.layerViewUid=t,this.graphicUid=i,this.outGeometries=new Array}}var L=i(7342),U=i(51990),F=i(22955),k=i(80935),G=i(45308),B=i(99785),H=i(3509);function j(e,t,i,r){const n=(0,B.oR)(e.rings,!!e.hasZ&&"on-the-ground"!==r.mode,1,e.spatialReference),s=(0,g.jh)(n.position.length),a=(0,w.au)(n.position,e.spatialReference,0,s,0,n.position,0,n.position.length/3,t,i,r),o=null!=a;return new K(n.position,s,Z(n.polygons,n.position,s),W(n.outlines,n.position,s),o,a)}function N(e,t){const i=(0,B.oR)(e.rings,!1,1),r=(0,G.projectBuffer)(i.position,e.spatialReference,0,i.position,t,0);for(let n=2;n<i.position.length;n+=3)i.position[n]=H.bi;return{position:i.position,polygons:Z(i.polygons,i.position),outlines:W(i.outlines,i.position),projectionSuccess:r}}function W(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return e.filter(e=>{let{count:t}=e;return t>1}).map(e=>{let{index:r,count:n}=e;const s=3*r,a=3*n;return null!=i?new Y(r,n,(0,g.l5)(t,s,a),(0,g.l5)(i,s,a)):new q(r,n,(0,g.l5)(t,s,a))})}function Z(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const r=new Array;for(const{index:n,count:s,holeIndices:a,pathLengths:o}of e){if(s<=1)continue;const e=3*n,l=3*s,c=a.map(e=>e-n),h=null!=i?new Q(n,s,(0,g.l5)(t,3*n,3*s),(0,g.l5)(i,e,l),c,o):new X(n,s,(0,g.l5)(t,3*n,3*s),c,o);r.push(h)}return r}class q{constructor(e,t,i){this.index=e,this.count=t,this.position=i}}class Y extends q{constructor(e,t,i,r){super(e,t,i),this.mapPositions=r}}class Q extends Y{constructor(e,t,i,r,n,s){super(e,t,i,r),this.holeIndices=n,this.pathLengths=s}}class X extends q{constructor(e,t,i,r,n){super(e,t,i),this.holeIndices=r,this.pathLengths=n}}class K{constructor(e,t,i,r,n,s){this.position=e,this.mapPositions=t,this.polygons=i,this.outlines=r,this.projectionSuccess=n,this.sampledElevation=s}}var $=i(9612),J=i(25672),ee=i(37046),te=i(65131);const ie=["polygon","extent"];class re extends C.UF{constructor(e,t,i,r){super(e,t,i,r,function(e){var t,i;return 1===(null!==(t=null===(i=e.material)||void 0===i||null===(i=i.color)||void 0===i?void 0:i.a)&&void 0!==t?t:0)}(t)),this.ensureDrapedStatus(!1)}async doLoad(){var e,t;const i=this.symbolLayer,r=null===i||void 0===i?void 0:i.material,s=null===(e=this.symbolLayer.material)||void 0===e||null===(e=e.color)||void 0===e?void 0:e.a,a=this.needsDrivenTransparentPass||null!=s&&1!==s,o=null===r||void 0===r?void 0:r.emissive,l=!this._hasDrivenColorOrOpacity&&(null==s||0===s),c={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:v.Un,diffuse:v.Un,opacity:l?0:1,layerOpacity:this._getLayerOpacity(),drivenOpacity:a,hasSymbolColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:i.castShadows,emissiveStrength:null!==(t=null===o||void 0===o?void 0:o.strength)&&void 0!==t?t:0,emissiveSource:1,offsetTransparentBackfaces:!0,normalType:1},h=new te.$U(c,this._context),d=new te.$U((0,n.A)((0,n.A)({},c),{},{cullFace:2}),this._context);this._materials[0]=h,this._materials[1]=d,this._updateTransparentDepedentMaterialParameters()}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,ie,this.symbolLayer.type))return null;const i=this._getDrivenUInt8ColorWithNaNSupport(e.renderingInfo,this._materialColor,!1);(0,U.K_)(i,i);const r=this.createElevationContextForGraphic(t);return this._createAs3DShape(t,e.renderingInfo,i,r,t.uid)}layerOpacityChanged(e,t){var i,r;const n=this._getLayerOpacity();null!==(i=this._materials[0])&&void 0!==i&&i.setParameters({layerOpacity:n}),null!==(r=this._materials[1])&&void 0!==r&&r.setParameters({layerOpacity:n}),this._updateTransparentDepedentMaterialParameters(),null===e||void 0===e||e.forEach(e=>{var i;return null===(i=t(e))||void 0===i?void 0:i.layerOpacityChanged(n,this._context.isAsync)})}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,w.Kf)}slicePlaneEnabledChanged(e,t){var i,r;return null!==(i=this._materials[0])&&void 0!==i&&i.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),null!==(r=this._materials[1])&&void 0!==r&&r.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),null!==e&&void 0!==e&&e.forEach(e=>{const i=t(e);null!=i&&i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){var e,t;const i={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return null!==(e=this._materials[0])&&void 0!==e&&e.setParameters(i),null!==(t=this._materials[1])&&void 0!==t&&t.setParameters(i),!0}_getExtrusionSize(e){var t;let i;return i=e.size&&this._drivenProperties.size?null!==(t=(0,b.kg)(e.size,2))&&void 0!==t?t:0:this._getSymbolSize(),i/=this._context.renderCoordsHelper.unitInMeters,i}applyRendererDiff(e,t){return this._drivenPropertiesChanged(t)?0:1}async queryForSnapping(e,t,i,r){var n;const s=this._getExtrusionSize(i)*this._context.renderCoordsHelper.unitInMeters/(0,o.G9)(t),{objectId:l,target:c}=e,h=(0,a.o8)(c);switch(h.z=(null!==(n=h.z)&&void 0!==n?n:0)+s,e.type){case"edge":{var d,u;const{start:t,end:i}=e,r=(0,a.o8)(t),n=(0,a.o8)(i);return r.z=(null!==(d=r.z)&&void 0!==d?d:0)+s,n.z=(null!==(u=n.z)&&void 0!==u?u:0)+s,[(0,x.P)(l,h,1/0,r,n)]}case"vertex":return[(0,x.k)(l,h,1/0),(0,x.P)(l,c,1/0,c,h)];default:return[]}}_getSymbolSize(){var e;return null!==(e=this.symbolLayer.size)&&void 0!==e?e:1}_createAs3DShape(e,t,i,r,n){const s=E(e.geometry);if(null==s)return null;if(0===s.rings.length||!s.rings.some(e=>e.length>0))return this._logGeometryValidationWarnings(s.rings,"rings","ExtrudeSymbol3DLayer"),null;const a=j(s,this._context.elevationProvider,this._context.renderCoordsHelper,r);this._logGeometryCreationWarnings(a,s.rings,"rings","ExtrudeSymbol3DLayer");const o=(0,P.W$)(s);if(null==o)return null;const x=new Array,b=new Array,C=(0,m.vt)(),A=(0,u.vt)(),R=(0,v.vt)(),T=1===this._context.renderCoordsHelper.viewingMode;T||this._context.renderCoordsHelper.worldUpAtPosition(null,R),(0,f.l)(s.spatialReference,[o.x,o.y,0],A,this._context.renderCoordsHelper.spatialReference);const M=(0,u.vt)();(0,d.B8)(M,A);const D=(0,h.vt)();(0,c.Ge)(D,M);const{polygons:z,mapPositions:O,position:V}=a,I=new Map,U=this._materials[0];for(const c of z){const e=c.count;if(this._context.clippingExtent&&((0,m.vY)(c.mapPositions,C),!(0,m.KG)(C,this._context.clippingExtent)))continue;const r=(0,l.e)(c.mapPositions,c.holeIndices,3);if(0===r.length)continue;const s=r.length,a=6*e,o=(0,_.my)(a+s),h=(0,_.my)(s),d=(0,g.jh)(3*a),u=(0,g.jh)(3*a),p=(0,g.jh)(3*a),v=(0,g.jh)(a);se(V,O,r,c,d,p,u,v,o,h,this._getExtrusionSize(t),R,T),(0,y.t)(d,d,M);const f=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:n,layerViewUid:this._context.layerViewUid}),w=new Ae(d,p,(0,J.fA)(u),v),S=ne(U,o,o.length-h.length,w,i,f),P=e,D=e,z=2*c.count,E=new Re(P,D,z,s/3);me(S,E,A),I.set(S,E),x.push(S,ne(this._materials[1],h,0,w,i,f)),b.push(w.heights)}if(0===x.length)return null;const G=new ee.B({geometries:x,layerViewUid:this._context.layerViewUid,graphicUid:n,isElevationSource:!0});G.transformation=A;const B=(0,L.Cc)(this.symbolLayer,{opacity:this._getLayerOpacity()}),H=B?new S.H(this._materials[0],B,this._context.slicePlaneEnabled):null,N=new S.Y(this,G,null,(e,t,i,r,n)=>function(e,t,i,r,n,s,a){const o=e.stageObject,l=o.geometries,c=l.length,h="absolute-height"!==t.mode;let v=0;const f=o.transformation,m=(0,d.Qw)((0,u.vt)(),f);for(let d=0;d<c;d+=2){const e=l[d];if(!(0,$.p)(e))continue;const t=e.getMutableAttribute("position").data,c=s[d/2],u=new k.aY(e.mapPositions),g=t.length/3;let _=!1,y=0;{let e=0;for(let s=0;s<g;s++){fe[0]=t[e],fe[1]=t[e+1],fe[2]=t[e+2],r(u,ye),h&&(y+=ye.sampledElevation),F.b.TESTS_DISABLE_OPTIMIZATIONS?((0,p.j)(ge,u.array[u.offset],u.array[u.offset+1],ye.z+c[e/3]),null!=i&&n.toRenderCoords(ge,i,ge),(0,p.t)(ge,ge,m)):((0,p.j)(ge,t[e],t[e+1],t[e+2]),(0,p.t)(ge,ge,f),n.setAltitude(ge,ye.z+c[e/3]),(0,p.t)(ge,ge,m)),t[e]=ge[0],t[e+1]=ge[1],t[e+2]=ge[2];const s=we/n.unitInMeters;(Math.abs(fe[0]-t[e])>=s||Math.abs(fe[1]-t[e+1])>=s||Math.abs(fe[2]-t[e+2])>=s)&&(_=!0),u.offset+=3,e+=3}}if(_){const t=a.get(e);t&&me(e,t,f),o.geometryVertexAttributeUpdated(l[d],"normalCompressed"),e.invalidateBoundingInfo(),o.geometryVertexAttributeUpdated(l[d],"position"),l[d+1].invalidateBoundingInfo(),o.geometryVertexAttributeUpdated(l[d+1],"position")}v+=y/g}return v/c}(e,t,i,r,n,b,I),r,H);return N.alignedSampledElevation=a.sampledElevation,N.needsElevationUpdates=(0,w.Kf)(r.mode),N}get _materialColor(){var e;return null===(e=this.symbolLayer.material)||void 0===e?void 0:e.color}_updateTransparentDepedentMaterialParameters(){const e=this._materials[0];e&&e.setParameters({cullFace:e.transparent?0:2})}}function ne(e,t,i,r,n,s){const a=(0,_.EH)(t.length),o=[["position",new M.n(r.positions,t,3,!0)],["normalCompressed",new M.n(r.normals,t,2,!0)],["symbolColor",new M.n(n,a,4,!0)]];return new D.V(e,o,r.elevation,0,s,i)}function se(e,t,i,r,n,s,a,o,l,c,h,d,u){const v=i.length/3;let f=2*r.count;!function(e,t,i,r,n,s,a,o,l,c,h,d,u,v,f,m,g){(0,p.d)(_e,m),null!==l&&void 0!==l||(l=[]),null!==c&&void 0!==c||(c=[]),null!==h&&void 0!==h||(h=[]);const _=f>0?1:-1;let y=3*i,x=0,b=3*x,w=r,S=3*w;for(let A=0;A<r;++A){const i=e[y],r=e[y+1],n=e[y+2];g&&(_e[0]=i,_e[1]=r,_e[2]=n,(0,p.n)(_e,_e)),o[b+0]=i,o[b+1]=r,o[b+2]=n;const s=t[y+0],a=t[y+1],d=t[y+2];l[b+0]=s,l[b+1]=a,l[b+2]=d,c[b+0]=-_*_e[0],c[b+1]=-_*_e[1],c[b+2]=-_*_e[2],h[x]=0,o[S+0]=i+f*_e[0],o[S+1]=r+f*_e[1],o[S+2]=n+f*_e[2],l[S+0]=s,l[S+1]=a,l[S+2]=d,h[w]=f,b+=3,S+=3,y+=3,x+=1,w+=1}y=3*s,b=0,S=3*v;const C=f<0?be:xe,P=f<0?xe:be;for(let p=0;p<a;++p)u[b]=n[y+C[0]],u[b+1]=n[y+C[1]],u[b+2]=n[y+C[2]],d[S]=n[y+P[0]]+r,d[S+1]=n[y+P[1]]+r,d[S+2]=n[y+P[2]]+r,b+=3,S+=3,y+=3}(e,t,r.index,r.count,i,0,v,n,s,a,o,l,c,f,h,d,u);let m=0,g=2*r.count;f=0;const _=r.pathLengths[0];le(n,s,o,a,m,_,r.count,g,l,f,h),g+=4*_,f+=2*_,m+=_;for(let p=1;p<r.pathLengths.length;++p){const e=r.pathLengths[p];le(n,s,o,a,m,e,r.count,g,l,f,h),g+=4*e,f+=2*e,m+=e}}function ae(e,t,i,r,n,s,a){r[s]=r[a],a*=3,e[s*=3]=e[a],e[s+1]=e[a+1],e[s+2]=e[a+2],t[s]=t[a],t[s+1]=t[a+1],t[s+2]=t[a+2],i[s]=n[0],i[s+1]=n[1],i[s+2]=n[2]}const oe=(0,v.vt)();function le(e,t,i,r,n,s,a,o,l,c,h){null!==t&&void 0!==t||(t=[]),null!==i&&void 0!==i||(i=[]),null!==r&&void 0!==r||(r=[]);let d=n,u=n+1,p=n+a,v=n+a+1,f=o,m=o+1,g=o+2*s,_=o+2*s+1;h<0&&(d=n+a+1,v=n);let y=3*c;for(let x=0;x<s;++x)x===s-1&&(u=n,h>0?v=n+a:d=n+a),ve(e,d,u,p,oe),ae(e,t,r,i,oe,f,d),ae(e,t,r,i,oe,m,u),ae(e,t,r,i,oe,g,p),ae(e,t,r,i,oe,_,v),l[y]=f,l[y+1]=g,l[y+2]=_,l[y+3]=f,l[y+4]=_,l[y+5]=m,y+=6,d++,u++,p++,v++,f+=2,m+=2,g+=2,_+=2}const ce=(0,v.vt)(),he=(0,v.vt)(),de=(0,v.vt)(),ue=(0,v.vt)(),pe=(0,v.vt)();function ve(e,t,i,r,n){t*=3,i*=3,r*=3,(0,p.j)(ce,e[t++],e[t++],e[t++]),(0,p.j)(he,e[i++],e[i++],e[i++]),(0,p.j)(de,e[r++],e[r++],e[r++]),(0,p.e)(ue,he,ce),(0,p.e)(pe,de,ce),(0,p.i)(n,pe,ue),(0,p.n)(n,n)}const fe=(0,v.vt)();function me(e,t,i){const r=e.getMutableAttribute("position"),n=e.getMutableAttribute("normalCompressed").data,s=r.data,a=e.attributes.get("position").indices,{topVertexStart:o,topVertexCount:l,topFaceStart:c,topFaceCount:h}=t,d=c+h,u=o+l,v=Se,f=Ce,m=Pe,g=_e,_=ge;(0,p.j)(_,0,0,0);const y=(e,t)=>{const r=3*e;(0,p.j)(t,s[r+0],s[r+1],s[r+2]),(0,p.t)(t,t,i)};for(let x=c;x<d;++x){const e=3*x;y(a[e+0],v[0]),y(a[e+1],v[1]),y(a[e+2],v[2]),(0,p.a)(f,v[1],v[0]),(0,p.a)(m,v[2],v[0]),(0,p.i)(g,f,m),(0,p.g)(_,_,g)}(0,p.n)(_,_);for(let p=o;p<u;++p){const e=_[0],t=_[1],i=_[2];(0,J.aT)(n,p,e,t,i)}}const ge=(0,v.vt)(),_e=(0,v.vt)(),ye=new w.Uk,xe=[0,2,1],be=[0,1,2],we=.01,Se=[(0,v.vt)(),(0,v.vt)(),(0,v.vt)()],Ce=(0,v.vt)(),Pe=(0,v.vt)();class Ae{constructor(e,t,i,r){this.positions=e,this.elevation=t,this.normals=i,this.heights=r}}class Re{constructor(e,t,i,r){this.topVertexStart=e,this.topVertexCount=t,this.topFaceStart=i,this.topFaceCount=r}}var Te=i(69539),Me=i(98773),De=i(50076),ze=i(30726),Oe=i(50346),Ve=i(76931),Ee=i(88685),Ie=i(90534),Le=i(72745),Ue=i(55855),Fe=i(64232),ke=i(1900),Ge=i(81456),Be=i(401),He=i(97763),je=i(29632),Ne=i(76589),We=i(93223),Ze=i(94439),qe=i(38865),Ye=i(29308);const Qe=.42,Xe=.32;function Ke(e,t){if(e)switch(t){case"bright":{const t=(e[0]+e[1]+e[2])/3;return[t*Xe+(1-Xe),t*Xe+(1-Xe),t*Xe+(1-Xe),e[3]*Xe]}case"dark":return[e[0]*Qe,e[1]*Qe,e[2]*Qe,e[3]*Qe]}}var $e=i(2413);class Je{constructor(e,t,i,r){this.graphics3DSymbolLayer=e,this.renderGeometries=t,this.boundingBox=i,this._drapeSourceRenderer=r,this.type="draped",this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(e){this.stage=e.stage}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}setVisibility(e){if(null!=this.stage&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,0);if(e||this._addedToStage){for(const e of this.renderGeometries)e.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,1)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,2),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,v.vt)();return(0,p.j)(e,0,0,0)}getBoundingBoxObjectSpace(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,m.vt)();return(0,m.Ie)(e)}addObjectState(e){0===e.stateType&&(this.renderGeometries.forEach(t=>{const i=t.geometry.allocateIdAndHighlight(e.highlightName);e.addRenderGeometry(t,i,this)}),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,8))}removeObjectState(e){this.renderGeometries.forEach(t=>e.removeByObject(t))}updateHighlights(e){}removeRenderGeometryObjectState(e,t){0===t.channel&&(e.geometry.removeHighlight(t),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries([e],8))}computeAttachmentOrigin(e){for(const t of this.renderGeometries)t.geometry.computeAttachmentOrigin(it)&&(e.draped.origin[0]+=it[0],e.draped.origin[1]+=it[1],e.draped.num++)}async getProjectedBoundingBox(e,t,i,r,n){(0,m.Ie)(n);for(let a=0;a<this.renderGeometries.length;a++){const t=this.renderGeometries[a];this._getRenderGeometryProjectedBoundingRect(t,e,et,i),(0,m.DC)(n,et)}if(t){let e;(0,m.gX)(n,it);const i=(0,P.vY)(n,t.service.spatialReference,t);try{e=await t.service.queryElevation(it[0],it[1],r,i,"ground")}catch(s){}null!=e&&(n[2]=Math.min(n[2],e),n[5]=Math.max(n[5],e))}return n}_getRenderGeometryProjectedBoundingRect(e,t,i,r){if(this.boundingBox)(0,m.hZ)(tt,this.boundingBox);else{const t=e.boundingSphere,i=t[3];tt[0]=t[0]-i,tt[1]=t[1]-i,tt[2]=t[2]-i,tt[3]=t[0]+i,tt[4]=t[1]+i,tt[5]=t[2]+i}return t(tt,0,2),this.calculateRelativeScreenBounds&&r.push({location:(0,m.gX)(tt),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),(0,m.ES)(tt,i)}}const et=(0,$e.vt)(),tt=(0,m.vt)(),it=(0,v.vt)();var rt,nt=i(82250),st=i(88265),at=i(63048),ot=i(72900),lt=i(25530),ct=i(72017),ht=i(442),dt=i(76632),ut=i(84248);const pt=(0,v.fA)(0,0,1),vt=[ot.Q_*ot.CN,ot.Q_*ot.CN];class ft extends C.UF{getCachedSize(){return{size:this._getIconSize()}}constructor(e,t,i,r){super(e,t,i,r,function(e){var t,i;return 1===(null!==(t=null===(i=e.material)||void 0===i||null===(i=i.color)||void 0===i?void 0:i.a)&&void 0!==t?t:0)&&null!=xt(e)}(t)),this._cimData=null,this._overrideHelperClass=null,this._arcadeInfo=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._textureHandle=null,this._patchTask=null,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}async doLoad(e){this._validateOrThrow();const t=this._prepareMaterialParameters(),i=this._getPrimitive();if(null!=i)this._prepareResourcesPrimitive(t,i);else{const i=(0,Ze.N7)(this.symbolLayer),r=gt(i);null!=r?await this._prepareResourcesCIM(t,JSON.parse(r),e):await this._prepareResourcesHref(t,i,e)}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=(0,P.Hj)(this._getIconSize());if(e)throw new De.A("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,t=Math.round(null!=e.size?(0,Ve.Lz)(e.size):16);return this._drivenProperties.size?Math.max(t,64):t}_generateTextureCIM(e,t){const i=this._overrideHelperClass;let r=this._cimData;if(i&&r&&r.symbol||this.logger.error("Can't create texture, CIM data is undefined"),r.primitiveOverrides){r=(0,a.o8)(r);const n=r.primitiveOverrides;i.evaluateOverrides(n,e,this._arcadeInfo.geometryType,null,null,t.layer.fieldsIndex),i.applyOverrides(r.symbol,n)}const n=(0,Ee.Wm)(JSON.stringify(r));let s=this._cimSymbolTextures.get(n);if(s)return s;const o=this._context.sharedResources.cimSymbolRasterizer,l=this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:null;l&&i.applyDictionaryTextOverrides(r.symbol,e,l,null);const c=null!=this._cimScaleFactorOrFunction?(0,He.s4)(this._cimScaleFactorOrFunction,e):1;1!==c&&r.symbol&&(0,je.Km)(r.symbol,c,!0);const h=Be.wp.getEnvelope(r,null,o.resourceManager);if(null!==h&&void 0!==h&&h.width&&h.height){var d,u;const e=h.x+h.width/2,t=h.y+h.height/2,i=o.rasterize({type:"cim",data:r},h.width,h.height,e,t,1,"esriGeometryPoint",0,null,this._context.graphicsCoreOwner.view.state.rasterPixelRatio),n=new We.Q({x:-h.x/h.width-.5,y:(h.height+h.y)/h.height-.5});this._cimMaterialParametersInfo.anchorPosition=_t("relative",n),s=new dt.g(i,{width:null!==(d=null===i||void 0===i?void 0:i.width)&&void 0!==d?d:1,height:null!==(u=null===i||void 0===i?void 0:i.height)&&void 0!==u?u:1,reloadable:!0})}else s=new dt.g(new ImageData(1,1),{width:1,height:1,reloadable:!0});return this._cimSymbolTextures.set(n,s),this._context.stage.addTexture(s),s}_prepareMaterialParameters(){const e={anchorPosition:_t(this.symbolLayer.anchor,this.symbolLayer.anchorPosition),rotation:this.symbolLayer.angle},t=this.symbol;(function(e){return e&&"point-3d"===e.type&&e.hasVisibleVerticalOffset()})(t)&&(e.verticalOffset=new lt.yc(t.verticalOffset)),this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this.view.screenSizePerspective.parameters),(0!==e.rotation||this._drivenProperties.rotation)&&(e.hasRotation=!0);const i=!!(0,s.A)("enable-feature:non-occluded-hud");return e.occlusionTest=!i,e.occludedFragmentFade=i,e.horizonCullingEnabled=i&&this._context.spherical,e.hasSlicePlane=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,t){const i=this._getOutlineSize();if(mt(t)&&0===i)throw new Error("Nothing to render");if(this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,null!=this._context.sharedResources.textures){const i=this._context.sharedResources.textures.fromData("".concat(t,"-icon"),()=>(0,ot.sZ)(t));this._textureHandle=i,e.textureId=i.texture.id}e.textureIsSignedDistanceField=!0,e.sampleSignedDistanceFieldTexelCenter=(0,ot.ny)(t),e.distanceFieldBoundingBox=ot.PY;const r=this._getIconSize();this._size=[r,r],this._symbolTextureRatio=1/ot.CN,this._createMaterial(e)}async _prepareResourcesHref(e,t,i){this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const r=this._getIconSize(),n=r*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(null!=this._context.sharedResources.textures){const s=await(0,Me.Ke)(this._context.sharedResources.textures.fromUrl(t,n,{signal:i}));if(!1===s.ok)throw(0,Oe.QP)(s.error),new De.A("graphics3diconsymbollayer:request-failed","Failed to load (Request for icon resource failed: ".concat(t,")"));this._textureHandle=s.value;const a=s.value.texture;this._size=yt(a,r),e.textureId=a.id}this._createMaterial(e)}async _prepareResourcesCIM(e,t,r){const{OverrideHelper:n}=await Promise.resolve().then(i.bind(i,48988));if(this._overrideHelperClass=n,this._cimData=t,!this._context.sharedResources.cimSymbolRasterizer){const e=(await Promise.resolve().then(i.bind(i,6840))).CIMSymbolRasterizer;(0,Oe.Te)(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new e(this._context.renderCoordsHelper.spatialReference))}const s=this._context.sharedResources.cimSymbolRasterizer,a=[],o=t,l=null===o||void 0===o?void 0:o.symbol;Be.wp.fetchResources(l,s.resourceManager,a,r),Be.wp.fetchFonts(l,s.resourceManager,a);const c=this._context.layer.fields?this._context.layer.fields.map(e=>e.toJSON()):[],h=this._context.renderCoordsHelper.spatialReference;if(this._arcadeInfo={spatialReference:h,fields:c,geometryType:"esriGeometryPoint"},null!==o&&void 0!==o&&o.primitiveOverrides&&a.push(n.createRenderExpressions(o.primitiveOverrides,this._arcadeInfo)),a.length>0&&(await Promise.all(a),(0,Oe.Te)(r)),this._context.renderer&&"dictionary"===this._context.renderer.type&&this._context.renderer.scaleExpression){const e=this._context.renderer;if(e.scaleExpression){const t=e.scaleExpression,r=await(0,Ge.Ad)(t,this._context.layer.spatialReference),{default:n}=await Promise.resolve().then(i.bind(i,52629)),s=new ke.A(c);this._cimScaleFactorOrFunction=(e,t,i)=>{const a=n(r,e,{$view:i},"esriGeometryPoint",s,t);return null!==a?a:1}}}(0,Oe.Te)(r),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return xt(this.symbolLayer)}_getOutlineSize(){var e;let t=0;const i=this.symbolLayer;return null!=(null===(e=i.outline)||void 0===e?void 0:e.size)?Math.max((0,Ve.Lz)(i.outline.size),0):(t=mt(this._getPrimitive())?1.5:0,Math.max(t,0))}_getOutlineColor(){var e;const t=this._getLayerOpacity(),i=this.symbolLayer,r=null===i||void 0===i||null===(e=i.outline)||void 0===e?void 0:e.color;if(null!=r){const e=Te.A.toUnitRGB(r),i=r.a*t;return[e[0],e[1],e[2],i]}return[0,0,0,0]}_getFillColor(){if(mt(this._getPrimitive()))return qe.r4;const e=null==this._getPrimitive(),t=this._materialColor;return this._getCombinedOpacityAndColor(t,{hasIntrinsicColor:e})}get _materialColor(){var e;return null===(e=this.symbolLayer.material)||void 0===e?void 0:e.color}get _fastVisualVariableFallbackColor(){const e=this._materialColor;return null==e?null==this._getPrimitive()?Ue.Un:Ue.uY:Te.A.toUnitRGBA(e)}_getFallbackSize(){const e=this._getIconSize(),{symbolLayer:{size:t}}=this;return(null!=t?Math.round((0,Ve.Lz)(t)):16)/e}_createMaterial(e){var t;const i=this._context.spherical;if(this._cimData){var r;this._fastUpdates=null;let t=e.textureId?this._cimSymbolMaterials.get(e.textureId):null;return t||(t=new ut.R(e,i),this._cimSymbolMaterials.set(null!==(r=e.textureId)&&void 0!==r?r:0,t)),t}this._fastUpdates=(0,at.s_)(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates&&(e=(0,n.A)((0,n.A)({},e),this._fastUpdates.materialParameters)),this._materials[0]=new ut.R(e,i),e.isFocused=!1;const s=null===(t=this.view.map)||void 0===t?void 0:t.focusAreas.style;return e.color=Ke(e.color,s),e.outlineColor=Ke(e.outlineColor,s),this._materials[1]=new ut.R(e,i),this._materials[0]}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,draped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._patchTask=(0,ze.DC)(this._patchTask),this._materials.length=0,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(e=>this._context.stage.removeTexture(e)),this._cimSymbolTextures.clear(),this._textureHandle=(0,ze.Gz)(this._textureHandle)}_getScaleFactor(e,t){let{size:i}=e;if(!this._drivenProperties.size)return 1;if(null==i)return this._getFallbackSize();const[r,n,s]=i;return"symbol-value"===r?1:"number"==typeof r&&isFinite(r)?(0,Ve.Lz)(r)/t:"number"==typeof s&&isFinite(s)?(0,Ve.Lz)(s)/t:1}_getDrivenRotation(e){var t;return this._drivenProperties.rotation&&null!==(t=e.heading)&&void 0!==t?t:0}createGraphics3DGraphic(e){var t,i,r;const s=e.graphic;if(!this._validateGeometry(s.geometry))return null;const a=(0,st.ZX)(s.geometry);if(null==a)return this.logger.warn("unsupported geometry type for text symbol: ".concat(s.geometry.type)),null;let o,l=[0,0];const c=null===(t=null===(i=this.view.focusAreasView)||void 0===i?void 0:i.containsGeometry(a))||void 0===t||t;if(this._cimData){if(!this._cimData.symbol)return null;const t=this._generateTextureCIM(s,e),i=(0,n.A)({textureId:t.id,isFocused:c},this._cimMaterialParametersInfo);o=this._createMaterial(i);const r=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;l=[t.parameters.width/r,t.parameters.height/r]}else l=this._size,o=c?this._materials[0]:this._materials[1];if(null==a)return this.logger.warn("unsupported geometry type for icon symbol: ".concat(s.geometry.type)),null;const h=e.renderingInfo,d=this._getDrivenUInt8Color(h,this._materialColor,null==this._getPrimitive()),u=this._getDrivenRotation(h);let p=1;if(null===(r=this._fastUpdates)||void 0===r||!r.visualVariables.size){const e=l[0]>l[1]?l[0]:l[1];p=this._getScaleFactor(h,e)}p*=this._symbolTextureRatio;const v=(0,Le.fA)(l[0]*p,l[1]*p),f=this.createElevationContextForGraphic(s);return this.ensureDrapedStatus("on-the-ground"===f.mode)&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(s,a,o,d,u,v):this._createAs3DShape(s,a,o,d,u,v,f,s.uid)}layerOpacityChanged(){const e=this._getFillColor(),t=this._getOutlineColor();this._forEachMaterial(i=>{i.setParameters({color:e}),i.setParameters({outlineColor:t})})}layerScreenSizePerspectiveChanged(){const e=this._context.screenSizePerspectiveEnabled&&!this.draped?this.view.screenSizePerspective.parameters:null;this._forEachMaterial(t=>{t.setParameters({screenSizePerspective:e})})}updateGeometry(e,t){const i=e.geometry;if(this.draped||!i||!this._validateGeometry(i))return!1;const{elevationContext:r,stageObject:n}=t;if(r.mode!==this.getGeometryElevationMode(i))return!1;const s=(0,st.ZX)(i);if(!s)return!1;r.updateFeatureExpressionFeature(e,this._context.layer);const a=(0,st.hS)(n,this._context,s,r);if(null==a)return!1;const o=(0,st.R$)(this._context,s);return n.geometries[0].localOrigin===o&&(t.alignedSampledElevation=a,(0,st.d2)(t,s,this._context.elevationProvider),!0)}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=(0,w.I2)(ft.elevationModeChangeTypes,i,r);if(1!==n)return n;const s=(0,w.nu)(r)||"absolute-height"===r;return this.updateGraphics3DGraphicElevationInfo(e,t,()=>s)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(e=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return null!=this._getPrimitive()}applyRendererDiff(e,t){for(const r in e.diff){var i;if("visualVariables"!==r)return 0;if(!(0,at.J_)(this._fastUpdates,t,this._fastVisualVariableConvertOptions()))return 0;null===(i=this._materials[0])||void 0===i||i.setParameters(this._fastUpdates.materialParameters)}return 2}get needsUpdateFocus(){return!0}prepareSymbolLayerPatch(e){var t;if(null!==(t=this._patchTask)&&void 0!==t&&t.abort(),"partial"!==e.diff.type)return;const i=e.diff.diff;this._preparePatchResource(e,i),this._preparePatchRotation(e,i)}_preparePatchResource(e,t){var i;if(!t.resource||"partial"!==t.resource.type)return;const r=t.resource.diff;if("complete"!==(null===r||void 0===r||null===(i=r.href)||void 0===i?void 0:i.type))return;const n=r.href.newValue,{textures:s}=this._context.sharedResources;if(null==n||null==s||null!=gt(n))return;const a=this._getIconSize(),o=a*this._context.graphicsCoreOwner.view.state.pixelRatio;e.symbolLayerStatePatches.push(()=>{this._patchTask=(0,ze.DC)(this._patchTask),this._patchTask=(0,Me.UT)(e=>this._context.schedule(async(e,t)=>{const i=await(0,Me.Ke)(s.fromUrl(n,o,{signal:t}));(0,Oe.Te)(t);const r=!i.ok;if(r&&(0,Oe.QP)(i.error),this._textureHandle=(0,ze.Gz)(this._textureHandle),this._patchTask=null,r){this._forEachMaterial(e=>{e.visible=!1,e.setParameters({textureId:null})});const e="Failed to load (Request for icon resource failed: ".concat(n,")");return void this.logger.error(new De.A("graphics3diconsymbollayer:request-failed",e))}this._textureHandle=i.value;const l=i.value.texture;this._size=yt(l,a),this._forEachMaterial(e=>{e.setParameters({textureId:l.id}),e.visible=!0})},e))}),delete r.href}_preparePatchRotation(e,t){var i;if(!t.angle||"complete"!==t.angle.type)return;const r=null!==(i=t.angle.newValue)&&void 0!==i?i:0,n=0!==r||this._drivenProperties.rotation;e.symbolLayerStatePatches.push(()=>{this._forEachMaterial(e=>e.setParameters({rotation:r,hasRotation:n}))}),delete t.angle}_defaultElevationInfoNoZ(){return bt}_createAs3DShape(e,t,i,r,n,s,a,o){const l=this.getFastUpdateAttrValues(e),c=this._context.layerViewUid,h=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:o,layerViewUid:c}),d=(0,ct.DJ)(i,{normal:pt,color:r,rotation:n,size:s,centerOffsetAndDistance:wt,featureAttribute:l,olidColor:h}),u=(0,st.SZ)(this._context,t,d,a,o);if(null==u)return null;const p=new S.Y(this,u.object,null,Ye.G8,a);return p.alignedSampledElevation=u.sampledElevation,p.needsElevationUpdates=(0,w.nu)(a.mode)||"absolute-height"===a.mode,p.getScreenSize=this._createScreenSizeGetter(s,l),p.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(p.getScreenSize(),1,e),(0,st.d2)(p,t,this._context.elevationProvider),p}_createAsOverlay(e,t,i,r,n,s){i.renderPriority=this._renderPriority;const a=(0,v.vt)();(0,Fe.g)(t,a,this._context.overlaySR),a[2]=H.bi;const o=this._context.clippingExtent;if(null!=o&&!(0,m.Uc)(o,a))return null;const l=this.getFastUpdateAttrValues(e),c=e.uid,h=this._context.layerViewUid,d=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:c,layerViewUid:h}),u=(0,ct.DJ)(i,{normal:pt,position:a,color:r,rotation:n,size:s,featureAttribute:l,olidColor:d}),p=new ht.$(u,{layerViewUid:h,graphicUid:c}),f=new Je(this,[p],null,this._context.drapeSourceRenderer);return f.getScreenSize=this._createScreenSizeGetter(s,l),f.calculateRelativeScreenBounds=e=>i.calculateRelativeScreenBounds(f.getScreenSize(),1,e),f}_createScreenSizeGetter(e,t){var i=this;const r=this._outlineSize+2;if(this._fastUpdates&&t){const n=e[0]/this._symbolTextureRatio,s=e[1]/this._symbolTextureRatio;return function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Le.vt)();const[a,o]=(0,at.VC)(St,i._fastUpdates.materialParameters,t);return e[0]=a*n+r,e[1]=o*s+r,e}}const n=e[0]/this._symbolTextureRatio+r,s=e[1]/this._symbolTextureRatio+r;return function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Le.vt)();return e[0]=n,e[1]=s,e}}_fastVisualVariableConvertOptions(){const e=Math.max(this._size[0],this._size[1]),t=(0,v.fA)(e,e,e),i=(0,Ve.PN)(1),r=e*i,n=(0,v.fA)(r,r,r),s=this._getFallbackSize();return new at.wI({supports:{size:!0,color:!0,rotation:!0,opacity:!1},modelSize:t,symbolSize:n,unitInMeters:i,fallbackColor:this._fastVisualVariableFallbackColor,fallbackSize:(0,v.fA)(s,s,s)})}_forEachMaterial(e){this._materials.forEach(e),this._cimSymbolMaterials.forEach(e)}test(){return(0,n.A)((0,n.A)({},super.test()),{},{material:this._materials[0]})}}function mt(e){return null!=e&&("cross"===e||"x"===e)}function gt(e){const t=(0,Ie.r$)(e);return"application/json"===(null===t||void 0===t?void 0:t.mediaType)?t.data:void 0}function _t(e,t){return"relative"===e?(0,Le.fA)((t.x||0)+.5,.5-(t.y||0)):e in nt.Zd?nt.Zd[e]:nt.Zd.center}function yt(e,t){var i,r;let{parameters:n}=e;const s=(null!==(i=n.width)&&void 0!==i?i:1)/(null!==(r=n.height)&&void 0!==r?r:1);return s>1?[t,Math.round(t/s)]:[Math.round(t*s),t]}function xt(e){var t,i,r;return null!==(t=e.resource)&&void 0!==t&&t.href?null:null!==(i=null===(r=e.resource)||void 0===r?void 0:r.primitive)&&void 0!==i?i:Ne.r}(rt=ft).PRIMITIVE_SIZE=vt,rt.elevationModeChangeTypes={definedChanged:1,staysOnTheGround:0,onTheGroundChanged:2};const bt={mode:"relative-to-ground",offset:0},wt=(0,Ue.fA)(0,0,0,1),St=(0,v.vt)();var Ct=i(43047);function Pt(e){switch(e){case"butt":return 0;case"square":return 1;case"round":return 2;default:return null}}function At(e){return"diamond"===e?"kite":e}var Rt=i(70667),Tt=i(29889),Mt=i(62984),Dt=i(34981),zt=i(59696),Ot=i(45463),Vt=i(93684),Et=i(52757),It=i(48549),Lt=i(16506),Ut=i(59246),Ft=i(60322),kt=i(96643),Gt=i(88849),Bt=i(57162);class Ht extends Ut.w{constructor(e,t){super(e,t,new Lt.$(Gt.L,()=>i.e(6419).then(i.bind(i,66419))),jt(t).locations)}_makePipelineState(e,t){const{output:i,oitPass:r,space:n,hasOccludees:s}=e;return(0,Bt.Ey)({blending:(0,Dt.RN)(i)?(0,Ft.Yf)(r):null,depthTest:0===n?null:{func:(0,Ft.K_)(r)},depthWrite:(0,Ft.z5)(e),drawBuffers:(0,Ut.L)(i,(0,Ft.m6)(r,i)),colorWrite:Bt.kn,stencilWrite:s?kt.v0:null,stencilTest:s?t?kt.a9:kt.qh:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(e){return e.occluder?(this._occluderPipelineTransparent=(0,Bt.Ey)({blending:Bt.T8,depthTest:kt.sf,depthWrite:null,colorWrite:Bt.kn,stencilWrite:null,stencilTest:kt.mK}),this._occluderPipelineOpaque=(0,Bt.Ey)({blending:Bt.T8,depthTest:kt.sf,depthWrite:null,colorWrite:Bt.kn,stencilWrite:kt.r8,stencilTest:kt.I$}),this._occluderPipelineMaskWrite=(0,Bt.Ey)({blending:null,depthTest:kt.m,depthWrite:null,colorWrite:null,stencilWrite:kt.v0,stencilTest:kt.a9})):this._occluderPipelineTransparent=this._occluderPipelineOpaque=this._occluderPipelineMaskWrite=null,this._occludeePipelineState=this._makePipelineState(e,!0),this._makePipelineState(e,!1)}getPipeline(e,t){var i,r,n;return e?this._occludeePipelineState:11===t?null!==(i=this._occluderPipelineTransparent)&&void 0!==i?i:super.getPipeline():10===t?null!==(r=this._occluderPipelineOpaque)&&void 0!==r?r:super.getPipeline():null!==(n=this._occluderPipelineMaskWrite)&&void 0!==n?n:super.getPipeline()}}function jt(e){const t=(0,It.BP)().vec3f("position").vec4f16("previousDelta").vec2f16("uv0");return e.hasVVColor?t.f32("colorFeatureAttribute"):t.vec4u8("color",{glNormalized:!0}),e.hasVVOpacity&&t.f32("opacityFeatureAttribute"),e.hasVVSize?t.f32("sizeFeatureAttribute"):t.f16("size"),e.worldSpace&&t.vec3f16("normal"),t.freeze()}var Nt=i(6326),Wt=i(6485),Zt=i(92656);class qt extends Zt.E{constructor(e){super(),this.spherical=e,this.space=1,this.anchor=0,this.occluder=!1,this.writeDepth=!1,this.hideOnShortSegments=!1,this.hasCap=!1,this.hasTip=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.hasVVOpacity=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasScreenSizePerspective=!1,this.textureCoordinateType=0,this.emissionSource=0,this.discardInvisibleFragments=!0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.hasSliceTranslatedView=!0,this.olidColorInstanced=!1,this.overlayEnabled=!1,this.snowCover=!1}get draped(){return 0===this.space}get worldSpace(){return 2===this.space}}(0,Nt.Cg)([(0,Wt.W)({count:3})],qt.prototype,"space",void 0),(0,Nt.Cg)([(0,Wt.W)({count:2})],qt.prototype,"anchor",void 0),(0,Nt.Cg)([(0,Wt.W)()],qt.prototype,"occluder",void 0),(0,Nt.Cg)([(0,Wt.W)()],qt.prototype,"writeDepth",void 0),(0,Nt.Cg)([(0,Wt.W)()],qt.prototype,"hideOnShortSegments",void 0),(0,Nt.Cg)([(0,Wt.W)()],qt.prototype,"hasCap",void 0),(0,Nt.Cg)([(0,Wt.W)()],qt.prototype,"hasTip",void 0),(0,Nt.Cg)([(0,Wt.W)()],qt.prototype,"hasVVSize",void 0),(0,Nt.Cg)([(0,Wt.W)()],qt.prototype,"hasVVColor",void 0),(0,Nt.Cg)([(0,Wt.W)()],qt.prototype,"hasVVOpacity",void 0),(0,Nt.Cg)([(0,Wt.W)()],qt.prototype,"hasOccludees",void 0),(0,Nt.Cg)([(0,Wt.W)()],qt.prototype,"terrainDepthTest",void 0),(0,Nt.Cg)([(0,Wt.W)()],qt.prototype,"cullAboveTerrain",void 0),(0,Nt.Cg)([(0,Wt.W)()],qt.prototype,"hasScreenSizePerspective",void 0);var Yt=i(75569);class Qt extends Ot.i{constructor(e,t){super(e,Kt),this.produces=new Map([[2,e=>9===e||(0,Dt.RN)(e)&&8===this.parameters.renderOccluded],[3,e=>(0,Dt.eh)(e)],[10,e=>(0,Dt.T2)(e)&&8===this.parameters.renderOccluded],[11,e=>(0,Dt.T2)(e)&&8===this.parameters.renderOccluded],[4,e=>(0,Dt.RN)(e)&&this.parameters.writeDepth],[8,e=>(0,Dt.RN)(e)&&!this.parameters.writeDepth],[18,e=>(0,Dt.RN)(e)||9===e]]),this.intersectDraped=void 0,this._configuration=new qt(t)}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.space=18===t.slot?0:this.parameters.worldSpace?2:1,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=0!==this.parameters.cap,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=t.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.occluder=8===this.parameters.renderOccluded,this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest&&(0,Dt.RN)(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.hasScreenSizePerspective=null!=this.parameters.screenSizePerspective,this._configuration}get visible(){return this.parameters.color[3]>=Yt.Q}intersect(){}createBufferWriter(){return new $t(jt(this.parameters),this.parameters)}createGLMaterial(e){return new Xt(e)}}class Xt extends zt.A{dispose(){var e;super.dispose(),null!==(e=this._markerTextures)&&void 0!==e&&e.release(this._markerPrimitive),this._markerPrimitive=null}beginSlot(e){const t=this._material.parameters.markerPrimitive;return t!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextures.swap(t,this._markerPrimitive)}),this._markerPrimitive=t),this.getTechnique(Ht,e)}}class Kt extends Vt.S{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive="arrow",this.placement="end",this.cap=0,this.anchor=0,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.stipplePattern=null,this.markerTexture=null}}class $t{constructor(e,t){this.layout=e,this._parameters=t}elementCount(){return"begin-end"===this._parameters.placement?12:6}write(e,t,i,r,n,s){const a=i.get("position").data,o=a.length/3;let l=[1,0,0];const c=i.get("normal");this._parameters.worldSpace&&null!=c&&(l=c.data);let h=1,d=0;this._parameters.vvSize?d=i.get("sizeFeatureAttribute").data[0]:i.has("size")&&(h=i.get("size").data[0]);let u=[1,1,1,1],v=0;this._parameters.vvColor?v=i.get("colorFeatureAttribute").data[0]:i.has("color")&&(u=i.get("color").data);let f=0;this._parameters.vvOpacity&&(f=i.get("opacityFeatureAttribute").data[0]);const m=new Float32Array(n.buffer),g=(0,Mt.Bg)(n.buffer),_=new Uint8Array(n.buffer);let y=s*(this.layout.stride/4);const x=m.BYTES_PER_ELEMENT/g.BYTES_PER_ELEMENT,b=4/x,w=(e,t,i,r)=>{m[y++]=e[0],m[y++]=e[1],m[y++]=e[2],(0,Et.Wu)(t,e,g,y*x),y+=b;let n=y*x;if(g[n++]=i[0],g[n++]=i[1],y=Math.ceil(n/x),this._parameters.vvColor)m[y++]=v;else{const e=Math.min(4*r,u.length-4),t=4*y++;_[t]=255*u[e],_[t+1]=255*u[e+1],_[t+2]=255*u[e+2],_[t+3]=255*u[e+3]}this._parameters.vvOpacity&&(m[y++]=f),n=y*x,this._parameters.vvSize?(m[y++]=d,n+=2):g[n++]=h,this._parameters.worldSpace&&(g[n++]=l[0],g[n++]=l[1],g[n++]=l[2]),y=Math.ceil(n/x)},S=(t,i)=>{const r=(0,p.j)(Jt,a[3*t],a[3*t+1],a[3*t+2]),n=ei;let s=t+i;do{(0,p.j)(n,a[3*s],a[3*s+1],a[3*s+2]),s+=i}while((0,p.G)(r,n)&&s>=0&&s<o);e&&((0,p.t)(r,r,e),(0,p.t)(n,n,e)),w(r,n,[-1,-1],t),w(r,n,[1,-1],t),w(r,n,[1,1],t),w(r,n,[-1,-1],t),w(r,n,[1,1],t),w(r,n,[-1,1],t)},C=this._parameters.placement;return"begin"!==C&&"begin-end"!==C||S(0,1),"end"!==C&&"begin-end"!==C||S(o-1,-1),null}}const Jt=(0,v.vt)(),ei=(0,v.vt)();var ti=i(35925),ii=i(52479);const ri=["polyline","polygon","extent"];class ni extends C.UF{constructor(e,t,i,r){super(e,t,i,r,function(e){var t,i,r,n,s;const a=null===(t=e.material)||void 0===t?void 0:t.color,o=null!==(i=null===(r=e.marker)||void 0===r?void 0:r.color)&&void 0!==i?i:a;return 1===(null!==(n=null===a||void 0===a?void 0:a.a)&&void 0!==n?n:0)&&1===(null!==(s=null===o||void 0===o?void 0:o.a)&&void 0!==s?s:0)}(t))}async doLoad(){this._fastUpdates=(0,at.s_)(this._context.renderer,this._fastVisualVariableConvertOptions());if(this._fastMarkerUpdates=(0,at.s_)(this._context.renderer,this._fastVisualVariableConvertOptions(!0)),!this._drivenProperties.size&&(null!=this.symbolLayer.size?this.symbolLayer.size:(0,Ve.PN)(1))<0)throw new De.A("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values")}_getMaterialParameters(e,t){var i,r,s,a;const o=this._screenSizePerspective,l=(0,n.A)((0,n.A)({},this._getMaterialColorParameters(t)),{},{width:this._computeMaterialWidth(null===(i=this.symbolLayer)||void 0===i?void 0:i.size),hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:Pt(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:(0,ti.Xq)(this.symbolLayer.pattern),emissiveStrength:null!==(r=this._emissiveStrength)&&void 0!==r?r:0,screenSizePerspective:o});return 4===t&&null!==(s=this._fastMarkerUpdates)&&void 0!==s&&s.visualVariables?(0,n.A)((0,n.A)({},l),this._fastMarkerUpdates.materialParameters):null!==(a=this._fastUpdates)&&void 0!==a&&a.visualVariables?(0,n.A)((0,n.A)({},l),this._fastUpdates.materialParameters):l}_getMaterialColorParameters(e){const t=4===e,i=this._getCombinedOpacityAndColor(t&&this._markerColor||this._materialColor);return this._patternHidesLine&&!t&&(i[3]=0),{color:i}}get _materialColor(){var e;return null===(e=this.symbolLayer.material)||void 0===e?void 0:e.color}get _emissiveStrength(){var e;return null===(e=this.symbolLayer.material)||void 0===e||null===(e=e.emissive)||void 0===e?void 0:e.strength}get _markerColor(){var e;return null===(e=this.symbolLayer.marker)||void 0===e?void 0:e.color}get _lineMaterial(){return null==this._materials[0]&&(this._materials[0]=new ii.W(this._getMaterialParameters(!1,0),this.view.state.isGlobal)),this._materials[0]}get _ringMaterial(){return null==this._materials[1]&&(this._materials[1]=new ii.W(this._getMaterialParameters(!0,1),this.view.state.isGlobal)),this._materials[1]}get _wireframeLineMaterial(){return null==this._materials[2]&&(this._materials[2]=new ii.W((0,n.A)((0,n.A)({},this._getMaterialParameters(!1,2)),{},{wireframe:!0}),this.view.state.isGlobal)),this._materials[2]}get _wireframeRingMaterial(){return null==this._materials[3]&&(this._materials[3]=new ii.W((0,n.A)((0,n.A)({},this._getMaterialParameters(!0,3)),{},{wireframe:!0}),this.view.state.isGlobal)),this._materials[3]}get _markerMaterial(){return null==this._materials[4]&&null!=this.symbolLayer.marker&&(this._materials[4]=new Qt((0,n.A)((0,n.A)({},this._getMaterialParameters(!1,4)),{},{placement:this.symbolLayer.marker.placement,markerPrimitive:At(this.symbolLayer.marker.style)}),this.view.state.isGlobal)),this._materials[4]}_getDrivenSize(e){if(this._drivenProperties.size){const t=e.size;return null!=t?(0,Ve.Lz)((0,b.or)(t)):this._getFallbackSize()}return 1}_getDrivenColor(e){let{color:t,opacity:i}=e;const r=(0,Ue.S)();return this._drivenProperties.color&&((0,Ct.d)(r,null!==t&&void 0!==t?t:this._getFallbackOpacityAndColor(Ue.uY)),null==i)||this._drivenProperties.opacity&&(t||this._materialColor)&&(r[3]=null!==i&&void 0!==i?i:this._getFallbackOpacity()),r}_getDrivenMarkerColor(e){let{color:t,opacity:i}=e;const r=(0,Ue.S)();return this._drivenProperties.color&&((0,Ct.d)(r,null!==t&&void 0!==t?t:this._getFallbackMarkerOpacityAndColor(Ue.uY)),null==i)||this._drivenProperties.opacity&&(t||this._markerColor||this._materialColor)&&(r[3]=null!==i&&void 0!==i?i:this._getFallbackMarkerOpacity()),r}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,ri,this.symbolLayer.type))return null;const i=this.createElevationContextForGraphic(t);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.draped?this._createAsOverlay(e):this._createAs3DShape(e,i,t.uid)}applyRendererDiff(e,t){for(const i in e.diff){if("visualVariables"!==i)return 0;{const e=this._fastUpdates;if(!(0,at.J_)(e,t,this._fastVisualVariableConvertOptions()))return 0;for(const t of this._materials)t instanceof ii.W&&t.setParameters(e.materialParameters);const i=this._fastMarkerUpdates,r=!0;if(!(0,at.J_)(i,t,this._fastVisualVariableConvertOptions(r)))return 0;for(const t of this._materials)t instanceof Qt&&t.setParameters(i.materialParameters)}}return 2}prepareSymbolLayerPatch(e){var t,i,r;if("partial"!==e.diff.type)return;const n=e.diff.diff,s={};"complete"===(null===(t=n.size)||void 0===t?void 0:t.type)&&(s.width=this._computeMaterialWidth(n.size.newValue),delete n.size),"complete"===(null===(i=n.cap)||void 0===i?void 0:i.type)&&(s.cap=Pt(null!==(r=n.cap.newValue)&&void 0!==r?r:"butt"),delete n.cap);const a=this._prepareMarkerPatch(e,n);this._prepareMaterialPatch(e,n,a),e.symbolLayerStatePatches.push(()=>{for(const e of this._materials)null===e||void 0===e||e.setParameters(s)})}layerOpacityChanged(){for(let t=0;t<5;t++){var e;null===(e=this._materials[t])||void 0===e||e.setParameters(this._getMaterialColorParameters(t))}}get _screenSizePerspective(){return!this.draped&&this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null}layerScreenSizePerspectiveChanged(){const e=this._screenSizePerspective;for(const t of this._materials)null===t||void 0===t||t.setParameters({screenSizePerspective:e})}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=(0,w.I2)(ni.elevationModeChangeTypes,i,r);if(1!==n)return n;const s=(0,w.nu)(r);return this.updateGraphics3DGraphicElevationInfo(e,t,()=>s)}slicePlaneEnabledChanged(){const e={hasSlicePlane:this._context.slicePlaneEnabled};for(const t of this._materials)null===t||void 0===t||t.setParameters(e);return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,i){const r=si(e.graphic.geometry),n="polygon"===r.type?r.rings:r.paths,s=new Array,a=(0,m.vt)(),o=(0,Tt.C)(r,this._context.elevationProvider,this._context.renderCoordsHelper,t),l="polygon"===r.type?"rings":"paths";this._logGeometryCreationWarnings(o,n,l,"LineSymbol3DLayer");for(let u=0;u<o.lines.length;u++){const t=o.lines[u],n=t.position,l=t.mapPositions;if(null!=this._context.clippingExtent&&((0,m.vY)(l,a),!(0,m.KG)(a,this._context.clippingExtent)))continue;const c=this._createGeometry("polygon"===r.type?this._ringMaterial:this._lineMaterial,e,n,l,r.type,1,i);if(s.push(c),F.b.LINE_WIREFRAMES&&s.push(c.instantiate({material:"polygon"===r.type?this._wireframeRingMaterial:this._wireframeLineMaterial})),null!=this._markerMaterial){const t=c.instantiate({material:this._markerMaterial});t.attributes.has("color")&&t.setAttributeData("color",this._getDrivenMarkerColor(e.renderingInfo)),s.push(t)}}if(0===s.length)return null;const c=this._context.layerViewUid,h=new ee.B({geometries:s,castShadow:!1,layerViewUid:c,graphicUid:i}),d=new S.Y(this,h,null,Ye.Zd,t);return d.alignedSampledElevation=o.sampledElevation,d.needsElevationUpdates=(0,w.nu)(t.mode),d}_createGeometry(e,t,i,r,n,s,a){var o,l,c;const h=0===s?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,d="polygon"===n,u=null===(o=this._fastUpdates)||void 0===o?void 0:o.visualVariables.color,p=null===(l=this._fastUpdates)||void 0===l?void 0:l.visualVariables.size,v=null===(c=this._fastUpdates)||void 0===c?void 0:c.visualVariables.opacity,f=this._context.layerViewUid,m=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerViewUid:f}),g={position:i,size:p?null:this._getDrivenSize(t.renderingInfo),color:u?null:this._getDrivenColor(t.renderingInfo),sizeFeature:p?(0,at.ul)(p.field,t.graphic):null,colorFeature:u?(0,at.ul)(u.field,t.graphic):null,opacityFeature:v?(0,at.ul)(v.field,t.graphic):null};return(0,Rt.te)(e,{overlayInfo:h,removeDuplicateStartEnd:d,mapPositions:r,attributeData:g},m)}_createAsOverlay(e){const t=e.graphic,i=si(t.geometry),r="polygon"===i.type?i.rings:i.paths,n="polygon"===i.type?this._ringMaterial:this._lineMaterial;n.renderPriority=this._renderPriority;const s=F.b.LINE_WIREFRAMES?"polygon"===i.type?this._wireframeRingMaterial:this._wireframeLineMaterial:null,a=this._markerMaterial;null!=s&&(s.renderPriority=this._renderPriority-.001),null!=a&&(a.renderPriority=this._renderPriority-.002);const o=new Array,l=(0,m.vt)(),c=(0,m.Ie)(),h=(0,Tt.A)(i,this._context.overlaySR),d="polygon"===i.type?"rings":"paths";this._logGeometryCreationWarnings(h,r,d,"LineSymbol3DLayer");for(const u of h.lines){if((0,m.vY)(u.position,l),!(0,m.KG)(l,this._context.clippingExtent))continue;(0,m.RF)(c,l);const r=this._createGeometry(n,e,u.position,void 0,i.type,0,t.uid),h=e=>{const i=this._context.layerViewUid,r=new ht.$(e,{layerViewUid:i,graphicUid:t.uid});o.push(r)};if(null!=a){const t=r.instantiate({material:a});t.attributes.has("color")&&t.setAttributeData("color",this._getDrivenMarkerColor(e.renderingInfo)),h(t);const i=this.symbolLayer.marker.placement;"begin"!==i&&"begin-end"!==i||(0,m.Hq)(l,u.position,0,1),"end"!==i&&"begin-end"!==i||(0,m.Hq)(l,u.position,u.position.length-3,1)}h(r),F.b.LINE_WIREFRAMES&&h(r.instantiate({material:s}))}return new Je(this,o,c,this._context.drapeSourceRenderer)}get _patternHidesLine(){const e=this.symbolLayer.pattern;return null!=e&&"style"===e.type&&"none"===e.style}_computeMaterialWidth(e){var t;return e=null!==e&&void 0!==e?e:(0,Ve.PN)(1),this._drivenProperties.size?null!==(t=this._fastUpdates)&&void 0!==t&&t.visualVariables.size?(0,Ve.Lz)(1):1:(0,Ve.Lz)(e)}_prepareMaterialPatch(e,t,i){var r,n;const s=t.material;if(null==s)return void(i.changed&&i.useMaterialColor&&ai(this._getCombinedOpacityAndColor(this._materialColor),this._materials[4],e));if("collection"===s.type)return;const a="complete"===s.type?null===(r=s.newValue)||void 0===r?void 0:r.color:"complete"===(null===(n=s.diff.color)||void 0===n?void 0:n.type)?s.diff.color.newValue:null,o=this._getCombinedOpacityAndColor(a);i.useMaterialColor&&ai((0,Ue.o8)(o),this._materials[4],e),this._patternHidesLine&&(o[3]=0),ai(o,this._materials[0],e),delete t.material}_prepareMarkerPatch(e,t){var i;const r=t.marker,n=this._markerMaterial;if(null==r||"partial"!==r.type||null==r.diff||null!=r.diff.placement||null!=r.diff.style&&"complete"!==r.diff.style.type||null!=r.diff.color&&"complete"!==r.diff.color.type||null==n)return{changed:!1,useMaterialColor:null==this._markerColor};const s=r.diff.color,a=null!=s,o=a?s.newValue:null,l=null==o&&null==this._markerColor;o&&ai(this._getCombinedOpacityAndColor(o),n,e);const c=null===(i=r.diff.style)||void 0===i?void 0:i.newValue;return c&&e.symbolLayerStatePatches.push(()=>n.setParameters({markerPrimitive:At(c)})),delete t.marker,{changed:a,useMaterialColor:l}}_fastVisualVariableConvertOptions(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=this._getFallbackSize();return new at.wI({supports:{size:!0,color:!0,rotation:!1,opacity:!0},fallbackColor:e?this._getFallbackMarkerOpacityAndColor(C.Z$):this._getFallbackOpacityAndColor(C.Z$),fallbackSize:(0,v.fA)(t,t,t)})}_getFallbackOpacityAndColor(e){var t;return null!==(t=Te.A.toUnitRGBA(this._materialColor))&&void 0!==t?t:e}_getFallbackOpacity(){var e,t;return null!==(e=null===(t=this._materialColor)||void 0===t?void 0:t.a)&&void 0!==e?e:0}_getFallbackMarkerOpacityAndColor(e){var t,i;const r=null===(t=this.symbolLayer)||void 0===t||null===(t=t.marker)||void 0===t?void 0:t.color;return null!==(i=Te.A.toUnitRGBA(r))&&void 0!==i?i:this._getFallbackOpacityAndColor(e)}_getFallbackMarkerOpacity(){var e,t;return null!==(e=null===(t=this.symbolLayer)||void 0===t||null===(t=t.marker)||void 0===t||null===(t=t.color)||void 0===t?void 0:t.a)&&void 0!==e?e:this._getFallbackOpacity()}_getFallbackSize(){var e;const t=null===(e=this.symbolLayer)||void 0===e?void 0:e.size;return null!=t?(0,Ve.Lz)(t):1}}function si(e){switch(e.type){case"extent":if(e instanceof A.A)return R.A.fromExtent(e);break;case"polygon":case"polyline":return e}return null}function ai(e,t,i){null!=t&&i.symbolLayerStatePatches.push(()=>t.setParameters({color:e}))}ni.elevationModeChangeTypes={definedChanged:2,staysOnTheGround:0,onTheGroundChanged:2};var oi=i(99746),li=i(15941),ci=i(56611),hi=i(14487),di=i(75002),ui=i(79629),pi=i(44032),vi=i(63713),fi=i(99773),mi=i(80963),gi=i(26375),_i=i(22956),yi=i(85192),xi=i(37040),bi=i(54439),wi=i(48989);const Si=2e3;class Ci extends S.Y{constructor(){super(...arguments),this.fastTransformUpdatesAllowed=!1,this._originalGeometries=[],this._fastTransformUpdatesEnabled=!1,this._autoDisableFastUpdatesTimeoutId=0}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}destroy(){super.destroy(),this._cancelAutoDisableFastUpdates()}enableFastTransformUpdates(e,t){if(!this.fastTransformUpdatesAllowed||this._fastTransformUpdatesEnabled)return;this._cancelAutoDisableFastUpdates(),this._fastTransformUpdatesEnabled=!0;const{stageObject:i}=this,r=i.geometries.slice();i.removeAllGeometries();const n=(0,d.sC)(Pi,i.transformation),s=t.getOrigin(n);for(const a of r){const t=e(a.material),r=a.instantiate({material:t});r.localOrigin=s,i.addGeometry(r)}this._originalGeometries=r}autoDisableFastTransformUpdates(e){this._cancelAutoDisableFastUpdates(),this._autoDisableFastUpdatesTimeoutId=setTimeout(()=>{this._autoDisableFastUpdatesTimeoutId=0,e()},Si)}updateAutoDisableFastTransformUpdates(e){this._autoDisableFastUpdatesTimeoutId&&this.autoDisableFastTransformUpdates(e)}_cancelAutoDisableFastUpdates(){clearTimeout(this._autoDisableFastUpdatesTimeoutId),this._autoDisableFastUpdatesTimeoutId=0}disableFastTransformUpdates(e){if(!this._fastTransformUpdatesEnabled)return;this._cancelAutoDisableFastUpdates(),this._fastTransformUpdatesEnabled=!1;const{stageObject:t}=this,i=t.geometries.map(t=>e(t.material));t.removeAllGeometries();for(let r=0;r<this._originalGeometries.length;r++){const e=this._originalGeometries[r],n=i[r];n.setParameters({modelTransformation:null}),n===e.material?t.addGeometry(e):t.addGeometry(e.instantiate({material:n}))}this._originalGeometries.length=0}updateFastLocalOrigin(e,t,i){var r;if(!this._fastTransformUpdatesEnabled)return;const{stageObject:n}=this;if(0===n.geometries.length)return;const s=n.geometries[0].localOrigin,a=(0,d.sC)(Pi,e),o=i.getOrigin(a);if(o===s)return;const l=null!==(r=null===t||void 0===t?void 0:t.localMatrix)&&void 0!==r?r:u.zK;n.shaderTransformation=null,n.transformation=e,n.geometries.forEach(e=>{e.transformation=l,e.localOrigin=o})}updateTransform(e,t,i){var r;const{stageObject:n}=this,s=null!==(r=null===t||void 0===t?void 0:t.localMatrix)&&void 0!==r?r:u.zK;if(!this._fastTransformUpdatesEnabled)return n.shaderTransformation=null,n.transformation=e,n.geometries.forEach(e=>e.transformation=s),void this._updateEdgeTransform(i);const a=n.transformation,o=n.geometries[0].transformation,l=e,c=s,h=(0,d.lw)(Ai,a,o),p=(0,d.lw)(Ri,l,c),v=(0,d.lw)(Mi,p,(0,d.B8)(Mi,o));n.shaderTransformation=v,this._setFastMaterialTransformation({matA:h,matB:p}),this._updateEdgeTransform(i)}alignWithElevation(e,t,i){if(!this._fastTransformUpdatesEnabled)return void super.alignWithElevation(e,t,i);const{stageObject:r}=this;if(!r.geometries[0].material.parameters.modelTransformation)return;const n=r.transformation,s=r.geometries[0].transformation,a=(0,d.lw)(Ai,n,s),o=r.effectiveTransformation,l=(0,d.C)(Ti,o);this.alignedSampledElevation=(0,Ye.G8)(this,this.elevationContext,e.spatialReference,(i,r)=>(0,w.sE)(i,e,this.elevationContext,t,r),t,l),r.shaderTransformation=l;const c=r.geometries[0].transformation,h=(0,d.lw)(Ri,l,c);this._setFastMaterialTransformation({matA:a,matB:h}),this._updateEdgeTransform(i)}_setFastMaterialTransformation(e){let{matA:t,matB:i}=e;const{stageObject:r}=this;if(0===r.geometries.length)return;const n=r.geometries[0].localOrigin,s=(0,d.kN)(Oi,(0,p.h)(Pi,n.vec3,-1)),a=(0,d.lw)(Di,s,t),o=(0,d.lw)(zi,s,i),l=(0,d.B8)(Di,a),c=(0,d.lw)(zi,o,l);for(const h of r.geometries)h.material.setParameters({modelTransformation:c})}_updateEdgeTransform(e){const{stageObject:t,_stageLayer:i}=this;i.stage.renderer.withEdgeView(i=>{i.fastUpdateObject3DEdgesTransform(t)||this.resetEdgeObject(e)})}}const Pi=(0,v.vt)(),Ai=(0,u.vt)(),Ri=(0,u.vt)(),Ti=(0,u.vt)(),Mi=(0,u.vt)(),Di=(0,u.vt)(),zi=(0,u.vt)(),Oi=(0,u.vt)();class Vi{constructor(){this._fastTransformOriginalMaterials=new Map,this._fastTransformClonedMaterials=new Map,this._graphicReferenceCount=0}enable(e,t,i){e.enableFastTransformUpdates(e=>{if(this._graphicReferenceCount<=1){if(this._fastTransformOriginalMaterials.has(e))return e;const i=t.byMaterial(e);return this._fastTransformOriginalMaterials.set(e,i),t.delete(e),e}const r=new te.$U(e.parameters,i);return this._fastTransformClonedMaterials.set(r,e),r},i.localOriginFactory)}disable(e,t){const i=new Set,r=new Set;e.disableFastTransformUpdates(e=>{if(!this._fastTransformClonedMaterials.has(e)){const n=e,s=this._fastTransformOriginalMaterials.get(n);return t.has(s.uid)?(i.add(n),t.byUid(s.uid).material):(r.add(n),s.material)}const n=e,s=this._fastTransformClonedMaterials.get(n);return this._fastTransformClonedMaterials.delete(n),s});for(const n of i)this._fastTransformOriginalMaterials.delete(n);for(const n of r){const e=this._fastTransformOriginalMaterials.get(n);this._fastTransformOriginalMaterials.delete(n),t.set(e.uid,e)}}onAddGraphic(){this._graphicReferenceCount++}onRemoveGraphic(e,t){this._graphicReferenceCount--,this.disable(e,t)}forEachMaterialInfo(e){this._fastTransformOriginalMaterials.forEach(e)}forEachClonedMaterial(e){this._fastTransformClonedMaterials.forEach(e)}destroy(){this._fastTransformClonedMaterials.clear(),this._fastTransformOriginalMaterials.clear()}}class Ei{constructor(){this._byUid=new Map,this._byMaterial=new Map}get materials(){return Array.from(this._byUid.values(),e=>e.material)}byUid(e){return this._byUid.get(e)}byMaterial(e){return this._byMaterial.get(e)}set(e,t){this._byUid.set(e,t),this._byMaterial.set(t.material,t)}delete(e){var t;const i=null===(t=this._byMaterial.get(e))||void 0===t?void 0:t.uid;i&&(this._byUid.delete(i),this._byMaterial.delete(e))}has(e){return this._byUid.has(e)}forEachMaterialInfo(e){this._byUid.forEach(e)}clear(){this._byUid.clear(),this._byMaterial.clear()}}var Ii=i(90346),Li=i(19555),Ui=i(44230),Fi=i(13927),ki=i(86994),Gi=i(82809),Bi=i(86401),Hi=i(34026),ji=i(93345);class Ni extends Ut.w{constructor(e,t){super(e,t,new Lt.$(Hi.N,()=>i.e(6272).then(i.bind(i,36272))),t.hasVertexColors?Bi.dB.locations:Bi.Ci.locations),this.primitiveType=ji.WR.LINES}initializePipeline(e){const{hasOccludees:t,output:i,transparent:r,oitPass:n}=e,s=function(e){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return(0,Bt.Ey)({blending:r,depthTest:kt.m,depthWrite:s,colorWrite:Bt.kn,stencilWrite:t?kt.v0:null,stencilTest:t?e?kt.a9:kt.qh:null,drawBuffers:(0,Ft.m6)(n,i)})};return(0,Dt.RN)(i)?(this._occludeePipeline=s(!0,r?Bt.T8:null,Bt.Uy),s(!1,r?Bt.T8:null,Bt.Uy)):s(!1)}getPipeline(e){return e?this._occludeePipeline:super.getPipeline()}}class Wi extends Zt.E{constructor(){super(...arguments),this.hasVertexColors=!1,this.transparent=!1,this.hasOccludees=!1,this.writeDepth=!0,this.draped=!1,this.snowCover=!1,this.emissionSource=0,this.textureCoordinateType=0}get discardInvisibleFragments(){return this.transparent&&this.writeDepth}}(0,Nt.Cg)([(0,Wt.W)()],Wi.prototype,"hasVertexColors",void 0),(0,Nt.Cg)([(0,Wt.W)()],Wi.prototype,"transparent",void 0),(0,Nt.Cg)([(0,Wt.W)()],Wi.prototype,"hasOccludees",void 0),(0,Nt.Cg)([(0,Wt.W)()],Wi.prototype,"writeDepth",void 0);class Zi extends Ot.i{constructor(e){super(e,Yi),this._configuration=new Wi,this.produces=new Map([[2,e=>(0,Dt.Mb)(e)]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.hasOccludees=t.hasOccludees,this._configuration}get visible(){return this.parameters.color[3]>=Yt.Q}intersect(e,t,i,n,s,a){const{options:o,camera:l,rayBegin:c,rayEnd:h}=i;if(!o.selectionMode||!e.visible||!l)return;if(!(0,ki.zH)(t))return void r.A.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix");const d=e.attributes.get("position").data,u=sr;(0,Li.C)(u,i.point);(0,p.j)(ar[0],u[0]-2,u[1]+2,0),(0,p.j)(ar[1],u[0]+2,u[1]+2,0),(0,p.j)(ar[2],u[0]+2,u[1]-2,0),(0,p.j)(ar[3],u[0]-2,u[1]-2,0);for(let r=0;r<4;r++)if(!l.unprojectFromRenderScreen(ar[r],or[r]))return;(0,Fi.Cr)(l.eye,or[0],or[1],lr),(0,Fi.Cr)(l.eye,or[1],or[2],cr),(0,Fi.Cr)(l.eye,or[2],or[3],hr),(0,Fi.Cr)(l.eye,or[3],or[0],dr);let v=Number.MAX_VALUE,f=0;for(let r=0;r<d.length-5;r+=3){if(Qi[0]=d[r]+t[12],Qi[1]=d[r+1]+t[13],Qi[2]=d[r+2]+t[14],Xi[0]=d[r+3]+t[12],Xi[1]=d[r+4]+t[13],Xi[2]=d[r+5]+t[14],(0,Fi.mN)(lr,Qi)<0&&(0,Fi.mN)(lr,Xi)<0||(0,Fi.mN)(cr,Qi)<0&&(0,Fi.mN)(cr,Xi)<0||(0,Fi.mN)(hr,Qi)<0&&(0,Fi.mN)(hr,Xi)<0||(0,Fi.mN)(dr,Qi)<0&&(0,Fi.mN)(dr,Xi)<0)continue;const e=l.projectToRenderScreen(Qi,Ji),i=l.projectToRenderScreen(Xi,er);if(null==e||null==i)continue;if(e[2]<0&&i[2]>0){(0,p.e)(Ki,Qi,Xi);const t=l.frustum,i=-(0,Fi.mN)(t[4],Qi)/(0,p.f)(Ki,(0,Fi.Qj)(t[4]));if((0,p.h)(Ki,Ki,i),(0,p.g)(Qi,Qi,Ki),!l.projectToRenderScreen(Qi,e))continue}else if(e[2]>0&&i[2]<0){(0,p.e)(Ki,Xi,Qi);const e=l.frustum,t=-(0,Fi.mN)(e[4],Xi)/(0,p.f)(Ki,(0,Fi.Qj)(e[4]));if((0,p.h)(Ki,Ki,t),(0,p.g)(Xi,Xi,Ki),!l.projectToRenderScreen(Xi,i))continue}else if(e[2]<0&&i[2]<0)continue;e[2]=0,i[2]=0;const n=(0,Ui.kb)((0,Ui.Cr)(e,i,rr),u);n<v&&(v=n,(0,p.d)(tr,Qi),(0,p.d)(ir,Xi),f=r/3)}if(v<4){let e=Number.MAX_VALUE;if((0,Ui.ld)((0,Ui.Cr)(tr,ir,rr),(0,Ui.Cr)(c,h,nr),$i)){(0,p.e)($i,$i,c);const t=(0,p.b)($i);(0,p.h)($i,$i,1/t),e=t/(0,p.k)(c,h)}a(e,$i,f)}}intersectDraped(e,t,i,r,n){if(!t.options.selectionMode)return;const s=e.attributes.get("position").data,a=e.attributes.get("size"),o=a?a.data[0]:0,l=i[0],c=i[1],h=((o+1)/2+4)*e.screenToWorldRatio;let d=Number.MAX_VALUE,u=0;for(let p=0;p<s.length-5;p+=3){const e=s[p],t=s[p+1],i=l-e,r=c-t,n=s[p+3]-e,a=s[p+4]-t,o=(0,li.qE)((n*i+a*r)/(n*n+a*a),0,1),h=n*o-i,v=a*o-r,f=h*h+v*v;f<d&&(d=f,u=p/3)}d<h*h&&r(n.distance,n.normal,u)}createGLMaterial(e){return new qi(e)}createBufferWriter(){const e=this.parameters.hasVertexColors?Bi.dB:Bi.Ci;return new Gi.Z(e)}}class qi extends zt.A{beginSlot(e){return this.getTechnique(Ni,e)}}class Yi extends Ot.q{constructor(){super(...arguments),this.color=Ue.Un,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1}}const Qi=(0,v.vt)(),Xi=(0,v.vt)(),Ki=(0,v.vt)(),$i=(0,v.vt)(),Ji=(0,Ve.r_)(),er=(0,Ve.r_)(),tr=(0,v.vt)(),ir=(0,v.vt)(),rr=(0,Ui.vt)(),nr=(0,Ui.vt)(),sr=(0,v.vt)(),ar=[(0,Ve.r_)(),(0,Ve.r_)(),(0,Ve.r_)(),(0,Ve.r_)()],or=[(0,v.vt)(),(0,v.vt)(),(0,v.vt)(),(0,v.vt)()],lr=(0,Fi.vt)(),cr=(0,Fi.vt)(),hr=(0,Fi.vt)(),dr=(0,Fi.vt)();var ur=i(78992);const pr=["mesh"];class vr extends C.UF{constructor(e,t,i,r){super(e,t,i,r,function(e){var t,i;return 1===(null!==(t=null===(i=e.material)||void 0===i||null===(i=i.color)||void 0===i?void 0:i.a)&&void 0!==t?t:0)}(t)),this._materialInfoCache=new Ei,this._fastUpdateProcessor=new Vi,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){F.b.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new Zi({color:[1,0,1,1]}),this._debugTangentNormalMaterial=new Zi({color:[1,.5,0,1]}),this._debugFaceNormalMaterial=new Zi({color:[0,1,1,1]})),this.updateComplexity()}destroy(){super.destroy(),this._textures.forEach(e=>e.unload()),this._context.stage.removeTextures(Array.from(this._textures.values())),this._materialInfoCache.clear(),this._textures.clear(),this._fastUpdateProcessor.destroy()}get materials(){return this._materialInfoCache.materials}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,pr,"fill on mesh-3d"))return null;const i=this.createElevationContextForGraphic(t),r=e.renderingInfo;return this._createAs3DShape(t,r,i,t.uid)}onRemoveGraphic(e){this._fastUpdateProcessor.onRemoveGraphic(e,this._materialInfoCache)}layerOpacityChanged(e,t){const i=this._getLayerOpacity();this._updateMaterialParameters(e=>{e.material.setParameters({layerOpacity:i});const t=e.material.parameters;this._setMaterialTextureAlphaMode(t,e)}),null===e||void 0===e||e.forEach(e=>{var r;return null===(r=t(e))||void 0===r?void 0:r.layerOpacityChanged(i,this._context.isAsync)})}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,w.Kf)}slicePlaneEnabledChanged(e,t){return this._updateMaterialParameters(e=>{let{material:t}=e;t.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),null!==e&&void 0!==e&&e.forEach(e=>{var i;return null===(i=t(e))||void 0===i?void 0:i.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const e=this._usePBR();return this._updateMaterialParameters(t=>{let{material:i}=t;return i.setParameters({usePBR:e})}),!0}updateTransform(e,t,i,r){var n;if(!e.fastTransformUpdatesAllowed)return!1;const s=e.fastTransformUpdatesEnabled;switch(r){case 0:if(s)return!0;break;case 1:if(!s)return!0;break;default:if(!s)return!!this.updateTransform(e,t,i,0)&&(e.autoDisableFastTransformUpdates(()=>this.updateTransform(e,t,i,1)),!0)}const a=this._context.renderCoordsHelper.spatialReference,o=Vr,{origin:l,transform:c}=i;if(!(0,f.l)(t,(0,p.j)(Tr,l.x,l.y,null!==(n=l.z)&&void 0!==n?n:0),o,a))return!1;switch(r){case 0:this._fastUpdateProcessor.enable(e,this._materialInfoCache,this._context);break;case 1:this._fastUpdateProcessor.disable(e,this._materialInfoCache);break;case 2:e.updateFastLocalOrigin(o,c,this._context.localOriginFactory)}const{elevationContext:h}=e;h.centerInElevationSR=this._getCenterInElevationSR(o);const{elevationProvider:d,renderCoordsHelper:u}=this._context;return e.alignedSampledElevation=(0,Ye.G8)(e,h,d.spatialReference,(e,t)=>(0,w.sE)(e,d,h,u,t),u,o),e.updateTransform(o,c,this._context.isAsync),e.updateAutoDisableFastTransformUpdates(()=>this.updateTransform(e,t,i,1)),!0}computeComplexity(){if(!this._textures||0===this._textures.size)return super.computeComplexity();let e=0;for(const r of this._textures.values())e+=r.usedMemory;const t=(0,n.A)((0,n.A)({},(0,wi.GI)(this.symbol,this.symbolLayer)),{},{resourceBytes:e}),i=(0,L.RF)(this.symbolLayer)?2:0;return new Ii.rz({drawCallsPerFeature:i,memory:t})}_requiresSymbolVertexColors(){return this._hasDrivenColorOrOpacity}_materialPropertiesDefault(e,t){const i=this._requiresSymbolVertexColors(),r=!!e.vertexAttributes.color,n=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:i,hasVertexColors:r,hasVertexTangents:n,uid:"vc:".concat(r,",vt:").concat(n,",vct").concat(t,",svc:").concat(i)}}_materialProperties(e,t,i){const r=this._materialPropertiesDefault(e,i);if(!t.material)return r;const{color:n,colorTexture:s,colorTextureTransform:a,normalTexture:o,normalTextureTransform:l,doubleSided:c,alphaCutoff:h,alphaMode:d}=t.material,u=Cr(n),p=Cr(s),v=Pr(a),f=Cr(o),m=Pr(l);if(r.color=n,r.colorTexture=s,r.normalTexture=o,r.uid="".concat(r.uid,",cmuid:").concat(u,",ctmuid:").concat(p,",cttuid:").concat(v,",ntmuid:").concat(f,",nttuid:").concat(m,",ds:").concat(c,",ac:").concat(h,",am:").concat(d),t.material instanceof pi.A){const{metallic:e,roughness:i,metallicRoughnessTexture:n,metallicRoughnessTextureTransform:s,emissiveColor:o,emissiveTexture:c,emissiveTextureTransform:h,occlusionTexture:d,occlusionTextureTransform:u}=t.material,p=Cr(n),v=Pr(s),f=Cr(o),m=Cr(c),g=Pr(h),_=Cr(d),y=Pr(u);r.uid="".concat(r.uid,",mrm:").concat(e,",mrr:").concat(i,",mrt:").concat(p,",mrtt:").concat(v,",emuid:").concat(f,",etmuid:").concat(m,",ett:").concat(g,",otmuid:").concat(_,",ott:").concat(y),r.metallic=e,r.roughness=i,r.metallicRoughnessTexture=n,r.emissiveColor=o,r.emissiveTexture=c,r.occlusionTexture=d,r.colorTextureTransform=br(a),r.normalTextureTransform=br(l),r.emissiveTextureTransform=br(h),r.occlusionTextureTransform=br(u),r.metallicRoughnessTextureTransform=br(s)}return r}_getInternalTexture(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;const r=function(e){var t;return null!==(t=e.data)&&void 0!==t?t:e.url}(e);if(!r)return null;const n="".concat(e.contentHash,"/").concat(i);let s=this._textures.get(n);if(s){const e=this._context.stage.renderView.textures;let t=null;const i=e.acquire(s.id);return null==i||(0,Oe.$X)(i)||(s.events.on("unloaded",()=>t=(0,ze.Gz)(t)),t=i),s}let a=null;const o=this._context.stage.renderView.renderingContext.parameters.maxMaxAnisotropy,l={wrap:wr(e.wrap),noUnpackFlip:!0,maxAnisotropy:o,mipmap:o>1};return(0,xi.x3)(r)?(a=r.data,l.preMultiplyAlpha=!1,l.encoding=r.encoding):(a=r,l.preMultiplyAlpha=1!==i,l.compressionOptions=t?{compressionTracker:this._context.compressionTracker,compressionCallback:()=>this.updateComplexity()}:void 0),s=new dt.g(a,l),this._textures.set(n,s),s.events.on("loaded",()=>this.updateComplexity()),s.load(this._context.stage.renderView.renderingContext),this._context.stage.addTexture(s),s.events.on("unloaded",()=>{this._textures.delete(n)}),s}_setInternalMaterialTextureParameters(e,t){var i,r,n,s;if(null!=e.colorTexture){const i=1!==t.textureAlphaMode,r=this._getInternalTexture(e.colorTexture,i,t.textureAlphaMode);r?(t.textureId=r.id,t.textureAlphaPremultiplied=!!r.parameters.preMultiplyAlpha):t.textureId=void 0}if(e.normalTexture&&(t.normalTextureId=null===(i=this._getInternalTexture(e.normalTexture))||void 0===i?void 0:i.id),e.emissiveColor){const i=Te.A.toUnitRGB(e.emissiveColor);t.emissiveBaseColor=(0,v.fA)((0,oi.Q6)(i[0]),(0,oi.Q6)(i[1]),(0,oi.Q6)(i[2]))}e.emissiveTexture&&(t.emissiveTextureId=null===(r=this._getInternalTexture(e.emissiveTexture))||void 0===r?void 0:r.id),e.occlusionTexture&&(t.occlusionTextureId=null===(n=this._getInternalTexture(e.occlusionTexture,!0))||void 0===n?void 0:n.id),e.metallicRoughnessTexture&&(t.metallicRoughnessTextureId=null===(s=this._getInternalTexture(e.metallicRoughnessTexture,!0))||void 0===s?void 0:s.id)}_setInternalMaterialParameters(e,t,i){var r,n;null!=e.color&&function(e,t,i){t.diffuse=Te.A.toUnitRGB(e),t.opacity="opaque"===i.alphaMode?1:e.a}(e.color,t,i),this._setInternalMaterialTextureParameters(e,t),t.colorTextureTransformMatrix=(0,bi.G)(e.colorTextureTransform),t.normalTextureTransformMatrix=(0,bi.G)(e.normalTextureTransform);const s=null!=(null===(r=e.normalTextureTransform)||void 0===r?void 0:r.scale)?null===(n=e.normalTextureTransform)||void 0===n?void 0:n.scale:Le.Un;t.scale=[s[0],s[1]],t.occlusionTextureTransformMatrix=(0,bi.G)(e.occlusionTextureTransform),t.emissiveTextureTransformMatrix=(0,bi.G)(e.emissiveTextureTransform),t.metallicRoughnessTextureTransformMatrix=(0,bi.G)(e.metallicRoughnessTextureTransform)}_setExternalMaterialParameters(e){var t,i,r,n,s,a;let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._materialColor;const l=this._drivenProperties.color,c=this._drivenProperties.opacity;if(l)e.externalColor=Ue.Un;else{const t=null!==o&&void 0!==o?o:null;if(t){const i=Te.A.toUnitRGBA(t);c&&(i[3]=1),e.externalColor=i}else e.externalColor=C.Z$}e.colorMixMode=null!==(t=null===(i=this.symbolLayer.material)||void 0===i?void 0:i.colorMixMode)&&void 0!==t?t:"multiply",e.castShadows=!!this.symbolLayer.castShadows,e.emissiveStrength=null!==(r=null===(n=this.symbolLayer)||void 0===n||null===(n=n.material)||void 0===n||null===(n=n.emissive)||void 0===n?void 0:n.strength)&&void 0!==r?r:1,e.emissiveSource=(0,yi.rs)(null!==(s=null===(a=this.symbolLayer)||void 0===a||null===(a=a.material)||void 0===a||null===(a=a.emissive)||void 0===a?void 0:a.source)&&void 0!==s?s:"emissive")}_getOrCreateMaterial(e,t){var i,r,n;const s=null===(i=t.material)||void 0===i?void 0:i.color,a=null===(r=t.material)||void 0===r?void 0:r.colorTexture,o=null===(n=t.material)||void 0===n?void 0:n.alphaMode,l="blend"===o,c=!("opaque"===o)&&(function(e){const t=e.vertexAttributes.color;if(null==t)return!1;for(let i=3;i<t.length;i+=4)if(255!==t[i])return!0;return!1}(e)||null!=s&&s.a<1||(null===a||void 0===a?void 0:a.transparent)||l),h=this._materialProperties(e,t,c),d=this._materialInfoCache.byUid(h.uid);if(d)return this._setInternalMaterialTextureParameters(h,d.material.parameters),d.material;const u={uid:h.uid,material:null,isComponentTransparent:c,alphaMode:t.material?t.material.alphaMode:"opaque"},p=(0,ur.Jr)({normalTexture:h.normalTexture,metallicRoughnessTexture:h.metallicRoughnessTexture,metallicFactor:h.metallic,roughnessFactor:h.roughness,emissiveTexture:h.emissiveTexture,emissiveFactor:Te.A.toUnitRGB(h.emissiveColor),occlusionTexture:h.occlusionTexture}),f={usePBR:this._usePBR(),isSchematic:p,hasVertexColors:h.hasVertexColors,hasSymbolColors:h.hasSymbolVertexColors,hasVertexTangents:h.hasVertexTangents,ambient:v.uY,diffuse:v.Un,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:0,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,drivenOpacity:this.needsDrivenTransparentPass||u.isComponentTransparent};f.mrrFactors=p?ur.Bt:[h.metallic,h.roughness,ur.mb[2]],t.material&&(f.doubleSided=t.material.doubleSided,f.cullFace=t.material.doubleSided?0:2,f.textureAlphaCutoff=t.material.alphaCutoff),this._setExternalMaterialParameters(f),this._setMaterialTextureAlphaMode(f,u),this._setInternalMaterialParameters(h,f,u);const m=new te.$U(f,this._context);return u.material=m,this._materialInfoCache.set(h.uid,u),m}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchColor(e,t)}_preparePatchColor(e,t){if(!t.material||"partial"!==t.material.type)return;const i=t.material.diff;if(!i.color||"complete"!==i.color.type||null==i.color.newValue||null==i.color.oldValue)return;const r=i.color.newValue;delete i.color,e.symbolLayerStatePatches.push(()=>{this._updateMaterialParameters(e=>{const t=e.material.parameters;this._setExternalMaterialParameters(t,r),this._setMaterialTextureAlphaMode(t,e),e.material.setParameters({externalColor:t.externalColor})})})}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTextureAlphaMode(e,t){if("auto"===t.alphaMode){var i,r,n,s;const a=this.needsDrivenTransparentPass||t.isComponentTransparent||(null!==(i=e.layerOpacity)&&void 0!==i?i:1)<1||(null!==(r=e.opacity)&&void 0!==r?r:1)<1||(null!==(n=null===(s=e.externalColor)||void 0===s?void 0:s[3])&&void 0!==n?n:1)<1;e.textureAlphaMode=a?3:1}else e.textureAlphaMode="opaque"===t.alphaMode?1:"mask"===t.alphaMode?2:0}_createFaceDebugNormals(e,t){const i=t.length,r=e.spatialReference.isGeographic?20015077/180:1,n=.1*Math.max(e.extent.width*r,e.extent.height*r,e.extent.zmax-e.extent.zmin),s=[],a=[],o=t[0].transformation,l=(0,c.Ge)((0,h.vt)(),o);for(let c=0;c<i;c++){const e=t[c].attributes.get("position");if(!e)continue;const i=e.data,r=e.indices;for(let t=0;t<r.length;t+=3)xr(i,r,t,zr),yr(i,r,t,Tr,Mr,Dr),(0,p.g)(Tr,Tr,Mr),(0,p.g)(Tr,Tr,Dr),(0,p.h)(Tr,Tr,1/3),(0,p.t)(Tr,Tr,o),s.push(...Tr),(0,p.o)(zr,zr,l),(0,p.n)(zr,zr),(0,p.c)(Tr,Tr,zr,n),s.push(...Tr),a.push(a.length),a.push(a.length)}return s.length?new D.V(this._debugFaceNormalMaterial,[["position",new M.n(s,a,3,!0)]],null,2):null}_createPerVertexDebugVectors(e,t,i,r,n){const s=t.length,a=e.spatialReference.isGeographic?20015077/180:1,o=.1*n*Math.max(e.extent.width*a,e.extent.height*a,e.extent.zmax-e.extent.zmin),l=[],d=[],u=t[0].transformation,v=(0,c.Ge)((0,h.vt)(),u);"tangent"===i&&(0,c.z0)(v,u);for(let c=0;c<s;c++){const e=t[c],r=e.attributes.get("position"),n=e.attributes.get(i);if(!r||!n)continue;const s=r.data,a=r.indices,h=n.data,f=n.indices;for(let t=0;t<a.length;t++){const e=3*a[t],i=f[t]*n.stride;(0,p.j)(Tr,s[e+0],s[e+1],s[e+2]),(0,p.t)(Tr,Tr,u),l.push(...Tr),(0,p.j)(Mr,h[i+0],h[i+1],h[i+2]),(0,p.o)(Mr,Mr,v),(0,p.n)(Mr,Mr),(0,p.c)(Tr,Tr,Mr,o),l.push(...Tr),d.push(d.length),d.push(d.length)}}return l.length?new D.V(r,[["position",new M.n(l,d,3,!0)]],null,2):null}_createAs3DShape(e,t,i,r){const n=e.geometry;if("mesh"!==n.type)return null;const s=this._createGeometryInfo(n,t,r);if(null==s)return null;const{geometries:a,objectTransformation:o}=s;if(F.b.DRAW_MESH_GEOMETRY_NORMALS){const e=this._createPerVertexDebugVectors(n,a,"normal",this._debugVertexNormalMaterial,1),t=this._createPerVertexDebugVectors(n,a,"tangent",this._debugTangentNormalMaterial,.5),i=this._createFaceDebugNormals(n,a);e&&a.push(e),t&&a.push(t),i&&a.push(i)}const l=this._context.layerViewUid,c=new ee.B({geometries:a,layerViewUid:l,graphicUid:r,isElevationSource:!0});c.transformation=o;const h=(0,L.Cc)(this.symbolLayer,{opacity:this._getLayerOpacity()}),d=h?new S.H(a[0].material,h,this._context.slicePlaneEnabled):null,u=new Ci(this,c,null,Ye.G8,i,d);this._fastUpdateProcessor.onAddGraphic(),u.needsElevationUpdates=(0,w.Kf)(i.mode),u.useObjectOriginAsAttachmentOrigin=!0,u.fastTransformUpdatesAllowed=this._fastTransformUpdatesAllowed(n),i.centerInElevationSR=this._getCenterInElevationSR(c.transformation);const{elevationProvider:p,renderCoordsHelper:v}=this._context;return u.alignedSampledElevation=(0,Ye.G8)(u,i,p.spatialReference,(e,t)=>(0,w.sE)(e,p,i,v,t),v),u}_fastTransformUpdatesAllowed(e){const{vertexSpace:t,spatialReference:i}=e;if(!(0,fi.Hq)(t))return!1;const{type:r}=t,{view:n}=this._context.graphicsCoreOwner,{viewingMode:s}=n.state,a=n.spatialReference;return 1===s&&"local"===r||2===s&&(0,mi.aI)(a,i)&&"georeferenced"===r&&!i.isGeographic}_getElevationSR(){var e;return null!==(e=this._context.elevationProvider.spatialReference)&&void 0!==e?e:null}_getCenterInElevationSR(e){const t=(0,v.vt)(),i=(0,p.j)(Lr,e[12],e[13],e[14]);return(0,hi.F)(i,this._context.renderCoordsHelper.spatialReference,t,this._getElevationSR()),t}_passthroughReprojectionInfo(e){return 0===e.reprojection&&!!e.objectTransformation}_createPositionBuffer(e,t){const i=e.vertexAttributes.position;let r,n=i;if(0===t.reprojection)return{position:n,georeferencedPositionBuffer:r};const s=1===t.reprojection?t.transformBeforeProject:null;s&&(n=(0,y.t)(new Float64Array(n.length),n,s));const{normal:a,tangent:o}=e.vertexAttributes;this._passthroughReprojectionInfo(t)||!a&&!o||(r=n);const l=n===i||n===r?new Float64Array(n.length):n;return(0,G.projectBuffer)(n,e.spatialReference,0,l,this._context.renderCoordsHelper.spatialReference,0),{position:l,georeferencedPositionBuffer:r}}_createNormalBuffer(e,t,i,r){const n=e.vertexAttributes.normal;if(null==n)return null;let s=n;const a=1===r.reprojection?r.transformBeforeProject:null;a&&(s=(0,gi.qs)(s,new Float32Array(s.length),a));const o=this._context.graphicsCoreOwner.view.viewingMode;if(0===r.reprojection)return s;if("local"===o){if(!(0,mi.r1)(this._context.renderCoordsHelper.spatialReference))return s;if(null==i)return null;if(e.spatialReference.isGeographic){const e=s===n?new Float32Array(s.length):s;return(0,gi.gZ)(s,0,i,e)}if(e.spatialReference.isWebMercator){const e=s===n?new Float32Array(s.length):s;return(0,gi.GN)(s,0,i,e)}return s}if(null==i)return null;const l=s===n?new Float32Array(s.length):s,c=this._context.renderCoordsHelper.spatialReference;return(0,gi.X4)(s,i,e.spatialReference,t,c,l)}_createTangentBuffer(e,t,i,r){const n=e.vertexAttributes.tangent;if(null==n)return null;let s=n;const a=1===r.reprojection?r.transformBeforeProject:null;a&&(s=(0,gi.KM)(s,new Float32Array(s.length),a));const o=this._context.graphicsCoreOwner.view.viewingMode;if(0===r.reprojection)return s;if("local"===o){if(!(0,mi.r1)(this._context.renderCoordsHelper.spatialReference))return s;if(null==i)return null;if(e.spatialReference.isGeographic){const e=s===n?new Float32Array(s.length):s;return(0,gi.gZ)(s,1,i,e)}if(e.spatialReference.isWebMercator){const e=s===n?new Float32Array(s.length):s;return(0,gi.GN)(s,1,i,e)}return s}if(null==i)return null;const l=s===n?new Float32Array(s.length):s,c=this._context.renderCoordsHelper.spatialReference;return(0,gi.xA)(s,i,e.spatialReference,t,c,l)}_createSymbolColorBuffer(e){return this._requiresSymbolVertexColors()?new Uint8Array(this._getDrivenUInt8ColorWithNaNSupport(e,this._materialColor,!0)):null}_createBuffers(e,t){const i=e.vertexAttributes&&e.vertexAttributes.position;if(!i)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const r=e.vertexAttributes.normal,n=e.vertexAttributes.uv,s=e.vertexAttributes.tangent;if(r&&r.length!==i.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(s&&s.length/4!=i.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(n&&n.length/2!=i.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const a=this._computeReprojectionInfo(e),{position:o,georeferencedPositionBuffer:l}=this._createPositionBuffer(e,a),c=function(e){return e.vertexAttributes.color}(e),h=this._createSymbolColorBuffer(t),d=this._createNormalBuffer(e,o,l,a),p=this._createTangentBuffer(e,o,l,a),v=n,{transformation:f,position:m,normal:g,tangent:_}=this._passthroughReprojectionInfo(a)?{transformation:a.objectTransformation,position:o,normal:d,tangent:p}:this._transformOriginLocal(e,o,d,p);return{positionBuffer:m,normalBuffer:g,tangentBuffer:_,uvBuffer:v,colorBuffer:c,symbolColorBuffer:h,objectTransformation:f,geometryTransformation:0===a.reprojection&&a.geometryTransformation?a.geometryTransformation:(0,u.vt)()}}_computeReprojectionInfo(e){var t,i;const{vertexSpace:r}=e,n="georeferenced"===r.type?(0,mi.aI)(this._context.renderCoordsHelper.spatialReference,e.spatialReference)?0:1:0;if((0,fi.E9)(r))return{reprojection:n};const s=r.origin,a=(0,u.vt)(),o=null!==(t=null===(i=e.transform)||void 0===i?void 0:i.localMatrix)&&void 0!==t?t:u.zK;if(0===n)return(0,f.l)(e.spatialReference,s,a,this._context.renderCoordsHelper.spatialReference),{reprojection:n,objectTransformation:a,geometryTransformation:(0,u.o8)(o)};const l=(0,d.kN)((0,u.vt)(),s);return(0,d.lw)(l,l,o),{reprojection:n,transformBeforeProject:l}}_transformOriginLocal(e,t,i,r){var n;const s=this._context.renderCoordsHelper.spatialReference,a=e.origin;Rr[0]=a.x,Rr[1]=a.y,Rr[2]=null!==(n=a.z)&&void 0!==n?n:0;const o=(0,u.vt)();(0,f.l)(e.spatialReference,Rr,o,s),(0,d.B8)(Or,o);const{position:l,normal:c,tangent:h}=e.vertexAttributes,p=t===l?new Float64Array(t.length):t;(0,y.t)(p,t,Or);const v=i?i===c?new Float32Array(i.length):i:null,m=r?r===h?new Float32Array(r.length):r:null;return i&&v&&(0,gi.qs)(i,v,Or),r&&m&&(0,gi.KM)(r,m,Or),{transformation:o,position:p,normal:v,tangent:m}}_validateFaces(e,t){const i=e.vertexAttributes.position.length/3,r=t.faces;if(r){let e=-1;for(let t=0;t<r.length;t++){const i=r[t];i>e&&(e=i)}if(i<=e)return this.logger.warn("Vertex index ".concat(e," is out of bounds of the mesh position buffer")),!1}else if(i%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_isOutsideClippingArea(e){var t;if(!this._context.clippingExtent)return!1;if(!(null===(t=e.vertexAttributes)||void 0===t?void 0:t.position))return!1;const i=this._context.elevationProvider.spatialReference,r=(0,_i.projectMeshVertexPositions)(e,null!==i&&void 0!==i?i:e.spatialReference);return!!r&&((0,m.vY)(r,Er),!(0,m.KG)(Er,this._context.clippingExtent))}_createGeometryInfo(e,t,i){var r;if(!(0,ci.canProjectWithoutEngine)(e.spatialReference,this._context.renderCoordsHelper.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(!this._validateVertexSpace(e))return null;if(this._isOutsideClippingArea(e))return null;const n=this._createBuffers(e,t);if(null==n)return null;const{positionBuffer:s,uvBuffer:a,colorBuffer:o,symbolColorBuffer:l,normalBuffer:c,tangentBuffer:h,objectTransformation:u,geometryTransformation:p}=n,v=null!==(r=e.components)&&void 0!==r?r:Ir,f=new Array;let m=!1;const g=(0,d.sC)(Tr,u),y=this._context.localOriginFactory.getOrigin(g);for(const d of v){if(!this._validateFaces(e,d))return null;const t=mr(e,d);if(0===t.length)continue;const r=gr(s,c,d,t);r.didFlipNormals&&(m=!0);const n=[["position",new M.n(s,t,3,!0)],["normal",new M.n(r.normals,r.indices,3,!0)]];o&&n.push(["color",new M.n(o,t,4,!0)]),l&&n.push(["symbolColor",new M.n(l,(0,_.EH)(t.length),4,!0)]),a&&n.push(["uv0",new M.n(a,t,2,!0)]),h&&n.push(["tangent",new M.n(h,t,4,!0)]);const u=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:this._context.layerViewUid}),v=this._getOrCreateMaterial(e,d),g=new D.V(v,n,null,0,u);g.transformation=p,g.localOrigin=y,f.push(g)}return m&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:f,objectTransformation:u}}_updateMaterialParameters(e){this._materialInfoCache.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachClonedMaterial((e,t)=>{t.setParameters(e.parameters)})}_validateVertexSpace(e){const{_context:{graphicsCoreOwner:{view:{state:{viewingMode:t}}}}}=this,{vertexSpace:i}=e;return 2!==t||"local"!==i.type||(this.logger.warn("Displaying a mesh with a local vertex space in a view in local viewing mode is not supported."),!1)}test(){return(0,n.A)((0,n.A)({},super.test()),{},{materials:this._materialInfoCache.materials})}get _materialColor(){var e;return null===(e=this.symbolLayer.material)||void 0===e?void 0:e.color}}class fr{constructor(e,t,i){this.normals=e,this.indices=t,this.didFlipNormals=i}}function mr(e,t){var i;return null!==(i=t.faces)&&void 0!==i?i:(0,_.tM)(e.vertexAttributes.position.length/3)}function gr(e,t,i,r){switch(i.shading||"flat"){default:case"source":return function(e,t,i,r){if(null==t)return _r(e,r);let n=!1;if(!i.trustSourceNormals)for(let s=0;s<r.length;s+=3){xr(e,r,s,zr);for(let e=0;e<3;e++){const i=3*r[s+e];Tr[0]=t[i],Tr[1]=t[i+1],Tr[2]=t[i+2],(0,p.f)(zr,Tr)<0&&(t[i]=-t[i],t[i+1]=-t[i+1],t[i+2]=-t[i+2],n=!0)}}return new fr(t,r,n)}(e,t,i,r);case"flat":return _r(e,r);case"smooth":return function(e,t){const i={};for(let s=0;s<t.length;s+=3){const r=xr(e,t,s,zr);for(let e=0;e<3;e++){const n=t[s+e];let a=i[n];a||(a={normal:(0,v.vt)(),count:0},i[n]=a),(0,p.g)(a.normal,a.normal,r),a.count++}}const r=(0,di.oe)(3*t.length),n=new Array(3*t.length);for(let s=0;s<t.length;s++){const e=i[t[s]];1!==e.count&&((0,p.n)(e.normal,e.normal),e.count=1);for(let t=0;t<3;t++)r[3*s+t]=e.normal[t];n[s]=s}return new fr(r,n,!1)}(e,r)}}function _r(e,t){const i=(0,di.oe)(t.length),r=new Array(3*t.length);for(let n=0;n<t.length;n+=3){const s=xr(e,t,n,zr);for(let e=0;e<3;e++)i[n+e]=s[e],r[n+e]=n/3}return new fr(i,r,!1)}function yr(e,t,i,r,n,s){const a=3*t[i],o=3*t[i+1],l=3*t[i+2];r[0]=e[a],r[1]=e[a+1],r[2]=e[a+2],n[0]=e[o],n[1]=e[o+1],n[2]=e[o+2],s[0]=e[l],s[1]=e[l+1],s[2]=e[l+2]}function xr(e,t,i,r){return yr(e,t,i,Tr,Mr,Dr),(0,p.e)(Mr,Mr,Tr),(0,p.e)(Dr,Dr,Tr),(0,p.i)(Tr,Mr,Dr),(0,p.n)(r,Tr),r}function br(e){if(!e)return null;const{scale:t,offset:i,rotation:r}=e;return{scale:t,offset:i,rotation:(0,li.kU)(r)}}function wr(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"repeat";if("string"==typeof e){const t=Sr(e);return{s:t,t:t}}return{s:Sr(e.horizontal),t:Sr(e.vertical)}}function Sr(e){switch(e){case"clamp":return 33071;case"mirror":return 33648;default:return 10497}}function Cr(e){return null==e?"-":e instanceof Te.A?e.toHex():e.contentHash}function Pr(e){const{offset:t,scale:i,rotation:r}=null!==e&&void 0!==e?e:Ar;return"".concat(t[0],",").concat(t[1],",").concat(r,",").concat(i[0],",").concat(i[1])}const Ar=new vi.A,Rr=(0,v.vt)(),Tr=(0,v.vt)(),Mr=(0,v.vt)(),Dr=(0,v.vt)(),zr=(0,v.vt)(),Or=(0,u.vt)(),Vr=(0,u.vt)(),Er=(0,m.vt)(),Ir=[new ui.A],Lr=(0,v.vt)();var Ur=i(47675),Fr=i(72733),kr=i(35416);class Gr{constructor(e,t,i,r,n){this.graphics3DSymbolLayer=e,this.instanceIndex=t,this.elevationAligner=i,this.elevationContext=r,this._highlightOrderMap=n,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1,this._highlightName=null}initialize(){}setVisibility(e){const{instanceData:t}=this;e!==t.getVisible(this.instanceIndex)&&t.setVisible(this.instanceIndex,e)}destroy(){null!=this.instanceIndex&&(this.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}get usedMemory(){return this.graphics3DSymbolLayer.usedMemory}alignWithElevation(e,t){if(this.elevationAligner){const i=(i,r)=>(0,w.sE)(i,e,this.elevationContext,t,r),r=this.elevationAligner(this,this.elevationContext,e.spatialReference,i,t);null!=r&&(this.alignedSampledElevation=r)}}getCenterObjectSpace(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,v.vt)();return this.instanceData.getCombinedLocalTransform(this.instanceIndex,Wr),(0,p.t)(e,this._lodRenderer.baseBoundingSphere.center,Wr)}getBoundingBoxObjectSpace(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,m.vt)();this.instanceData.getCombinedLocalTransform(this.instanceIndex,Wr);const t=this._lodRenderer.baseBoundingBox;(0,m.Ie)(e);for(let i=0;i<8;++i)(0,p.j)(Hr,1&i?t[3]:t[0],2&i?t[4]:t[1],4&i?t[5]:t[2]),(0,p.t)(Hr,Hr,Wr),(0,m.iT)(e,Hr);return e}computeAttachmentOrigin(e){this.instanceData.getGlobalTransform(this.instanceIndex,Wr),e.render.origin[0]+=Wr[12],e.render.origin[1]+=Wr[13],e.render.origin[2]+=Wr[14],e.render.num++}async getProjectedBoundingBox(e,t,i,r,n){const s=this.getBoundingBoxObjectSpace(n),a=Nr,o=(0,m.fT)(s)?1:a.length;this.instanceData.getGlobalTransform(this.instanceIndex,Wr);for(let h=0;h<o;h++){const e=a[h];Hr[0]=s[e[0]],Hr[1]=s[e[1]],Hr[2]=s[e[2]],(0,p.t)(Hr,Hr,Wr),Br[3*h]=Hr[0],Br[3*h+1]=Hr[1],Br[3*h+2]=Hr[2]}if(!e(Br,0,o))return null;(0,m.Ie)(s);let l=null;this.calculateRelativeScreenBounds&&(l=this.calculateRelativeScreenBounds());for(let h=0;h<3*o;h+=3){for(let e=0;e<3;e++)s[e]=Math.min(s[e],Br[h+e]),s[e+3]=Math.max(s[e+3],Br[h+e]);l&&i.push({location:Br.slice(h,h+3),screenSpaceBoundingRect:l})}if(t&&((0,m.gX)(s,jr),"absolute-height"!==this.elevationContext.mode)){let e;const i=(0,P.vY)(s,t.service.spatialReference,t);try{e=await t.service.queryElevation(jr[0],jr[1],r,i,"ground")}catch(c){}null!=e&&(0,m.cY)(s,0,0,-this.alignedSampledElevation+e)}return s}addObjectState(e){0===e.stateType&&this.addObjectHighlightState(e)}addObjectHighlightState(e){const t=new kr.h(e.highlightName);this._addHighlightId(t),e.addExternal(e=>{this._removeHighlightId(e)},t)}removeObjectState(e){this._highlights.forEach(t=>e.remove(t))}updateHighlights(e){this._highlightOrderMap=e,this._updateHighlightOptions()}_calculateHighlightOptions(){let e=-1,t=null;return this._highlights.forEach(i=>{let{highlightName:r}=i;const n=this._highlightOrderMap.get(r);void 0!==n&&n>e&&(e=n,t=r)}),t}_addHighlightId(e){this._highlights.add(e),this._updateHighlightOptions()}_removeHighlightId(e){this._highlights.delete(e),this._updateHighlightOptions()}_updateHighlightOptions(){const e=this._calculateHighlightOptions();e!==this._highlightName&&(this._highlightName=e,this.instanceData.setHighlight(this.instanceIndex,e))}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}get instanceData(){return this._lodRenderer.instanceData}}const Br=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Hr=(0,v.vt)(),jr=(0,v.vt)(),Nr=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],Wr=(0,u.vt)();var Zr=i(12062);function qr(e,t){const i=e.stageResources.geometries.map(t=>new Zr.iC(new Zr.dI(t),e.stageResources.textures)),r=null==e.lodThreshold||0===e.lodThreshold&&t>0?function(e){const t=e.reduce((e,t)=>e+t.numTriangles,0);return Math.sqrt(t*Yr/Math.PI)}(i):e.lodThreshold;return new Zr.hr(i,r,e.pivotOffset)}const Yr=20;var Qr=i(39513),Xr=i(73177),Kr=i(61693),$r=i(26314);var Jr=i(18690),en=i(87663),tn=i(46053),rn=i(87990),nn=i(57481),sn=i(33062),an=i(60586),on=i(89596),ln=i(42589),cn=i(78315),hn=i(94966),dn=i(94536);class un extends dn.x{constructor(e,t){super(e=>(0,cn.A)(this._instanceData.view.boundingSphere.getVec(e,pn)),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=t,this._tmpSphere=(0,cn.c)(),this._tmpMat4=(0,u.vt)()}addInstance(e){const t=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);(0,cn.q)(this._tmpSphere,this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*(0,hn.hG)(i),t.setVec(e,(0,cn.y)(this._tmpSphere)),this.add([e])}removeInstance(e){this.remove([e])}}const pn=(0,Ue.vt)();class vn{constructor(e,t){this._worldSpaceRadius=e,this._minScreenSpaceRadii=t}selectLevel(e,t,i){const r=i.computeScreenPixelSizeAt(e),n=this._worldSpaceRadius*t/r;let s=0;for(let a=1;a<this._minScreenSpaceRadii.length;++a)n>=this._minScreenSpaceRadii[a]&&(s=a);return s}}class fn{constructor(e,t){this._material=e,this._repository=t,this._map=new Map}dispose(){this._map.forEach((e,t)=>{null!=e&&this._repository.release(this._material,t)})}load(e,t,i){const r=this._material.produces.get(t);if(null===r||void 0===r||!r(i))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,t,i));const n=this._map.get(i);if(n){if(2===n.ensureResources(e))return n;this._repository.requestRender()}return null}}var mn=i(69008),gn=i(9243);class _n{constructor(e,t){this.geometry=t;const i=e.renderContext.rctx,r=t.renderGeometry,{material:n,layout:s,buffer:a}=r;this._materials=e.materials,n.setParameters({instancedDoublePrecision:!0}),this.glMaterials=new fn(n,this._materials),this.vbo=new gn.R(i,(0,nn.U)(s),a),this.vao=new mn.Z(i,this.vbo)}destroy(){this.glMaterials.dispose(),this.vbo.dispose(),this.vao.dispose()}get material(){return this.geometry.renderGeometry.material}get layout(){return this.geometry.renderGeometry.layout}get boundingInfo(){return this.geometry.boundingInfo}get numTriangles(){return this.numVertices/3}get numVertices(){return this.geometry.renderGeometry.numVertices}get usedMemory(){return 128+this.vbo.usedMemory+this.vao.usedMemory}intersect(e,t,i,r,n,s,a,o){return this.geometry.intersect(e,t,i,r,n,s,a,o)}}class yn{static async create(e,t,i){const r=await Promise.allSettled(t.components.map(t=>e.controller.schedule(()=>new _n(e,t.geometry),i))),n=r.map(e=>"fulfilled"===e.status?e.value:null).filter(Jr.Ru);if((0,Oe.G4)(i)||n.length!==r.length){n.forEach(e=>e.destroy()),(0,Oe.Te)(i);for(const e of r)if("rejected"===e.status)throw e.reason}return new yn(t.minScreenSpaceRadius,n)}constructor(e,t){this.minScreenSpaceRadius=e,this.components=t}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,t,i,r,n,s,a){this.components.forEach(o=>o.intersect(e,t,i,r,n,s,this.boundingSphere,a))}get boundingBox(){if(null==this._boundingBox){const e=(0,m.Ie)();this.components.forEach(t=>{null!=t.boundingInfo&&((0,m.iT)(e,t.boundingInfo.bbMin),(0,m.iT)(e,t.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(null==this._boundingSphere){const e=this.boundingBox,t=(0,v.vt)();(0,m.gX)(e,t),this._boundingSphere={center:t,radius:.5*(0,m._F)(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,t)=>e+t.numTriangles,0)}}var xn=i(53760),bn=i(99362),wn=i(68967),Sn=i(37267),Cn=i(1723),Pn=i(59752),An=i(27207),Rn=i(75757);let Tn=class extends an.Cc{constructor(e,t){super(e),this.type=3,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=new Array,this._highlightRenderInstanceDatas=new Map,this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new sn.A,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.produces=new Map([[2,e=>this._produces(e)],[4,e=>!!this._hasTransparentLevels()&&this._produces(e)]]),this._instanceData=new ln.e7({shaderTransformation:e.shaderTransformation},e.symbol.materialParameters),this.addHandles(t.registerTask(Pn.W6.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=(0,xn.Qm)(this.symbol.materialParameters),this._glInstanceBufferLayout=(0,nn.U)(this._instanceBufferLayout,1),this.addHandles([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",e=>{let{index:t}=e;this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(t)}),this._instanceData.events.on("instance-visibility-changed",e=>{let{index:t}=e;this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(t)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}get _allRenderInstanceData(){return[this._defaultRenderInstanceData,...this._highlightRenderInstanceDatas.values()]}get _allRenderInstanceDataExceptHighlightShadow(){const e=[this._defaultRenderInstanceData];for(const t of this._highlightRenderInstanceDatas)t[0]!==Cn.Tv&&e.push(t[1]);return e}hasHighlight(e){return this._highlightRenderInstanceDatas.has(e)}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerViewUid(){return this.metadata.layerViewUid}get instanceData(){return this._instanceData}get hasEmitters(){return this._levels.some(e=>e.components.some(e=>e.material.hasEmissions))}get usedMemory(){return this._allRenderInstanceData.reduce((e,t)=>t.reduce((e,t)=>e+t.usedMemory,e),this._levels.reduce((e,t)=>e+t.components.reduce((e,t)=>e+t.usedMemory,0),0))}get renderStats(){const e=this._instanceData.size,t=[];return this._levels.forEach((e,i)=>{const r=this._allRenderInstanceData[0][i].size+this._allRenderInstanceData[1][i].size,n=e.triangleCount;t.push({renderedInstances:r,renderedTriangles:r*n,trianglesPerInstance:n})}),{totalInstances:e,renderedInstances:t.reduce((e,t)=>e+t.renderedInstances,0),renderedTriangles:t.reduce((e,t)=>e+t.renderedTriangles,0),levels:t}}_createRenderInstanceDataArray(){const{rctx:e}=this._context.renderContext;return this.symbol.levels.map(t=>new xn.Ui(e,this._instanceBufferLayout))}async initializeRenderContext(e,t){this._context=e,this._defaultRenderInstanceData=this._createRenderInstanceDataArray();const i=await Promise.allSettled(this.symbol.levels.map(i=>yn.create(e,i,t))),r=i.map(e=>"fulfilled"===e.status?e.value:null).filter(Jr.Ru);if((0,Oe.G4)(t)||r.length!==i.length){r.forEach(e=>e.destroy()),(0,Oe.Te)(t);for(const e of i)if("rejected"===e.status)throw e.reason}this._levels=r,this._levelSelector=(e=>{const t=e.baseBoundingSphere.radius,i=e.levels.map(e=>e.minScreenSpaceRadius);return new vn(t,i)})(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData.forEach(e=>e.destroy()),this._highlightRenderInstanceDatas.forEach(e=>e.forEach(e=>e.destroy()))}_hasTransparentLevels(){return this._levels.some(e=>e.components.some(e=>{const t=e.material.produces.get(4);return null===t||void 0===t?void 0:t(0)}))}hasHighlights(){return(0,en.Bs)(this._highlightRenderInstanceDatas,e=>e.some(e=>e.size>0))}_produces(e){return(9!==e||this.hasHighlights())&&(5!==e||this.hasHighlight(Cn.Tv))}prepareRender(e){if(!F.b.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const t=e.bind.contentCamera.equals(this._camera);this._camera.copyFrom(e.bind.contentCamera),t||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(Pn.Bb),this._needFullCycle=!1)}}acquireTechniques(e){if(!this.baseMaterial.visible||!this.baseMaterial.isVisibleForOutput(e.output))return null;const t=this._getInstanceDatas(e);if(!t)return null;const i=new Array,r=this.levels;return t.forEach(t=>r.forEach((r,n)=>{let{components:s}=r;return s.forEach(r=>i.push(this._beginComponent(e,t[n],r)))})),i}render(e,t){const i=this._getInstanceDatas(e);if(!i||null==t)return;let r=0;const n=this.levels;i.forEach(i=>n.forEach((n,s)=>{let{components:a}=n;return a.forEach(n=>this._renderComponent(e,t[r++],i[s],n,s))})),e.rctx.unbindBuffer(34962),e.rctx.bindVAO(null)}_getInstanceDatas(e){const{output:t,bind:i}=e,r=9===t,n=5===t,s=6!==t;if(!r&&!n)return s?this._allRenderInstanceData:this._allRenderInstanceDataExceptHighlightShadow;const{_highlightRenderInstanceDatas:a}=this;if(s){if(r){var o;const e=null===(o=i.highlight)||void 0===o?void 0:o.name;if(!e)return null;const t=a.get(e);return t?[t]:null}const e=a.get(Cn.Tv);return n?e?[e]:null:Array.from(a.values())}return null}intersect(e,t,i,r){if(!this.baseMaterial.visible||null==this._octree)return;const n=(0,v.vt)();(0,p.e)(n,r,i);const s=n=>{this._instanceData.getCombinedModelTransform(n,On),e.transform.set(On),(0,p.t)(Vn,i,e.transform.inverse),(0,p.t)(En,r,e.transform.inverse);const s=this._instanceData.getState(n),a=this._instanceData.getLodLevel(n),o=this._levels.length;4&s&&((0,ki.vA)(!!(18&s),"invalid instance state"),(0,ki.vA)(a>=0&&a<o,"invaid lod level"),this._levels[a].intersect(e,t,Vn,En,n,this.metadata,o))};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(s):this._octree.forEachAlongRay(i,n,s)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(null==this._octreeCached){var e;const t=this._instanceData,i=null===(e=t.view)||void 0===e?void 0:e.state;if(!i)return null;this._octreeCached=new un(t,this.baseBoundingSphere);for(let e=0;e<t.capacity;++e)18&i.get(e)&&this._octreeCached.addInstance(e)}return this._octreeCached}_invalidateOctree(){this._octreeCached=(0,ze.pR)(this._octreeCached)}queryDepthRange(e){if(null==this._octree)return new on.d;const t=e.viewForward,i=this._octree.findClosest(t,1,e.frustum),r=this._octree.findClosest(t,-1,e.frustum);if(null==i||null==r)return new on.d;const n=e.eye,s=this._instanceData.view;s.boundingSphere.getVec(i,zn),(0,p.e)(zn,zn,n);const a=(0,p.f)(zn,t)-zn[3];s.boundingSphere.getVec(r,zn),(0,p.e)(zn,zn,n);const o=(0,p.f)(zn,t)+zn[3];return new on.d(a,o)}_requestUpdateCycle(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.startUpdateCycle()))}get readyToRun(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:t,_camera:i,_levelSelector:r}=this;this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.beginUpdate()));const n=this._instanceData,s=n.view;let a=n.size;const o=n.capacity;let l=this._instanceIndex;const c=Math.ceil(o/500),{_highlightRenderInstanceDatas:h}=this;for(let d=0;d<a&&!e.done;++d){l===this._cycleStartIndex&&this._startUpdateCycle();const d=s.state.get(l);let u=0;if(!(1&d)){l=l+1===o?0:l+1,a++;continue}const p=s.lodLevel.get(l);if(2&d&&this._defaultRenderInstanceData[p].freeTail(),16&d){const e=n.geHighlightOptionsPrev(l);if(e){const t=h.get(e);if(!t)throw new De.A("internal:lod-renderer","Internal error in lodRenderer");t[p].freeTail(),t.every(e=>e.isEmpty)&&(t.forEach(e=>e.destroy()),h.delete(e))}}if(32&d)n.freeInstance(l);else if(4&d){let e=0;if(t&&(s.modelOrigin.getVec(l,Dn),e=r.selectLevel(Dn,n.getCombinedMedianScaleFactor(l),i)),u=-83&d,e>=0)if(8&d){const t=n.getHighlightName(l);if(t){const i=()=>{const e=this._createRenderInstanceDataArray();return e.forEach(e=>e.beginUpdate()),e},r=(0,en.tE)(h,t,i);if(e>=r.length)throw new De.A("internal:lod-renderer","LodRenderer internal error - missing lodLevel ".concat(e));Mn(r[e],s,l)}u|=16}else Mn(this._defaultRenderInstanceData[e],s,l),u|=2;s.state.set(l,u),s.lodLevel.set(l,e)}else u=-83&d,s.state.set(l,u);const v=!!(18&d),f=!!(18&u);null!=this._octreeCached&&(!v&&f?this._octreeCached.addInstance(l):v&&!f?this._octreeCached.removeInstance(l):v&&f&&64&d&&(this._octreeCached.removeInstance(l),this._octreeCached.addInstance(l))),l=l+1===o?0:l+1,l%c===0&&e.madeProgress(),v!==f&&this.metadata.notifyGraphicVisibilityChanged(l),f&&64&d&&this.metadata.notifyGraphicGeometryChanged(l)}this._instanceIndex=l,this._allRenderInstanceData.forEach(e=>e.forEach(e=>e.endUpdate())),this._context.requestRender()}_beginComponent(e,t,i){if(0===t.size)return null;const r=i.glMaterials.load(e.rctx,e.bind.slot,e.output);return null===r||void 0===r?void 0:r.beginSlot(e.bind)}_renderComponent(e,t,i,r,n){if(!t)return;const{bind:s,rctx:a}=e;a.runAppleAmdDriverHelper();const o=a.bindTechnique(t,s,r.material.parameters,Ln),l=this._glInstanceBufferLayout;o.assertCompatibleVertexAttributeLocations(r.vao,(0,Rn.Xk)(l)),a.bindVAO(r.vao),F.b.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===e.output&&(o.setUniform4fv("externalColor",In[Math.min(n,In.length-1)]),o.setUniform1i("symbolColorMixMode",bn.Um.replace));const c=i.capacity,h=i.headIndex,d=i.tailIndex,u=i.firstIndex,p=(e,n)=>{(0,An.yu)(a,o.locations,i.buffer,e),a.drawArraysInstanced(t.primitiveType,0,r.numVertices,n-e)};r.material.transparent&&null!=u?h>d?((0,ki.vA)(u>=d&&u<=h,"invalid firstIndex"),p(u,h),p(d,u)):h<d&&(u<=h?((0,ki.vA)(u>=0&&u<=h,"invalid firstIndex"),p(u,h),p(d,c),p(0,u)):((0,ki.vA)(u>=d&&u<=c,"invalid firstIndex"),p(u,c),p(0,h),p(d,u))):h>d?p(d,h):h<d&&(p(0,h),p(d,c))}};function Mn(e,t,i){const r=e.allocateHead();!function(e,t,i,r){(0,wn.Vk)(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,r),i.model.copyFrom(r,e.model,t),i.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(r,e.color,t),e.olidColor&&i.olidColor&&i.olidColor.copyFrom(r,e.olidColor,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(r,e.featureAttribute,t)}(t,i,e.view,r)}(0,Nt.Cg)([(0,tn.MZ)({constructOnly:!0})],Tn.prototype,"symbol",void 0),(0,Nt.Cg)([(0,tn.MZ)({constructOnly:!0})],Tn.prototype,"metadata",void 0),(0,Nt.Cg)([(0,tn.MZ)({constructOnly:!0})],Tn.prototype,"shaderTransformation",void 0),(0,Nt.Cg)([(0,tn.MZ)()],Tn.prototype,"_instanceData",void 0),(0,Nt.Cg)([(0,tn.MZ)()],Tn.prototype,"_cycleStartIndex",void 0),(0,Nt.Cg)([(0,tn.MZ)({readOnly:!0})],Tn.prototype,"_enableLevelSelection",null),(0,Nt.Cg)([(0,tn.MZ)()],Tn.prototype,"_updateCyclesWithStaticCamera",void 0),(0,Nt.Cg)([(0,tn.MZ)({readOnly:!0})],Tn.prototype,"readyToRun",null),Tn=(0,Nt.Cg)([(0,rn.$)("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],Tn);const Dn=(0,v.vt)(),zn=(0,Ue.vt)(),On=(0,u.vt)(),Vn=(0,v.vt)(),En=(0,v.vt)(),In=[(0,Ue.CN)(1,0,1,1),(0,Ue.CN)(0,0,1,1),(0,Ue.CN)(0,1,0,1),(0,Ue.CN)(1,1,0,1),(0,Ue.CN)(1,0,0,1)],Ln=new Sn.V;class Un{constructor(e,t,i,r,n,s,a,o,l,c){let h=arguments.length>10&&void 0!==arguments[10]?arguments[10]:null;this.lodResources=e,this.lodRenderer=t,this.stageResources=i,this.resourceSize=r,this.isEsriSymbolResource=n,this.isWosr=s,this.resourceBoundingBox=a,this.symbolSize=o,this.extentPadding=l,this.physicalBasedRenderingEnabled=c,this.pivotOffset=h}}class Fn extends C.UF{getCachedSize(){const[e,t,i]=null!=this._resources?this._resources.symbolSize:[1,1,1];return{width:e,depth:t,height:i}}constructor(e,t,i,r){super(e,t,i,r,function(e){var t,i,r;return 1===(null!==(t=null===(i=e.material)||void 0===i||null===(i=i.color)||void 0===i?void 0:i.a)&&void 0!==t?t:0)&&null==(null===(r=e.resource)||void 0===r?void 0:r.href)}(t)),this._resources=null,this._instanceIndexToGraphicUid=new Map,this._hasLoadedPBRTextures=!1,this._disposeResourceHandles=new Array,this.skipHighSymbolLodsChanged=!1,this.ensureDrapedStatus(!1),this._hasLoadedPBRTextures=i.physicalBasedRenderingEnabled}async doLoad(e){if(!this._drivenProperties.size){const e=(0,P.Hj)(this.symbolLayer);if(e)throw new Error(e)}if(this._isPrimitive){const t=this.symbolLayer.resource,i=t&&(0,Xr.k)(null===t||void 0===t?void 0:t.primitive)?t.primitive:Ur.r;this._resources=await this._createResourcesForPrimitive(i,e)}else{var t,i;const r=await async function(e){var t;if(null==e||null==e.styleName&&null==e.styleUrl)return null;const i=e.name;if(null==i)throw new De.A("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference");const r={portal:e.portal},n=await(0,Kr.cF)(e,r).catch(()=>null);if(null===n)return null;const s=(0,$r.p)(i,n.data);if(s&&(null===(t=s.formatInfos)||void 0===t||!t.some(e=>"gltf_basisu"===e.type)))return null;const a=await(0,$r.I)(n,i,r,Kr.o5,{acceptedFormats:["web-gltf-basisu","web-gltf","web"]}).catch(()=>null);if(null===a||"point-3d"!==a.type)return null;const o=a.symbolLayers.items[0];return"object"===o.type?o.resource:null}(this.symbol.styleOrigin),n=null!==(t=null===r||void 0===r?void 0:r.href)&&void 0!==t?t:null===(i=this.symbolLayer.resource)||void 0===i?void 0:i.href;this._resources=await this._createResourcesForUrl(n,e)}this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.updateComplexity()}get extentPadding(){return null!=this._resources?this._resources.extentPadding:0}get _isPrimitive(){return null!=this._primitive}get lodRenderer(){var e;return null===(e=this._resources)||void 0===e?void 0:e.lodRenderer}get materials(){var e,t;return null!==(e=null===(t=this._resources)||void 0===t?void 0:t.stageResources.materials)&&void 0!==e?e:[]}async _createResourcesForPrimitive(e,t){var i,r,n;const s=this.symbolLayer,a=(0,m.vt)((0,Fr.Fq)(e)),o=(0,v.ci)((0,m.Ej)(a)),l=(0,v.ci)((0,Fr.Bb)(o,s)),c=(0,p.b)(l),h=null===s||void 0===s?void 0:s.material,d={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:ur.Bt,ambient:v.Un,diffuse:v.Un,opacity:1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:s.castShadows,emissiveStrength:null!==(i=null===h||void 0===h||null===(r=h.emissive)||void 0===r?void 0:r.strength)&&void 0!==i?i:0,emissiveSource:1,offsetTransparentBackfaces:!1,drivenOpacity:this.needsDrivenTransparentPass},u=!!d.usePBR,f=this.symbol;"point-3d"===f.type&&f.verticalOffset&&(d.verticalOffset=new lt.yc(f.verticalOffset),d.castShadows=!1),this._context.screenSizePerspectiveEnabled&&(d.screenSizePerspective=this.view.screenSizePerspective.parameters),this._hasDrivenColorOrOpacity?d.externalColor=C.Z$:d.externalColor=null!==(n=Te.A.toUnitRGBA(this._materialColor))&&void 0!==n?n:Ue.uY,this._fastUpdates=(0,at.s_)(this._context.renderer,this._fastVisualVariableConvertOptions(a,l,o,null)),d.instanced=!0,this._fastUpdates?(Object.assign(d,this._fastUpdates.materialParameters),d.instancedFeatureAttribute=!0):this._hasDrivenColorOrOpacity&&(d.instancedColor=!0);const g=new te.$U(d,this._context);g.setParameters({cullFace:Bn(g.transparent)});const _=(0,Xr._)(e,g);if(!_)throw new Error("Unknown object symbol primitive: ".concat(e));const y=await this._createStageResources(_,u,t),x=await this._createLodRenderer(_,t);return new Un(_,x,y,o,!1,!1,a,l,c,u)}async _createResourcesForUrl(e,t){const i={instanced:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},r={spherical:this._context.spherical,materialParameters:i,streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache,compressionOptions:{compressionTracker:this._context.compressionTracker,compressionCallback:()=>this.updateComplexity()}};this._fastUpdates=(0,at.s_)(this._context.renderer,this._fastVisualVariableConvertOptions(null,null,null,null)),this._fastUpdates?(Object.assign(r.materialParameters,this._fastUpdates.materialParameters),r.materialParameters.instancedFeatureAttribute=!0):this._hasDrivenColorOrOpacity&&(r.materialParameters.instancedColor=!0);const s=this.symbol;if("point-3d"===s.type&&s.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=s.verticalOffset;r.materialParameters.verticalOffset={screenLength:(0,Ve.Lz)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0},r.materialParameters.castShadows=!1}const a=this._context.physicalBasedRenderingEnabled;r.signal=t,r.usePBR=a,r.skipHighLods=this._context.skipHighSymbolLods;const o=await(0,Qr.fetch)(e,r),l=o.isEsriSymbolResource,c=o.isWosr,h=function(e){return new Zr.Fe(e.map((e,t)=>qr(e,t)))}(o.lods),d=this._context,u=this.symbolLayer.material,f=this._getExternalColorParameters(u),g=this.needsDrivenTransparentPass,_=h.getMaterials();_.forEach(e=>{e.setParameters((0,n.A)((0,n.A)({},f),{},{drivenOpacity:g})),d.screenSizePerspectiveEnabled&&e.setParameters({screenSizePerspective:this.view.screenSizePerspective.parameters})});const y=o.referenceBoundingBox,x=(0,v.ci)((0,m.Ej)(y)),b=(0,v.ci)(h.levels[0].pivotOffset),w=(0,v.ci)((0,Fr.Bb)(x,this.symbolLayer)),S=(0,p.b)(w),C=this._fastUpdates;(0,at.J_)(C,this._context.renderer,this._fastVisualVariableConvertOptions(y,w,x,b))&&_.forEach(e=>e.setParameters(C.materialParameters));const P=await this._createStageResources(h,a,t),A=await this._createLodRenderer(h,t);return new Un(h,A,P,x,l,c,y,w,S,a,b)}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createStageResources(e,t,i){const r=this._context.stage,n=e.getMaterials();t!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();const s=e.getTextures();r.addTextures(s),this._addDisposeResource(()=>{s.forEach(e=>e.unload()),r.removeTextures(s)}),await Promise.all(s.map(e=>this._context.stage.schedule(()=>e.load(r.renderView.renderingContext),i))),(0,Oe.Te)(i);const a=e.getEngineGeometries();return{materials:n,textures:s,geometries:a}}async _createLodRenderer(e,t){const i=this._context.stage,r={layerViewUid:this._context.layerViewUid,graphicUid:e=>this._instanceIndexToGraphicUid.get(e),notifyGraphicGeometryChanged:e=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(e)),notifyGraphicVisibilityChanged:e=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(e))},n=this._fastUpdates,s=new Tn({symbol:e,metadata:r,shaderTransformation:n?{applyTransform:(e,t,i)=>{e.getFeatureAttribute(t,Wn),(0,d.C)(i,(0,at.b3)(n.materialParameters,Wn,i))},scaleFactor:(e,t,i)=>{t.getFeatureAttribute(i,Wn),(0,at.VC)(e,n.materialParameters,Wn)}}:null},this._context.scheduler);return s.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource(()=>{i.removeRenderPlugin(s),s.destroy()}),await i.addRenderPlugin(s,t),s}_getExternalColorParameters(e){var t,i,r,n;const s={};if(s.externalColor=C.Z$,!this._drivenProperties.color&&null!=(null===e||void 0===e?void 0:e.color)){const t=Te.A.toUnitRGBA(e.color);this._drivenProperties.opacity&&(t[3]=NaN),s.externalColor=t}return s.emissiveStrength=null!==(t=null===e||void 0===e||null===(i=e.emissive)||void 0===i?void 0:i.strength)&&void 0!==t?t:1,s.emissiveSource=(0,yi.rs)(null!==(r=null===e||void 0===e||null===(n=e.emissive)||void 0===n?void 0:n.source)&&void 0!==r?r:"emissive"),s}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach(e=>e()),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry))return null;const i=(0,st.ZX)(t.geometry);if(null==i)return this.logger.warn("unsupported geometry type for object symbol: ".concat(t.geometry.type)),null;const r=this.createElevationContextForGraphic(t),n=e.renderingInfo;return this._createAs3DShape(t,i,n,r,t.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(null==this._resources)return;const e=this._getLayerOpacity(),t=this._resources.stageResources.materials;for(let i=0;i<t.length;i++){const r=t[i];r.setParameters({layerOpacity:e}),this._isPrimitive&&r.setParameters({cullFace:Bn(r.transparent)})}}layerScreenSizePerspectiveChanged(){if(null==this._resources)return;const e=this._context.screenSizePerspectiveEnabled?this.view.screenSizePerspective.parameters:null;for(const t of this._resources.stageResources.materials)t.setParameters({screenSizePerspective:e})}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,w.Kf)}slicePlaneEnabledChanged(){if(null==this._resources)return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(null==this._resources)return!0;const{stageResources:e,isWosr:t}=this._resources;for(const i of e.materials)this._isPrimitive?i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):t||i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return!1!==this._hasLoadedPBRTextures||!0!==this._context.physicalBasedRenderingEnabled||(this._hasLoadedPBRTextures=!0,!1)}applyRendererDiff(e,t){if(null==this._resources)return 0;const{stageResources:{materials:i},lodRenderer:r,resourceBoundingBox:n,symbolSize:s,resourceSize:a,pivotOffset:o}=this._resources;for(const l in e.diff){if("visualVariables"!==l)return 0;if(!(0,at.J_)(this._fastUpdates,t,this._fastVisualVariableConvertOptions(n,s,a,o)))return 0;for(const e of i)e.setParameters(this._fastUpdates.materialParameters);r.notifyShaderTransformationChanged()}return 2}computeComplexity(){if(null==this._resources)return super.computeComplexity();const e=this._resources.lodResources,t=(0,wi.pg)(e.levels),i=e.computeUsedMemory(),r=(0,n.A)((0,n.A)({},(0,wi.GI)(this.symbol,this.symbolLayer)),{},{resourceBytes:i});return new Ii.rz({verticesPerFeature:t,memory:r})}_hasLodRenderer(){return null!=this._resources}_createAs3DShape(e,t,i,r,n){if(!this._hasLodRenderer()||null==this._resources)return null;const s=this.getFastUpdateAttrValues(e),a=this._context.clippingExtent;if((0,Fe.g)(t,Hn,this._context.elevationProvider.spatialReference),null!=a&&!(0,m.Uc)(a,Hn))return null;const o=Gn(r),l=this._computeGlobalTransform(t,r,Nn,Zn),c=this._computeLocalTransform(this._resources,this.symbolLayer,i,jn),h=this._resources.lodRenderer.instanceData,d=h.addInstance();this._instanceIndexToGraphicUid.set(d,n),h.setLocalTransform(d,c,!1),h.setGlobalTransform(d,l),s&&h.setFeatureAttribute(d,s),null==this._fastUpdates&&this._hasDrivenColorOrOpacity&&h.setColor(d,this._getDrivenUInt8ColorWithNaNSupport(i,this._materialColor,!this._isPrimitive));const u=this._context.stage.renderView.olidRenderHelper;if(u){const e=u.getObjectAndLayerIdColor({graphicUid:n,layerViewUid:this._context.layerViewUid});h.setObjectAndLayerIdColor(d,e)}const p=new Gr(this,d,Ye.Jf,r,this._context.stage.view.state.highlightOrderMap);return o&&(p.alignedSampledElevation=Zn.sampledElevation),p.needsElevationUpdates=(0,w.Kf)(r.mode),(0,st.d2)(p,t,this._context.elevationProvider),p}_computeGlobalTransform(e,t,i,r){return(0,w.sE)(e,this._context.elevationProvider,t,this._context.renderCoordsHelper,r),Hn[0]=e.x,Hn[1]=e.y,Hn[2]=r.z,(0,f.l)(e.spatialReference,Hn,i,this._context.renderCoordsHelper.spatialReference),i}_computeLocalTransform(e,t,i,r){return(0,d.D_)(r),this._applyObjectRotation(i,!1,r),this._applyObjectRotation(t,!0,r),this._applyObjectScale(e,i,r),this._applyAnchor(e,t,r),r}_applyObjectScale(e,t,i){var r;if(null!==(r=this._fastUpdates)&&void 0!==r&&r.requiresShaderTransformation)return;const n=this._drivenProperties.size&&t.size?t.size:e.symbolSize,s=(0,P.pW)(n,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);1===s[0]&&1===s[1]&&1===s[2]||(0,d.hs)(i,i,s)}prepareSymbolLayerPatch(e){if("partial"!==e.diff.type)return;const t=e.diff.diff;this._preparePatchTransform(e,t),this._preparePatchColor(e,t)}updateGeometry(e,t){if(null==this._resources)return!0;const i=e.geometry;if(!i)return!1;const r=(0,st.ZX)(i);if(null==r)return!1;const n=this.getGeometryElevationMode(i),{elevationContext:s}=t;return s.mode===n&&(s.updateFeatureExpressionFeature(e,this._context.layer),this._computeGlobalTransform(r,s,Nn,Zn),Gn(s)&&(t.alignedSampledElevation=Zn.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(t.instanceIndex,Nn,!0),(0,st.d2)(t,r,this._context.elevationProvider),!0)}_preparePatchTransform(e,t){if(!(t.heading||t.tilt||t.roll||t.width||t.height||t.depth||t.anchor||t.anchorPosition))return;if(null==this._resources)return;const i=(e,t,i)=>{var r;return null!==(r=null!=e&&"complete"===e.type?e.newValue:t)&&void 0!==r?r:i},r=i(t.heading,this.symbolLayer.heading,0),n=i(t.tilt,this.symbolLayer.tilt,0),s=i(t.roll,this.symbolLayer.roll,0),a=i(t.width,this.symbolLayer.width,void 0),o=i(t.height,this.symbolLayer.height,void 0),l=i(t.depth,this.symbolLayer.depth,void 0),c=i(t.anchor,this.symbolLayer.anchor,void 0),h=i(t.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete t.heading,delete t.tilt,delete t.roll,delete t.width,delete t.height,delete t.depth,delete t.anchor,delete t.anchorPosition;const d={heading:r,tilt:n,roll:s,anchor:c,anchorPosition:h},u=this._resources;1===this.loadStatus&&e.symbolLayerStatePatches.push(()=>{u.symbolSize=(0,v.ci)((0,Fr.Bb)(u.resourceSize,{width:a,height:o,depth:l,isPrimitive:this._isPrimitive}))}),e.graphics3DGraphicPatches.push((e,t)=>{let{instanceIndex:i}=e;const r=this._computeLocalTransform(u,d,t,jn);u.lodRenderer.instanceData.setLocalTransform(i,r,!0)})}_preparePatchColor(e,t){if(!t.material||"partial"!==t.material.type)return;const i=t.material.diff;if(!i.color||"complete"!==i.color.type||null==i.color.newValue||null==i.color.oldValue)return;const r=i.color.newValue,n=null!=r?Te.A.toUnitRGBA(r):Ue.Un;delete i.color;const s=this._resources;if(null==s)return;const a=this._isPrimitive;e.graphics3DGraphicPatches.push(e=>{let{instanceIndex:t}=e;if(this._hasDrivenColorOrOpacity)s.lodRenderer.instanceData.setColor(t,n);else{const e={externalColor:n};for(const t of s.stageResources.materials)t.setParameters(e),a&&t.setParameters({cullFace:Bn(t.transparent)})}})}_applyObjectRotation(e,t,i){var r;if(null===(r=this._fastUpdates)||void 0===r||!r.requiresShaderTransformation||!t)return(0,P.$2)(e.heading,e.tilt,e.roll,i)}_applyAnchor(e,t,i){var r;if(null!==(r=this._fastUpdates)&&void 0!==r&&r.requiresShaderTransformation)return;const n=kn(e.resourceBoundingBox,e.pivotOffset,t);n&&(0,d.Tl)(i,i,n)}_fastVisualVariableConvertOptions(e,t,i,r){const n=null!=e?(0,v.ci)((0,m.Ej)(e)):v.Un,s=null!=e?kn(e,r,this.symbolLayer):v.uY,a=this._context.renderCoordsHelper.unitInMeters,o=(0,P.pW)(null!=t?t:void 0,t,i,a),l=(0,v.fA)(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return new at.wI({supports:{size:!0,color:!0,rotation:!0,opacity:!1},modelSize:n,symbolSize:null!==t&&void 0!==t?t:v.Un,unitInMeters:a,anchor:s,scale:o,rotation:l,fallbackColor:this._getFallbackOpacityAndColor(),fallbackSize:o})}get _primitive(){var e;const{resource:t}=this.symbolLayer;return null!=(null===t||void 0===t?void 0:t.href)?null:null!==(e=null===t||void 0===t?void 0:t.primitive)&&void 0!==e?e:Ur.r}_getFallbackOpacityAndColor(){var e;return null!==(e=Te.A.toUnitRGBA(this._materialColor))&&void 0!==e?e:this._isPrimitive?Ue.uY:C.Z$}get _materialColor(){var e;return null===(e=this.symbolLayer.material)||void 0===e?void 0:e.color}}function kn(e,t,i){const r=(0,v.vt)();switch(i.anchor){case"center":(0,p.d)(r,(0,m.gX)(e)),(0,p.u)(r,r);break;case"top":{const t=(0,m.gX)(e);(0,p.j)(r,-t[0],-t[1],-e[5]);break}case"bottom":{const t=(0,m.gX)(e);(0,p.j)(r,-t[0],-t[1],-e[2]);break}case"relative":{const t=(0,m.gX)(e),n=(0,m.Ej)(e),s=i.anchorPosition,a=s?(0,v.fA)(s.x,s.y,s.z):v.uY;(0,p.C)(r,n,a),(0,p.g)(r,r,t),(0,p.u)(r,r);break}default:null!=t?(0,p.u)(r,t):(0,p.d)(r,v.uY)}return r}function Gn(e){return"absolute-height"!==e.mode}function Bn(e){return e?0:2}const Hn=(0,v.vt)(),jn=(0,u.vt)(),Nn=(0,u.vt)(),Wn=(0,Ue.vt)(),Zn=new w.Uk;var qn=i(64573);class Yn{constructor(e,t,i,r,n){this.vertices=e,this.positionsES=t,this.offset=r,this.positions=n;const s=e.length,a=Math.floor(s/2),o=this.offset+3*a,l=i[o],c=i[o+1],h=i[o+2];this.origin=(0,v.fA)(l,c,h);const d=this.offset+3*s;for(let u=this.offset;u<d;u+=3)n[u]=i[u]-l,n[u+1]=i[u+1]-c,n[u+2]=i[u+2]-h;this.updatePathVertexInformation()}updatePathVertexInformation(){const e=this.vertices.length,t=this.vertices[0];let i=this.offset;const r=this.positions;t.vRight[0]=r[i+3]-r[i],t.vRight[1]=r[i+4]-r[i+1],t.vRight[2]=r[i+5]-r[i+2],i+=3;let n=(0,p.b)(t.vRight);t.vMinSiblingLength=n,(0,p.n)(t.vRight,t.vRight);let s=t;for(let a=1;a<e;++a){const t=this.vertices[a];if(t.vLeft=s.vRight,a<e-1){t.vRight[0]=r[i+3]-r[i],t.vRight[1]=r[i+4]-r[i+1],t.vRight[2]=r[i+5]-r[i+2];const e=(0,p.b)(t.vRight);t.vMinSiblingLength=Math.min(n,e),n=e,(0,p.n)(t.vRight,t.vRight)}else(0,p.d)(t.vRight,t.vLeft),t.vMinSiblingLength=n;s=t,i+=3}}}var Qn=i(94587),Xn=i(39246);class Kn{constructor(e,t,i,r,n){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};this.path=e,this.profile=t,this.extruder=i,this.startCap=r,this.endCap=n,this.options=s,this._extrusionVertexCount=0;const a=this.path.vertices.length-2;this.numExtrusionProfiles=i.numProfilesPerJoin()*a+2,this.numVerticesTotal=t.vertices.length*this.numExtrusionProfiles,this.startCap.vertexBufferStart=this.numVerticesTotal;const o=this.startCap.numVertices;this.numVerticesTotal+=o,this.endCap.vertexBufferStart=this.numVerticesTotal;const l=this.endCap.numVertices;this.numVerticesTotal+=l,this.pathVertexData=(0,_.JH)(1*this.numVerticesTotal),this.profileRightAxes=(0,Xn.O)(2*this.numVerticesTotal),this.profileUpAxes=(0,Xn.O)(2*this.numVerticesTotal),this.profileVertexAndNormals=(0,Qn.fY)(4*this.numVerticesTotal),this.profileAuxData=(0,Qn.fY)(3*this.numVerticesTotal),this.positions=(0,di.AK)(e.positions,e.offset,3*e.vertices.length),this._rebuildGeometry(),this._buildTopology()}emitVertex(e,t,i,r,n){let s=4*this._extrusionVertexCount;if(this.profileVertexAndNormals[s]=i[0],this.profileVertexAndNormals[s+1]=i[1],this.profileVertexAndNormals[s+2]=r[0],this.profileVertexAndNormals[s+3]=r[1],this.pathVertexData[this._extrusionVertexCount]=e,s=3*this._extrusionVertexCount,n){const t=this.path.vertices[e],i=t.maxStretchDistance;this.profileAuxData[s]=t.rotationRight[0]*i,this.profileAuxData[s+1]=t.rotationRight[1]*i}else this.profileAuxData[s]=this.profileAuxData[s+1]=0;this.profileAuxData[s+2]=0,(0,J.aT)(this.profileRightAxes,this._extrusionVertexCount,t.right[0],t.right[1],t.right[2]),(0,J.aT)(this.profileUpAxes,this._extrusionVertexCount,t.up[0],t.up[1],t.up[2]),++this._extrusionVertexCount}emitCapVertex(e,t,i,r,n,s){let a=4*this._extrusionVertexCount;this.profileVertexAndNormals[a]=i[0],this.profileVertexAndNormals[a+1]=i[1],this.profileVertexAndNormals[a+2]=r[0],this.profileVertexAndNormals[a+3]=r[1],a=3*this._extrusionVertexCount,this.profileAuxData[a]=n,this.profileAuxData[a+1]=s,this.profileAuxData[a+2]=1,(0,J.aT)(this.profileRightAxes,this._extrusionVertexCount,t.right[0],t.right[1],t.right[2]),(0,J.aT)(this.profileUpAxes,this._extrusionVertexCount,t.up[0],t.up[1],t.up[2]),this.pathVertexData[this._extrusionVertexCount]=e,++this._extrusionVertexCount}_rebuildGeometry(){this._extrusionVertexCount=0;const{positions:e,offset:t,vertices:i}=this.path;this.positions=(0,di.AK)(e,t,3*i.length);let r=0;const n=(e,t,i,n,s)=>this.emitCapVertex(r,e,t,i,n,s),s=(e,t,i,n)=>this.emitVertex(r,e,t,i,n);for(this.startCap.rebuildConnectingProfileGeometry(i[r],this.profile,n),r=1;r<i.length-1;++r)this.extruder.extrude(i[r],this.profile,s);this.endCap.rebuildConnectingProfileGeometry(i[r],this.profile,n),r=0,this.startCap.rebuildCapGeometry(i[r],n),r=i.length-1,this.endCap.rebuildCapGeometry(i[r],n)}_buildTopology(){const e=this.profile.vertices.length,t=this.profile.numSegments,i=this.numExtrusionProfiles-1;let r=t*i*2*3;this.startCap.indexBufferStart=r,this.startCap.firstProfileVertexIndex=0,r+=this.startCap.numIndices,this.endCap.indexBufferStart=r,this.endCap.firstProfileVertexIndex=e*(this.numExtrusionProfiles-1);const n=new Array,s=new Array,a=(e,t,i)=>{n.push(e),n.push(t),n.push(i),s.push(this.pathVertexData[e]),s.push(this.pathVertexData[t]),s.push(this.pathVertexData[i])};for(let o=0;o<t;++o){const t=this.profile.indices[2*o],r=this.profile.indices[2*o+1];for(let n=0;n<i;++n){const i=n*e+t,s=(n+1)*e+r,o=n*e+r;a(i,(n+1)*e+t,s),a(i,s,o)}}this.startCap.buildTopology(this.path.vertices[0],a),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],a),this.vertexIndices=(0,_.Dg)(n),this.pathVertexIndices=(0,_.Dg)(s)}onPathChanged(){this._rebuildGeometry()}}class $n{rebuildConnectingProfileGeometry(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.frame,t.vertices[r],t.normals[r],0,0)}}class Jn extends $n{constructor(){super(),this.numVertices=0,this.numIndices=0}rebuildCapGeometry(){}buildTopology(){}}class es extends $n{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];super(),this.profile=e,this.profilePlaneOffset=t,this.flip=i}get numVertices(){return this.profile.vertices.length}get numIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,t,i){const r=this.profilePlaneOffset;for(let n=0;n<t.vertices.length;++n)i(e.frame,t.vertices[n],t.normals[n],r,0)}rebuildCapGeometry(e,t){const i=this.profile,r=this.flip?1:-1,n=this.profilePlaneOffset,s=rs;(0,Li.hZ)(s,0,0);for(let a=0;a<i.vertices.length;++a)t(e.frame,i.vertices[a],s,n,r)}buildTopology(e,t){const i=this.profile,r=this.vertexBufferStart+i.indices[0];for(let n=1;n<i.numSegments;++n){const e=i.indices[2*n],s=i.indices[2*n+1],a=this.vertexBufferStart+e,o=this.vertexBufferStart+s;this.flip?t(o,a,r):t(r,a,o)}}}class ts extends $n{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}get numVertices(){let e=this.profile.vertices.length*(this.numSegments-1)+this.profile.poles.length;return this.breakNormals&&(e+=this.profile.vertices.length),e}get numIndices(){let e=0;const t=this.profile;e+=2*t.numSegments*(this.numSegments-1);for(let i=0;i<t.numSegments;++i){const r=t.indices[2*i],n=t.indices[2*i+1];t.poleIndices[r]===t.poleIndices[n]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,t){const i=this.profile,r=e.frame,n=.5*this.sign,s=is,a=rs;(0,Li.hZ)(a,0,0);for(const o of i.poles)o.normal?t(r,o.position,o.normal,n,0):t(r,o.position,a,n,this.sign);if(this.breakNormals)for(let o=0;o<i.vertices.length;++o)t(r,i.vertices[o],i.normals[o],0,0);for(let o=0;o<this.numSegments-1;++o){const e=(1-(o+1)/this.numSegments)*Math.PI*.5,l=Math.sin(e),c=Math.cos(e);for(let o=0;o<i.vertices.length;++o){const e=i.poles[i.poleIndices[o]];(0,Li.Re)(s,i.vertices[o],e.position),(0,Li.hs)(s,s,l),e.normal?((0,Li.WQ)(s,s,e.position),t(r,s,e.normal,n*c,0)):((0,Li.S8)(a,s),(0,Li.hs)(a,a,l),(0,Li.WQ)(s,s,e.position),t(r,s,a,n*c,this.sign*c))}}}buildTopology(e,t){const i=this.profile,r=this.breakNormals?this.vertexBufferStart+i.poles.length:this.firstProfileVertexIndex,n=this.breakNormals?this.vertexBufferStart+i.poles.length+i.vertices.length:this.vertexBufferStart+i.poles.length;for(let s=0;s<i.numSegments;++s){const e=i.indices[2*s],a=i.indices[2*s+1],o=this.vertexBufferStart+i.poleIndices[e],l=this.vertexBufferStart+i.poleIndices[a];let c=r+e,h=r+a;for(let r=0;r<this.numSegments-1;++r){const s=n+r*i.vertices.length+e,o=n+r*i.vertices.length+a;this.flip?(t(s,h,c),t(h,s,o)):(t(c,h,s),t(o,s,h)),c=s,h=o}this.flip?(t(o,h,c),o!==l&&t(o,l,h)):(t(c,h,o),o!==l&&t(h,l,o))}}}const is=(0,Le.vt)(),rs=(0,Le.vt)();class ns{numProfilesPerJoin(){return 1}extrude(e,t,i){for(let r=0;r<t.vertices.length;++r)i(e.frame,t.vertices[r],t.normals[r],!1)}}class ss{constructor(e,t){this.cutoffAngle=e,this.numBendSubdivisions=t}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,t,i){const r=hs,{rotationAngle:n,rotationRight:s,frame:a}=e;if(Math.abs(n)>=this.cutoffAngle){const o=e.rotationFrameUp;for(let l=0;l<this.numBendSubdivisions+1;++l){(0,d.$0)(cs,.5*-n+l*n/this.numBendSubdivisions,o),os(r,a,cs);for(let o=0;o<t.vertices.length;++o)(0,Li.Om)(t.vertices[o],s)*n>=0?i(r,t.vertices[o],t.normals[o],!1):i(a,e.applyMiterStretch(ls,t.vertices[o]),t.normals[o],!0)}}else for(let o=0;o<this.numBendSubdivisions+1;++o)for(let r=0;r<t.vertices.length;++r){const o=(0,Li.Om)(t.vertices[r],s)*n>=0;i(a,e.applyMiterStretch(ls,t.vertices[r]),t.normals[r],!o)}}}class as{constructor(){this.up=(0,v.vt)(),this.right=(0,v.vt)()}}function os(e,t,i){(0,p.t)(e.up,t.up,i),(0,p.t)(e.right,t.right,i)}const ls=(0,Le.vt)(),cs=(0,u.vt)(),hs=new as;class ds extends D.V{constructor(e,t,i,r,n,s){super(e,t,null,0,s),this.path=i,this.geometrySR=r,this.stencilWidth=n}}function us(e){return"path"in e}var ps=i(48168);class vs{constructor(e){this.builder=e}onPathChanged(e){this.builder.onPathChanged()}}class fs extends vs{constructor(e){super(e),this.color=(0,Ue.fA)(255,255,255,255),this._size=(0,Le.vt)(),this.positions=(0,di.oe)(3*this.builder.numVerticesTotal),this.normals=new Int16Array(2*this.builder.numVerticesTotal)}bakeVertexColors(e){(0,Ct.d)(this.color,e)}bake(e){(0,Li.C)(this._size,e);const{numVerticesTotal:t,pathVertexData:i,positions:r,profileRightAxes:n,profileUpAxes:s,profileVertexAndNormals:a,profileAuxData:o}=this.builder;for(let l=0;l<t;++l){let t=i[l];t*=3;const c=xs;let h=0,d=0;const u=(0,J.Tz)(bs,n,l),v=(0,J.Tz)(ws,s,l),f=4*l,m=(0,Li.hZ)(gs,a[f]*e[0],a[f+1]*e[1]),g=3*l;if(1===o[g+2])(0,p.i)(c,v,u),h=o[g]*e[0],d=o[g+1];else{const e=_s,t=ys;(0,Li.hZ)(e,o[g],o[g+1]);const i=(0,Li.Bw)(e);(0,Li.S8)(e,e);const r=(0,Li.Om)(m,e);if(Math.abs(r)>i){(0,Li.hZ)(t,-e[1],e[0]);const n=(0,Li.Om)(m,t);(0,Li.hs)(e,e,i*Math.sign(r)),(0,Li.hs)(t,t,n),(0,Li.WQ)(m,e,t)}(0,p.j)(c,0,0,0)}const _=u[0]*m[0]+v[0]*m[1],y=u[1]*m[0]+v[1]*m[1],x=u[2]*m[0]+v[2]*m[1];this.positions[g]=r[t]+_+c[0]*h,this.positions[g+1]=r[t+1]+y+c[1]*h,this.positions[g+2]=r[t+2]+x+c[2]*h;const b=a[f+2],w=a[f+3];(0,J.aT)(this.normals,l,u[0]*b+v[0]*w+c[0]*d,u[1]*b+v[1]*w+c[1]*d,u[2]*b+v[2]*w+c[2]*d)}}createGeometryData(){const e=this.builder.vertexIndices;return[["position",new M.n(this.positions,e,3,!0)],["normalCompressed",new M.n(this.normals,e,2,!0)],["color",new M.n(this.color,(0,_.EH)(e.length),4,!0)]]}onPathChanged(e){super.onPathChanged(e),this.bake(this.size)}intersect(e,t,i,r){const n=this.builder.vertexIndices,s=new M.K(this.positions,3),a=n.length/3;(0,ps.Z$)(e,t,0,a,n,s,void 0,i,(e,t,i)=>r(e,i,t))}get size(){return this._size}}class ms extends vs{constructor(e,t,i,r){super(e),this.sizeAttributeValue=t,this.colorAttributeValue=i,this.opacityAttributeValue=r,this.baked=new fs(e),this._vvSize=(0,di.oe)(this.builder.path.vertices.length).fill(t),this._vvColor=(0,Qn.fY)(this.builder.path.vertices.length).fill(i),this._vvOpacity=(0,Qn.fY)(this.builder.path.vertices.length).fill(r)}createGeometryData(){const e=this.builder,{pathVertexIndices:t,vertexIndices:i}=e;return[["position",new M.n(e.positions,t,3,!0)],["profileVertexAndNormal",new M.n(e.profileVertexAndNormals,i,4,!0)],["profileAuxData",new M.n(e.profileAuxData,i,3,!0)],["profileRight",new M.n(e.profileRightAxes,i,2,!0)],["profileUp",new M.n(e.profileUpAxes,i,2,!0)],["sizeFeatureAttribute",new M.n(this._vvSize,t,1,!0)],["colorFeatureAttribute",new M.n(this._vvColor,t,1,!0)],["opacityFeatureAttribute",new M.n(this._vvOpacity,t,1,!0)]]}onPathChanged(e){super.onPathChanged(e);const t=e.getMutableAttribute("position");t&&(t.data=this.builder.positions)}}const gs=(0,Le.vt)(),_s=(0,Le.vt)(),ys=(0,Le.vt)(),xs=(0,v.vt)(),bs=(0,v.vt)(),ws=(0,v.vt)();var Ss=i(95925);const Cs=(0,v.vt)();var Ps=i(97255);class As{constructor(){this.vertices=new Array,this.normals=new Array,this.indices=new Array,this.poles=new Array,this.poleIndices=new Array}addVertex(e,t){return this.vertices.push((0,Le.o8)(e)),this.normals.push((0,Le.o8)(t)),this.vertices.length-1}addPole(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.poles.push({position:(0,Le.o8)(e),normal:t?(0,Le.o8)(t):null}),this.poles.length-1}addSegment(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.indices.push(e.v0),this.indices.push(e.v1),t&&(this.poleIndices.push(t.v0),this.poleIndices.push(t.v1))}get numSegments(){return this.indices.length/2}translate(e,t){for(const i of this.vertices)i[0]+=e,i[1]+=t;for(const i of this.poles)i.position[0]+=e,i.position[1]+=t}get usedMemory(){return this.vertices.length*(0,Ps.Qf)(this.vertices[0])*2+(0,Ps.Qf)(this.indices)}}const Rs={top:[0,-.5],bottom:[0,.5]};function Ts(e){const t=qn.ZC,i=new As,r={v0:0,v1:0};i.addPole((0,Le.fA)(0,0));for(let s=0;s<t;++s){const e=2*s*Math.PI/t,r=Math.cos(e),n=Math.sin(e),a=(0,Le.fA)(.5*r,.5*n),o=(0,Le.fA)(r,n);i.addVertex(a,o)}for(let s=0;s<t-1;++s){const e={v0:s,v1:s+1};i.addSegment(e,r)}const n={v0:t-1,v1:0};if(i.addSegment(n,r),"center"!==e){const t=Rs[e];i.translate(t[0],t[1])}return i}const Ms={center:Ts("center"),top:Ts("top"),bottom:Ts("bottom")},Ds={center:zs("center"),top:zs("top"),bottom:zs("bottom")};function zs(e){const t=new As,i=(0,Le.fA)(-.5,-.5),r=(0,Le.fA)(.5,-.5),n=(0,Le.fA)(.5,.5),s=(0,Le.fA)(-.5,.5),a=(0,Le.fA)(0,-1),o=(0,Le.fA)(1,0),l=(0,Le.fA)(0,1),c=(0,Le.fA)(-1,0);if(t.addPole((0,Le.fA)(0,.5),l),t.addPole((0,Le.fA)(0,.5)),t.addPole((0,Le.fA)(0,-.5)),t.addPole((0,Le.fA)(0,-.5),a),t.addVertex(i,a),t.addVertex(r,a),t.addSegment({v0:0,v1:1},{v0:3,v1:3}),t.addVertex(r,o),t.addVertex(n,o),t.addSegment({v0:2,v1:3},{v0:2,v1:1}),t.addVertex(n,l),t.addVertex(s,l),t.addSegment({v0:4,v1:5},{v0:0,v1:0}),t.addVertex(s,c),t.addVertex(i,c),t.addSegment({v0:6,v1:7},{v0:1,v1:2}),"center"!==e){const i=Rs[e];t.translate(i[0],i[1])}return t}var Os=i(53494);function Vs(e,t,i,r,n){return e[0]=t,e[1]=i,e[2]=r,e[3]=n,e}function Es(e,t,i){const r=t[0],n=t[1],s=t[2],a=t[3],o=i[0],l=i[1],c=i[2],h=i[3];return e[0]=r*o+s*l,e[1]=n*o+a*l,e[2]=r*c+s*h,e[3]=n*c+a*h,e}function Is(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}const Ls=Es,Us=Is;Object.freeze(Object.defineProperty({__proto__:null,LDU:function(e,t,i,r){return e[2]=r[2]/r[0],i[0]=r[0],i[1]=r[1],i[3]=r[3]-e[2]*i[1],[e,t,i]},add:function(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e},adjoint:function(e,t){const i=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=i,e},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},determinant:function(e){return e[0]*e[3]-e[2]*e[1]},equals:function(e,t){const i=e[0],r=e[1],n=e[2],s=e[3],a=t[0],o=t[1],l=t[2],c=t[3],h=(0,Os.FD)();return Math.abs(i-a)<=h*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-o)<=h*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(n-l)<=h*Math.max(1,Math.abs(n),Math.abs(l))&&Math.abs(s-c)<=h*Math.max(1,Math.abs(s),Math.abs(c))},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},frob:function(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2)},fromRotation:function(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=-i,e[3]=r,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},invert:function(e,t){const i=t[0],r=t[1],n=t[2],s=t[3];let a=i*s-n*r;return a?(a=1/a,e[0]=s*a,e[1]=-r*a,e[2]=-n*a,e[3]=i*a,e):null},mul:Ls,multiply:Es,multiplyScalar:function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e},multiplyScalarAndAdd:function(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e},rotate:function(e,t,i){const r=t[0],n=t[1],s=t[2],a=t[3],o=Math.sin(i),l=Math.cos(i);return e[0]=r*l+s*o,e[1]=n*l+a*o,e[2]=r*-o+s*l,e[3]=n*-o+a*l,e},scale:function(e,t,i){const r=t[0],n=t[1],s=t[2],a=t[3],o=i[0],l=i[1];return e[0]=r*o,e[1]=n*o,e[2]=s*l,e[3]=a*l,e},set:Vs,str:function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},sub:Us,subtract:Is,transpose:function(e,t){if(e===t){const i=t[1];e[1]=t[2],e[2]=i}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e}},Symbol.toStringTag,{value:"Module"}));function Fs(){return[1,0,0,1]}Object.freeze(Object.defineProperty({__proto__:null,clone:function(e){return[e[0],e[1],e[2],e[3]]},create:Fs,fromValues:function(e,t,i,r){return[e,t,i,r]}},Symbol.toStringTag,{value:"Module"}));class ks{constructor(){this.vLeft=(0,v.vt)(),this.vRight=(0,v.vt)(),this.vMinSiblingLength=0,this.frame=new as}setFrameFromUpVector(e){(0,p.d)(this.frame.up,e),(0,p.g)(Ks,this.vLeft,this.vRight),(0,p.n)(Ks,Ks),(0,p.h)(Xs,this.frame.up,(0,p.f)(Ks,this.frame.up)),(0,p.e)($s,Ks,Xs),(0,p.n)($s,$s),(0,p.i)(this.frame.right,$s,this.frame.up)}get foldingAngle(){return Math.PI-this.rotationAngle}}class Gs extends ks{get rotationFrameUp(){return this.frame.up}get rotationRight(){return Le.Cw}get rotationAngle(){return(0,p.h)(Ys,this.frame.up,(0,p.f)(this.frame.up,this.vLeft)),(0,p.e)(Ys,this.vLeft,Ys),(0,p.u)(Ys,Ys),(0,p.n)(Ys,Ys),(0,p.h)(Qs,this.frame.up,(0,p.f)(this.frame.up,this.vRight)),(0,p.e)(Qs,this.vRight,Qs),(0,p.n)(Qs,Qs),(0,p.i)(qs,this.rotationFrameUp,this.vLeft),Math.sign((0,p.f)(qs,this.vRight))*(Math.PI-(0,li.XM)((0,p.f)(Ys,Qs)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength/Math.cos(.5*this.foldingAngle))}applyMiterStretch(e,t){const i=this.rotationAngle;if(Math.abs(i)<=0)return t;const r=(0,li.J_)(Math.cos(.5*i));return(0,Li.hZ)(e,(r-1+1)*t[0],t[1])}}class Bs extends ks{get rotationFrameUp(){const e=Math.sign((0,p.f)(this.frame.right,this.vRight));return(0,p.i)(js,this.vRight,this.vLeft),(0,p.h)(js,js,e),(0,p.n)(js,js)}get rotationRight(){const e=this.rotationFrameUp,t=(0,p.f)(e,this.frame.up),i=(0,p.f)(e,this.frame.right);return(0,p.h)(Ws,this.frame.up,-i),(0,p.h)(Zs,this.frame.right,t),(0,p.g)(Ws,Ws,Zs),(0,p.n)(Ws,Ws),function(e,t,i){(0,Li.hZ)(e,(0,p.f)(i,t.right),(0,p.f)(i,t.up))}(Ns,this.frame,Ws),Ns}get rotationAngle(){const e=Math.sign((0,p.f)(this.frame.right,this.vRight));return(0,p.u)(qs,this.vLeft),-e*(Math.PI-(0,li.XM)((0,p.f)(qs,this.vRight)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength*(0,li.J_)(Math.cos(.5*this.foldingAngle)))}applyMiterStretch(e,t){const i=this.rotationAngle;if(0===Math.abs(i))return t;const r=(0,li.J_)(Math.cos(.5*i)),n=this.rotationRight,s=Vs(Js,1+(r-1)*n[0]*n[0],(r-1)*n[0]*n[1],(r-1)*n[0]*n[1],1+(r-1)*n[1]*n[1]);return(0,Li.ZF)(e,t,s)}}function Hs(e){switch(e){case 0:return new Gs;case 1:return new Bs}}const js=(0,v.vt)(),Ns=(0,Le.vt)(),Ws=(0,v.vt)(),Zs=(0,v.vt)(),qs=(0,v.vt)(),Ys=(0,v.vt)(),Qs=(0,v.vt)(),Xs=(0,v.vt)(),Ks=(0,v.vt)(),$s=(0,v.vt)(),Js=[1,0,0,1];var ea=i(85887),ta=i(61785),ia=i(91116);class ra extends ea.W{constructor(){super(...arguments),this.ambient=(0,v.CN)(.2,.2,.2),this.diffuse=(0,v.CN)(.8,.8,.8),this.opacity=1,this.origin=(0,v.vt)(),this.modelTransformation=null,this.mrrFactors=ur.mb,this.emissiveStrength=0,this.emissiveSource=1,this.emissiveBaseColor=v.uY}}class na extends Ut.w{constructor(e,t){super(e,t,new Lt.$(ia.P,()=>i.e(438).then(i.bind(i,10438))),sa(t).locations)}initializePipeline(e){const{output:t,transparent:i,hasSlicePlane:r,doubleSidedMode:n,hasOccludees:s,oitPass:a}=e,o=0===a,l=2===a;return(0,Bt.Ey)({blending:(0,Dt.RN)(t)&&i?(0,Ft.Yf)(a):null,culling:r&&!i&&0!==n?Bt.hG:null,depthTest:{func:(0,Ft.K_)(a)},depthWrite:o||l?Bt.Uy:null,drawBuffers:(0,Ut.L)(t,(0,Ft.m6)(a,t)),colorWrite:Bt.kn,stencilWrite:s?kt.v0:null,stencilTest:s?kt.qh:null,polygonOffset:o||l?null:Ft.SE})}}function sa(e){const t=(0,It.BP)().vec3f("position").vec4f16("profileVertexAndNormal").vec2i16("profileRight",{glNormalized:!0}).vec2i16("profileUp",{glNormalized:!0});return e.hasVVSize&&t.f32("sizeFeatureAttribute"),e.hasVVColor&&t.f32("colorFeatureAttribute"),e.hasVVOpacity&&t.f32("opacityFeatureAttribute"),(0,ta.E)()&&t.vec4u8("olidColor"),t.vec3f16("profileAuxData"),t.freeze()}class aa extends Zt.E{constructor(e){super(),this.spherical=e,this.pbrMode=0,this.doubleSidedMode=0,this.emissionSource=0,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.hasVVSize=!1,this.hasVVColor=!1,this.hasVVOpacity=!1,this.transparent=!1,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.snowCover=!1,this.textureCoordinateType=0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.useCustomDTRExponentForWater=!1,this.useFillLights=!1,this.hasColorTexture=!1,this.hasMetallicRoughnessTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.draped=!1,this.overlayEnabled=!1}get discardInvisibleFragments(){return this.transparent}}(0,Nt.Cg)([(0,Wt.W)({count:7})],aa.prototype,"pbrMode",void 0),(0,Nt.Cg)([(0,Wt.W)({count:3})],aa.prototype,"doubleSidedMode",void 0),(0,Nt.Cg)([(0,Wt.W)({count:8})],aa.prototype,"emissionSource",void 0),(0,Nt.Cg)([(0,Wt.W)()],aa.prototype,"receiveShadows",void 0),(0,Nt.Cg)([(0,Wt.W)()],aa.prototype,"receiveAmbientOcclusion",void 0),(0,Nt.Cg)([(0,Wt.W)()],aa.prototype,"hasVVSize",void 0),(0,Nt.Cg)([(0,Wt.W)()],aa.prototype,"hasVVColor",void 0),(0,Nt.Cg)([(0,Wt.W)()],aa.prototype,"hasVVOpacity",void 0),(0,Nt.Cg)([(0,Wt.W)()],aa.prototype,"transparent",void 0),(0,Nt.Cg)([(0,Wt.W)()],aa.prototype,"hasOccludees",void 0),(0,Nt.Cg)([(0,Wt.W)()],aa.prototype,"terrainDepthTest",void 0),(0,Nt.Cg)([(0,Wt.W)()],aa.prototype,"cullAboveTerrain",void 0),(0,Nt.Cg)([(0,Wt.W)()],aa.prototype,"snowCover",void 0);class oa extends Ot.i{constructor(e,t){super(e,ha),this.supportsEdges=!0,this._pp0=(0,v.fA)(0,0,1),this._pp1=(0,v.fA)(0,0,0),this.produces=new Map([[2,e=>(this.parameters.castShadows&&(0,Dt.Bf)(e)||(0,Dt.iq)(e))&&!this.transparent],[4,e=>(this.parameters.castShadows&&(0,Dt.Bf)(e)||(0,Dt.iq)(e))&&this.transparent]]),this._configuration=new aa(t.spherical)}get hasEmissions(){return this.parameters.emissiveStrength>0}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.hasVVSize=this.parameters.hasVVSize,this._configuration.hasVVColor=this.parameters.hasVVColor,this._configuration.hasVVOpacity=this.parameters.hasVVOpacity,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.transparent,this._configuration.hasOccludees=t.hasOccludees,(0,Dt.RN)(e)?(this._configuration.doubleSidedMode=this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?1:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?2:0,this._configuration.receiveShadows=t.shadowMap.enabled,this._configuration.receiveAmbientOcclusion=null!=t.ssao):this._configuration.receiveShadows=this._configuration.receiveAmbientOcclusion=!1,this._configuration.pbrMode=this.parameters.usePBR?2:0,this._configuration.emissionSource=this.parameters.usePBR?1:0,this._configuration.oitPass=t.oitPass,this._configuration.terrainDepthTest=t.terrainDepthTest,this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.snowCover=t.snowCover>0,this._configuration}isVisibleForOutput(e){return 4!==e&&6!==e&&5!==e||this.parameters.castShadows}get visible(){return this.parameters.opacity>=Yt.Q}intersect(e,t,i,r,n,s){this._intersect(e,i,r,n,s)}intersectDraped(e,t,i,r){return this._pp0[0]=this._pp1[0]=i[0],this._pp0[1]=this._pp1[1]=i[1],this._intersect(e,t,this._pp0,this._pp1,r)}_intersect(e,t,i,r,n){const s=e;if(!us(s))return;const a=s.path,o=(0,Le.o8)(this.parameters.size);if(this.parameters.vvSize){const{offset:e,factor:t,minSize:i,maxSize:r,fallback:n}=this.parameters.vvSize,s=a.sizeAttributeValue;Number.isNaN(s)?(o[0]*=n[0],o[1]*=n[2]):(o[0]*=(0,li.qE)(e[0]+s*t[0],i[0],r[0]),o[1]*=(0,li.qE)(e[2]+s*t[2],i[2],r[2]))}const l=new ps.JG(t.tolerance,!1,t.options.normalRequired),c=Math.max(o[0],o[1]),h=e.boundingInfo;if(null==h)return void ca(a,o,i,r,l,n);const d=(0,m.fA)(h.bbMin[0]-c,h.bbMin[1]-c,h.bbMin[2]-c,h.bbMax[0]+c,h.bbMax[1]+c,h.bbMax[2]+c),u=[r[0]-i[0],r[1]-i[1],r[2]-i[2]],p=Math.sqrt(u[0]*u[0]+u[1]*u[1]+u[2]*u[2]),v=[p/u[0],p/u[1],p/u[2]];(0,ps.Wb)(d,i,v,t.tolerance)&&ca(a,o,i,r,l,n)}createBufferWriter(){return new Gi.Z(sa(this.parameters))}createGLMaterial(e){return new la(e)}get transparent(){const{parameters:e}=this;return e.drivenOpacity||e.opacity<1}}class la extends zt.A{beginSlot(e){return this.getTechnique(na,e)}}function ca(e,t,i,r,n,s){e.baked.size&&e.baked.size[0]===t[0]&&e.baked.size[1]===t[1]||e.baked.bake(t),e.baked.intersect(i,r,n,s)}class ha extends ra{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType="normal",this.castShadows=!0,this.hasSlicePlane=!1,this.drivenOpacity=!1,this.usePBR=!1}}const da=["polyline"];class ua extends C.UF{constructor(e,t,i,r){super(e,t,i,r,function(e){var t,i;return 1===(null!==(t=null===(i=e.material)||void 0===i||null===(i=i.color)||void 0===i?void 0:i.a)&&void 0!==t?t:0)}(t)),this._intrinsicSize=(0,Le.fA)(1,1),this._upVectorAlignment=1,this._stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){var e,t,i,r;const s=this.symbolLayer,a=null!=s.width?s.width:s.height,o=null!=s.height?s.height:a;this._vvConvertOptions=new at.wI({supports:{size:!0,color:!0,rotation:!1,opacity:!0},modelSize:[1,1,1],symbolSize:[a,1,o],unitInMeters:this._context.renderCoordsHelper.unitInMeters,fallbackColor:this._getFallbackOpacityAndColor(C.Z$),fallbackSize:[a,1,o]});const l=null===(e=this._context.renderer)||void 0===e?void 0:e.visualVariables;this._fastUpdates=null!==l&&void 0!==l&&l.length?(0,at.s_)(this._context.renderer,this._vvConvertOptions):null;const c=s.anchor||"center";this._upVectorAlignment="heading"===s.profileRotation?0:1;const h=s.profile||"circle";switch(h){default:case"circle":this._profile=Ms[c];break;case"quad":this._profile=Ds[c]}switch(s.join){case"round":this._extruder=new ss(0,qn.kf);break;case"bevel":this._extruder=new ss(0,1);break;case"miter":this._extruder=new ss(.8*Math.PI,1);break;default:this._extruder=new ns}switch(this._cap){case"none":this._startCap=new Jn,this._endCap=new Jn;break;case"butt":default:this._startCap=new es(this._profile,0),this._endCap=new es(this._profile,0,!0);break;case"square":this._startCap=new es(this._profile,-.5),this._endCap=new es(this._profile,.5,!0);break;case"round":{const e="quad"===h;this._startCap=new ts({profile:this._profile,flip:!1,breakNormals:e,subdivisions:qn.RL}),this._endCap=new ts({profile:this._profile,flip:!0,breakNormals:e,subdivisions:qn.RL});break}}const d=this._materialColor,u=this._getCombinedOpacityAndColor(d),p=(0,v.ci)(u),f=u[3],m=this.needsDrivenTransparentPass,g=null===(t=s.material)||void 0===t?void 0:t.emissive,_={diffuse:p,ambient:p,emissiveStrength:null!==(i=null===g||void 0===g?void 0:g.strength)&&void 0!==i?i:0,emissiveSource:1,opacity:f,drivenOpacity:m,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&((0,Li.hZ)(this._intrinsicSize,a,o),!(0,P.Mh)(this._intrinsicSize[0])||!(0,P.Mh)(this._intrinsicSize[1])))throw new De.A("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");let y;null!==(r=this._fastUpdates)&&void 0!==r&&r.visualVariables.size||(0,Li.hs)(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates?y=new oa((0,n.A)((0,n.A)((0,n.A)({},_),this._fastUpdates.materialParameters),{},{size:(0,Le.ci)(this._intrinsicSize)}),this._context):(_.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,_.normalType=1,y=new te.$U(_,this._context)),y.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._materials[0]=y,this._updateTransparentDepedentMaterialParameters()}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,da,this.symbolLayer.type))return null;const i=this.createElevationContextForGraphic(t);return this._createAs3DShape(e,i)}layerOpacityChanged(){const e=this._materialColor,t=this._getCombinedOpacity(e),i=this._materials[0];i&&(i.setParameters({opacity:t}),this._updateTransparentDepedentMaterialParameters())}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(e,t){return this.updateGraphics3DGraphicElevationInfo(e,t,w.Kf)}slicePlaneEnabledChanged(){var e;return null!==(e=this._materials[0])&&void 0!==e&&e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){var e;return null!==(e=this._materials[0])&&void 0!==e&&e.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}applyRendererDiff(e,t){for(const r in e.diff){var i;if("visualVariables"!==r)return 0;if(!(0,at.J_)(this._fastUpdates,t,this._vvConvertOptions))return 0;null===(i=this._materials[0])||void 0===i||i.setParameters(this._fastUpdates.materialParameters)}return 2}_getVertexData(e){let t=0;const i=e.paths,r=[],n=e.spatialReference,s=this._context.elevationProvider.spatialReference,a=this._context.renderCoordsHelper.spatialReference;for(const h of i)t+=h.length;const o=(0,g.jh)(3*t);let l,c=0;for(const h of i){r.push({offset:c,numVertices:h.length});for(const t of h)o[c++]=t[0],o[c++]=t[1],o[c++]=e.hasZ?t[2]:0}return null==s||n.equals(s)||(0,G.projectBuffer)(o,n,0,o,s,0,t)?(null==s||s.equals(a)?l=(0,g.xm)(o):(l=(0,g.jh)(3*t),(0,G.projectBuffer)(o,s,0,l,a,0,t)),{pathVertexDataInfos:r,vertexDataES:o,vertexDataRS:l}):null}_createAs3DShape(e,t){const{graphic:i,renderingInfo:r}=e,n=i.geometry,s=this._getVertexData(n);if(null==s)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(0===s.pathVertexDataInfos.length)return 0!==n.paths.length&&n.paths.some(e=>e.length>0)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)"),null;const a=new Array,o=n.spatialReference,l=(0,m.vt)(),c=this._context.renderCoordsHelper,h=new k.aY(s.vertexDataES),v=i.uid,f=(0,di.oe)(s.vertexDataRS.length);for(const S of s.pathVertexDataInfos){const e=S.numVertices;if(e<2)continue;const n=S.offset;if(null!=this._context.clippingExtent&&((0,m.Rz)(s.vertexDataES,n,e,l),!(0,m.KG)(l,this._context.clippingExtent)))continue;const b=new Array,C=n+3*e;for(let i=n;i<C;i+=3){h.offset=i;const e=(0,w.nG)(h,this._context.elevationProvider,t,c);(0,p.j)(ma,s.vertexDataRS[i],s.vertexDataRS[i+1],s.vertexDataRS[i+2]),c.setAltitude(ma,e),s.vertexDataRS[i]=ma[0],s.vertexDataRS[i+1]=ma[1],s.vertexDataRS[i+2]=ma[2],b.push(Hs(this._upVectorAlignment))}const P=new Yn(b,s.vertexDataES,s.vertexDataRS,n,f);pa(P,this._upVectorAlignment,this._context.renderCoordsHelper);const A=new Kn(P,this._profile,this._extruder,this._startCap,this._endCap);let R=null;if(this._fastUpdates){var g,_,y;const e=this._fastUpdates.visualVariables,t=(0,at.ul)(null===(g=e.size)||void 0===g?void 0:g.field,i),r=(0,at.ul)(null===(_=e.color)||void 0===_?void 0:_.field,i),n=(0,at.ul)(null===(y=e.opacity)||void 0===y?void 0:y.field,i);R=new ms(A,t,r,n)}else{const e=(0,Le.o8)(this._intrinsicSize);if(this._drivenProperties.size){var x;const t=null!==(x=r.size)&&void 0!==x?x:["symbol-value","symbol-value","symbol-value"];e[0]*=va(t[0],"symbol-value"===t[2]?this.symbolLayer.height||0:t[2],this.symbolLayer.width||0),e[1]*=va(t[2],"symbol-value"===t[0]?this.symbolLayer.width||0:t[0],this.symbolLayer.height||0)}const t=new fs(A);t.bake(e);const i=this._getDrivenColor(r);i&&t.bakeVertexColors(i),R=t}const T=R.createGeometryData(),M=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:v,layerViewUid:this._context.layerViewUid}),D=new ds(this._materials[0],T,R,o,this._stencilWidth,M);D.transformation=(0,d.Tl)((0,u.vt)(),u.zK,A.path.origin),a.push(D)}if(0===a.length)return null;const b=new ee.B({geometries:a,layerViewUid:this._context.layerViewUid,graphicUid:v}),C=new S.Y(this,b,null,(e,t,i,r,n)=>function(e,t,i,r,n){const s=e.stageObject,a=s.geometries;let o=0;for(const l of a){if(!us(l))continue;const e=l.path,a=e.builder.path;o+=fa(a,t,i,r),0!==n&&pa(a,n,r),e.onPathChanged(l),l.invalidateBoundingInfo(),s.geometryVertexAttributeUpdated(l,"position")}return o/a.length}(e,t,r,n,this._upVectorAlignment),t,null);return C.alignedSampledElevation=0,C.needsElevationUpdates=(0,w.Kf)(t.mode),C}_getDrivenColor(e){return this._hasDrivenColorOrOpacity?this._getDrivenUInt8ColorWithNaNSupport(e,this._materialColor,!1):null}get _materialColor(){var e;return null===(e=this.symbolLayer.material)||void 0===e?void 0:e.color}_getFallbackOpacityAndColor(e){var t;return null!==(t=Te.A.toUnitRGBA(this._materialColor))&&void 0!==t?t:e}get _cap(){return this.symbolLayer.cap||"butt"}_updateTransparentDepedentMaterialParameters(){const e=this._materials[0];e&&e.setParameters({cullFace:e.transparent||"none"===this._cap?0:2})}}function pa(e,t,i){const{origin:r,positions:n}=e;let s=e.offset;switch(t){default:case 0:for(const t of e.vertices)ma[0]=n[s++]+r[0],ma[1]=n[s++]+r[1],ma[2]=n[s++]+r[2],i.worldUpAtPosition(ma,ma),t.setFrameFromUpVector(ma);break;case 1:ma[0]=n[s]+r[0],ma[1]=n[s+1]+r[1],ma[2]=n[s+2]+r[2],i.worldUpAtPosition(ma,ma),function(e,t){let i=null;const r=e.vertices.length,n=.99619469809,s=(0,v.vt)(),a=(0,v.vt)(),o=(0,v.vt)(),l=(0,v.vt)(),c=(0,v.vt)(),h=(0,v.vt)(),d=(0,Fi.vt)();let u=e.vertices[0];(0,p.d)(a,t),(0,p.j)(s,0,1,0),(0,ct.Xl)(u.vRight,a,s,s,o,a,n),(0,p.d)(u.frame.up,a),(0,p.d)(u.frame.right,o);const f=e.positions;let m=e.offset;i=u;for(let v=1;v<r;++v){u=e.vertices[v],(0,p.g)(c,u.vLeft,u.vRight);let t=(0,p.b)(c);t>0?(t=1/Math.sqrt(t),c[0]=c[0]*t,c[1]=c[1]*t,c[2]=c[2]*t):(c[0]=u.vRight[0],c[1]=u.vRight[1],c[2]=u.vRight[2]),h[0]=f[m]+i.frame.up[0],h[1]=f[m+1]+i.frame.up[1],h[2]=f[m+2]+i.frame.up[2],m+=3;const r=(0,p.j)(Cs,f[m],f[m+1],f[m+2]);(0,Fi.O_)(r,c,d),(0,Fi.Ui)(d,(0,Ss.LV)(h,u.vLeft),l)?(l[0]-=f[m],l[1]-=f[m+1],l[2]-=f[m+2],(0,p.n)(a,l),(0,p.i)(o,c,a),(0,p.n)(o,o)):(0,ct.Xl)(c,i.frame.up,i.frame.right,s,o,a,n),(0,p.d)(u.frame.up,a),(0,p.d)(u.frame.right,o),i=u}}(e,ma)}}function va(e,t,i){switch(e){case"symbol-value":return i;case"proportional":return t;default:return e}}function fa(e,t,i,r){let n=0;const{origin:s,vertices:a,positions:o,positionsES:l}=e,c=e.offset+3*a.length;for(let h=e.offset;h<c;h+=3)(0,p.j)(ma,l[h],l[h+1],l[h+2]),i(ma,ga),n+=ga.sampledElevation,ma[0]=o[h]+s[0],ma[1]=o[h+1]+s[1],ma[2]=o[h+2]+s[2],r.setAltitude(ma,ga.z),o[h]=ma[0]-s[0],o[h+1]=ma[1]-s[1],o[h+2]=ma[2]-s[2];return e.updatePathVertexInformation(),n/a.length}const ma=(0,v.vt)(),ga=new w.Uk;var _a=i(34111),ya=i(482);function xa(e,t,i,r){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;(0,p.j)(Ca,1,0,0),(0,p.j)(Pa,0,1,0),(0,p.j)(Aa,0,0,1),function(e,t){(0,p.j)(La,0,0,0);for(let i=0;i<t.length-3;i+=3)La[0]+=t[i],La[1]+=t[i+1],La[2]+=t[i+2];(0,p.h)(e,La,1/(t.length/3-1))}(ba,i),(0,Fi.ci)(Sa,i)&&function(e,t,i,r,n,s){null!=n?(n.basisMatrixAtPosition(s,Oa),(0,p.j)(Va,Oa[0],Oa[1],Oa[2]),(0,p.j)(Ea,Oa[4],Oa[5],Oa[6]),(0,p.j)(Ia,Oa[8],Oa[9],Oa[10])):((0,p.j)(Va,1,0,0),(0,p.j)(Ea,0,1,0),(0,p.j)(Ia,0,0,1));const a=(0,Fi.Qj)(e);(0,p.f)(a,Ia)<0&&(0,p.h)(a,a,-1),(0,p.d)(r,a);const o=(0,p.f)(a,Ea),l=(0,p.f)(a,Va);Math.abs(o)>Math.abs(l)?((0,p.c)(t,Va,a,-l),(0,p.n)(t,t),(0,p.i)(i,t,a),(0,p.n)(i,i),(0,p.h)(i,i,-1)):((0,p.c)(i,Ea,a,-o),(0,p.n)(i,i),(0,p.i)(t,i,a),(0,p.n)(t,t))}(Sa,Ca,Pa,Aa,r,ba),(0,Li.hZ)(Ra,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),(0,Li.hZ)(Ta,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let h=0;h<i.length;h+=3){(0,p.j)(wa,i[h],i[h+1],i[h+2]);const e=(0,p.f)(Ca,wa),t=(0,p.f)(Pa,wa);Ra[0]=Math.min(Ra[0],e),Ra[1]=Math.min(Ra[1],t),Ta[0]=Math.max(Ta[0],e),Ta[1]=Math.max(Ta[1],t)}const s=(0,p.f)(Aa,ba);Ua(Ma,Ra[0],Ra[1],s,Ca,Pa,Aa),Ua(Da,Ta[0],Ra[1],s,Ca,Pa,Aa),Ua(za,Ra[0],Ta[1],s,Ca,Pa,Aa),(0,p.e)(Da,Da,Ma),(0,p.h)(Da,Da,.5),(0,p.e)(za,za,Ma),(0,p.h)(za,za,.5),(0,p.g)(Ma,Ma,Da),(0,p.g)(Ma,Ma,za);const a=Ra[0]%n,o=Ra[1]%n,l=Ra[0]-a,c=Ra[1]-o;for(let h=0;h<i.length;h+=3){(0,p.j)(wa,i[h],i[h+1],i[h+2]);const r=h/3,s=4*r;e[s]=((0,p.f)(Ca,wa)-l)/n,e[s+1]=((0,p.f)(Pa,wa)-c)/n,e[s+2]=l/n,e[s+3]=c/n;const a=9*r;for(let e=0;e<3;e++)t[a+e]=Ma[e],t[a+e+3]=Da[e],t[a+e+6]=za[e]}}const ba=(0,v.vt)(),wa=(0,v.vt)(),Sa=(0,Fi.vt)(),Ca=(0,v.vt)(),Pa=(0,v.vt)(),Aa=(0,v.vt)(),Ra=(0,Le.vt)(),Ta=(0,Le.vt)(),Ma=(0,v.vt)(),Da=(0,v.vt)(),za=(0,v.vt)();const Oa=(0,u.vt)(),Va=(0,v.vt)(),Ea=(0,v.vt)(),Ia=(0,v.vt)();const La=(0,v.vt)();function Ua(e,t,i,r,n,s,a){(0,p.j)(e,t*n[0]+i*s[0]+r*a[0],t*n[1]+i*s[1]+r*a[1],t*n[2]+i*s[2]+r*a[2])}var Fa=i(76956),ka=i(88105),Ga=i(63928),Ba=i(58071);class Ha extends Ut.w{constructor(e,t){super(e,t,new Lt.$(Ba.P,()=>i.e(1109).then(i.bind(i,71109))),Na(t).locations)}_setPipelineState(e,t){const{oitPass:i,output:r,cullFace:n,draped:s,hasOccludees:a,polygonOffset:o}=e,l=0===i;return(0,Bt.Ey)({blending:(0,Dt.RN)(r)?(0,Ft.Yf)(i):null,culling:(0,Bt.Xt)(n),depthTest:s?null:{func:(0,Ft.K_)(i)},depthWrite:(0,Ft.z5)(e),drawBuffers:(0,Ut.L)(r,(0,Ft.m6)(i,r)),colorWrite:Bt.kn,stencilWrite:a?kt.v0:null,stencilTest:a?t?kt.a9:kt.qh:null,polygonOffset:l?o?ja:null:(0,Ft.mE)(e)})}initializePipeline(e){return this._occludeePipelineState=this._setPipelineState(e,!0),this._setPipelineState(e,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}const ja={factor:1,units:1};function Na(e){const t=(0,It.BP)().vec3f("position").vec4f("uvMapSpace");return e.draped||t.mat3f("boundingRect"),e.hasVVColor?t.f32("colorFeatureAttribute"):t.vec4u8("color"),(0,ta.E)()&&t.vec4u8("olidColor"),t.freeze()}class Wa extends Zt.E{constructor(){super(...arguments),this.cullFace=0,this.style=0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasOccludees=!1,this.enableOffset=!0,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasVVColor=!1,this.draped=!1,this.textureCoordinateType=0,this.emissionSource=0,this.discardInvisibleFragments=!0,this.writeDepth=!0,this.occlusionPass=!1,this.hasVVInstancing=!1,this.hasVVSize=!1,this.hasVVOpacity=!1,this.overlayEnabled=!1,this.snowCover=!1}}(0,Nt.Cg)([(0,Wt.W)({count:3})],Wa.prototype,"cullFace",void 0),(0,Nt.Cg)([(0,Wt.W)({count:6})],Wa.prototype,"style",void 0),(0,Nt.Cg)([(0,Wt.W)()],Wa.prototype,"hasVertexColors",void 0),(0,Nt.Cg)([(0,Wt.W)()],Wa.prototype,"polygonOffset",void 0),(0,Nt.Cg)([(0,Wt.W)()],Wa.prototype,"hasOccludees",void 0),(0,Nt.Cg)([(0,Wt.W)()],Wa.prototype,"enableOffset",void 0),(0,Nt.Cg)([(0,Wt.W)()],Wa.prototype,"terrainDepthTest",void 0),(0,Nt.Cg)([(0,Wt.W)()],Wa.prototype,"cullAboveTerrain",void 0),(0,Nt.Cg)([(0,Wt.W)()],Wa.prototype,"hasVVColor",void 0),(0,Nt.Cg)([(0,Wt.W)()],Wa.prototype,"draped",void 0);class Za extends Ga.W{constructor(e){super(e,Xa),this._configuration=new Wa,this.supportsEdges=!0,this.produces=new Map([[2,e=>(0,Dt.CL)(e)],[4,e=>(0,Dt.RN)(e)],[5,e=>(0,Dt.eh)(e)],[18,e=>this.parameters.draped&&(0,Dt.Mb)(e)]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.style=this.parameters.style,this._configuration.draped=this.parameters.draped,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.camera.relativeElevation<Ft.xt,this._configuration.terrainDepthTest=t.terrainDepthTest&&(0,Dt.RN)(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.hasVVColor=!!this.parameters.vvColor,this._configuration}get visible(){return this.parameters.color[3]>=Yt.Q}createGLMaterial(e){return new qa(e)}createBufferWriter(){return new Ya(Na(this.parameters))}}class qa extends zt.A{beginSlot(e){return this.getTechnique(Ha,e)}}class Ya extends Gi.Z{write(e,t,i,r,n,s){const a=(0,Et.vJ)(i,r,this.layout,e,t,n,s);for(const o of this.layout.fields.keys()){const t=i.get(o),r=null===t||void 0===t?void 0:t.indices;if(t&&r)switch(o){case"uvMapSpace":{(0,ki.vA)(4===t.size);const e=n.getField(o,ka.Eq);e&&(0,Et.Ut)(t,e,s);break}case"boundingRect":{(0,ki.vA)(9===t.size);const i=n.getField(o,ka.jZ);i&&Qa(t,e,i,s);break}}}return a}}function Qa(e,t,i,r){const{data:n,indices:s}=e,a=t,o=i.typedBuffer,l=i.typedBufferStride,c=s.length;r*=l;for(let h=0;h<c;++h){const e=9*s[h],t=n[e],i=n[e+1],c=n[e+2];o[r]=a[0]*t+a[4]*i+a[8]*c+a[12],o[r+1]=a[1]*t+a[5]*i+a[9]*c+a[13],o[r+2]=a[2]*t+a[6]*i+a[10]*c+a[14];for(let s=3;s<9;++s)o[r+s]=n[e+s];r+=l}}class Xa extends Vt.S{constructor(){super(...arguments),this.color=(0,Ue.fA)(1,1,1,1),this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=0,this.hasOccludees=!1,this.style=2,this.draped=!0}}function Ka(e,t){if(function(e){return e.material instanceof Za&&!e.material.parameters.draped}(e)){const i=e.attributes.get("position").data;xa(e.getMutableAttribute("uvMapSpace").data,e.getMutableAttribute("boundingRect").data,i,t)}}function $a(e,t,i,r,n){const s=(0,Ye.B6)(e,t,i,r,n),a=e.stageObject.geometries;for(const o of a)Ka(o,n);return s}var Ja=i(12028);const eo=["polyline","polygon","extent"];class to extends C.UF{constructor(e,t,i,r){super(e,t,i,r,function(e){var t,i;return 1===(null!==(t=null===(i=e.material)||void 0===i||null===(i=i.color)||void 0===i?void 0:i.a)&&void 0!==t?t:0)}(t)),this._needsUV=!1,this._materials=[]}async doLoad(){this._fastUpdates=(0,at.s_)(this._context.renderer,this._vvConvertOptions)}get _materialColor(){var e;return null===(e=this.symbolLayer.material)||void 0===e?void 0:e.color}_createMaterials(){var e;if(this._materials.length>0)return;const t=this._materialColor,i=this._getCombinedOpacityAndColor(t);this._materials[0]=function(e,t){const i=null===e||void 0===e?void 0:e.pattern;return null==i?new Fa.v(t):"none"===i.style||"solid"===i.style?("none"===i.style&&(t.color=(0,Ue.fA)(0,0,0,0),t.forceTransparentMode=!0),new Fa.v(t)):(t.style=function(e){switch(e){case"horizontal":return 0;case"vertical":return 1;case"cross":return 2;case"forward-diagonal":return 3;case"backward-diagonal":return 4;case"diagonal-cross":return 5;default:return}}(i.style),new Za(t))}(this.symbolLayer,(0,n.A)({color:i,forceTransparentMode:this.needsDrivenTransparentPass,discardInvisibleFragments:!0,polygonOffset:!1,hasVertexColors:!0,draped:this.draped,hasSlicePlane:this._context.slicePlaneEnabled},null===(e=this._fastUpdates)||void 0===e?void 0:e.materialParameters)),this._needsUV=this._materials[0]instanceof Za;const r=this.symbolLayer.outline;if(function(e){return null!=(null===e||void 0===e?void 0:e.size)&&e.size>0&&null!=e.color&&(null==e.pattern||"style"!==e.pattern.type||"none"!==e.pattern.style)}(r)){const e=(0,ti.Xq)(r.pattern);this._materials[1]=new ii.W({width:(0,Ve.Lz)(r.size),color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:e,cap:Pt(r.patternCap||"butt"),screenSizePerspective:this._outlineScreenSizePerspective},this.view.state.isGlobal)}}get _outlineScreenSizePerspective(){return!this.draped&&(0,Ja.tl)(this._context.layer.screenSizePerspectiveEnabled)?this.view.screenSizePerspective.parameters:null}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,eo,this.symbolLayer.type))return null;const i=this._getDrivenUInt8Color(e.renderingInfo,this._materialColor,!1),r=this.createElevationContextForGraphic(t);return this.ensureDrapedStatus("on-the-ground"===r.mode),this._createMaterials(),this.draped?this._createAsOverlay(t,i):this._createAs3DShape(t,i,r)}applyRendererDiff(e,t){for(const r in e.diff){var i;if("visualVariables"!==r)return 0;if(!(0,at.J_)(this._fastUpdates,t,this._vvConvertOptions))return 0;null===(i=this._materials[0])||void 0===i||i.setParameters(this._fastUpdates.materialParameters)}return 2}layerOpacityChanged(){if(null!=this._materials[0]){const e=this._materials[0].parameters.color,t=this._materialColor,i=this._getCombinedOpacity(t);this._materials[0].setParameters({color:[e[0],e[1],e[2],i],forceTransparentMode:this.needsDrivenTransparentPass})}if(null!=this._materials[1]){const e=this._materials[1].parameters.color;this._materials[1].setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}}layerScreenSizePerspectiveChanged(){var e;null===(e=this._materials[1])||void 0===e||e.setParameters({screenSizePerspective:this._outlineScreenSizePerspective})}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=(0,w.I2)(to.elevationModeChangeTypes,i,r);if(1!==n)return n;const s=(0,w.nu)(r);return this.updateGraphics3DGraphicElevationInfo(e,t,()=>s)}slicePlaneEnabledChanged(){var e;if(null!==(e=this._materials[0])&&void 0!==e&&e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[1]){const e={hasSlicePlane:this._context.slicePlaneEnabled};this._materials[1].setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,t,i){var r;const n=E(e.geometry);if(!n)return null;const s=j(n,this._context.elevationProvider,this._context.renderCoordsHelper,i),a=new ro(s,t,this._context.layerViewUid,e.uid),o=a.renderData.position.length/3;if(this._needsUV&&(a.uvMapSpace=(0,di.oe)(4*o,!0),a.boundingRect=(0,g.jh)(9*o),xa(a.uvMapSpace,a.boundingRect,a.renderData.position,this._context.renderCoordsHelper)),a.olidColor=null===(r=this._context.stage.renderView)||void 0===r?void 0:r.getObjectAndLayerIdColor(a),this._createAs3DShapeFill(e,a),this._materials[1]&&this._createAs3DShapeOutline(a),this._logGeometryCreationWarnings(a.renderData,n.rings,"rings","FillSymbol3DLayer"),0===a.outGeometries.length)return null;const l=new ee.B({geometries:a.outGeometries,castShadow:!1,layerViewUid:this._context.layerViewUid,graphicUid:e.uid}),c=new S.Y(this,l,null,$a,i);return c.alignedSampledElevation=a.renderData.sampledElevation,c.needsElevationUpdates=(0,w.nu)(i.mode),c}_createAs3DShapeFill(e,t){const i=t.renderData.polygons;for(const{position:n,mapPositions:s,holeIndices:a,index:o,count:l}of i){var r;if(null!=this._context.clippingExtent&&((0,m.vY)(s,io),!(0,m.KG)(io,this._context.clippingExtent)))continue;const i=z(s,a,this._context.elevationProvider.spatialReference);if(0===i.length)continue;const c=null===(r=this._fastUpdates)||void 0===r?void 0:r.visualVariables.color,h=O({material:this._materials[0],indices:i,mapPositions:s,attributeData:{position:n,color:c?null:t.color,colorFeature:c?(0,at.ul)(c.field,e):null,uvMapSpace:this._needsUV?(0,di.AK)(t.uvMapSpace,4*o,4*l):null,boundingRect:this._needsUV?(0,g.l5)(t.boundingRect,9*o,9*l):null,olidColor:t.olidColor}});t.outGeometries.push(h)}}_createAs3DShapeOutline(e){if(null==this._materials[1])return;const t=e.renderData.outlines;for(const{mapPositions:i,position:r}of t){if(null!=this._context.clippingExtent&&((0,m.vY)(i,io),!(0,m.KG)(io,this._context.clippingExtent)))continue;const t=(0,Rt.te)(this._materials[1],{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:i,attributeData:{position:r}},e.olidColor);e.outGeometries.push(t)}}_createAsOverlay(e,t){var i;const r=E(e.geometry);if(null==r)return null;this._materials[0].renderPriority=this._renderPriority+this._renderPriorityStep/2,null!=this._materials[1]&&(this._materials[1].renderPriority=this._renderPriority);const n=N(r,this._context.overlaySR),s=new no(n,t,this._context.layerViewUid,e.uid),a=s.renderData.position.length/3;return this._needsUV&&(s.uvMapSpace=(0,di.oe)(4*a,!0),function(e,t,i,r){let n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;if(i.isGeographic&&1===r){const e=(0,g.jh)(t.length),r=t.length,n=(0,_a.tO)(i);for(let i=0;i<r;i+=3)(0,ya.RC)(t,i,e,i,n);t=e}(0,Li.hZ)(Ra,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let c=0;c<t.length;c+=3)Ra[0]=Math.min(Ra[0],t[c]),Ra[1]=Math.min(Ra[1],t[c+1]);const s=Ra[0]%n,a=Ra[1]%n,o=Ra[0]-s,l=Ra[1]-a;for(let c=0;c<t.length;c+=3){const i=c/3*4;e[i]=(t[c]-o)/n,e[i+1]=(t[c+1]-l)/n,e[i+2]=o/n,e[i+3]=l/n}}(s.uvMapSpace,s.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),s.outBoundingBox=(0,m.Ie)(),s.olidColor=null===(i=this._context.stage.renderView)||void 0===i?void 0:i.getObjectAndLayerIdColor(s),this._createAsOverlayFill(e,s),this._materials[1]&&this._createAsOverlayOutline(s),this._logGeometryCreationWarnings(s.renderData,r.rings,"rings","FillSymbol3DLayer"),0===s.outGeometries.length?null:new Je(this,s.outGeometries,s.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(e,t){const i=t.renderData.polygons;for(const{position:n,holeIndices:s,index:a,count:o}of i){var r;const i=(0,m.vY)(n,io);if(!(0,m.KG)(i,this._context.clippingExtent))continue;const c=(0,l.e)(n,s,3);if(0===c.length)continue;(0,m.RF)(t.outBoundingBox,i);const h=null===(r=this._fastUpdates)||void 0===r?void 0:r.visualVariables.color,d=O({material:this._materials[0],indices:c,attributeData:{position:n,color:h?null:t.color,colorFeature:h?(0,at.ul)(h.field,e):null,uvMapSpace:this._needsUV?(0,di.AK)(t.uvMapSpace,4*a,4*o):null,olidColor:t.olidColor}});t.outGeometries.push(new ht.$(d,t))}}_createAsOverlayOutline(e){if(null==this._materials[1])return;const t=e.renderData.outlines;for(let i=0;i<t.length;++i){const{position:r}=t[i];if((0,m.vY)(r,io),!(0,m.KG)(io,this._context.clippingExtent))continue;(0,m.RF)(e.outBoundingBox,io);const n=(0,Rt.te)(this._materials[1],{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:r}},e.olidColor);e.outGeometries.push(new ht.$(n,e))}}_getOutlineOpacity(){var e;const t=null===(e=this.symbolLayer)||void 0===e||null===(e=e.outline)||void 0===e?void 0:e.color;return(this.draped?1:this._getLayerOpacity())*(null!=t?t.a:0)}_getOutlineColor(){var e;const t=null===(e=this.symbolLayer)||void 0===e||null===(e=e.outline)||void 0===e?void 0:e.color,i=this._getOutlineOpacity();return(0,P.$C)(null!=t?Te.A.toUnitRGB(t):null,i)}test(){return(0,n.A)((0,n.A)({},super.test()),{},{createAsOverlay:(e,t)=>this._createAsOverlay(e,t),createAs3DShape:(e,t,i)=>this._createAs3DShape(e,t,i)})}get _vvConvertOptions(){var e;return new at.wI({supports:{size:!1,color:!0,rotation:!1,opacity:!1},fallbackColor:null!==(e=Te.A.toUnitRGBA(this._materialColor))&&void 0!==e?e:Ue.uY})}}to.elevationModeChangeTypes={definedChanged:2,staysOnTheGround:0,onTheGroundChanged:2};const io=(0,m.vt)();class ro extends I{constructor(e,t,i,r){super(e,i,r),this.color=t}}class no extends I{constructor(e,t,i,r){super(e,i,r),this.color=t}}var so=i(82041),ao=i(28350);class oo{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"center",i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:(0,Le.vt)(),n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:(0,Ue.fA)(0,0,0,-1),s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"world",a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:(0,v.vt)(),o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0;this.verticalOffset=e,this.anchor=t,this.hasLabelVerticalOffset=i,this.screenOffset=r,this.centerOffset=n,this.centerOffsetUnits=s,this.translation=a,this.elevationOffset=o}}class lo{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"center",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"center",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:(0,Le.vt)(),s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];this.placement=e,this.horizontalPlacement=t,this.verticalPlacement=i,this.text=r,this.displaySize=n,this.isFocused=s}}var co=i(48190),ho=i(85504);class uo{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=po(e.color),this.haloStyle=function(e){return"rgb(".concat(e.slice(0,3).map(e=>Math.floor(255*e)).toString(),")")}(e.halo.color),this.backgroundStyle=0!==e.background.color[3]?po(e.background.color):null}fontString(e){const t=this.definition.font;return"".concat(t.style," ").concat(t.weight," ").concat(e,"px ").concat(t.family,", ").concat("sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji")}setFontProperties(e,t){e.font=this.fontString(t),e.textAlign="left",e.textBaseline="alphabetic"}static async fromSymbol(e,t){var i,n,s,a,o,l,c,h,d,u;const p=null===e||void 0===e||null===(i=e.material)||void 0===i?void 0:i.color,v=null!==(n=Te.A.toUnitRGBA(p))&&void 0!==n?n:Ue.uY,f=null!=e.size?(0,Ve.Lz)(e.size):12,m=e.lineHeight,g=null!=e.background?Te.A.toUnitRGBA(e.background.color):Ue.uY,_={family:null!==(s=null===(a=e.font)||void 0===a?void 0:a.family)&&void 0!==s?s:"sans-serif",decoration:null!==(o=null===(l=e.font)||void 0===l?void 0:l.decoration)&&void 0!==o?o:"none",weight:null!==(c=null===(h=e.font)||void 0===h?void 0:h.weight)&&void 0!==c?c:"normal",style:null!==(d=null===(u=e.font)||void 0===u?void 0:u.style)&&void 0!==d?d:"normal"},y=e.halo,x=null!=(null===y||void 0===y?void 0:y.color)&&y.size>0?{size:(0,Ve.Lz)(y.size),color:Te.A.toUnitRGBA(y.color)}:{size:0,color:Ue.uY},b=new uo({color:v,size:f,background:{color:g,padding:null!=e.background?[.65*f,.5*f]:[0,0],borderRadius:null!=e.background?f*(6/16):0},lineSpacingFactor:m,font:_,halo:x,pixelRatio:t});if(e.font){let t=!1;const i=b.fontString(f);try{t=(await document.fonts.load(i)).some(e=>!(0,ho.NZ)(e))}catch(jt){r.A.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce("Failed to preload font '".concat(i,"'. Some text symbology may be rendered using the default browser font."))}if(!t&&!vo.has(e.font.family))try{await(0,ho.Al)(e.font)}catch(jt){}}return b}}function po(e){return"rgba(".concat(e.slice(0,3).map(e=>Math.floor(255*e)).toString(),",").concat(e[3],")")}const vo=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]);var fo=i(39345),mo=i(42510),go=i(91967),_o=i(54099),yo=i(90632),xo=(i(47249),i(67737)),bo=i(81330),wo=i(22856),So=i(80895),Co=i(96673);const Po=4096;let Ao=class extends go.A{constructor(e){super(e),this.id=(0,yo.c)(),this.events=new _o.bk,this._glTexture=null,this._atlas=new Do(256,256),this._needsRepack=!1,this._canRepack=!0,this._elementsToRender=new Map,this._elements=new Map,this._uvCallbacks=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view.stage,this._stage.addTexture(this),this._updateCanvasElementSize(this._atlas),this._reset()}unload(){this._glTexture=(0,ze.WD)(this._glTexture),this._frameWorker=(0,ze.xt)(this._frameWorker),this.updating=!1,this.events.emit("unloaded")}get loaded(){return null!=this._glTexture}get glTexture(){return this._glTexture}static get maxSize(){return Oo=xo.G.stableRendering?Ro:0,[Po-Ro-Oo,Po-Ro-Oo-To]}load(e){if(this._glTexture)return this._glTexture;const t=new Co.R;return t.wrapMode=33071,t.samplingMode=9987,t.hasMipmap=!0,t.preMultiplyAlpha=!0,t.maxAnisotropy=e.parameters.maxMaxAnisotropy,this._glTexture=new So.g(e,t,this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(Pn.W6.TEXT_TEXTURE_ATLAS,this),this.setDirty(),this._glTexture}dispose(){this._elements.clear(),this._elementsToRender.clear(),this._frameWorker=(0,ze.xt)(this._frameWorker),this._glTexture&&(this._stage.removeTexture(this),this._glTexture=(0,ze.WD)(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(e){this._canvas.width=e.width,this._canvas.height=e.height}_resizeAtlas(e,t){var i,r;const{width:n,height:s}=this._atlas;n===e&&s===t||(this._atlas.width=e,this._atlas.height=t,null!==(i=this._glTexture)&&void 0!==i&&i.resize(e,t),null!==(r=this._glTexture)&&void 0!==r&&r.updateData(0,0,0,n,s,this._canvas),this._updateCanvasElementSize(this._atlas),this._elements.forEach(e=>{var t;return null===(t=this._uvCallbacks.get(e.textRenderer.key))||void 0===t?void 0:t.forEach(t=>t(e.uv))}),this._reset())}_reset(){this._elementsToRender.clear(),this._atlas.reset(),this._needsRepack=!0,this.setDirty()}_addAtlasElement(e,t,i,r){const n=this._atlas;if(n.width<i||n.height<r)return!1;let s=n.cursors.get(r);if(!s){if(n.height<n.nextY+r)return!1;s=[new zo(n.nextY)],n.cursors.set(r,s),n.nextY+=r}let a=s.find(e=>n.width>=e.x+i);if(null==a){if(n.height<n.nextY+r)return!1;a=new zo(n.nextY),n.nextY+=r,s.push(a)}return e.setNewPosition(a),this._elements.set(t,e),this._elementsToRender.set(t,e),a.x+=i,!0}_ensureCallbacks(e){const t=this._uvCallbacks.get(e);if(t)return t;const i=new Set;return this._uvCallbacks.set(e,i),i}_addCallback(e,t){this._ensureCallbacks(e).add(t)}_removeCallback(e,t){const i=this._uvCallbacks.get(e);return!(null===i||void 0===i||!i.delete(t)||0!==i.size)&&(this._uvCallbacks.delete(e),!0)}_processAddition(e){const t=e.textRenderer.key;if(this._needsRepack)return void this._elements.set(t,e);const i=this._atlas,r=e.textRenderer.renderedWidth,n=e.textRenderer.renderedHeight,s=r+Ro,a=n+Ro+To;if(!this._addAtlasElement(e,t,s,a)){if(this._canRepack)this._reset();else if(i.width<s){const e=(0,bo.FC)(Math.max(s,1.5*i.width),Po);this._resizeAtlas(e,i.height)}else{const e=i.nextY+a,t=(0,bo.FC)(Math.max(e,1.5*i.height),Po);if(t>i.height)this._resizeAtlas(i.width,t);else if(i.width<Po){const e=(0,bo.FC)(1.5*i.width,Po);this._resizeAtlas(e,i.height)}}this._elements.set(t,e)}}_renderElement(e){var t;const i=e.commitNewPosition(),r=e.textRenderer;this._ctx.clearRect(i[0]-Ro,i[1]-Ro,r.renderedWidth+2*Ro,r.renderedHeight+2*Ro),r.render(this._ctx,i[0],i[1]),null===(t=this._uvCallbacks.get(r.key))||void 0===t||t.forEach(t=>t(e.uv))}get readyToRun(){return this.updating}runTask(e){if(null==this._glTexture)return wo.G;for(;this._needsRepack&&(this._canRepack||this._atlas.height<Po&&this._atlas.height<Po);){this._canRepack=this._needsRepack=!1;const t=this._elements;this._elements=new Map,t.forEach(e=>this._processAddition(e)),e.madeProgress()}if(this._elementsToRender.size>0){for(const[t,i]of this._elementsToRender){if(e.done)break;this._renderElement(i),this._elementsToRender.delete(t),e.madeProgress()}this._glTexture.setData(this._canvas)}this.updating=this._elementsToRender.size>0}addText(e,t){const i=e.key;this._addCallback(i,t);let r=this._elements.get(i);return r?(0,Ct.a)(r.uv,Ue.uY)||t(r.uv):(r=new Mo(e),this._processAddition(r),this.setDirty()),{remove:()=>this._removeText(e,t)}}_removeText(e,t){const i=e.key;this._elements.get(i)&&this._removeCallback(i,t)&&(this._elements.delete(i),this._elementsToRender.delete(i),this._canRepack=!0)}setDirty(){this._glTexture&&(this.updating=!0)}get test(){}get usedMemory(){var e,t,i,r,n,s;return(null!==(e=null===(t=this._glTexture)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0)+(null!==(i=null===(r=this._canvas)||void 0===r?void 0:r.width)&&void 0!==i?i:0)*(null!==(n=null===(s=this._canvas)||void 0===s?void 0:s.height)&&void 0!==n?n:0)*4}};(0,Nt.Cg)([(0,tn.MZ)({constructOnly:!0})],Ao.prototype,"view",void 0),(0,Nt.Cg)([(0,tn.MZ)({type:Boolean})],Ao.prototype,"updating",void 0),Ao=(0,Nt.Cg)([(0,rn.$)("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],Ao);const Ro=2,To=2;class Mo{constructor(e){this.textRenderer=e,this._uv=(0,Ue.vt)(),this._newPosition=[0,0]}get uv(){if(null==this._xOffset||null==this._yOffset)return Ue.uY;const{renderedWidth:e,renderedHeight:t}=this.textRenderer;return(0,Ct.s)(this._uv,this._xOffset,this._yOffset+t,this._xOffset+e,this._yOffset)}setNewPosition(e){this._newPosition[0]=e.x,this._newPosition[1]=e.y}commitNewPosition(){return this._xOffset=this._newPosition[0],this._yOffset=this._newPosition[1],this._newPosition}get xOffset(){return this._xOffset}get yOffset(){return this._yOffset}}class Do{constructor(e,t){this.width=e,this.height=t,this.cursors=new Map,this.nextY=0}reset(){this.cursors.clear(),this.nextY=Oo}}class zo{constructor(e){this.y=e,this.x=Oo}}let Oo=0;class Vo{constructor(e,t,i){this._renderer=new mo.J(e,t,i,Ao.maxSize)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){const e=(0,fo.y)(Eo,this._renderer.renderedWidth,this._renderer.renderedHeight),t=e.getContext("2d");return t.save(),this._renderer.render(t,0,0),t.restore(),new dt.g(e,{wrap:{s:33071,t:33071},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0})}}const Eo={canvas:null},Io=(0,v.CN)(0,0,1);class Lo extends C.UF{constructor(e,t,i,r){super(e,t,i,r),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=(0,P.Hj)(this.symbolLayer.size);if(e)throw new De.A("graphics3dtextsymbollayer:invalid-size",e)}await this._createTextRenderParameters()}async _createTextRenderParameters(){const e=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;this._textRenderParameters=await uo.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(e){var t,i;const r=e.graphic,n=(0,st.ZX)(r.geometry);if(null==n)return this.logger.warn("unsupported geometry type for text symbol: ".concat(r.geometry.type)),null;const s=null===(t=null===(i=this.view.focusAreasView)||void 0===i?void 0:i.containsGeometry(n))||void 0===t||t,a=this.symbolLayer.text;if(null==a||""===a)return null;const o=(0,so.YX)(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(null!=o&&!(0,so.Ie)(this.symbolLayer))return this.logger.errorOncePerTick("Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '".concat(this.symbolLayer.horizontalAlignment,"' alignment)")),null;const{verticalAlignment:l}=this.symbolLayer,c=new oo(o);(0,nt.xU)(l,c.screenOffset);const h=new lo(c,this.symbolLayer.horizontalAlignment,(0,nt.RH)(l));return h.isFocused=null!==s&&void 0!==s?s:h.isFocused,this._createAs3DShape(r,n,a,h)}get needsUpdateFocus(){return!0}createLabel(e,t,i,r,n){var s,a;const o=e.graphic,l=(0,st.ZX)(o.geometry);if(null==l)return this.logger.warn("unsupported geometry type for label: ".concat(o.geometry.type)),null;const c=null===(s=null===(a=this.view.focusAreasView)||void 0===a?void 0:a.containsGeometry(l))||void 0===s||s,h=t.text;return!h||/^\s+$/.test(h)?null:(t.isFocused=null!==c&&void 0!==c?c:t.isFocused,this._createAs3DShape(o,l,h,t,i,r,n))}createElevationContextForGraphic(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;const i=super.createElevationContextForGraphic(e);return i.addOffsetRenderUnits(t),i}updateElevationContextForGraphic(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;super.updateElevationContextForGraphic(e,t),e.addOffsetRenderUnits(i)}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerScreenSizePerspectiveChanged(e,t){const i=!this.draped&&this._context.screenSizePerspectiveEnabled,r=i?this.view.screenSizePerspective.labelParameters:null,n=i?this.view.screenSizePerspective.parameters:null;Uo(e,t,e=>{for(const t of e.stageObject.geometries)t.material.setParameters({screenSizePerspective:r,screenSizePerspectiveAlignment:n})})}layerElevationInfoChanged(e,t){return Uo(e,t,(e,t)=>{this.graphics3DGraphicLayerElevationInfoChanged(t,e)}),1}slicePlaneEnabledChanged(e,t){return Uo(e,t,e=>{for(const t of e.stageObject.geometries)t.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return!1}graphics3DGraphicLayerElevationInfoChanged(e,t){var i;const{elevationContext:r,metadata:n}=t;this.updateElevationContextForGraphic(r,e,null!==(i=null===n||void 0===n?void 0:n.elevationOffset)&&void 0!==i?i:0),t.needsElevationUpdates=(0,w.nu)(r.mode)||"absolute-height"===r.mode}updateGeometry(e,t){const i=e.geometry;if(this.draped||!i||!this._validateGeometry(i))return!1;const{elevationContext:r,stageObject:n}=t;if(r.mode!==this.getGeometryElevationMode(i))return!1;const s=(0,st.ZX)(i);if(!s)return!1;r.updateFeatureExpressionFeature(e,this._context.layer);const a=(0,st.hS)(n,this._context,s,r);if(null==a)return!1;const o=(0,st.R$)(this._context,s);return n.geometries[0].localOrigin===o&&(t.alignedSampledElevation=a,(0,st.d2)(t,s,this._context.elevationProvider),!0)}_defaultElevationInfoNoZ(){return Fo}_createAs3DShape(e,t,i,r,n){var a,o,l,c;let h=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,d=arguments.length>6&&void 0!==arguments[6]?arguments[6]:()=>r.placement.elevationOffset;const u=this.createElevationContextForGraphic(e,r.placement.elevationOffset),p=e.uid;let v=null,f=null;if(null==h){const e=(0,nt.QE)(r.horizontalPlacement);v=new Vo(i,e,this._textRenderParameters);let t=null;if(null!=this._context.sharedResources.textures){f=this._context.sharedResources.textures.fromData(v.key,()=>v.create()),f.texture.events.on("unloaded",()=>t=(0,ze.Gz)(t));const e=this._context.stage.renderView.textures.acquire(f.texture.id);if(null==e||(0,Oe.$X)(e))return f.release(),null;t=e}}const m=!!(0,s.A)("enable-feature:non-occluded-hud"),g=function(e,t){if("baseline"===t.verticalPlacement){const i=nt.cN[t.horizontalPlacement],r=null!=e?e.baselineAnchorY:0;return(0,Le.fA)(i,r)}const i=(0,nt.Ir)(t.horizontalPlacement,t.verticalPlacement);return nt.Zd[i]}(v,r),_={occlusionTest:!m,occludedFragmentFade:m,horizonCullingEnabled:m&&this._context.spherical,screenOffset:r.placement.screenOffset,anchorPosition:g,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:r.placement.centerOffsetUnits,depthEnabled:!1,drawAsLabel:!0,isLabel:!0,isFocused:r.isFocused};if("polyline"===(null===(a=e.geometry)||void 0===a?void 0:a.type)&&(_.shaderPolygonOffset=1e-4),h?_.textureId=h.id:f&&(_.textureId=f.texture.id),null!=r.placement.verticalOffset){const{screenLength:e,minWorldLength:t,maxWorldLength:i}=r.placement.verticalOffset;_.verticalOffset={screenLength:(0,Ve.Lz)(e),minWorldLength:t||0,maxWorldLength:null!=i?i:1/0}}const y=null===(o=this._context.graphicsCoreOwner.view.focusAreasView)||void 0===o?void 0:o.polygons.length,x={screenOffset:_.screenOffset,anchorPosition:g,centerOffsetUnits:_.centerOffsetUnits,verticalOffset:_.verticalOffset,shaderPolygonOffset:_.shaderPolygonOffset,occlusionTest:_.occlusionTest,isFocused:r.isFocused,focusStyle:null!==(l=null===(c=this.view.map)||void 0===c?void 0:c.focusAreas.style)&&void 0!==l?l:"none"};if(this._context.screenSizePerspectiveEnabled){const{parameters:e,labelParameters:t}=this.view.screenSizePerspective,i=(0,co.z)(this._textRenderParameters);_.screenSizePerspective=t,_.screenSizePerspectiveMinPixelReferenceSize=i.maxHeight,_.screenSizePerspectiveAlignment=e,x.fontHeight=i.maxHeight}_.hasSlicePlane=this._context.slicePlaneEnabled;const b=this._context.spherical,C=n?JSON.stringify(x):"";let P=null===n||void 0===n?void 0:n.get(C);if(null==P){if(!r.isFocused&&y){var A;const e=null===(A=this.view.map)||void 0===A?void 0:A.focusAreas.style;_.color=Ke(_.color,e),_.outlineColor=Ke(_.outlineColor,e)}P=new ut.R(_,b),null===n||void 0===n||n.set(C,P)}const R=r.placement.translation,T=v?(0,Le.fA)(v.displayWidth,v.displayHeight):Le.uY,M=r.placement.centerOffset,D=Io,z=h?(0,Ue.fA)(0,0,0,0):null,O=(0,ct.DJ)(P,{normal:D,position:R,size:T,centerOffsetAndDistance:M,uvi:z}),V=(0,st.SZ)(this._context,t,O,u,p);if(null==V)return null;const E=new S.Y(this,V.object,f,(t,i,n,s,a,o)=>{const l=d()||r.placement.elevationOffset;return this.updateElevationContextForGraphic(i,e,l),(0,Ye.G8)(t,i,n,s,a,o)},u);E.alignedSampledElevation=V.sampledElevation,E.needsElevationUpdates=(0,w.nu)(u.mode)||"absolute-height"===u.mode,E.getScreenSize=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:(0,Le.vt)();return e[0]=v?v.displayWidth:r.displaySize[0],e[1]=v?v.displayHeight:r.displaySize[1],e};const I=new ao.Z(r.placement.elevationOffset,i);return E.metadata=I,(0,st.d2)(E,t,this._context.elevationProvider),E}}function Uo(e,t,i){null===e||void 0===e||e.forEach(e=>{const r=t(e);null!=r&&i(r,e.graphic)})}const Fo={mode:"relative-to-ground",offset:0};var ko=i(91417),Go=(i(82884),i(15263));class Bo extends Ut.w{constructor(e,t){super(e,t,new Lt.$(Go.W,()=>i.e(9233).then(i.bind(i,69233))),(0,ta.E)()?Bi.wB.locations:Bi.KL.locations)}initializePipeline(e){const{oitPass:t,output:i,transparent:r,draped:n}=e;return(0,Bt.Ey)({blending:3!==i&&9!==i&&10!==i&&r?(0,Ft.Yf)(t):null,depthTest:n?null:{func:(0,Ft.K_)(t)},depthWrite:(0,Ft.z5)(e),drawBuffers:(0,Ft.m6)(t,i),colorWrite:Bt.kn,polygonOffset:(0,Ft.mE)(e)})}}class Ho extends zt.A{ensureResources(e){return this._techniques.context.waterTextures.ensureResources(e)}beginSlot(e){const t=this._techniques.context.waterTextures.passParameters;return this._material.setParameters({wavePerturbation:t.wavePerturbation,waveNormal:t.waveNormal}),this.getTechnique(Bo,e)}}class jo extends Zt.E{constructor(e){super(),this.spherical=e,this.receiveShadows=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.screenSpaceReflections=!1,this.cloudReflections=!1,this.draped=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.textureCoordinateType=0,this.emissionSource=0,this.pbrMode=3,this.occlusionPass=!1,this.useCustomDTRExponentForWater=!0,this.highStepCount=!0,this.useFillLights=!1,this.overlayEnabled=!1,this.snowCover=!1}get discardInvisibleFragments(){return this.transparent&&this.writeDepth}}(0,Nt.Cg)([(0,Wt.W)()],jo.prototype,"receiveShadows",void 0),(0,Nt.Cg)([(0,Wt.W)()],jo.prototype,"transparent",void 0),(0,Nt.Cg)([(0,Wt.W)()],jo.prototype,"enableOffset",void 0),(0,Nt.Cg)([(0,Wt.W)()],jo.prototype,"writeDepth",void 0),(0,Nt.Cg)([(0,Wt.W)()],jo.prototype,"screenSpaceReflections",void 0),(0,Nt.Cg)([(0,Wt.W)()],jo.prototype,"cloudReflections",void 0),(0,Nt.Cg)([(0,Wt.W)()],jo.prototype,"draped",void 0),(0,Nt.Cg)([(0,Wt.W)()],jo.prototype,"terrainDepthTest",void 0),(0,Nt.Cg)([(0,Wt.W)()],jo.prototype,"cullAboveTerrain",void 0);class No extends Ga.W{constructor(e,t){super(e,Wo),this.produces=new Map([[2,e=>(0,Dt.RN)(e)&&!this.parameters.transparent||(0,Dt.CL)(e)],[4,e=>(0,Dt.RN)(e)&&this.parameters.transparent||(0,Dt.CL)(e)],[18,e=>this.parameters.draped&&(0,Dt.RN)(e)||3===e||(0,Dt.CL)(e)],[19,e=>3===e]]),this._configuration=new jo(t.spherical)}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.writeDepth=!0,this._configuration.receiveShadows=(0,Dt.RN)(e)&&t.shadowMap.enabled,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.screenSpaceReflections=null!=t.ssr.lastFrameColor,this._configuration.cloudReflections=null!=t.clouds.data,this._configuration.draped=this.parameters.draped,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.camera.relativeElevation<Ft.xt,this._configuration.terrainDepthTest=t.terrainDepthTest&&(0,Dt.RN)(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration}get visible(){return!0}update(e){return this.setParameters({timeElapsed:(0,ko.y)(e.time)*this.parameters.animationSpeed},!1),this._animationEnabled(e.camera)&&e.dt>0}_animationEnabled(e){const t=Math.min(e.relativeElevation,e.distance);return Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*t<Zo}createGLMaterial(e){return new Ho(e)}createBufferWriter(){return new Gi.Z((0,ta.E)()?Bi.wB:Bi.KL)}get test(){}}class Wo extends Ot.q{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=(0,Le.fA)(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=(0,Ue.fA)(0,0,0,0),this.transparent=!0,this.hasSlicePlane=!1,this.draped=!1,this.origin=(0,v.vt)(),this.modelTransformation=null}}const Zo=35e3,qo={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}};var Yo;const Qo=["polyline","polygon","extent"];class Xo extends C.UF{constructor(e,t,i,r){super(e,t,i,r)}async doLoad(){}createGraphics3DGraphic(e){const t=e.graphic;if(!this._validateGeometry(t.geometry,Qo,this.symbolLayer.type))return null;const i=this.createElevationContextForGraphic(t);return this.ensureDrapedStatus("on-the-ground"===i.mode),this.ensureMaterial(),this.draped?this._createAsOverlay(t):this._createAs3DShape(t,i,t.uid)}ensureMaterial(){if(this._materials[0])return;const e=new Wo,t=Te.A.toUnitRGBA(this.symbolLayer.color);t[3]*=this._getLayerOpacity(),e.color=t,e.transparent=t[3]<1||this.needsDrivenTransparentPass,e.waveDirection=null!=this.symbolLayer.waveDirection?function(e){const t=(0,Le.vt)(),i=(0,Os.DF)(e);return t[0]=Math.sin(i),t[1]=Math.cos(i),t}(this.symbolLayer.waveDirection):(0,Le.fA)(0,0);const i=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,r=qo[i];e.waveStrength=r.waveStrength,e.waveTextureRepeat=r.textureRepeat,e.waveVelocity=r.waveVelocity,e.flowStrength=r.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.draped=this.draped,this._materials[0]=new No(e,this._context)}layerOpacityChanged(){if(null==this._materials[0])return;const e=this._materials[0].parameters.color,t=this.symbolLayer.color.a*this._getLayerOpacity(),i=t<1||this.needsDrivenTransparentPass;this._materials[0].setParameters({color:[e[0],e[1],e[2],t],transparent:i})}layerScreenSizePerspectiveChanged(){}layerElevationInfoChanged(e,t,i){const r=this._elevationContext.mode,n=(0,w.I2)(Xo.elevationModeChangeTypes,i,r);if(1!==n)return n;const s=(0,w.nu)(r);return this.updateGraphics3DGraphicElevationInfo(e,t,()=>s)}slicePlaneEnabledChanged(){var e;return null!==(e=this._materials[0])&&void 0!==e&&e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}get needsDrivenTransparentPass(){return!1}_createAs3DShape(e,t,i){var r;const n=E(e.geometry);if(null==n)return null;const s=j(n,this._context.elevationProvider,this._context.renderCoordsHelper,t),a=s.position.length/3,o=(0,di.oe)(2*a);Ko(o,s.mapPositions,a,this._context.elevationProvider.spatialReference);const l=new il(s,o,this._context.layerViewUid,e.uid);if(l.olidColor=null===(r=this._context.stage.renderView)||void 0===r?void 0:r.getObjectAndLayerIdColor(l),this._create3DShapeGeometries(l),this._logGeometryCreationWarnings(l.renderData,n.rings,"rings","WaterSymbol3DLayer"),0===l.outGeometries.length)return null;const c=new ee.B({geometries:l.outGeometries,castShadow:!1,layerViewUid:this._context.layerViewUid,graphicUid:i}),h=new S.Y(this,c,null,Ye.B6,t);return h.alignedSampledElevation=l.renderData.sampledElevation,h.needsElevationUpdates=(0,w.nu)(t.mode),h}_create3DShapeGeometries(e){const t=e.renderData.polygons,i=e.uvCoords;for(const{count:r,index:n,position:s,mapPositions:a,holeIndices:o}of t){if(null!=this._context.clippingExtent&&((0,m.vY)(a,tl),!(0,m.KG)(tl,this._context.clippingExtent)))continue;const t=(0,l.e)(a,o,3);if(0===t.length)continue;const c=(0,di.AK)(i,2*n,2*r),h=V({material:this._materials[0],indices:t,mapPositions:a,attributeData:{position:s,uv0:c}},e.olidColor);e.outGeometries.push(h)}}_createAsOverlay(e){var t;const i=E(e.geometry);if(null==i)return null;this._materials[0].renderPriority=this._renderPriority;const r=N(i,this._context.overlaySR),n=r.position.length/3,s=(0,di.oe)(2*n);Ko(s,r.position,n,this._context.overlaySR);const a=new rl(r,s,this._context.layerViewUid,e.uid);return a.olidColor=null===(t=this._context.stage.renderView)||void 0===t?void 0:t.getObjectAndLayerIdColor(a),a.outBoundingBox=(0,m.Ie)(),this._createAsOverlayWater(a),this._logGeometryCreationWarnings(a.renderData,i.rings,"rings","WaterSymbol3DLayer"),0===a.outGeometries.length?null:new Je(this,a.outGeometries,a.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayWater(e){const t=e.uvCoords,i=e.renderData.polygons;for(const{position:r,holeIndices:n,index:s,count:a}of i){if((0,m.vY)(r,tl),!(0,m.KG)(tl,this._context.clippingExtent))continue;(0,m.RF)(e.outBoundingBox,tl);const i=(0,l.e)(r,n,3);if(0===i.length)continue;const o=(0,di.AK)(t,2*s,2*a),c=V({material:this._materials[0],indices:i,attributeData:{position:r,uv0:o}},e.olidColor);e.outGeometries.push(new ht.$(c,e))}}test(){return(0,n.A)((0,n.A)({},super.test()),{},{create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()})}}function Ko(e,t,i,r){const n=(0,o.GA)(r);(0,$e.Ie)(Jo);for(let o=0;o<i;o++)(0,Li.hZ)(el,t[3*o],t[3*o+1]),(0,$e.tK)(Jo,el);(0,Ct.c)(Jo,Jo,n);const s=Jo[0]%Xo.unitSizeOfTexture,a=Jo[1]%Xo.unitSizeOfTexture;$o[0]=Jo[0]-s,$o[1]=Jo[1]-a;for(let o=0;o<i;o++)e[2*o]=(t[3*o]*n-$o[0])/Xo.unitSizeOfTexture,e[2*o+1]=(t[3*o+1]*n-$o[1])/Xo.unitSizeOfTexture}(Yo=Xo).unitSizeOfTexture=100,Yo.elevationModeChangeTypes={definedChanged:2,staysOnTheGround:0,onTheGroundChanged:2};const $o=(0,Le.vt)(),Jo=(0,$e.vt)(),el=(0,Le.vt)(),tl=(0,m.vt)();class il extends I{constructor(e,t,i,r){super(e,i,r),this.uvCoords=t}}class rl extends I{constructor(e,t,i,r){super(e,i,r),this.uvCoords=t}}function nl(e,t,i,n){var s;const a=(null===(s=al[e.type])||void 0===s?void 0:s[t.type])||sl[t.type];return a?new a(e,t,i,n):(r.A.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory").error("GraphicsLayerFactory#make","unknown symbol type ".concat(t.type)),null)}const sl={icon:ft,object:Fn,line:ni,path:ua,fill:to,extrude:re,text:Lo,water:Xo},al={"mesh-3d":{fill:vr}}},42510:(e,t,i)=>{i.d(t,{J:()=>l,X:()=>o});var r=i(15941),n=i(22955),s=i(48190),a=i(39345);const o=1;class l{constructor(e,t,i,r){this.text=e,this._alignment=t,this._parameters=i,this._maxSize=r,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key="".concat(e,"--").concat(this._parameters.key,"-").concat(this._alignment),this._lines=e.replaceAll(" ","\xa0").split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._horizontalPadding)}get displayHeight(){let e=this._metrics.firstLineAscent;for(let t=0;t<this._lines.length-1;t++)e+=this._lineSpacing;return e+=this._metrics.lastLineDescent,Math.ceil(e+2*this._haloSize+2*this._verticalPadding)}get renderedWidth(){return this._toRoundedRenderUnit(this.displayWidth)}get renderedHeight(){return this._toRoundedRenderUnit(this.displayHeight)}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._metrics.firstLineAscent)}get _firstLineYOffset(){return this._verticalPadding+this._haloSize}get _metrics(){if(null==this._metricsCached){const e=(0,a.y)(h,u,u).getContext("2d"),t=this._parameters.definition.pixelRatio,i=this._fontSize*t;this._parameters.setFontProperties(e,i);let r=2*this._haloSize;const n=this._parameters.definition.font;"italic"!==n.style&&"oblique"!==n.style&&"bold"!==n.weight&&"bolder"!==n.weight||(r+=.3*e.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let o=0,l=0,c=0,d=0,p=0;this._lines.forEach((i,n)=>{const s=e.measureText(i),a=s.width/t,h=a+r;this._textWidths.push(a),this._lineWidths.push(h),o=Math.max(o,h),d=Math.max(d,s.actualBoundingBoxAscent/t),p=Math.max(p,s.actualBoundingBoxDescent/t),0===n&&(l=s.actualBoundingBoxAscent/t),n===this._lines.length-1&&(c=s.actualBoundingBoxDescent/t)});const f=(0,s.z)(this._parameters),m=Math.max(d,f.maxAscent),g=Math.max(p,f.maxDescent),_=l,y="underline"===this._parameters.definition.font.decoration?g:c,x=o;this._metricsCached=new v(_,y,m,g,x)}return this._metricsCached}get _lineSpacing(){return(this._midLineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _midLineHeight(){return this._metrics.midLineHeight}get _linePadding(){return this._midLineHeight*d}get _midLineAscent(){return this._metrics.maxLineAscent}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _horizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _verticalPadding(){return Math.max(this._hasBackground?this._parameters.definition.background.padding[1]:0,o)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(null==this._renderPixelRatio){const e=this._parameters.definition.pixelRatio;this._renderPixelRatio=Math.min(e,Math.min(this._maxSize[0]/this.displayWidth,this._maxSize[1]/this.displayHeight))}return this._renderPixelRatio}_getLineXOffset(e){switch(this._alignment){case 0:return this._horizontalPadding;case 1:return(this.displayWidth-this._lineWidths[e])/2;case 2:return this.displayWidth-this._horizontalPadding-this._lineWidths[e]}}render(e,t,i){e.save();const r=t/=this.renderPixelRatio,s=i/=this.renderPixelRatio,a=this._haloSize,o=this._firstLineYOffset+this._metrics.firstLineAscent;t+=a,i+=o;const l=this._haloSize>0;l&&this._renderHalo(e,r,s,a,o),this._parameters.setFontProperties(e,this._renderedFontSize);for(let n=0;n<this._lines.length;++n){const r=this._lines[n],s=this._getLineXOffset(n);l&&(e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",this._fillText(e,r,t+s,i),this._renderLineDecoration(e,t+s,i,this._textWidths[n])),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.textStyle,this._fillText(e,r,t+this._getLineXOffset(n),i),this._renderLineDecoration(e,t+s,i,this._textWidths[n]),i+=this._lineSpacing}if(n.b.TEXT_SHOW_BASELINE){e.strokeStyle=p,e.setLineDash([2,2]),e.lineWidth=1;let t=s+o;for(let i=0;i<this._lines.length;++i)this._drawLine(e,[r,t],[r+this.displayWidth,t]),t+=this._lineSpacing}if(n.b.TEXT_SHOW_BORDER&&(e.strokeStyle=p,e.setLineDash([]),e.lineWidth=1,this._drawBox(e,[r,s],[this.displayWidth,this.displayHeight])),this._hasBackground){const t=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(e,r,s,t),e.globalCompositeOperation="destination-over",e.fillStyle=this._parameters.backgroundStyle,e.fill()}e.restore()}_renderLineDecoration(e,t,i,r){let n=arguments.length>4&&void 0!==arguments[4]&&arguments[4];if("none"===this._parameters.definition.font.decoration||0===r)return;const s=Math.max(this._parameters.definition.size/16,1);switch(this._parameters.definition.font.decoration){case"underline":i+=2*s;break;case"line-through":i-=.33*this._midLineAscent}const a=n?this._haloSize:0;e.strokeStyle=n?this._parameters.haloStyle:this._parameters.textStyle,e.lineWidth=this._toRenderUnit(s+2*a),e.beginPath(),e.moveTo(this._toRenderUnit(t-a),this._toRenderUnit(i)),e.lineTo(this._toRenderUnit(t+r+a),this._toRenderUnit(i)),e.stroke()}_roundedRect(e,t,i,n){t=this._toRenderUnit(t),i=this._toRenderUnit(i);const s=this.renderedWidth,a=this.renderedHeight;0!==n?(n=(0,r.qE)(n,0,Math.floor(a/2)),e.beginPath(),e.moveTo(t,i+n),e.arcTo(t,i,t+n,i,n),e.lineTo(t+s-n,i),e.arcTo(t+s,i,t+s,i+n,n),e.lineTo(t+s,i+a-n),e.arcTo(t+s,i+a,t+s-n,i+a,n),e.lineTo(t+n,i+a),e.arcTo(t,i+a,t,i+a-n,n),e.closePath()):e.rect(t,i,s,a)}_renderHalo(e,t,i,r,n){const s=this.renderedWidth,o=this.renderedHeight,l=(0,a.y)(h,Math.max(s,u),Math.max(o,u)),c=l.getContext("2d");c.clearRect(0,0,s,o),this._parameters.setFontProperties(c,this._renderedFontSize),c.fillStyle=this._parameters.haloStyle,c.strokeStyle=this._parameters.haloStyle;const d=this._renderedHaloSize<3;c.lineJoin=d?"miter":"round",d?this._renderHaloEmulated(c,r,n):this._renderHaloNative(c,r,n);let p=n;for(let a=0;a<this._lines.length;++a){const e=this._getLineXOffset(a);this._renderLineDecoration(c,r+e,p,this._textWidths[a],!0),p+=this._lineSpacing}e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(l,0,0,s,o,this._toRenderUnit(t),this._toRenderUnit(i),s,o),e.globalAlpha=1}_renderHaloEmulated(e,t,i){for(let r=0;r<this._lines.length;++r){const n=this._lines[r],s=this._getLineXOffset(r);for(const[r,a]of c)this._fillText(e,n,t+s+this._haloSize*r,i+this._haloSize*a);i+=this._lineSpacing}}_renderHaloNative(e,t,i){const r=2*this._haloSize;for(let n=0;n<this._lines.length;++n){const s=this._lines[n],a=this._getLineXOffset(n),o=5,l=.1;for(let n=0;n<o;n++){const c=1-(o-1)*l+n*l;e.lineWidth=this._toRenderUnit(c*r),this._strokeText(e,s,t+a,i)}i+=this._lineSpacing}}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(e){return e*this.renderPixelRatio}_toRoundedRenderUnit(e){return Math.round(e*this.renderPixelRatio)}_fillText(e,t,i,r){e.fillText(t,this._toRenderUnit(i),this._toRenderUnit(r))}_strokeText(e,t,i,r){e.strokeText(t,this._toRenderUnit(i),this._toRenderUnit(r))}_drawLine(e,t,i){e.beginPath(),e.moveTo(this._toRoundedRenderUnit(t[0])+.5,this._toRoundedRenderUnit(t[1])+.5),e.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),e.stroke()}_drawBox(e,t,i){const r=this._toRenderUnit(t[0]),n=this._toRenderUnit(t[1]),s=this._toRenderUnit(i[0]),a=this._toRenderUnit(i[1]),o=Math.floor(r)+.5,l=Math.ceil(r+s)-.5,c=Math.floor(n)+.5,h=Math.ceil(n+a)-.5;e.beginPath(),e.moveTo(o,c),e.lineTo(l,c),e.lineTo(l,h),e.lineTo(o,h),e.lineTo(o,c),e.stroke()}}const c=[];{const e=16;for(let t=0;t<360;t+=360/e)c.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)])}const h={canvas:null},d=.2,u=512,p="rgb(255, 0, 255, 0.5)";class v{get firstLineHeight(){return this.firstLineAscent+this.maxLineDescent}get midLineHeight(){return this.maxLineAscent+this.maxLineDescent}get lastLineHeight(){return this.maxLineAscent+this.lastLineDescent}constructor(e,t,i,r,n){this.firstLineAscent=e,this.lastLineDescent=t,this.maxLineAscent=i,this.maxLineDescent=r,this.displayWidth=n}}},48190:(e,t,i)=>{i.d(t,{z:()=>n});var r=i(39345);function n(e){const{size:t}=e.definition,i=e.fontString(t);let n=s.get(i);if(!n){const c=(0,r.y)(o,0,0).getContext("2d");e.setFontProperties(c,t);const h=c.measureText(l);n=new a(h.actualBoundingBoxAscent,h.actualBoundingBoxDescent),s.set(i,n)}return n}const s=new Map;class a{get maxHeight(){return this.maxAscent+this.maxDescent}constructor(e,t){this.maxAscent=e,this.maxDescent=t}}const o={canvas:null},l=(()=>{let e="";for(let t=32;t<127;t++)e+=String.fromCharCode(t);return e})()},52896:(e,t,i)=>{i.d(t,{$I:()=>g,AU:()=>v,Cr:()=>d,g7:()=>m,i4:()=>h,ui:()=>u,up:()=>y,vt:()=>c,yo:()=>f});var r=i(15941),n=i(34761),s=i(60008),a=i(4336),o=i(20664),l=i(9392);function c(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:y;return[e[0],e[1],e[2],e[3]]}function h(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:c();return(0,o.d)(i,e),i[3]=t,i}function d(e,t,i){return(0,o.i)(i,e,t),(0,o.n)(i,i),i[3]=-(0,o.p)(e,t),i}function u(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:c();const i=(0,n.l)(x,e);return _(t,(0,r.KJ)((0,s.Xd)(t,i))),t}function p(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:c();return(0,s.x8)(x,e,g(e)),(0,s.x8)(b,t,g(t)),(0,s.lw)(x,b,x),_(i,(0,r.KJ)((0,s.Xd)(i,x)))}function v(e,t,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:c();return h(l.Cw,e,w),h(l.JP,t,S),h(l.Cb,i,C),p(w,S,w),p(w,C,r),r}function f(e){return e}function m(e){return e[3]}function g(e){return(0,r.kU)(e[3])}function _(e,t){return e[3]=t,e}const y=[0,0,1,0],x=(0,a.vt)(),b=(0,a.vt)(),w=(c(),c()),S=c(),C=c()},58071:(e,t,i)=>{i.d(t,{P:()=>U,b:()=>L});var r,n,s,a,o,l,c,h,d,u,p,v,f,m,g=i(57528),_=i(26917),y=i(59395),x=i(90080),b=i(54478),w=i(94192),S=i(66763),C=i(80883),P=i(3799),A=i(58350),R=i(23148),T=i(86955),M=i(91911),D=i(2687);const z=.70710678118,O=z,V=.08715574274,E=10,I=1;function L(e){const t=new D.N5,{vertex:i,fragment:L,attributes:U,varyings:F}=t,k=9===e.output;(0,P.NB)(i,e),t.include(y.d),t.include(b.c,e),t.include(S.A,e),t.include(x.g,e),t.fragment.include(_.HQ,e),t.include(M.z,e),t.include(w.Z,e),e.draped?i.uniforms.add(new R.U("worldToScreenRatio",e=>1/e.screenToPCSRatio)):U.add("boundingRect","mat3"),U.add("position","vec3"),U.add("uvMapSpace","vec4"),e.hasVVColor&&U.add("colorFeatureAttribute","float"),e.hasVertexColors||F.add("vColor","vec4"),F.add("vpos","vec3",{invariant:!0}),F.add("vuv","vec2"),i.uniforms.add(new A.E("uColor",e=>e.color));const G=3===e.style||4===e.style||5===e.style;return G&&i.code.add((0,T.H)(r||(r=(0,g.A)(["\n      const mat2 rotate45 = mat2(",", ",",\n                                 ",", ",");\n    "])),T.H.float(z),T.H.float(-O),T.H.float(O),T.H.float(z))),e.draped||((0,P.yu)(i,e),i.uniforms.add(new R.U("worldToScreenPerDistanceRatio",e=>1/e.camera.perScreenPixelRatio)),i.code.add((0,T.H)(n||(n=(0,g.A)(["vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {\nfloat projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);\nreturn center + halfVector * clamp(projectedLength, -1.0, 1.0);\n}"])))),i.code.add((0,T.H)(s||(s=(0,g.A)(["vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {\nfloat d = dot(planeNormal, planePoint);\nfloat t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);\nreturn rayOrigin + t * rayDir;\n}"])))),i.code.add((0,T.H)(a||(a=(0,g.A)(["\n      float boundingRectDistanceToCamera() {\n        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);\n        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);\n        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);\n        vec3 n = normalize(cross(halfU, halfV));\n\n        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);\n\n        float viewAngle = dot(viewDir, n);\n        float minViewAngle = ",";\n\n        if (abs(viewAngle) < minViewAngle) {\n          // view direction is (almost) parallel to plane -> clamp it to min angle\n          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;\n          viewDir = normalize(viewDir + normalComponent * n);\n        }\n\n        // intersect view direction with infinite plane that contains bounding rect\n        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);\n\n        // clip to bounds by projecting to u and v line segments individually\n        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);\n        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);\n\n        // use to calculate the closest point to camera on bounding rect\n        vec3 closestPoint = uProjected + vProjected - center;\n\n        return length(closestPoint - cameraPosition);\n      }\n    "])),T.H.float(V)))),i.code.add((0,T.H)(o||(o=(0,g.A)(["\n    vec2 scaledUV() {\n      vec2 uv = uvMapSpace.xy ",";\n      vec2 uvCellOrigin = uvMapSpace.zw ",";\n\n      ","\n\n      // Logarithmically discretize ratio to avoid jittering\n      float step = 0.1;\n      float discreteWorldToScreenRatio = log(worldToScreenRatio);\n      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;\n      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);\n\n      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ",");\n      return uvOffset + (uv * discreteWorldToScreenRatio);\n    }\n  "])),(0,T.If)(G," * rotate45"),(0,T.If)(G," * rotate45"),(0,T.If)(!e.draped,(0,T.H)(l||(l=(0,g.A)(["float distanceToCamera = boundingRectDistanceToCamera();\n               float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;"])))),T.H.float(E))),i.main.add((0,T.H)(c||(c=(0,g.A)(["\n    vuv = scaledUV();\n    vpos = position;\n    forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);\n    forwardNormalizedVertexColor();\n    forwardObjectAndLayerIdColor();\n    ","\n    gl_Position = transformPosition(proj, view, vpos);\n  "])),e.hasVertexColors?"vColor *= uColor;":e.hasVVColor?"vColor = uColor * interpolateVVColor(colorFeatureAttribute);":"vColor = uColor;")),L.include(C.a),e.draped&&L.uniforms.add(new R.U("texelSize",e=>1/e.camera.pixelRatio)),k||(L.code.add((0,T.H)(h||(h=(0,g.A)(["\n      const float lineWidth = ",";\n      const float spacing = ",";\n      const float spacingINV = ",";\n\n      float coverage(float p, float txlSize) {\n        p = mod(p, spacing);\n\n        float halfTxlSize = txlSize / 2.0;\n\n        float start = p - halfTxlSize;\n        float end = p + halfTxlSize;\n\n        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;\n        coverage -= min(lineWidth, mod(start, spacing));\n        coverage -= max(lineWidth - mod(end, spacing), 0.0);\n\n        return coverage / txlSize;\n      }\n    "])),T.H.float(I),T.H.float(E),T.H.float(1/E))),e.draped||L.code.add((0,T.H)(d||(d=(0,g.A)(["const int maxSamples = 5;\nfloat sampleAA(float p) {\nvec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));\nfloat fwidth = dxdy.x + dxdy.y;\nivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));\nvec2 invSamples = 1.0 / vec2(samples);\nfloat accumulator = 0.0;\nfor (int j = 0; j < maxSamples; j++) {\nif(j >= samples.y) {\nbreak;\n}\nfor (int i = 0; i < maxSamples; i++) {\nif(i >= samples.x) {\nbreak;\n}\nvec2 step = vec2(i,j) * invSamples - 0.5;\naccumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);\n}\n}\naccumulator /= float(samples.x * samples.y);\nreturn accumulator;\n}"]))))),L.main.add((0,T.H)(u||(u=(0,g.A)(["\n    discardBySlice(vpos);\n    discardByTerrainDepth();\n    vec4 color = vColor;\n    ","\n    outputColorHighlightOID(color, vpos, color.rgb);\n  "])),(0,T.If)(!k,(0,T.H)(p||(p=(0,g.A)(["color.a *= ",";"])),function(e){function t(t){return e.draped?(0,T.H)(v||(v=(0,g.A)(["coverage(vuv.",", texelSize)"])),t):(0,T.H)(f||(f=(0,g.A)(["sampleAA(vuv.",")"])),t)}switch(e.style){case 3:case 0:return t("y");case 4:case 1:return t("x");case 5:case 2:return(0,T.H)(m||(m=(0,g.A)(["1.0 - (1.0 - ",") * (1.0 - ",")"])),t("x"),t("y"));default:return"0.0"}}(e))))),t}const U=Object.freeze(Object.defineProperty({__proto__:null,build:L},Symbol.toStringTag,{value:"Module"}))},59883:(e,t,i)=>{function r(e,t,i){return{objectId:e,target:t,distance:i,type:"vertex"}}function n(e,t,i,r,n){return{objectId:e,target:t,distance:i,type:"edge",start:r,end:n,draped:arguments.length>5&&void 0!==arguments[5]&&arguments[5]}}i.d(t,{P:()=>n,k:()=>r})},82250:(e,t,i)=>{i.d(t,{Ir:()=>c,QE:()=>l,RH:()=>h,Zd:()=>o,cN:()=>a,xU:()=>d});var r=i(19555),n=i(72745),s=i(42510);const a=Object.freeze({left:0,center:.5,right:1}),o=Object.freeze({"bottom-left":(0,n.fA)(0,0),bottom:(0,n.fA)(.5,0),"bottom-right":(0,n.fA)(1,0),left:(0,n.fA)(0,.5),center:(0,n.fA)(.5,.5),right:(0,n.fA)(1,.5),"top-left":(0,n.fA)(0,1),top:(0,n.fA)(.5,1),"top-right":(0,n.fA)(1,1)});function l(e){switch(e){case"left":return 0;case"right":return 2;default:return 1}}function c(e,t){switch(t){case"bottom":return"left"===e?"bottom-left":"right"===e?"bottom-right":"bottom";case"center":return e;case"top":return"left"===e?"top-left":"right"===e?"top-right":"top"}}function h(e){return"middle"===e?"center":e}function d(e,t){switch(e){case"top":return(0,r.hZ)(t,0,s.X);case"bottom":return(0,r.hZ)(t,0,-s.X);default:return(0,r.C)(t,n.uY)}}},82884:(e,t,i)=>{i.d(t,{V:()=>v});var r,n=i(57528),s=i(19555),a=i(72745),o=i(43047),l=i(55855),c=i(32925),h=(i(51740),i(95756)),d=i(58350),u=i(86955),p=i(70367);function v(e){e.fragment.uniforms.add(new p.N("texWaveNormal",e=>e.waveNormal),new p.N("texWavePerturbation",e=>e.wavePerturbation),new d.E("waveParams",e=>(0,o.s)(f,e.waveStrength,e.waveTextureRepeat,e.flowStrength,e.flowOffset)),new h.G("waveDirection",e=>(0,s.hZ)(m,e.waveDirection[0]*e.waveVelocity,e.waveDirection[1]*e.waveVelocity))),e.fragment.include(c.z),e.fragment.code.add((0,u.H)(r||(r=(0,n.A)(["const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);\nvec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {\nreturn 2.0 * texture(_tex, _uv).rg - 1.0;\n}\nfloat sampleNoiseTexture(vec2 _uv) {\nreturn texture(texWavePerturbation, _uv).b;\n}\nvec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {\nreturn 2.0 * texture(_tex, _uv).rgb - 1.0;\n}\nfloat computeProgress(vec2 uv, float time) {\nreturn fract(time);\n}\nfloat computeWeight(vec2 uv, float time) {\nfloat progress = computeProgress(uv, time);\nreturn 1.0 - abs(1.0 - 2.0 * progress);\n}\nvec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {\nfloat flowStrength = waveParams[2];\nfloat flowOffset = waveParams[3];\nvec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;\nfloat progress = computeProgress(uv, time + phaseOffset);\nfloat weight = computeWeight(uv, time + phaseOffset);\nvec2 result = uv;\nresult -= flowVector * (progress + flowOffset);\nresult += phaseOffset;\nresult += (time - progress) * FLOW_JUMP;\nreturn vec3(result, weight);\n}\nconst float TIME_NOISE_TEXTURE_REPEAT = 0.3737;\nconst float TIME_NOISE_STRENGTH = 7.77;\nvec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {\nfloat waveStrength = waveParams[0];\nvec2 waveMovement = time * -_waveDir;\nfloat timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;\nvec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);\nvec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);\nvec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;\nvec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;\nvec3 mixNormal = normalize(normal_A + normal_B);\nmixNormal.xy *= waveStrength;\nmixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));\nreturn mixNormal;\n}\nvec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {\nfloat waveTextureRepeat = waveParams[1];\nvec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);\nfloat foam  = normals2FoamIntensity(normal, waveParams[0]);\nreturn vec4(normal, foam);\n}"]))))}const f=(0,l.vt)(),m=(0,a.vt)()},85887:(e,t,i)=>{i.d(t,{H:()=>P,W:()=>A});var r,n,s,a,o,l,c,h,d,u,p,v=i(57528),f=i(72745),m=i(95756),g=i(5517),_=i(58350),y=i(66701),x=i(21390),b=i(60205),w=i(86955),S=i(93684);const C=8;function P(e,t){const{attributes:i,vertex:f}=e;i.add("position","vec3"),i.add("profileVertexAndNormal","vec4"),i.add("profileAuxData","vec3"),i.add("profileRight","vec2"),i.add("profileUp","vec2"),f.code.add((0,w.H)(r||(r=(0,v.A)(["bool isCapVertex() {\nreturn profileAuxData.z == 1.0;\n}"])))),f.uniforms.add(new m.G("size",e=>e.size));const{hasVVSize:P,hasVVColor:A,hasVVOpacity:R}=t;P?(i.add("sizeFeatureAttribute","float"),f.uniforms.add(new g.t("vvSizeMinSize",e=>e.vvSize.minSize),new g.t("vvSizeMaxSize",e=>e.vvSize.maxSize),new g.t("vvSizeOffset",e=>e.vvSize.offset),new g.t("vvSizeFactor",e=>e.vvSize.factor),new g.t("vvSizeFallback",e=>e.vvSize.fallback)),f.code.add((0,w.H)(n||(n=(0,v.A)(["vec2 getSize() {\nfloat value = sizeFeatureAttribute;\nif (isnan(value)) {\nreturn vvSizeFallback.xz;\n}\nreturn size * clamp(vvSizeOffset + value * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;\n}"]))))):f.code.add((0,w.H)(s||(s=(0,v.A)(["vec2 getSize(){\nreturn size;\n}"])))),R?(i.add("opacityFeatureAttribute","float"),f.constants.add("vvOpacityNumber","int",C),f.uniforms.add(new b.x("vvOpacityValues",e=>e.vvOpacity.values,C),new b.x("vvOpacityOpacities",e=>e.vvOpacity.opacityValues,C),new x.m("vvOpacityFallback",e=>e.vvOpacity.fallback,{supportsNaN:!0})),f.code.add((0,w.H)(a||(a=(0,v.A)(["\n    vec4 applyOpacity(vec4 color) {\n      // if we encounter NaN in the color it means the color is in the fallback case where the symbol color\n      // is not defined and there is no valid color visual variable override. In this case just return a fully\n      // transparent color\n      if (isnan(color.r)) {\n        return vec4(0);\n      }\n\n      float value = opacityFeatureAttribute;\n\n      if (isnan(value)) {\n        // If there is a color vv then it will already have taken care of applying the fallback\n        return ",";\n      }\n\n      if (value <= vvOpacityValues[0]) {\n        return vec4(color.rgb, vvOpacityOpacities[0]);\n      }\n\n      for (int i = 1; i < vvOpacityNumber; ++i) {\n        if (vvOpacityValues[i] >= value) {\n          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);\n          return vec4(color.rgb, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));\n        }\n      }\n\n      return vec4( color.rgb, vvOpacityOpacities[vvOpacityNumber - 1]);\n    }\n    "])),(0,w.If)(A,"color","vec4(color.rgb, vvOpacityFallback)")))):f.code.add((0,w.H)(o||(o=(0,v.A)(["vec4 applyOpacity(vec4 color){\nreturn color;\n}"])))),A?(i.add("colorFeatureAttribute","float"),f.constants.add("vvColorNumber","int",S.p),f.uniforms.add(new b.x("vvColorValues",e=>e.vvColor.values,S.p),new y.F("vvColorColors",e=>e.vvColor.colors,S.p),new _.E("vvColorFallback",e=>e.vvColor.fallback)),f.code.add((0,w.H)(l||(l=(0,v.A)(["vec4 getColor() {\nfloat value = colorFeatureAttribute;\nif (isnan(value)) {\nreturn applyOpacity(vvColorFallback);\n}\nif (value <= vvColorValues[0]) {\nreturn applyOpacity(vvColorColors[0]);\n}\nfor (int i = 1; i < vvColorNumber; ++i) {\nif (vvColorValues[i] >= value) {\nfloat f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);\nreturn applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));\n}\n}\nreturn applyOpacity(vvColorColors[vvColorNumber - 1]);\n}"]))))):f.code.add((0,w.H)(c||(c=(0,v.A)(["vec4 getColor(){\nreturn applyOpacity(vec4(1, 1, 1, 1));\n}"])))),f.code.add((0,w.H)(h||(h=(0,v.A)(["vec3 decompressAxis(vec2 axis) {\nfloat z = 1.0 - abs(axis.x) - abs(axis.y);\nreturn normalize(vec3(axis + sign(axis) * min(z, 0.0), z));\n}\nvec3 calculateVPos() {\nvec2 size = getSize();\nvec3 origin = position;\nvec3 right = decompressAxis(profileRight);\nvec3 up = decompressAxis(profileUp);\nvec2 profileVertex = profileVertexAndNormal.xy * size;"])))),f.code.add((0,w.H)(d||(d=(0,v.A)(["if(isCapVertex()) {\nfloat positionOffsetAlongProfilePlaneNormal = profileAuxData.x * size[0];\nvec3 forward = cross(up, right);\nvec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;\nreturn origin + offset;\n}\nvec2 rotationRight = vec2(profileAuxData.x, profileAuxData.y);\nfloat maxDistance = length(rotationRight);"])))),f.code.add((0,w.H)(u||(u=(0,v.A)(["rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);\nfloat rx = dot(profileVertex, rotationRight);\nif (abs(rx) > maxDistance) {\nvec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);\nfloat ry = dot(profileVertex, rotationUp);\nprofileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;\n}\nvec3 offset = right * profileVertex.x + up * profileVertex.y;\nreturn origin + offset;\n}"])))),f.code.add((0,w.H)(p||(p=(0,v.A)(["vec3 localNormal() {\nvec3 right = decompressAxis(profileRight);\nvec3 up = decompressAxis(profileUp);\nvec3 normal = right * profileVertexAndNormal.z + up * profileVertexAndNormal.w;\nif(isCapVertex()) {\nvec3 forward = cross(up, right);\nnormal += forward * profileAuxData.y;\n}\nreturn normal;\n}"]))))}class A extends S.S{constructor(){super(...arguments),this.size=(0,f.fA)(1,1)}}},88849:(e,t,i)=>{i.d(t,{L:()=>k,b:()=>F});var r,n,s,a,o,l,c,h,d,u,p,v,f,m,g,_,y=i(57528),x=i(99443),b=i(26917),w=i(3838),S=i(87236),C=i(17698),P=i(94192),A=i(80883),R=i(20179),T=i(3799),M=i(28450),D=i(51596),z=i(58350),O=i(23148),V=i(86955),E=i(23687),I=i(70367),L=i(91911),U=i(2687);function F(e){const t=new U.N5,{space:i,anchor:F,hasTip:k,hasScreenSizePerspective:G}=e,B=2===i,H=1===i;t.include(w.s,e),t.include(C.r,e),t.include(P.Z,e);const{vertex:j,fragment:N,varyings:W}=t;(0,T.NB)(j,e),t.attributes.add("position","vec3"),t.attributes.add("previousDelta","vec4"),t.attributes.add("uv0","vec2"),W.add("vColor","vec4"),W.add("vpos","vec3",{invariant:!0}),W.add("vUV","vec2"),W.add("vSize","float"),k&&W.add("vLineWidth","float"),j.uniforms.add(new M.E("nearFar",e=>{let{camera:t}=e;return t.nearFar}),new D.I("viewport",e=>{let{camera:t}=e;return t.fullViewport})).code.add((0,V.H)(r||(r=(0,y.A)(["vec4 projectAndScale(vec4 pos) {\nvec4 posNdc = proj * pos;\nposNdc.xy *= viewport.zw / posNdc.w;\nreturn posNdc;\n}"])))),j.code.add((0,V.H)(n||(n=(0,y.A)(["void clip(vec4 pos, inout vec4 prev) {\nfloat vnp = nearFar[0] * 0.99;\nif (prev.z > -nearFar[0]) {\nfloat interpolation = (-vnp - pos.z) / (prev.z - pos.z);\nprev = mix(pos, prev, interpolation);\n}\n}"])))),B?(t.attributes.add("normal","vec3"),(0,T.S7)(j),j.constants.add("tiltThreshold","float",.7),j.code.add((0,V.H)(s||(s=(0,y.A)(["vec3 perpendicular(vec3 v) {\nvec3 n = (viewNormal * vec4(normal.xyz, 1.0)).xyz;\nvec3 n2 = cross(v, n);\nvec3 forward = vec3(0.0, 0.0, 1.0);\nfloat tiltDot = dot(forward, n);\nreturn abs(tiltDot) < tiltThreshold ? n : n2;\n}"]))))):j.code.add((0,V.H)(a||(a=(0,y.A)(["vec2 perpendicular(vec2 v) {\nreturn vec2(v.y, -v.x);\n}"]))));const Z=B?"vec3":"vec2";return j.code.add((0,V.H)(o||(o=(0,y.A)(["\n      "," normalizedSegment("," pos, "," prev) {\n        "," segment = pos - prev;\n        float segmentLen = length(segment);\n\n        // normalize or zero if too short\n        return (segmentLen > 0.001) ? segment / segmentLen : ",";\n      }\n\n      "," displace("," pos, "," prev, float displacementLen) {\n        "," segment = normalizedSegment(pos, prev);\n\n        "," displacementDirU = perpendicular(segment);\n        "," displacementDirV = segment;\n\n        ","\n\n        return pos + displacementLen * (uv0.x * displacementDirU + uv0.y * displacementDirV);\n      }\n    "])),Z,Z,Z,Z,B?"vec3(0.0, 0.0, 0.0)":"vec2(0.0, 0.0)",Z,Z,Z,Z,Z,Z,1===F?"pos -= 0.5 * displacementLen * displacementDirV;":"")),H&&(j.uniforms.add(new E.F("inverseProjectionMatrix",e=>{let{camera:t}=e;return t.inverseProjectionMatrix})),j.code.add((0,V.H)(l||(l=(0,y.A)(["vec3 inverseProject(vec4 posScreen) {\nposScreen.xy = (posScreen.xy / viewport.zw) * posScreen.w;\nreturn (inverseProjectionMatrix * posScreen).xyz;\n}"])))),j.code.add((0,V.H)(c||(c=(0,y.A)(["bool rayIntersectPlane(vec3 rayDir, vec3 planeOrigin, vec3 planeNormal, out vec3 intersection) {\nfloat cos = dot(rayDir, planeNormal);\nfloat t = dot(planeOrigin, planeNormal) / cos;\nintersection = t * rayDir;\nreturn abs(cos) > 0.001 && t > 0.0;\n}"])))),j.uniforms.add(new O.U("perScreenPixelRatio",e=>{let{camera:t}=e;return t.perScreenPixelRatio})),j.code.add((0,V.H)(h||(h=(0,y.A)(["\n      vec4 toFront(vec4 displacedPosScreen, vec3 posLeft, vec3 posRight, vec3 prev, float lineWidth) {\n        // Project displaced position back to camera space\n        vec3 displacedPos = inverseProject(displacedPosScreen);\n\n        // Calculate the plane that we want the marker to lie in. Note that this will always be an approximation since ribbon lines are generally\n        // not planar and we do not know the actual position of the displaced prev vertices (they are offset in screen space, too).\n        vec3 planeNormal = normalize(cross(posLeft - posRight, posLeft - prev));\n        vec3 planeOrigin = posLeft;\n\n        ",";\n\n        // Move the plane towards the camera by a margin dependent on the line width (approximated in world space). This tolerance corrects for the\n        // non-planarity in most cases, but sharp joins can place the prev vertices at arbitrary positions so markers can still clip.\n        float offset = lineWidth * perScreenPixelRatio;\n        planeOrigin *= (1.0 - offset);\n\n        // Intersect camera ray with the plane and make sure it is within clip space\n        vec3 rayDir = normalize(displacedPos);\n        vec3 intersection;\n        if (rayIntersectPlane(rayDir, planeOrigin, planeNormal, intersection) && intersection.z < -nearFar[0] && intersection.z > -nearFar[1]) {\n          return vec4(intersection.xyz, 1.0);\n        }\n\n        // Fallback: use depth of pos or prev, whichever is closer to the camera\n        float minDepth = planeOrigin.z > prev.z ? length(planeOrigin) : length(prev);\n        displacedPos *= minDepth / length(displacedPos);\n        return vec4(displacedPos.xyz, 1.0);\n      }\n  "])),(0,V.If)(e.hasCap,"if(prev.z > posLeft.z) {\n                vec2 diff = posLeft.xy - posRight.xy;\n                planeOrigin.xy += perpendicular(diff) / 2.0;\n             }")))),(0,T.Nz)(j),t.include(R.F),j.main.add((0,V.H)(d||(d=(0,y.A)(["\n    // Check for special value of uv0.y which is used by the Renderer when graphics\n    // are removed before the VBO is recompacted. If this is the case, then we just\n    // project outside of clip space.\n    if (uv0.y == 0.0) {\n      // Project out of clip space\n      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);\n    }\n    else {\n      vec4 pos  = view * vec4(position, 1.0);\n      vec4 prev = view * vec4(position + previousDelta.xyz * previousDelta.w, 1.0);\n\n      float lineWidth = getLineWidth(",");\n      float screenMarkerSize = getScreenMarkerSize(lineWidth);\n\n      clip(pos, prev);\n\n      ","\n      forwardViewPosDepth(pos.xyz);\n      // Convert back into NDC\n      displacedPosScreen.xy = (displacedPosScreen.xy / viewport.zw) * displacedPosScreen.w;\n\n      // Convert texture coordinate into [0,1]\n      vUV = (uv0 + 1.0) / 2.0;\n      ","\n      ","\n\n      vSize = screenMarkerSize;\n      vColor = getColor();\n\n      // Use camera space for slicing\n      vpos = pos.xyz;\n\n      gl_Position = displacedPosScreen;\n    }"])),(0,V.If)(G,"pos.xyz"),B?(0,V.H)(u||(u=(0,y.A)(["","\n            pos.xyz = displace(pos.xyz, prev.xyz, getWorldMarkerSize(pos.xyz));\n            vec4 displacedPosScreen = projectAndScale(pos);"])),(0,V.If)(e.hideOnShortSegments,(0,V.H)(p||(p=(0,y.A)(["\n                if (areWorldMarkersHidden(pos.xyz, prev.xyz)) {\n                  // Project out of clip space\n                  gl_Position = vec4(1e038, 1e038, 1e038, 1.0);\n                  return;\n                }"]))))):(0,V.H)(v||(v=(0,y.A)(["\n            vec4 posScreen = projectAndScale(pos);\n            vec4 prevScreen = projectAndScale(prev);\n            vec4 displacedPosScreen = posScreen;\n\n            displacedPosScreen.xy = displace(posScreen.xy, prevScreen.xy, screenMarkerSize);\n            ",""])),(0,V.If)(H,(0,V.H)(f||(f=(0,y.A)(["\n                vec2 displacementDirU = perpendicular(normalizedSegment(posScreen.xy, prevScreen.xy));\n\n                // We need three points of the ribbon line in camera space to calculate the plane it lies in\n                // Note that we approximate the third point, since we have no information about the join around prev\n                vec3 lineRight = inverseProject(posScreen + lineWidth * vec4(displacementDirU.xy, 0.0, 0.0));\n                vec3 lineLeft = pos.xyz + (pos.xyz - lineRight);\n\n                pos = toFront(displacedPosScreen, lineLeft, lineRight, prev.xyz, lineWidth);\n                displacedPosScreen = projectAndScale(pos);"]))))),(0,V.If)(!B,"vUV = noPerspectiveWrite(vUV, displacedPosScreen.w);"),(0,V.If)(k,"vLineWidth = noPerspectiveWrite(lineWidth, displacedPosScreen.w);"))),N.include(b.HQ,e),t.include(L.z,e),N.include(A.a),N.uniforms.add(new z.E("intrinsicColor",e=>{let{color:t}=e;return t}),new I.N("tex",e=>{let{markerTexture:t}=e;return t})).constants.add("texelSize","float",1/x.vO).code.add((0,V.H)(m||(m=(0,y.A)(["float markerAlpha(vec2 samplePos) {\nsamplePos += vec2(0.5, -0.5) * texelSize;\nfloat sdf = texture(tex, samplePos).r;\nfloat pixelDistance = sdf * vSize;\npixelDistance -= 0.5;\nreturn clamp(0.5 - pixelDistance, 0.0, 1.0);\n}"])))),k&&(t.include(R.m),N.constants.add("relativeMarkerSize","float",x.Cz/x.vO).constants.add("relativeTipLineWidth","float",x.DZ).code.add((0,V.H)(g||(g=(0,y.A)(["\n    float tipAlpha(vec2 samplePos) {\n      // Convert coordinates s.t. they are in pixels and relative to the tip of an arrow marker\n      samplePos -= vec2(0.5, 0.5 + 0.5 * relativeMarkerSize);\n      samplePos *= vSize;\n\n      float halfMarkerSize = 0.5 * relativeMarkerSize * vSize;\n      float halfTipLineWidth = 0.5 * max(1.0, relativeTipLineWidth * noPerspectiveRead(vLineWidth));\n\n      ","\n\n      float distance = max(abs(samplePos.x) - halfMarkerSize, abs(samplePos.y) - halfTipLineWidth);\n      return clamp(0.5 - distance, 0.0, 1.0);\n    }\n  "])),(0,V.If)(B,"halfTipLineWidth *= fwidth(samplePos.y);")))),t.include(S.Q,e),t.include(R.m),N.main.add((0,V.H)(_||(_=(0,y.A)(["\n    discardBySlice(vpos);\n    discardByTerrainDepth();\n\n    vec4 finalColor = intrinsicColor * vColor;\n\n    // Cancel out perspective correct interpolation if in screen space or draped\n    vec2 samplePos = ",";\n    finalColor.a *= ",";\n    outputColorHighlightOID(finalColor, vpos, finalColor.rgb);"])),(0,V.If)(!B,"noPerspectiveRead(vUV)","vUV"),k?"max(markerAlpha(samplePos), tipAlpha(samplePos))":"markerAlpha(samplePos)")),t}const k=Object.freeze(Object.defineProperty({__proto__:null,build:F},Symbol.toStringTag,{value:"Module"}))},91116:(e,t,i)=>{i.d(t,{P:()=>B,b:()=>G});var r,n,s,a,o,l,c,h,d,u,p,v,f=i(57528),m=i(67078),g=i(34981),_=i(26917),y=i(59395),x=i(90080),b=i(85887),w=i(49399),S=i(87236),C=i(9365),P=i(66970),A=i(43557),R=i(27920),T=i(2260),M=i(26719),D=i(51740),z=i(94192),O=i(80883),V=i(3799),E=i(5517),I=i(21390),L=i(86955),U=i(34260),F=i(91911),k=i(2687);function G(e){const t=new k.N5,{vertex:i,fragment:G,varyings:B}=t;(0,V.NB)(i,e),B.add("vpos","vec3",{invariant:!0}),t.include(b.H,e);const{output:H,spherical:j,pbrMode:N,snowCover:W}=e;switch(((0,g.RN)(H)||10===H)&&(t.include(y.d),t.include(D.Bz,e),t.include(x.g,e),t.include(z.Z,e),B.add("vnormal","vec3"),B.add("vcolor","vec4"),i.main.add((0,L.H)(r||(r=(0,f.A)(["vpos = calculateVPos();\nvnormal = normalize(localNormal());\nforwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);\ngl_Position = transformPosition(proj, view, vpos);\nforwardObjectAndLayerIdColor();\nvcolor = getColor();\nforwardLinearDepthToReadShadowMap();"]))))),H){case 1:case 0:t.include(M._,e),t.include(P.kA,e),G.include(C.n,e),t.include(R.r,e),G.include(_.HQ,e),t.include(F.z,e),(0,V.yu)(G,e),(0,P.a8)(G),(0,P.eU)(G),G.uniforms.add(i.uniforms.get("localOrigin"),new E.t("ambient",e=>e.ambient),new E.t("diffuse",e=>e.diffuse),new I.m("opacity",e=>e.opacity)),G.include(O.a),G.include(U.b,e),(0,A.O4)(G),G.main.add((0,L.H)(n||(n=(0,f.A)(["\n        discardBySlice(vpos);\n        discardByTerrainDepth();\n\n        shadingParams.viewDirection = normalize(vpos - cameraPosition);\n        shadingParams.normalView = vnormal;\n        vec3 normal = shadingNormal(shadingParams);\n        float ssao = evaluateAmbientOcclusionInverse();\n\n        vec3 posWorld = vpos + localOrigin;\n        vec3 normalGround = ","\n\n        vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one\n        float combinedOpacity = vcolor.a * opacity;\n\n        ","\n\n        float additionalAmbientScale = additionalDirectedAmbientLight(posWorld);\n        vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;\n        float shadow = readShadow(additionalAmbientScale, vpos);\n\n        ","\n\n        vec3 shadedColor = ","\n        vec4 finalColor = vec4(shadedColor, combinedOpacity);\n        outputColorHighlightOID(finalColor, vpos, albedo ",");"])),j?"normalize(posWorld);":"vec3(0.0, 0.0, 1.0);",(0,L.If)(W,(0,L.H)(s||(s=(0,f.A)(["float snow = getSnow(normal, normalGround);\n                 albedo = mix(albedo, vec3(1), snow);\n                 ssao = mix(ssao, 1.0, snow);"])))),(0,L.If)(2===N,"float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];\n           ".concat((0,L.If)(W,"mrr = applySnowToMRR(mrr, snow);"))),2===N?"evaluateSceneLightingPBR(normal, albedo, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, additionalAmbientIrradiance);":"evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);",(0,L.If)(W,", snow")));break;case 2:t.include(y.d),i.main.add((0,L.H)(a||(a=(0,f.A)(["vpos = calculateVPos();\ngl_Position = transformPosition(proj, view, vpos);"])))),t.fragment.include(_.HQ,e),G.main.add((0,L.H)(o||(o=(0,f.A)(["discardBySlice(vpos);"]))));break;case 4:case 5:case 6:case 7:t.include(y.d),(0,m.xJ)(t),B.add("depth","float"),i.main.add((0,L.H)(l||(l=(0,f.A)(["vpos = calculateVPos();\ngl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);"])))),t.fragment.include(_.HQ,e),t.include(w.L,e),G.main.add((0,L.H)(c||(c=(0,f.A)(["discardBySlice(vpos);\noutputDepth(depth);"]))));break;case 10:t.fragment.include(_.HQ,e),G.main.add((0,L.H)(h||(h=(0,f.A)(["discardBySlice(vpos);\noutputObjectAndLayerIdColor();"]))));break;case 3:t.include(y.d),t.include(T.n,e),(0,V.S7)(i),B.add("vnormal","vec3"),i.main.add((0,L.H)(d||(d=(0,f.A)(["vpos = calculateVPos();\nvnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);\ngl_Position = transformPosition(proj, view, vpos);"])))),t.fragment.include(_.HQ,e),G.main.add((0,L.H)(u||(u=(0,f.A)(["discardBySlice(vpos);\nvec3 normal = normalize(vnormal);\nif (gl_FrontFacing == false) normal = -normal;\nfragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);"]))));break;case 9:t.include(y.d),t.include(T.n,e),B.add("vnormal","vec3"),i.main.add((0,L.H)(p||(p=(0,f.A)(["vpos = calculateVPos();\ngl_Position = transformPosition(proj, view, vpos);"])))),t.fragment.include(_.HQ,e),t.include(S.Q,e),G.main.add((0,L.H)(v||(v=(0,f.A)(["discardBySlice(vpos);\ncalculateOcclusionAndOutputHighlight();"]))))}return t}const B=Object.freeze(Object.defineProperty({__proto__:null,build:G},Symbol.toStringTag,{value:"Module"}))}}]);
//# sourceMappingURL=622.3c0314fa.chunk.js.map