"use strict";(self.webpackChunkmmsp_land_hl=self.webpackChunkmmsp_land_hl||[]).push([[2665],{317:(e,t,r)=>{r.d(t,{k9:()=>T,zF:()=>C});var i,s=r(6326),n=r(42553),a=r(46053),o=(r(81806),r(76460),r(47249),r(6409)),h=r(87990);let l=i=class extends n.o{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new i({cloudCover:this.cloudCover})}};(0,s.Cg)([(0,o.e)({cloudy:"cloudy"}),(0,a.MZ)({json:{write:{isRequired:!0}}})],l.prototype,"type",void 0),(0,s.Cg)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],l.prototype,"cloudCover",void 0),l=i=(0,s.Cg)([(0,h.$)("esri.views.3d.environment.CloudyWeather")],l);const u=l;var c;let d=c=class extends n.o{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new c({fogStrength:this.fogStrength})}};(0,s.Cg)([(0,o.e)({foggy:"foggy"}),(0,a.MZ)({json:{write:{isRequired:!0}}})],d.prototype,"type",void 0),(0,s.Cg)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],d.prototype,"fogStrength",void 0),d=c=(0,s.Cg)([(0,h.$)("esri.views.3d.environment.FoggyWeather")],d);const g=d;var p;let v=p=class extends n.o{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new p({cloudCover:this.cloudCover,precipitation:this.precipitation})}};(0,s.Cg)([(0,o.e)({rainy:"rainy"}),(0,a.MZ)({json:{write:{isRequired:!0}}})],v.prototype,"type",void 0),(0,s.Cg)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],v.prototype,"cloudCover",void 0),(0,s.Cg)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],v.prototype,"precipitation",void 0),v=p=(0,s.Cg)([(0,h.$)("esri.views.3d.environment.RainyWeather")],v);const _=v;var f;let m=f=class extends n.o{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new f({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};(0,s.Cg)([(0,o.e)({snowy:"snowy"}),(0,a.MZ)({json:{write:{isRequired:!0}}})],m.prototype,"type",void 0),(0,s.Cg)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],m.prototype,"cloudCover",void 0),(0,s.Cg)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],m.prototype,"precipitation",void 0),(0,s.Cg)([(0,a.MZ)({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],m.prototype,"snowCover",void 0),m=f=(0,s.Cg)([(0,h.$)("esri.views.3d.environment.SnowyWeather")],m);const x=m;var y;let b=y=class extends n.o{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new y({cloudCover:this.cloudCover})}};(0,s.Cg)([(0,o.e)({sunny:"sunny"}),(0,a.MZ)({json:{write:{isRequired:!0}}})],b.prototype,"type",void 0),(0,s.Cg)([(0,a.MZ)({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],b.prototype,"cloudCover",void 0),b=y=(0,s.Cg)([(0,h.$)("esri.views.3d.environment.SunnyWeather")],b);const w={key:"type",base:b,typeMap:{sunny:b,cloudy:u,rainy:_,snowy:x,foggy:g}};Object.keys(w.typeMap);const C=1e4,T=1e5},442:(e,t,r)=>{r.d(t,{$:()=>h});var i=r(90632),s=r(34761),n=r(13191),a=r(78315),o=r(94966);class h{constructor(e){var t;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.geometry=e,this.screenToWorldRatio=1,this._transformation=(0,n.vt)(),this._shaderTransformation=null,this._boundingSphere=null,this.id=(0,i.c)(),this.layerViewUid=r.layerViewUid,this.graphicUid=r.graphicUid,this.castShadow=null!==(t=r.castShadow)&&void 0!==t&&t,r.objectShaderTransformation&&this.objectShaderTransformationChanged(r.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){(0,s.C)(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){var t;null==e?this._shaderTransformation=null:(null!==(t=this._shaderTransformation)&&void 0!==t||(this._shaderTransformation=(0,n.vt)()),(0,s.lw)(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){var e;return this.boundingInfo?(null==this._boundingSphere&&(null!==(e=this._boundingSphere)&&void 0!==e||(this._boundingSphere=(0,a.c)()),(0,a.q)(this._boundingSphere,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*(0,o.hG)(this.shaderTransformation)),this._boundingSphere):a.N}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){var e;return null!==(e=this._shaderTransformation)&&void 0!==e?e:this.transformation}get attributes(){return this.geometry.attributes}get positionAttribute(){return this.geometry.positionAttribute}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}}},3509:(e,t,r)=>{r.d(t,{bi:()=>Ot});var i=r(89379),s=r(6326),n=r(18690),a=r(54099),o=r(81806),h=r(87663),l=r(30726),u=r(5457),c=r(68134),d=r(41289),g=r(46053),p=r(76460),v=r(87990),_=r(34761),f=r(20664),m=r(9392),x=r(22955),y=r(43047),b=r(2413),w=r(75507);class C{constructor(){this._extent=(0,b.vt)(),this.resolution=0,this.renderLocalOrigin=(0,w.f)(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new T}get extent(){return this._extent}setExtent(e){(0,y.d)(this._extent,e)}setupGeometryViews(e){if(this._setupGeometryView(),!e)return;const t=.001*e.range;if(this._extent[0]-t<=e.min){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,b.cY)(this._extent,e.range,0,t)}if(this._extent[2]+t>=e.max){const t=this.canvasGeometries.extents[this.canvasGeometries.numViews++];(0,b.cY)(this._extent,-e.range,0,t)}}_setupGeometryView(){this.canvasGeometries.numViews=1,(0,b.C)(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}}class T{constructor(){this.extents=[(0,b.vt)(),(0,b.vt)(),(0,b.vt)()],this.numViews=0}}class S{constructor(e,t,r){this._fbos=e,this._format=t,this._name=r}get valid(){var e;return null!=(null===(e=this._handle)||void 0===e?void 0:e.getTexture())}dispose(){this._handle=(0,l.Gz)(this._handle)}get texture(){var e;return null===(e=this._handle)||void 0===e?void 0:e.getTexture()}ensureFramebuffer(e,t){var r,i,s;this._handle&&(null===(r=this._handle.fbo)||void 0===r?void 0:r.width)===e&&(null===(i=this._handle.fbo)||void 0===i?void 0:i.height)===t||(null!==(s=this._handle)&&void 0!==s&&s.release(),this._handle=this._fbos.acquire(e,t,this._name,this._format))}bind(e){var t;e.bindFramebuffer(null===(t=this._handle)||void 0===t?void 0:t.fbo)}generateMipMap(){var e,t;(null===(e=this._handle)||void 0===e||null===(e=e.getTexture())||void 0===e||null===(e=e.descriptor)||void 0===e?void 0:e.hasMipmap)&&(null===(t=this._handle)||void 0===t||null===(t=t.getTexture())||void 0===t||t.generateMipmap())}}var O=r(61785);class M{constructor(e,t,r,i){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1,n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:6;this.output=r,this.content=i,this.redrawOnRequest=s,this.fbo=new S(e,n,t)}handleRenderRequest(e){return 1===e||e===this.redrawOnRequest}get valid(){return this.fbo.valid}}class P{constructor(e){this.targets=[new M(e,"overlay color",0,0),new M(e,"overlay IM color",0,1),new M(e,"overlay highlight",9,2,1,3),new M(e,"overlay water",3,3,0),new M(e,"overlay occluded",0,4)],(0,O.E)()&&this.targets.push(new M(e,"overlay olid",10,5,1,5))}getTexture(e){var t;return null===(t=this.targets[e])||void 0===t?void 0:t.fbo.texture}dispose(e){if(0!==e)for(const t of this.targets)t.fbo.dispose();else this.targets[3].fbo.dispose()}computeValidity(){return this.targets.reduce((e,t,r)=>t.valid?e|=1<<r:e,0)}}var R=r(33062),F=r(53070),V=r(60586),D=(r(47249),r(19555)),z=r(74628),A=r(36451),I=r(16506),W=r(59246),L=r(11850),q=r(61157),B=r(57162),H=r(75757);class E extends W.w{constructor(e,t){super(e,t,new I.$(q.H,()=>r.e(2671).then(r.bind(r,82671))),(0,H.Xk)(L.wR))}initializePipeline(){return(0,B.Ey)({blending:B.T8,colorWrite:B.kn})}}var N=r(43666);class j extends W.w{constructor(e,t){super(e,t,new I.$(N.a,()=>r.e(9616).then(r.bind(r,9616))),(0,H.Xk)(L.wR))}initializePipeline(){return(0,B.Ey)({colorWrite:B.kn})}}var G=r(21019);class k extends W.w{constructor(e,t){super(e,t,new I.$(G.a,()=>r.e(1521).then(r.bind(r,51521))),L.Nx)}initializePipeline(){return(0,B.Ey)({colorWrite:B.kn})}}var Z=r(1723),U=r(31432);class Q extends U.Y{constructor(){super(...arguments),this.occludedFactor=Z.cD,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}}var $=r(62854);class X extends W.w{constructor(e,t){super(e,t,new I.$($.H,()=>r.e(7932).then(r.bind(r,37932))),(0,H.Xk)(L.wR))}initializePipeline(){return(0,B.Ey)({colorWrite:B.kn})}}var Y=r(69008),K=r(76718),J=r(93345),ee=r(80895),te=r(96673),re=r(9243);let ie=class extends A.A{constructor(){super(...arguments),this.produces=z.OG.HIGHLIGHTS,this.consumes={required:[z.OG.HIGHLIGHTS,"highlights"]},this._downsampleDrawParameters=new G.H,this._passParameters=new Q,this._highlightBlurDrawParameters=new N.H,this._grid=new se}initialize(){this.addHandles([(0,c.wB)(()=>this._updateOptionsTexture(),()=>{},c.Vh)])}destroy(){this._grid.coverage=(0,l.Gz)(this._grid.coverage),this._grid.vao=(0,l.WD)(this._grid.vao),this._passParameters.highlightOptionsTexture=(0,l.Gz)(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(null==this._passParameters.highlightOptionsTexture){const e=new te.R(16,2);e.internalFormat=6408,e.samplingMode=9728,this._passParameters.highlightOptionsTexture=new ee.g(this.renderingContext,e,null)}this._passParameters.highlightOptionsTexture.setData(function(e){const t=new Uint8Array(128);let r=0;for(const s of e){var i;const e=4*r,n=4*r+64;++r;const{color:a}=s,o=null!==(i=s.haloColor)&&void 0!==i?i:a;t[e+0]=a.r,t[e+1]=a.g,t[e+2]=a.b,t[e+3]=s.fillOpacity*a.a*255,t[n+0]=o.r,t[n+1]=o.g,t[n+2]=o.b,t[n+3]=s.haloOpacity*o.a*255}return t}(this.view.state.highlights)),this.requestRender(1)}precompile(){this.techniques.precompile(k),this.techniques.precompile(X),this.techniques.precompile(j),this.techniques.precompile(E)}render(e){const t=e.find(e=>{let{name:t}=e;return t===z.OG.HIGHLIGHTS}),{techniques:r,bindParameters:i}=this;if(!i.decorations)return t;if(!r.get(k).compiled)return this.requestRender(1),t;const s=e.find(e=>{let{name:t}=e;return"highlights"===t}).getTexture();return this._renderHighlightPostprocess(s,t),t}_prepareAndDownSample(e){var t;this._gridUpdateResources(e);const r=this.techniques.get(k),i=this._gridComputeCoverage(r,e),{horizontalCellCount:s,verticalCellCount:n}=i,a=this._passParameters;return a.horizontalCellCount=s,a.verticalCellCount=n,a.coverageTexture=null===(t=i.coverage)||void 0===t?void 0:t.getTexture(),i}_renderGrid(e){const t=e.verticalCellCount*e.horizontalCellCount;this.renderingContext.bindVAO(e.vao),this.renderingContext.drawElementsInstanced(J.WR.TRIANGLES,6,J.pe.UNSIGNED_BYTE,0,t)}_renderHighlightPostprocess(e,t){const{fboCache:r,techniques:i,bindParameters:s,_passParameters:n,renderingContext:a}=this,o=i.get(X),h=i.get(j),l=i.get(E);if(!l.compiled||!h.compiled||!o.compiled)return void this.requestRender(1);n.highlightTexture=e;const u=this._prepareAndDownSample(e),{width:c,height:d}=e.descriptor;n.highlightTexture=e;const{camera:g}=s,{fullWidth:p,fullHeight:v,pixelRatio:_,fullViewport:f}=g,m=Math.ceil(p/_),x=Math.ceil(v/_),{_highlightBlurDrawParameters:y}=this,b=this.view.stage.renderView.renderer,{highlights:w}=s;for(let T=0;T<w.length;++T){var C;const{name:e}=w[T];if(!b.hasHighlight(e))continue;n.highlightLevel=T,a.setClearColor(0,0,0,0);const i=r.acquire(c,d,"single highlight",2);a.bindFramebuffer(i.fbo),a.setViewport(0,0,c,d),a.clear(16384),a.bindTechnique(o,s,n),this._renderGrid(u),y.blurInput=i.getTexture(),(0,D.hZ)(y.blurSize,1/m,0);const g=r.acquire(m,x,"single highlight blur",2);a.unbindTexture(null===(C=g.fbo)||void 0===C?void 0:C.colorTexture),a.bindFramebuffer(g.fbo),a.setViewport(0,0,m,x),a.clear(16384),a.bindTechnique(h,s,n,y),this._renderGrid(u),i.release(),(0,D.hZ)(y.blurSize,0,1/x),n.highlightBlurTexture=g.getTexture(),a.bindFramebuffer(t.fbo),a.setViewport4fv(f),a.bindTechnique(l,s,n,y),this._renderGrid(u),g.release()}n.coverageTexture=n.highlightTexture=null}_gridUpdateResources(e){const t=this._grid,{width:r,height:i}=e.descriptor;if(t.horizontalCellCount=Math.ceil(r/G.g),t.verticalCellCount=Math.ceil(i/G.g),t.vao)return;const s=this.renderingContext,n=K.g.createIndex(s,35044,ae);t.vao=new Y.Z(s,new re.R(s,L.wR),n)}_gridComputeCoverage(e,t){var r;const i=this.renderingContext,s=this._grid,n=t.descriptor,a=Math.ceil(n.width/G.g),o=Math.ceil(n.height/G.g);this._downsampleDrawParameters.input=t;const{highlights:h}=this.bindParameters;null===(r=s.coverage)||void 0===r||r.release();const l=this.fboCache.acquire(a,o,"highlight coverage",h.length>oe?3:1);return s.coverage=l,i.bindFramebuffer(l.fbo),i.bindTechnique(e,this.bindParameters,this._passParameters,this._downsampleDrawParameters),i.setViewport(0,0,a,o),i.screen.draw(),s}get test(){}};(0,s.Cg)([(0,g.MZ)()],ie.prototype,"produces",void 0),(0,s.Cg)([(0,g.MZ)()],ie.prototype,"consumes",void 0),ie=(0,s.Cg)([(0,v.$)("esri.views.3d.webgl-engine.effects.highlight.Highlight")],ie);class se{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}}let ne=0;const ae=new Uint8Array([0,1,2,2,1,3]);const oe=4;var he=r(75941);class le{constructor(e,t,r,i){this.material=e,this.output=t,this.techniques=r,this.textures=i}}var ue=r(86994);class ce{constructor(e,t,r,i){this._textures=e,this._techniques=t,this.materialChanged=r,this.requestRender=i,this._id2glMaterialRef=new he.O}dispose(){this._textures.destroy()}acquire(e,t,r){this._ownMaterial(e);const i=e.produces.get(t);if(null===i||void 0===i||!i(r))return null;let s=this._id2glMaterialRef.get(r,e.id);if(null==s){const t=e.createGLMaterial(new le(e,r,this._techniques,this._textures));s=new de(t),this._id2glMaterialRef.set(r,e.id,s)}return s.ref(),s.glMaterial}release(e,t){const r=this._id2glMaterialRef.get(t,e.id);null!=r&&(r.unref(),r.referenced||((0,l.WD)(r.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&p.A.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}}class de{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,(0,ue.vA)(this._refCnt>=0)}get referenced(){return this._refCnt>0}}var ge=r(97583),pe=r(91417),ve=r(13191),_e=r(72745),fe=r(4212),me=r(15941),xe=r(75540),ye=r(52896),be=r(14556);var we=r(317);class Ce{constructor(){this.startTime=0,this._data=(0,xe.v)(null),this.coverage=0,this.absorption=0,this._readChannels=0,this.parallax=new Te,this.parallaxNew=new Te,this._anchorPoint=(0,m.vt)(),this._fadeState=(0,xe.v)(0),this._fadeFactor=(0,xe.v)(1)}get data(){return this._data.value}set data(e){this._data.value=e}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case 0:return 0;case 4:return 1-this.fadeFactor;case 1:return this.fadeFactor;case 2:case 3:return 1}}fade(e,t,r){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=r?(0,me.qE)((t-this.startTime)/(Pe*r),0,1):1,1===this.fadeFactor&&this._endFade()),this._evaluateState(e,t),this._updateParallax(e)}_evaluateState(e,t){const r=e.relativeElevation,i=this._updateAnchorPoint(e);(r>1.7*we.zF||r<-we.zF||i>Fe)&&this.opacity>0?this._startFade(0,t):this.isFading||(r>we.zF||r<-.35*we.zF||i>Re*Fe?this.opacity>0&&this._startFade(4,t):function(e){return null!=e&&!e.readyToRun}(this.data)&&(0===this.opacity?this._startFade(1,t):2===this.data.state&&(2===this.fadeState?this._startFade(3,t):this._startFade(2,t))))}_updateParallax(e){const t=(0,f.m)(e.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(t-be.$O.radius*be.$O.radius,0))/Math.sqrt(t),(0,ye.Cr)(Se,this.parallax.anchorPoint,Oe),(0,_.e$)(this.parallax.transform,ve.zK,Oe[3],(0,ye.yo)(Oe)),(0,ye.Cr)(Se,this.parallaxNew.anchorPoint,Oe),(0,_.e$)(this.parallaxNew.transform,ve.zK,Oe[3],(0,ye.yo)(Oe))}_updateAnchorPoint(e){var t;return(0,f.n)(this._anchorPoint,e.eye),(0,f.h)(this._anchorPoint,this._anchorPoint,be.$O.radius),0===this.fadeState&&2===(null===(t=this.data)||void 0===t?void 0:t.state)?((0,f.d)(this.parallax.anchorPoint,this._anchorPoint),0):(0,f.b)((0,f.e)(Me,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(e,t){switch(this._fadeState.value=e,this.startTime=t,e){case 3:this.requestFade(),this._switchReadChannels(),(0,f.d)(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 1:this.requestFade(),this._switchReadChannels(),(0,f.d)(this.parallax.anchorPoint,this._anchorPoint),(0,f.d)(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 4:this.requestFade();break;case 2:this._switchReadChannels(),(0,f.d)(this.parallax.anchorPoint,this._anchorPoint),(0,f.d)(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case 0:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&2!==this.data.state&&(this.data.state=0),this.fadeState){case 3:(0,f.d)(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=2;break;case 1:this._fadeState.value=2;break;case 4:this._fadeState.value=0;break;case 2:case 0:break;default:(0,fe.Xb)(this.fadeState)}}_switchReadChannels(){var e;2===(null===(e=this.data)||void 0===e?void 0:e.state)&&(this._readChannels=1-this._readChannels,this.data.state=3)}get isFading(){return 4===this.fadeState||1===this.fadeState||3===this.fadeState}}class Te{constructor(){this.anchorPoint=(0,m.vt)(),this.radiusCurvatureCorrection=0,this.transform=(0,ve.vt)()}}const Se=(0,m.fA)(0,0,1),Oe=(0,ye.vt)(),Me=(0,m.vt)(),Pe=1.25,Re=.5,Fe=2e5;var Ve=r(4998);class De{constructor(e){this.shadowMap=e,this.slot=2,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=0,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this.cutFillEnabled=!1,this._camera=new R.A,this._inverseViewport=(0,_e.vt)(),this._oldLighting=new Ve.TA,this._newLighting=new Ve.TA,this._fadedLighting=new Ve.TA,this._lighting=this._newLighting,this.ssr=new ze,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=new Array,this.highlightOrderMap=new Map,this.highlightMixOrigin=(0,_e.vt)(),this.highlightMixTexture=null,this.hudRenderStyle=0,this.hudOccludedFragmentOpacity=1,this.snowCover=0,this.clouds=new Ce,this.shadowHighlightsVisible=!1}destroy(){this._camera=null,this.contentCamera=null,this.depth=null,this.geometryDepth=null,this.mainDepth=null,this.overlay=null,this.ssao=null,this.terrainDepth=null}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,t,r,i){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=t,this._newLighting.globalFactor=r,this._newLighting.set(e),this._oldLighting.updateLegacy(),1===i&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return null==this.highlightLevel?null:this.highlights[this.highlightLevel]}}class ze{constructor(){this.fadeFactor=1,this.reprojectionMatrix=(0,ve.vt)()}}class Ae{constructor(e,t,r){this.rctx=e,this.techniques=r,this.lastFrameCamera=new R.A,this.output=0,this.renderOccludedMask=Ie,this.time=(0,pe.l5)(0),this.bind=new De(t),this.bind.alignPixelEnabled=!0}}const Ie=13;var We=r(44680),Le=r(55855);let qe=class extends R.A{constructor(){super(...arguments),this._projectionMatrix=(0,ve.vt)()}get projectionMatrix(){return this._projectionMatrix}};(0,s.Cg)([(0,g.MZ)()],qe.prototype,"_projectionMatrix",void 0),(0,s.Cg)([(0,g.MZ)({readOnly:!0})],qe.prototype,"projectionMatrix",null),qe=(0,s.Cg)([(0,v.$)("esri.views.3d.webgl-engine.lib.CascadeCamera")],qe);var Be=r(81330);class He{constructor(){this.camera=new qe,this.lightMat=(0,ve.vt)()}}class Ee{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}class Ne{constructor(e,t){this._fbos=e,this._viewingMode=t,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Ee,this._projectionView=(0,ve.vt)(),this._projectionViewInverse=(0,ve.vt)(),this._modelViewLight=(0,ve.vt)(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=(0,Le.vt)(),this._cascades=[new He,new He,new He,new He],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min((0,o.A)("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){var e;return null===(e=this._handle)||void 0===e?void 0:e.getTexture(J.nI)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return(0,y.s)(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=(0,l.Gz)(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=(0,me.qE)(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&null!=this.depthTexture}get cascades(){for(let e=0;e<this._numCascades;++e)Ke[e]=this._cascades[e];return Ke.length=this._numCascades,Ke}start(e,t,r,i,s){(0,ue.vA)(this.enabled);const{near:n,far:a}=function(e){let{near:t,far:r}=e;return t<2&&(t=2),r<2&&(r=2),t>=r&&(t=2,r=4),{near:t,far:r}}(r);this._computeCascadeDistances(n,a,i),this._textureHeight=this._computeTextureHeight(e,s,i),this._setupMatrices(e,t);const{viewMatrix:o,projectionMatrix:h}=e;for(let l=0;l<this._numCascades;++l)this._constructCascade(l,h,o,t);this._lastOrigin=null,this.clear()}finish(){(0,ue.vA)(this.enabled)}getShadowMapMatrices(e){if(!this._lastOrigin||!(0,f.q)(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||(0,m.vt)(),(0,f.d)(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){(0,_.Tl)(Je,this._cascades[t].lightMat,e);for(let e=0;e<16;++e)et[16*t+e]=Je[e]}}return et}moveSnapshot(e){var t,r;(0,ue.vA)(this.enabled),null!==(t=this._snapshots[e])&&void 0!==t&&t.release(),this._snapshots[e]=this._handle,null!==(r=this._handle)&&void 0!==r&&r.setName(0===e?"shadow map highlight":"shadow map excluding highlight"),this._handle=null}copySnapshot(e){var t,r,i;if(!this.enabled)return;if(!(null===(t=this._handle)||void 0===t||null===(t=t.getTexture(J.nI))||void 0===t?void 0:t.descriptor))return;null===(r=this._snapshots[e])||void 0===r||r.release();const s=0===e?"shadow map highlight":"shadow map excluding highlight",n=this._acquireFBO(s);this._snapshots[e]=n;const a=null===(i=this._handle)||void 0===i?void 0:i.fbo;if(!a||null===n||void 0===n||!n.fbo)return void console.error("No FBO");const{rctx:o}=this._fbos;o.blitFramebuffer(a,n.fbo,256)}getSnapshot(e){var t;return this.enabled?null===(t=this._snapshots[e])||void 0===t?void 0:t.getTexture(J.nI):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(256)}_computeTextureHeight(e,t,r){let{pixelRatio:i,fullWidth:s,fullHeight:n}=e;const a=Math.min(window.devicePixelRatio,t)/i,o=r?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return(0,Be.Mv)(Math.max(s,n)*a*o,this._maxTextureWidth/this._numCascades)}_ensureFbo(){var e,t,r;(null===(e=this._handle)||void 0===e||null===(e=e.fbo)||void 0===e?void 0:e.width)===this._textureWidth&&(null===(t=this._handle)||void 0===t?void 0:t.fbo.height)===this._textureHeight||(null!==(r=this._handle)&&void 0!==r&&r.release(),this._handle=this._acquireFBO("shadow map"))}_acquireFBO(e){var t;const r=this._fbos.acquire(this._textureWidth,this._textureHeight,e,12);return null!==(t=r.getTexture(J.nI))&&void 0!==t&&t.setShadowFiltering(!0),r}_discardSnapshot(e){this._snapshots[e]=(0,l.Gz)(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}bindFbo(){var e;this._fbos.rctx.bindFramebuffer(null===(e=this._handle)||void 0===e?void 0:e.fbo)}_constructCascade(e,t,r,i){const s=this._cascades[e],n=-this._cascadeDistances[e],a=-this._cascadeDistances[e+1],o=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]),h=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]);(0,ue.vA)(o<h);for(let d=0;d<8;++d){(0,y.s)(Ge,d%4==0||d%4==3?-1:1,d%4==0||d%4==1?-1:1,d<4?o:h,1);const e=ke[d];(0,y.t)(e,Ge,this._projectionViewInverse),e[0]/=e[3],e[1]/=e[3],e[2]/=e[3]}(0,f.u)(Ye,ke[0]),s.camera.viewMatrix=(0,_.Tl)(je,this._modelViewLight,Ye);for(let d=0;d<8;++d)(0,f.t)(ke[d],ke[d],s.camera.viewMatrix);let l=ke[0][2],u=ke[0][2];for(let d=1;d<8;++d)l=Math.min(l,ke[d][2]),u=Math.max(u,ke[d][2]);l-=200,u+=200,s.camera.near=-u,s.camera.far=-l,function(e,t,r,i,s){const n=1/ke[0][3],a=1/ke[4][3];(0,ue.vA)(n<a);let o=n+Math.sqrt(n*a);const h=Math.sin((0,me.XM)(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));o/=h,function(e,t,r,i,s,n,a,o){(0,D.hZ)(tt,0,0);for(let b=0;b<4;++b)(0,D.WQ)(tt,tt,e[b]);(0,D.hs)(tt,tt,.25),(0,D.hZ)(rt,0,0);for(let b=4;b<8;++b)(0,D.WQ)(rt,rt,e[b]);(0,D.hs)(rt,rt,.25),(0,D.Cc)(it[0],e[4],e[5],.5),(0,D.Cc)(it[1],e[5],e[6],.5),(0,D.Cc)(it[2],e[6],e[7],.5),(0,D.Cc)(it[3],e[7],e[4],.5);let h=0,l=(0,D.hG)(it[0],tt);for(let b=1;b<4;++b){const e=(0,D.hG)(it[b],tt);e<l&&(l=e,h=b)}(0,D.Re)(st,it[h],e[h+4]);const u=st[0];let c,d;st[0]=-st[1],st[1]=u,(0,D.Re)(nt,rt,tt),(0,D.Om)(nt,st)<0&&(0,D.ze)(st,st),(0,D.Cc)(st,st,nt,r),(0,D.S8)(st,st),c=d=(0,D.Om)((0,D.Re)(at,e[0],tt),st);for(let b=1;b<8;++b){const t=(0,D.Om)((0,D.Re)(at,e[b],tt),st);t<c?c=t:t>d&&(d=t)}(0,D.C)(i,tt),(0,D.hs)(at,st,c-t),(0,D.WQ)(i,i,at);let g=-1,p=1,v=0,_=0;for(let b=0;b<8;++b){(0,D.Re)(ot,e[b],i),(0,D.S8)(ot,ot);const t=st[0]*ot[1]-st[1]*ot[0];t>0?t>g&&(g=t,v=b):t<p&&(p=t,_=b)}(0,ue.MX)(g>0,"leftArea"),(0,ue.MX)(p<0,"rightArea"),(0,D.hs)(ht,st,c),(0,D.WQ)(ht,ht,tt),(0,D.hs)(lt,st,d),(0,D.WQ)(lt,lt,tt),ut[0]=-st[1],ut[1]=st[0];const f=(0,ue.L)(i,e[_],lt,(0,D.WQ)(at,lt,ut),1,s),m=(0,ue.L)(i,e[v],lt,at,1,n),x=(0,ue.L)(i,e[v],ht,(0,D.WQ)(at,ht,ut),1,a),y=(0,ue.L)(i,e[_],ht,at,1,o);(0,ue.MX)(f,"rayRay"),(0,ue.MX)(m,"rayRay"),(0,ue.MX)(x,"rayRay"),(0,ue.MX)(y,"rayRay")}(ke,o,h,Ze,Ue,Qe,$e,Xe),function(e,t,r,i,s){(0,D.Re)(pt,r,i),(0,D.hs)(pt,pt,.5),vt[0]=pt[0],vt[1]=pt[1],vt[2]=0,vt[3]=pt[1],vt[4]=-pt[0],vt[5]=0,vt[6]=pt[0]*pt[0]+pt[1]*pt[1],vt[7]=pt[0]*pt[1]-pt[1]*pt[0],vt[8]=1,vt[ct(0,2)]=-(0,D.Om)(gt(vt,0),e),vt[ct(1,2)]=-(0,D.Om)(gt(vt,1),e);let n=(0,D.Om)(gt(vt,0),r)+vt[ct(0,2)],a=(0,D.Om)(gt(vt,1),r)+vt[ct(1,2)],o=(0,D.Om)(gt(vt,0),i)+vt[ct(0,2)],h=(0,D.Om)(gt(vt,1),i)+vt[ct(1,2)];n=-(n+o)/(a+h),vt[ct(0,0)]+=vt[ct(1,0)]*n,vt[ct(0,1)]+=vt[ct(1,1)]*n,vt[ct(0,2)]+=vt[ct(1,2)]*n,n=1/((0,D.Om)(gt(vt,0),r)+vt[ct(0,2)]),a=1/((0,D.Om)(gt(vt,1),r)+vt[ct(1,2)]),vt[ct(0,0)]*=n,vt[ct(0,1)]*=n,vt[ct(0,2)]*=n,vt[ct(1,0)]*=a,vt[ct(1,1)]*=a,vt[ct(1,2)]*=a,vt[ct(2,0)]=vt[ct(1,0)],vt[ct(2,1)]=vt[ct(1,1)],vt[ct(2,2)]=vt[ct(1,2)],vt[ct(1,2)]+=1,n=(0,D.Om)(gt(vt,1),t)+vt[ct(1,2)],a=(0,D.Om)(gt(vt,2),t)+vt[ct(2,2)],o=(0,D.Om)(gt(vt,1),r)+vt[ct(1,2)],h=(0,D.Om)(gt(vt,2),r)+vt[ct(2,2)],n=-.5*(n/a+o/h),vt[ct(1,0)]+=vt[ct(2,0)]*n,vt[ct(1,1)]+=vt[ct(2,1)]*n,vt[ct(1,2)]+=vt[ct(2,2)]*n,n=(0,D.Om)(gt(vt,1),t)+vt[ct(1,2)],a=(0,D.Om)(gt(vt,2),t)+vt[ct(2,2)],o=-a/n,vt[ct(1,0)]*=o,vt[ct(1,1)]*=o,vt[ct(1,2)]*=o,s[0]=vt[0],s[1]=vt[1],s[2]=0,s[3]=vt[2],s[4]=vt[3],s[5]=vt[4],s[6]=0,s[7]=vt[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=vt[6],s[13]=vt[7],s[14]=0,s[15]=vt[8]}(Ze,Ue,$e,Xe,s.projectionMatrix),s.projectionMatrix[10]=2/(r-i),s.projectionMatrix[14]=-(r+i)/(r-i)}(r,i,l,u,s.camera),(0,_.lw)(s.lightMat,s.camera.projectionMatrix,s.camera.viewMatrix);const c=this._textureHeight;s.camera.viewport=[e*c,0,c,c]}_setupMatrices(e,t){(0,_.lw)(this._projectionView,e.projectionMatrix,e.viewMatrix),(0,_.B8)(this._projectionViewInverse,this._projectionView);const r=1===this._viewingMode?e.eye:(0,f.j)(Ye,0,0,1);(0,_.t5)(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],r)}_computeCascadeDistances(e,t,r){const i=r?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor((0,ue.kL)(t/e,4)),i);const s=(t-e)/this._numCascades,n=(t/e)**(1/this._numCascades);let a=e,o=e;for(let h=0;h<this._numCascades+1;++h)this._cascadeDistances[h]=(0,me.Cc)(a,o,this.settings.splitSchemeLambda),a*=n,o+=s}get test(){}}const je=(0,ve.vt)(),Ge=(0,Le.vt)(),ke=[];for(let Rt=0;Rt<8;++Rt)ke.push((0,Le.vt)());const Ze=(0,_e.vt)(),Ue=(0,_e.vt)(),Qe=(0,_e.vt)(),$e=(0,_e.vt)(),Xe=(0,_e.vt)(),Ye=(0,m.vt)(),Ke=[];const Je=(0,ve.vt)(),et=ve.zK.concat(ve.zK,ve.zK,ve.zK),tt=(0,_e.vt)(),rt=(0,_e.vt)(),it=[(0,_e.vt)(),(0,_e.vt)(),(0,_e.vt)(),(0,_e.vt)()],st=(0,_e.vt)(),nt=(0,_e.vt)(),at=(0,_e.vt)(),ot=(0,_e.vt)(),ht=(0,_e.vt)(),lt=(0,_e.vt)(),ut=(0,_e.vt)();function ct(e,t){return 3*t+e}const dt=(0,_e.vt)();function gt(e,t){return(0,D.hZ)(dt,e[t],e[t+3]),dt}const pt=(0,_e.vt)(),vt=(0,We.vt)();class _t extends W.w{constructor(e,t){super(e,t,new I.$(F.a,()=>r.e(2553).then(r.bind(r,62553))),L.Nx)}initializePipeline(e){return e.hasAlpha?(0,B.Ey)({blending:B.T8,colorWrite:B.kn}):(0,B.Ey)({colorWrite:B.kn})}}var ft=r(6485);class mt extends ft.K{constructor(){super(...arguments),this.hasAlpha=!1}}(0,s.Cg)([(0,ft.W)()],mt.prototype,"hasAlpha",void 0);var xt=r(71011),yt=r(80381);class bt extends W.w{constructor(e,t){super(e,t,new I.$(yt.a,()=>r.e(1747).then(r.bind(r,71747))),L.Nx)}}var wt=r(59752);let Ct=class extends V.RW{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new yt.O,this.hasHighlights=!1,this.renderOccludedFlags=1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new u.A,this._passParameters=new F.T,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new R.A,this.events=new a.bk,this.longitudeCyclical=null,this.produces=new Map([[18,e=>9!==e||this.hasHighlights],[19,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1,this._hasDrapedFlowSource=!1}initialize(){const e=this._view,t=e.stage,r=t.renderer.fboCache,{waterTextures:i,techniques:s}=t.renderView;this._renderContext=new Ae(this._rctx,new Ne(r,e.state.viewingMode),s),this.addHandles([(0,c.wB)(()=>i.updating,()=>this.events.emit("content-changed"),c.pc),(0,c.wB)(()=>this._spatialReference,e=>this._localOriginFactory=new ge.g(e),c.pc),(0,c.on)(()=>e.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),(0,c.wB)(()=>function(e){let t=0;for(const i of e){const{name:e}=i;t+=e.length;const{color:r,fillOpacity:s,haloColor:n,haloOpacity:a}=i;t+=r.r+r.g+r.b+r.a+s,t+=n?n.r+n.g+n.b+n.a+a:0}const r=e.at(0);if(r){const{shadowOpacity:e,shadowDifference:i,shadowColor:s}=r;t+=e+i+s.r+s.g+s.b+s.a}return ne+++(t>=0?0:1)}(e.state.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,c.Vh),(0,c.wB)(()=>e.state.highlights,t=>{this._bindParameters.highlights=t,this._bindParameters.highlightOrderMap=e.state.highlightOrderMap},c.Vh),e.resourceController.scheduler.registerTask(wt.W6.OVERLAY_RENDERER,this)]);const{_bindParameters:n,_camera:a}=this;a.near=1,a.far=1e4,a.relativeElevation=null,n.slot=18,n.mainDepth=null,n.camera=a,n.oitPass=0,n.updateLighting([new xt.$p((0,m.S)())],0,0,0)}destroy(){this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._passParameters.texture=(0,l.WD)(this._passParameters.texture),this.disposeOverlays(),this._renderContext=null,this._sortedRenderers.prune()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get _spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){const t=new ce(this._view.stage.renderView.textures,this._techniques,()=>{this._onMaterialOrContentChanged(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));this._pluginContext=(0,i.A)((0,i.A)({},e),{},{materials:t}),this._techniques.precompile(bt)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||(0,h.Bs)(this._renderers,e=>e.updating||e.canCompact)}get hasOverlays(){return null!=this._overlays&&null!=this._renderTargets}getMaterialRenderer(e){for(const t of this._renderers.values()){const r=t.getMaterialRenderer(e);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),(0,n.Am)(this._sortedRenderers.map(e=>e.drapeSource.layer).filter(e=>!!e))}registerDrapeSource(e,t){const r=this._renderers.get(e);null!=r&&r.destroy(),this._renderers.set(e,t),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles((0,c.wB)(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e)}removeDrapeSourceRenderer(e){if(null==e)return;const t=this._renderers.get(e);null!=t&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){var e,t;return null!==(e=null===(t=this._renderTargets)||void 0===t?void 0:t.computeValidity())&&void 0!==e?e:0}releaseRenderTargets(e){var t;null===(t=this._renderTargets)||void 0===t||t.dispose(e)}get overlays(){var e;return null!==(e=this._overlays)&&void 0!==e?e:[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&(0,d.bw)(e,e=>1===e.drapeTargetType)}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=(0,d.bw)(e,e=>1===e.drapeSourceType),this._hasDrapedRasterSource=(0,d.bw)(e,e=>0===e.drapeSourceType),this._hasDrapedFlowSource=(0,d.bw)(e,e=>2===e.drapeSourceType)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=this._hasDrapedFlowSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._bindParameters.overlayStretch;null==this._overlays&&(this._renderTargets=new P(this._stage.renderer.fboCache),this._overlays=[new C,new C]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=r}disposeOverlays(){var e;this._overlays=null,null!==(e=this._renderTargets)&&void 0!==e&&e.dispose(1),this._renderTargets=null,this.events.emit("textures-disposed")}_useOverlayColorInsteadOfColorNoRasterImage(e){return 1===e&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource}getTexture(e){var t;const r=this._useOverlayColorInsteadOfColorNoRasterImage(e);return null===(t=this._renderTargets)||void 0===t?void 0:t.getTexture(r?0:e)}get readyToRun(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_onMaterialOrContentChanged(){this.renderOccludedFlags=(0,h.Bs)(this._renderers,e=>e.hasOccluders)?Mt:1}_processDrapeSources(e,t){let r=!1;for(const[i,s]of this._renderers){if(e.done)break;(i.destroyed||t(i))&&s.commitChanges()&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers(),e.madeProgress()),this.compact(e),r&&(null!=this._overlays&&0===this._renderers.size&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this._onMaterialOrContentChanged(),this.hasHighlights=(0,h.Bs)(this._renderers,e=>e.hasHighlights),this.events.emit("content-changed"))}compact(e){let t=!1;for(const r of this._renderers.values()){if(e.done)break;t=r.compact(e)||t}return t&&this.notifyChange("updating"),t}hasHighlight(e){return(0,h.Bs)(this._renderers,t=>t.hasHighlight(e))}processSyncDrapeSources(){this._processDrapeSources(wt.Bb,e=>1===e.updatePolicy)}get isEmpty(){return!x.b.OVERLAY_DRAW_DEBUG_TEXTURE&&(0,h.mt)(this._renderers,e=>e.isEmpty)}get hasWater(){const e=(0,h.Bs)(this._renderers,e=>{let{hasWater:t}=e;return t});return e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water")),this._hasWater}renders(e){var t,r;if(x.b.OVERLAY_DRAW_DEBUG_TEXTURE&&4!==e&&2!==e)return!0;if(!this._overlays)return!1;const i=this._overlays[0];for(const a of this._overlays)a.setupGeometryViews(this.longitudeCyclical);if(!i.hasSomeSizedView())return!1;const s=this._renderContext.output;this._renderContext.output=null!==(t=null===(r=this._renderTargets)||void 0===r||null===(r=r.targets.find(t=>t.content===e))||void 0===r?void 0:r.output)&&void 0!==t?t:0,++this._techniques.precompiling;const n=this._sortedRenderers.some(e=>{let{renderer:t}=e;return t.precompile(this._renderContext)});return--this._techniques.precompiling,this._renderContext.output=s,n}get mode(){var e;return this.isEmpty?0:this.hasWater&&this.renders(3)?2:null!==(e=this._renderTargets)&&void 0!==e&&e.getTexture(0)?1:0}updateAnimation(e){let t=!1;return this._renderers.forEach(r=>t=r.updateAnimation(e)||t),t&&this.parent.requestRender(0),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(!this._overlays||!this._renderTargets)return!1;const t=this._bindParameters;t.alignPixelEnabled=e.alignPixelEnabled,++this._techniques.precompiling;for(const r of this._renderTargets.targets){if(1===r.content&&!this._needsColorWithoutRasterImage)continue;const{output:e}=r;this._renderContext.output=e,t.slot=3===e?19:18,9===e&&(t.highlightMixTexture=t.highlights.length>1?this._rctx.emptyTexture:null);const i=this._renderContext.renderOccludedMask;4===r.content&&(this._renderContext.renderOccludedMask=Mt),this._sortedRenderers.forAll(e=>{let{drapeSource:t,renderer:i}=e;1===r.content&&0===t.drapeSourceType||4===r.content&&i.hasOnlyOccluders||i.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=i,t.highlightMixTexture=null}return--this._techniques.precompiling,!0}drawOverlays(e,t){if(!this._overlays||!this._renderTargets)return;for(const i of this._overlays)i.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;const r=this.allSourcesOccluders;for(const i of this._renderTargets.targets){if((0!==i.content||!this._hasDrapedFlowSource)&&!i.handleRenderRequest(t)||1===i.content&&!this._needsColorWithoutRasterImage||4===i.content&&r)continue;const e=this._drawTarget(0,i),s=this._drawTarget(1,i);(e||s)&&i.fbo.generateMipMap()}}_drawTarget(e,t){const r=this._overlays[e],i=r.canvasGeometries;if(0===i.numViews)return!1;const s=this._view.state.contentPixelRatio;this._screenToWorldRatio=s*r.mapUnitsPerPixel/this._bindParameters.overlayStretch;const{output:n}=t;if(this.isEmpty||3===n&&!this.hasWater||!r.hasSomeSizedView())return!1;const{_rctx:a,_camera:o,_renderContext:h,_bindParameters:l}=this;if(o.pixelRatio=r.pixelRatio*s,h.output=n,l.screenToWorldRatio=this._screenToWorldRatio,l.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,l.slot=3===n?19:18,4===t.content&&(h.renderOccludedMask=Mt),!this.renders(t.content))return h.renderOccludedMask=Ie,!1;const{resolution:u}=r,c=0===e,d=c?0:u;if(a.setViewport(d,0,u,u),this._bindTargetFBO(t),c)if(9!==t.output)a.setClearColor(0,0,0,0),a.clear(16384);else{const{gl:e}=a;e.clearBufferuiv(e.COLOR,0,[0,0,0,0])}if(x.b.OVERLAY_DRAW_DEBUG_TEXTURE&&4!==t.content&&2!==t.content){this._techniques.precompile(_t,Pt);const t=this._techniques.get(_t,Pt);for(let s=0;s<i.numViews;s++)this._setViewParameters(i.extents[s],r),this._ensureDebugPatternResources(r.resolution,St[e]),a.bindTechnique(t,l,this._passParameters),a.screen.draw()}if(9===t.output){const{fboCache:r}=this._stage.renderer,i=this._resolution;this._bindTargetFBO(t),function(e,t,r,i,s){let n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;const{highlights:a}=i,o=a.length>1?t.acquire(r.width,r.height,"highlight mix",a.length>oe?3:1):null,{gl:h}=e;if(o){const t=e.getBoundFramebufferObject();e.bindFramebuffer(o.fbo),h.clearBufferuiv(h.COLOR,0,[0,0,0,0]),e.bindFramebuffer(t)}const l=null===o||void 0===o?void 0:o.getTexture();i.highlightMixTexture=l,(0,D.hZ)(i.highlightMixOrigin,n,0),a.forEach((t,a)=>{if(a>0){const t=ee.g.TEXTURE_UNIT_FOR_UPDATES;e.bindTexture(l,t),e.setActiveTexture(t),h.copyTexSubImage2D(3553,0,0,0,n,0,r.width,r.height),e.bindTexture(null,t)}e.clear(256),i.highlightLevel=a,s()}),i.highlightLevel=null,i.highlightMixTexture=null,null===o||void 0===o||o.release()}(a,r,{width:i,height:i},l,()=>this._renderAllGeometry(e,t),d)}else this._renderAllGeometry(e,t);return a.bindFramebuffer(null),h.renderOccludedMask=Ie,!0}get allSourcesOccluders(){return(0,h.mt)(this._renderers,e=>e.hasOnlyOccluders)}_renderAllGeometry(e,t){const r=this._overlays[e],i=r.canvasGeometries;this._sortedRenderers.forAll(s=>{let{drapeSource:n,renderer:a}=s;if(1===t.content&&0===n.drapeSourceType)return;const{fullOpacity:o}=n,h=null!=o&&o<1&&0===t.output&&this._bindTemporaryFBO();for(let e=0;e<i.numViews;e++)this._setViewParameters(i.extents[e],r),a.render(this._renderContext);if(h){this._bindTargetFBO(t),this._overlayParameters.texture=h.getTexture(),this._overlayParameters.opacity=o,this._overlayParameters.overlayIndex=e;const r=this._techniques.get(bt);this._rctx.bindTechnique(r,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),h.release()}})}_bindTargetFBO(e){const t=this._resolution,r=2*t;e.fbo.ensureFramebuffer(r,t),e.fbo.bind(this._rctx)}_bindTemporaryFBO(){const e=this._resolution,t=2*e,r=this._stage.renderer.fboCache,i=r.acquire(t,e,"overlay tmp");return r.rctx.bindFramebuffer(i.fbo),r.rctx.clear(16384),i}get _resolution(){var e,t;return null!==(e=null===(t=this._overlays)||void 0===t?void 0:t[0].resolution)&&void 0!==e?e:0}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,r,i){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let s=0;for(const{renderer:o}of this._sortedRenderers){var n,a;s=null!==(n=null===(a=o.intersect)||void 0===a?void 0:a.call(o,e,t,r,i,s))&&void 0!==n?n:s}}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),0===this._renderers.size)return;const e=this._view.map.allLayers.map(e=>e.uid),t=e.length;this._renderers.forEach((r,i)=>{var s,n,a;const o=e.indexOf(null===(s=i.layer)||void 0===s?void 0:s.uid),h=o>=0,l=null!==(n=i.renderGroup)&&void 0!==n?n:h?0:1,u=null!==(a=i.drapeSourcePriorityOffset)&&void 0!==a?a:0,c=t*l+(h?o:0)+u;this._sortedRenderers.push(new Tt(i,r,c))}),this._sortedRenderers.sort((e,t)=>e.index-t.index)}_setViewParameters(e,t){const r=this._camera;r.viewport=[0,0,t.resolution,t.resolution],(0,_.v3)(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),(0,_.kN)(r.viewMatrix,[-e[0],-e[1],0])}_ensureDebugPatternResources(e,t){if((0,f.j)(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const r=new Uint8Array(e*e*4);let i=0;for(let n=0;n<e;n++)for(let t=0;t<e;t++){const s=Math.floor(t/10),a=Math.floor(n/10);s<2||a<2||10*s>e-20||10*a>e-20?(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=255):(r[i++]=255,r[i++]=255,r[i++]=255,r[i++]=1&s&&1&a?1&t^1&n?0:255:1&s^1&a?0:128)}const s=new te.R(e);s.samplingMode=9728,this._passParameters.texture=new ee.g(this._rctx,s,r)}get test(){}};(0,s.Cg)([(0,g.MZ)()],Ct.prototype,"hasHighlights",void 0),(0,s.Cg)([(0,g.MZ)()],Ct.prototype,"renderOccludedFlags",void 0),(0,s.Cg)([(0,g.MZ)()],Ct.prototype,"_sortedDrapeSourceRenderersDirty",void 0),(0,s.Cg)([(0,g.MZ)({constructOnly:!0})],Ct.prototype,"parent",void 0),(0,s.Cg)([(0,g.MZ)({readOnly:!0})],Ct.prototype,"_techniques",null),(0,s.Cg)([(0,g.MZ)({type:Boolean,readOnly:!0})],Ct.prototype,"updating",null),(0,s.Cg)([(0,g.MZ)()],Ct.prototype,"isEmpty",null),Ct=(0,s.Cg)([(0,v.$)("esri.views.3d.terrain.OverlayRenderer")],Ct);class Tt{constructor(e,t,r){this.drapeSource=e,this.renderer=t,this.index=r}}const St=[[1,.5,.5],[.5,.5,1]],Ot=-2,Mt=4,Pt=new mt;Pt.hasAlpha=!0},21019:(e,t,r)=>{r.d(t,{H:()=>u,a:()=>v,b:()=>p,c:()=>c,g:()=>d,o:()=>g});var i,s=r(57528),n=r(73398),a=r(86955),o=r(70571),h=r(31432),l=r(2687);class u extends h.Y{}function c(){const e=new l.N5,{outputs:t,fragment:r}=e;return e.include(n.c),r.uniforms.add(new o.R("highlightTexture",e=>e.highlightTexture)),r.constants.add("outlineWidth","int",Math.ceil(g)),r.constants.add("cellSize","int",d),t.add("fragGrid","uvec2"),r.main.add((0,a.H)(i||(i=(0,s.A)(["ivec2 inputTextureSize = textureSize(highlightTexture, 0);\nivec2 cellBottomLeftCornerInput = ivec2(ivec2(floor(gl_FragCoord.xy) * vec2(cellSize)));\nivec2 coordMid =  cellBottomLeftCornerInput + ivec2(cellSize >> 1);\nuvec2 centreTexel = texelFetch(highlightTexture, coordMid, 0).rg & uvec2(0x55u);\nfloat marginSquare = float(outlineWidth*outlineWidth);\nuvec2 outputValue = centreTexel & uvec2(0x55u);\nfor(int y = -outlineWidth; y <= cellSize + outlineWidth; y+=2) {\nint dy = y < 0 ? -y : y > cellSize ? y-cellSize : 0;\nint xMargin = dy > 0 ? int(ceil(sqrt(marginSquare - float(dy*dy)))) : outlineWidth;\nfor(int x = -xMargin; x <= cellSize + xMargin; x+=2) {\nivec2 coord = cellBottomLeftCornerInput + ivec2(x, y);\nuvec2[4] texels = uvec2[4] (\ntexelFetch(highlightTexture,coord+ivec2(0,0),0).rg & uvec2(0x55u),\ntexelFetch(highlightTexture,coord+ivec2(1,0),0).rg & uvec2(0x55u),\ntexelFetch(highlightTexture,coord+ivec2(0,1),0).rg & uvec2(0x55u),\ntexelFetch(highlightTexture,coord+ivec2(1,1),0).rg & uvec2(0x55u)\n);\nif (texels[0] == texels[1] && texels[1] == texels[2] && texels[2] == texels[3] && texels[3] ==  centreTexel) {\ncontinue;\n}\nfor (int i=0; i<4; ++i){\noutputValue |= ((texels[i] ^ centreTexel) << 1);\noutputValue |= texels[i];\n}\n}\n}\nfragGrid = outputValue;"])))),e}const d=32,g=9,p=.4,v=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:u,blurSize:p,build:c,gridCellPixelSize:d,outlineSize:g},Symbol.toStringTag,{value:"Module"}))},29889:(e,t,r)=>{r.d(t,{A:()=>l,C:()=>h});var i=r(45308),s=r(44815),n=r(99785),a=r(67425),o=r(3509);function h(e,t,r,i){const o="polygon"===e.type?1:0,h="polygon"===e.type?e.rings:e.paths,{position:l,outlines:c}=(0,n.oR)(h,!!e.hasZ,o,e.spatialReference),d=(0,s.jh)(l.length),g=(0,a.au)(l,e.spatialReference,0,d,0,l,0,l.length/3,t,r,i),p=null!=g;return{lines:p?u(c,l,d):[],projectionSuccess:p,sampledElevation:g}}function l(e,t){const r="polygon"===e.type?1:0,s="polygon"===e.type?e.rings:e.paths,{position:a,outlines:h}=(0,n.oR)(s,!1,r),l=(0,i.projectBuffer)(a,e.spatialReference,0,a,t,0);for(let i=2;i<a.length;i+=3)a[i]=o.bi;return{lines:l?u(h,a):[],projectionSuccess:l}}function u(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const i=new Array;for(const{index:n,count:a}of e){if(a<=1)continue;const e=3*n,o=3*a;i.push({position:(0,s.l5)(t,3*n,3*a),mapPositions:null!=r?(0,s.l5)(r,e,o):void 0})}return i}},35925:(e,t,r)=>{r.d(t,{Xq:()=>o,wk:()=>a});const i={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},s={dash:i.dash,"dash-dot":[...i.dash,...i.dot],dot:i.dot,"long-dash":i["long-dash"],"long-dash-dot":[...i["long-dash"],...i.dot],"long-dash-dot-dot":[...i["long-dash"],...i.dot,...i.dot],none:null,"short-dash":i["short-dash"],"short-dash-dot":[...i["short-dash"],...i["short-dot"]],"short-dash-dot-dot":[...i["short-dash"],...i["short-dot"],...i["short-dot"]],"short-dot":i["short-dot"],solid:null},n=8;function a(e){return{pattern:[e,e],pixelRatio:2}}function o(e){return"style"===(null===e||void 0===e?void 0:e.type)?function(e){return null!=e?function(e,t){return null==e?e:{pattern:e.slice(),pixelRatio:t}}(s[e],n):null}(e.style):null}},36911:(e,t,r)=>{r.d(t,{Z:()=>c});var i=r(4212),s=r(76460),n=r(30726),a=r(97255),o=r(93345),h=r(27207),l=r(75757);const u=()=>s.A.getLogger("esri.views.webgl.VertexArrayObject");let c=class e{constructor(e,t,r,s){this._context=e,this._indexBuffer=r,this._buffers=t instanceof Map?t:new Map([["geometry",t]]),this._baseInstances=null==s?new Map:"number"==typeof s?new Map([["geometry",s]]):s,this.locations=(0,i.zI)((0,l.Sk)(this._buffers))}get glName(){return this._glName}get context(){return this._context}get buffers(){return(0,i.zI)(this._buffers)}buffer(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"geometry";return this.buffers.get(e)}get indexBuffer(){return this._indexBuffer}getByteLength(e){var t,r;return null!==(t=null===(r=this.buffer(e))||void 0===r?void 0:r.sizeBytes)&&void 0!==t?t:0}vertexCount(e){const t=this.buffer(e);return t?t.sizeBytes/t.layout[0].stride:0}get usedMemory(){var e,t;return Array.from(this._buffers.values()).reduce((e,t)=>e+t.usedMemory,null!==(e=null===(t=this._indexBuffer)||void 0===t?void 0:t.usedMemory)&&void 0!==e?e:0+(this._buffers.size+(this._indexBuffer?1:0))*a.i5)}dispose(){this._context?(this._buffers.forEach(e=>e.dispose()),this._buffers.clear(),this._indexBuffer=(0,n.WD)(this._indexBuffer),this.disposeVAOOnly()):(this._glName||this._buffers.size>0)&&u().warn("Leaked WebGL VAO")}disposeVAOOnly(){this._context?(this._context.getBoundVAO()===this&&this._context.bindVAO(null),this._glName&&(this._context.gl.deleteVertexArray(this._glName),this._glName=null,this._context.instanceCounter.decrement(o.vt.VertexArrayObject,this)),this._context=null):this._glName&&u().warn("Leaked WebGL VAO")}bind(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.locations;const t=this._context.gl;this._glName?t.bindVertexArray(this._glName):(this._context.instanceCounter.increment(o.vt.VertexArrayObject,this),this._glName=t.createVertexArray(),t.bindVertexArray(this._glName),this._bindLayout(e))}_bindLayout(e){const{_buffers:t,_indexBuffer:r}=this;if(t||u().error("Vertex buffer dictionary is empty!"),t.forEach((t,r)=>{var i;return(0,h.yu)(this._context,e,t,null!==(i=this._baseInstances.get(r))&&void 0!==i?i:0)}),null!=r){const e=this._context.gl;this._context.gl.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r.glName)}}unbind(){this._context.gl.bindVertexArray(null)}shallowCloneWithBaseInstances(t){return new e(this._context,this._buffers,this._indexBuffer,t)}}},37923:(e,t,r)=>{r.d(t,{C:()=>x,b:()=>m});var i,s,n=r(57528),a=r(26917),o=r(59395),h=r(90080),l=r(54478),u=r(94192),c=r(66763),d=r(80883),g=r(3799),p=r(58350),v=r(86955),_=r(91911),f=r(2687);function m(e){const t=new f.N5,{vertex:r,fragment:m,attributes:x,varyings:y}=t,{hasVVColor:b,hasVertexColors:w}=e;return(0,g.NB)(r,e),t.include(o.d),t.include(l.c,e),t.include(c.A,e),t.include(h.g,e),m.include(a.HQ,e),t.include(_.z,e),t.include(u.Z,e),x.add("position","vec3"),b&&x.add("colorFeatureAttribute","float"),w||y.add("vColor","vec4"),y.add("vpos","vec3",{invariant:!0}),r.uniforms.add(new p.E("uColor",e=>e.color)),r.main.add((0,v.H)(i||(i=(0,n.A)(["\n      vpos = position;\n      forwardNormalizedVertexColor();\n      forwardObjectAndLayerIdColor();\n\n      ","\n      forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);\n      gl_Position = transformPosition(proj, view, vpos);"])),w?"vColor *= uColor;":b?"vColor = uColor * interpolateVVColor(colorFeatureAttribute);":"vColor = uColor;")),m.include(d.a),m.main.add((0,v.H)(s||(s=(0,n.A)(["discardBySlice(vpos);\ndiscardByTerrainDepth();\noutputColorHighlightOID(vColor, vpos, vColor.rgb);"])))),t}const x=Object.freeze(Object.defineProperty({__proto__:null,build:m},Symbol.toStringTag,{value:"Module"}))},43666:(e,t,r)=>{r.d(t,{H:()=>d,a:()=>p,b:()=>g});var i,s=r(57528),n=r(72745),a=r(47233),o=r(56289),h=r(86955),l=r(27374),u=r(31432),c=r(2687);class d extends u.Y{constructor(){super(...arguments),this.blurSize=(0,n.vt)()}}function g(){const e=new c.N5;return e.include(a.Q),e.outputs.add("fragHighlight","vec2",0),e.fragment.uniforms.add(new o.t("blurSize",e=>e.blurSize),new l.o("blurInput",e=>e.blurInput)).main.add((0,h.H)(i||(i=(0,s.A)(["vec2 highlightTextureSize = vec2(textureSize(blurInput,0));\nvec2 center = texture(blurInput, sUV).rg;\nif (vOutlinePossible == 0.0) {\nfragHighlight = center;\n} else {\nvec2 sum = center * 0.204164;\nsum += texture(blurInput, sUV + blurSize * 1.407333).rg * 0.304005;\nsum += texture(blurInput, sUV - blurSize * 1.407333).rg * 0.304005;\nsum += texture(blurInput, sUV + blurSize * 3.294215).rg * 0.093913;\nsum += texture(blurInput, sUV - blurSize * 3.294215).rg * 0.093913;\nfragHighlight = sum;\n}"])))),e}const p=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:d,build:g},Symbol.toStringTag,{value:"Module"}))},47233:(e,t,r)=>{r.d(t,{Q:()=>p});var i=r(57528),s=r(19555),n=r(72745),a=r(86955),o=r(87003);class h extends o.n{constructor(e,t){super(e,"ivec2",1,(r,i,s)=>r.setUniform2iv(e,t(i,s)))}}var l,u,c=r(72790),d=r(70571),g=r(21019);function p(e){const{vertex:t}=e;t.uniforms.add(new d.R("coverageTexture",e=>e.coverageTexture),new h("highlightRenderCellCount",e=>(0,s.hZ)(v,e.horizontalCellCount,e.verticalCellCount)),new h("highlightTextureResolution",e=>{let{highlightTexture:t}=e;return(0,s.hZ)(v,t.descriptor.width,t.descriptor.height)}),new c.c("highlightLevel",e=>e.highlightLevel)).constants.add("cellSize","int",g.g),e.varyings.add("sUV","vec2"),e.varyings.add("vOutlinePossible","float"),t.code.add((0,a.H)(l||(l=(0,i.A)(["const ivec2 cellVertices[4] = ivec2[4](ivec2(0,0), ivec2(1,0), ivec2(0,1), ivec2(1,1));"])))),t.main.add((0,a.H)(u||(u=(0,i.A)(["int cellIndex = gl_InstanceID;\nint cellX = cellIndex % highlightRenderCellCount[0];\nint cellY = (cellIndex - cellX) / highlightRenderCellCount[0];\nivec2 cellPos = ivec2(cellX, cellY);\nuvec2 covTexel = texelFetch(coverageTexture, cellPos, 0).rg;\nint channelIndex = (highlightLevel >> 2) & 3;\nuint channelValue = covTexel[channelIndex];\nint highlightIndex = (highlightLevel & 3) << 1;\nbool covered = ((channelValue >> highlightIndex) & 1u) == 1u;\nif (!covered) {\ngl_Position = vec4(0.0);\nreturn;\n}\nvOutlinePossible = (((channelValue >> highlightIndex) & 2u) == 2u) ? 1.0 : 0.0;\nivec2 iPosInCell = cellVertices[gl_VertexID];\nvec2 sPos = vec2(cellPos * cellSize + iPosInCell * (cellSize));\nvec2 vPos = sPos / vec2(highlightTextureResolution);\nsUV = vPos;\ngl_Position = vec4(2.0 * vPos - vec2(1.0), 0.0, 1.0);"]))))}const v=(0,n.vt)()},53070:(e,t,r)=>{r.d(t,{T:()=>d,a:()=>p,b:()=>g});var i,s=r(57528),n=r(9392),a=r(73398),o=r(5517),h=r(86955),l=r(70367),u=r(31432),c=r(2687);class d extends u.Y{constructor(){super(...arguments),this.color=(0,n.fA)(1,1,1)}}function g(){const e=new c.N5;return e.include(a.c),e.fragment.uniforms.add(new l.N("tex",e=>e.texture),new o.t("uColor",e=>e.color)),e.fragment.main.add((0,h.H)(i||(i=(0,s.A)(["vec4 texColor = texture(tex, uv);\nfragColor = texColor * vec4(uColor, 1.0);"])))),e}const p=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:d,build:g},Symbol.toStringTag,{value:"Module"}))},60586:(e,t,r)=>{r.d(t,{Cc:()=>o,RW:()=>a});var i=r(91967);const s={required:[]};class n extends i.A{precompile(e){return!!this.acquireTechniques(e)}consumes(){return s}get usedMemory(){return 0}get renderOccludedFlags(){return 1}get isDecoration(){return!1}get readyToRun(){return!1}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmitters(){return!1}forEachGeometry(e){}}class a extends n{}class o extends n{}},61157:(e,t,r)=>{r.d(t,{H:()=>_,b:()=>v});var i,s=r(57528),n=r(47233),a=r(79138),o=r(56289),h=r(21390),l=r(86955),u=r(72790),c=r(70367),d=r(70571),g=r(21019),p=r(2687);function v(){const e=new p.N5;e.include(n.Q);const{fragment:t}=e;return t.uniforms.add(new c.N("blurInput",e=>e.highlightBlurTexture),new o.t("blurSize",e=>e.blurSize),new d.R("highlightTexture",e=>e.highlightTexture),new c.N("highlightOptionsTexture",e=>e.highlightOptionsTexture),new u.c("highlightLevel",e=>e.highlightLevel),new h.m("occludedIntensityFactor",e=>e.occludedFactor)),t.constants.add("inner","float",1-(g.o-g.b)/g.o),e.include(a.y),t.main.add((0,l.H)(i||(i=(0,s.A)(["vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));\nvec2 uv = sUV;\nvec2 center = texture(blurInput, uv).rg;\nvec2 blurredHighlightValue = (vOutlinePossible == 0.0)\n? center\n: center * 0.204164\n+ texture(blurInput, uv + blurSize * 1.407333).rg * 0.304005\n+ texture(blurInput, uv - blurSize * 1.407333).rg * 0.304005\n+ texture(blurInput, uv + blurSize * 3.294215).rg * 0.093913\n+ texture(blurInput, uv - blurSize * 3.294215).rg * 0.093913;\nfloat highlightIntensity = blurredHighlightValue.r;\nfloat occlusionWeight = blurredHighlightValue.g;\nif (highlightIntensity <= 0.01) {\ndiscard;\n}\nvec4 fillColor    = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 0), 0);\nvec4 outlineColor = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 1), 0);\nuvec2 centerTexel = texelFetch(highlightTexture, ivec2(uv * highlightTextureSize), 0).rg;\nuint centerBits = readLevelBits(centerTexel, highlightLevel);\nbool centerFilled = (centerBits & 1u) == 1u;\nbool centerOccluded = (centerBits & 3u) == 3u;\nbool occluded = centerOccluded || (0.5 * highlightIntensity < occlusionWeight);\nfloat occlusionFactor = occluded ? occludedIntensityFactor : 1.0;\nfloat outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, inner, highlightIntensity);\nfloat fillFactor = centerFilled ? 1.0 : 0.0;\nvec4 baseColor = mix(outlineColor, fillColor, fillFactor);\nfloat intensity = baseColor.a * occlusionFactor * outlineFactor;\nfragColor = vec4(baseColor.rgb, intensity);"])))),e}const _=Object.freeze(Object.defineProperty({__proto__:null,build:v},Symbol.toStringTag,{value:"Module"}))},62854:(e,t,r)=>{r.d(t,{H:()=>d,b:()=>c});var i,s=r(57528),n=r(47233),a=r(79138),o=r(86955),h=r(72790),l=r(70571),u=r(2687);function c(){const e=new u.N5;e.include(n.Q),e.include(a.y);const{fragment:t}=e;return e.outputs.add("fragSingleHighlight","vec2",0),t.uniforms.add(new l.R("highlightTexture",e=>e.highlightTexture),new h.c("highlightLevel",e=>e.highlightLevel)),t.main.add((0,o.H)(i||(i=(0,s.A)(["ivec2 iuv = ivec2(gl_FragCoord.xy);\nuvec2 inputTexel = texelFetch(highlightTexture, iuv, 0).rg;\nuint bits = readLevelBits(inputTexel, highlightLevel);\nbool hasHighlight = (bits & 1u) == 1u;\nbool hasOccluded  = (bits & 2u) == 2u;\nfragSingleHighlight = vec2(hasHighlight ? 1.0 : 0.0, hasOccluded ? 1.0 : 0.0);"])))),e}const d=Object.freeze(Object.defineProperty({__proto__:null,build:c},Symbol.toStringTag,{value:"Module"}))},63928:(e,t,r)=>{r.d(t,{W:()=>n});var i=r(45463),s=r(48168);class n extends i.i{intersect(e,t,r,i,n,a){return(0,s.Uy)(e,r,i,n,void 0,a)}intersectDraped(e,t,r,i){return(0,s.gz)(r[0],r[1],e,i)}}},69008:(e,t,r)=>{r.d(t,{Z:()=>s});var i=r(36911);class s extends i.Z{}},70571:(e,t,r)=>{r.d(t,{R:()=>s});var i=r(87003);class s extends i.n{constructor(e,t){super(e,"usampler2D",1,(r,i,s)=>r.bindTexture(e,t(i,s)))}}},75941:(e,t,r)=>{r.d(t,{O:()=>i});class i{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return 0===this._outer.size}get outerSize(){return this._outer.size}get size(){let e=0;for(const t of this._outer.values())e+=t.size;return e}get(e,t){var r;return null===(r=this._outer.get(e))||void 0===r?void 0:r.get(t)}getInner(e){return this._outer.get(e)}set(e,t,r){const i=this._outer.get(e);i?i.set(t,r):this._outer.set(e,new Map([[t,r]]))}delete(e,t){const r=this._outer.get(e);r&&(r.delete(t),0===r.size&&this._outer.delete(e))}pop(e,t){const r=this.get(e,t);return this.delete(e,t),r}*outerMap(){for(const e of this._outer)yield e}*values(){for(const e of this._outer.values())yield*e.values()}*[Symbol.iterator](){for(const[e,t]of this._outer)for(const[r,i]of t)yield[e,r,i]}forEach(e){this._outer.forEach((t,r)=>e(t,r))}forAll(e){this._outer.forEach((t,r)=>t.forEach((t,i)=>e(t,r,i)))}copy(){const e=new i;return this.forAll((t,r,i)=>e.set(r,i,t)),e}}},76956:(e,t,r)=>{r.d(t,{v:()=>S});var i=r(55855),s=r(34981),n=r(59696),a=r(60322),o=r(82809),h=r(63928),l=r(93684),u=r(48549),c=r(16506),d=r(59246),g=r(61785),p=r(96643),v=r(37923),_=r(57162);l.S;class f extends d.w{constructor(e,t){super(e,t,new c.$(v.C,()=>r.e(5837).then(r.bind(r,35837))),x(t).locations)}_createPipeline(e,t){const{oitPass:r,output:i,transparent:n,cullFace:o,draped:h,hasOccludees:l,polygonOffset:u}=e,c=0===r;return(0,_.Ey)({blending:(0,s.RN)(i)&&n?(0,a.Yf)(r):null,culling:(0,_.Xt)(o),depthTest:h?null:{func:(0,a.K_)(r)},depthWrite:(0,a.z5)(e),drawBuffers:(0,d.L)(i,(0,a.m6)(r,i)),colorWrite:_.kn,stencilWrite:l?p.v0:null,stencilTest:l?t?p.a9:p.qh:null,polygonOffset:c?u?m:null:(0,a.mE)(e)})}initializePipeline(e){return this._occludeePipelineState=this._createPipeline(e,!0),this._createPipeline(e,!1)}getPipeline(e){return e?this._occludeePipelineState:super.getPipeline()}}const m={factor:1,units:1};function x(e){const t=(0,u.BP)().vec3f("position");return(0,g.E)()&&t.vec4u8("olidColor"),e.hasVVColor?t.f32("colorFeatureAttribute"):t.vec4u8("color"),t.freeze()}var y=r(6326),b=r(6485),w=r(92656);class C extends w.E{constructor(){super(...arguments),this.cullFace=0,this.hasVertexColors=!1,this.transparent=!1,this.discardInvisibleFragments=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasVVColor=!1,this.draped=!1,this.textureCoordinateType=0,this.emissionSource=0,this.occlusionPass=!1,this.olidColorInstanced=!1,this.hasVVInstancing=!1,this.hasVVSize=!1,this.hasVVOpacity=!1,this.snowCover=!1}}(0,y.Cg)([(0,b.W)({count:3})],C.prototype,"cullFace",void 0),(0,y.Cg)([(0,b.W)()],C.prototype,"hasVertexColors",void 0),(0,y.Cg)([(0,b.W)()],C.prototype,"transparent",void 0),(0,y.Cg)([(0,b.W)()],C.prototype,"discardInvisibleFragments",void 0),(0,y.Cg)([(0,b.W)()],C.prototype,"polygonOffset",void 0),(0,y.Cg)([(0,b.W)()],C.prototype,"enableOffset",void 0),(0,y.Cg)([(0,b.W)()],C.prototype,"writeDepth",void 0),(0,y.Cg)([(0,b.W)()],C.prototype,"hasOccludees",void 0),(0,y.Cg)([(0,b.W)()],C.prototype,"terrainDepthTest",void 0),(0,y.Cg)([(0,b.W)()],C.prototype,"cullAboveTerrain",void 0),(0,y.Cg)([(0,b.W)()],C.prototype,"hasVVColor",void 0),(0,y.Cg)([(0,b.W)()],C.prototype,"draped",void 0);var T=r(75569);class S extends h.W{constructor(e){super(e,M),this._configuration=new C,this.supportsEdges=!0,this.produces=new Map([[2,e=>this._isOpaqueMaterialPass(e)],[3,e=>this._isOpaqueNoSSAODepthPass(e)],[4,e=>(0,s.QG)(e)&&this._transparent&&this.parameters.writeDepth],[5,e=>(0,s.eh)(e)&&this._transparent&&this.parameters.writeDepth],[8,e=>(0,s.QG)(e)&&this._transparent&&!this.parameters.writeDepth],[18,e=>(0,s.i3)(e)]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._transparent,this._configuration.discardInvisibleFragments=this._transparent&&!this._isOpaquePass(e)&&this.parameters.discardInvisibleFragments,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=t.hasOccludees,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.camera.relativeElevation<a.xt,this._configuration.terrainDepthTest=t.terrainDepthTest&&(0,s.RN)(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.hasVVColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}get visible(){return this.parameters.color[3]>=T.Q}get _transparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}_isOpaquePass(e){return this._isOpaqueMaterialPass(e)||this._isOpaqueNoSSAODepthPass(e)}_isOpaqueMaterialPass(e){return 9===e||(0,s.QG)(e)&&!this._transparent}_isOpaqueNoSSAODepthPass(e){return(0,s.eh)(e)&&this.parameters.writeDepth&&!this._transparent}createGLMaterial(e){return new O(e)}createBufferWriter(){return new o.Z(x(this.parameters))}}class O extends n.A{beginSlot(e){return this.getTechnique(f,e)}}class M extends l.S{constructor(){super(...arguments),this.color=i.uY,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=0,this.draped=!1,this.discardInvisibleFragments=!1}}},80381:(e,t,r)=>{r.d(t,{O:()=>d,a:()=>p,b:()=>g});var i,s=r(57528),n=r(73398),a=r(21390),o=r(86955),h=r(72790),l=r(70367),u=r(31432),c=r(2687);class d extends u.Y{constructor(){super(...arguments),this.overlayIndex=0,this.opacity=1}}function g(){const e=new c.N5;return e.include(n.c),e.fragment.uniforms.add(new l.N("tex",e=>e.texture)),e.fragment.uniforms.add(new h.c("overlayIdx",e=>e.overlayIndex)),e.fragment.uniforms.add(new a.m("opacity",e=>e.opacity)),e.fragment.main.add((0,o.H)(i||(i=(0,s.A)(["vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);\nfragColor = texture(tex, overlayUV) * opacity;"])))),e}const p=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:d,build:g},Symbol.toStringTag,{value:"Module"}))},86401:(e,t,r)=>{r.d(t,{Ci:()=>s,KL:()=>o,dB:()=>a,l5:()=>n,wB:()=>h});var i=r(48549);const s=(0,i.BP)().vec3f("position").freeze(),n=(0,i.BP)().vec3f("position").vec2f16("uv0").freeze(),a=(0,i.BP)().vec3f("position").vec4u8("color").freeze(),o=(0,i.BP)().vec3f("position").vec2f("uv0").freeze(),h=(0,i.BP)().vec3f("position").vec2f("uv0").vec4u8("olidColor").freeze()}}]);
//# sourceMappingURL=2665.45b49c69.chunk.js.map